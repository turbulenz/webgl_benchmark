(function(){function c(){return this}function h(){return this}function p(){return this}function d(){return this}function v(){return this}function m(){return this}function g(){return this}function y(){return this}function b(){return this}function w(){return this}function E(){return this}function S(){return this}function T(){return this.endStreams=0,this.endTechniqueParameters=48,this.endInstances=56,this.firstIndex=0,this.count=0,this.sortKey=0,this.technique=null,this.indexBuffer=null,this.primitive=-1,this.userData=null,this[0]=undefined,this[1]=undefined,this[2]=undefined,this[48]=undefined,this[49]=undefined,this[56]=undefined,this[57]=undefined,this[58]=undefined,this[59]=undefined,this[60]=undefined,this[61]=undefined,this[62]=undefined,this[63]=undefined,this}function N(){return this}function C(){return this}function k(){return this}function O(){return this}function _(){return this}function D(){return this}function P(){return this}function H(){return this}function B(){return this}function j(){return this}function F(){return this}function I(){return this}function R(){return this}function U(){return this}function z(){return this}function W(e,n){this._public=n,this.id=W.uniqueId,W.uniqueId+=1,this.world=null,this.shape=e.shape._private,this.friction=e.friction!==undefined?e.friction:.5,this.restitution=e.restitution!==undefined?e.restitution:0;var r=e.transform;this.transform=r?t.m43Copy(r):t.m43BuildIdentity(),this.arbiters=[],this.constraints=[],this.velocity=new Float32Array(12);var i=e.linearVelocity;i&&(this.velocity[0]=i[0],this.velocity[1]=i[1],this.velocity[2]=i[2]),i=e.angularVelocity,i&&(this.velocity[3]=i[0],this.velocity[4]=i[1],this.velocity[5]=i[2]),this.linearDamping=e.linearDamping!==undefined?e.linearDamping:0,this.angularDamping=e.angularDamping!==undefined?e.angularDamping:0,this.extents=new Float32Array(6),this.startTransform=t.m43BuildIdentity(),this.endTransform=t.m43BuildIdentity(),this.prevTransform=t.m43Copy(this.transform),this.newTransform=t.m43BuildIdentity(),this.island=null,this.islandRoot=this,this.islandRank=0,this.delaySleep=!0,this.group=0,this.mask=0,this.kinematic=!1,this.fixedRotation=!1,this.mass=0,this.inverseMass=0,this.inverseInertiaLocal=null,this.inverseInertia=null,this.collisionObject=!1,this.permitSleep=!1,this.sweepFrozen=!1,this.active=!1,this.contactCallbacks=null}function X(e,t){return this.mask=e.contactCallbacksMask!==undefined?e.contactCallbacksMask:t,this.added=!1,this.deferred=e.onAddedContacts||e.onProcessedContacts||e.onRemovedContacts,this.onPreSolveContact=e.onPreSolveContact||null,this.onAddedContacts=e.onAddedContacts||null,this.onProcessedContacts=e.onProcessedContacts||null,this.onRemovedContacts=e.onRemovedContacts||null,this.trigger=e.trigger||!1,this}function V(){return this}function $(){return this}function K(){return this}function Q(){return this.bodyA=null,this.bodyB=null,this.data=new Float32Array(46),this}function G(){return this}function Y(){return this.crouch=!1,this.dead=!1,this.start=t.m43BuildIdentity(),this.end=t.m43BuildIdentity(),this.rigidBody=null,this}function Z(){return this}function et(){return this}function nt(){return this._private=null,this}function rt(){return this.objectA=null,this.objectB=null,this.shapeA=null,this.shapeB=null,this.friction=0,this.restitution=0,this.contacts=[],this.activeContacts=[],this.active=!0,this.skipDiscreteCollisions=!1,this.contactFlags=0,this.trigger=!1,this}function it(){return this.bodies=[],this.constraints=[],this.wakeTimeStamp=0,this.active=!1,this}function st(){return this.index=0,this.collisionRadius=0,this.triangleArray=null,this}function ot(){return this.objectA=null,this.objectB=null,this.shapeA=null,this.shapeB=null,this.closestA=t.v3BuildZero(),this.closestB=t.v3BuildZero(),this.axis=t.v3BuildZero(),this.distance=0,this.toi=0,this.frozenA=!1,this.frozenB=!1,this.concave=!1,this}function ut(){return this}function at(){return this}function lt(){return this}function ct(){return this}function ht(){return this}function pt(){return this}function dt(){return this}function vt(){return this}function mt(){return this}function bt(){}function wt(){}function Et(){}function St(){}function xt(){}function Nt(){}function Ct(){}function kt(){function t(e){return!isNaN(parseFloat(e))&&isFinite(e)}var e=null;window.location&&window.location.search?e=window.location.search:window.parent&&window.parent.location&&window.parent.location.search&&(e=window.parent.location.search);if(!e)return{};e=e.substring(1);if(e==="")return{};var n={},r=e.split("&"),i=r.length;for(var s=0;s<i;s+=1){var o=r[s].split("="),u=o[0],a=o[1];a==="true"?a=!0:a==="false"?a=!1:a&&(a=decodeURIComponent(a),t(a)?a=parseFloat(a):a=a.replace(/\+/g," ")),n[u]=a}return n}function Lt(e){var t=kt();for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}var e=Array;typeof Float32Array!="undefined"&&Float32Array.prototype!==undefined&&Float32Array.prototype.slice===undefined&&(Float32Array.prototype.slice=function(t,n){var r=this.length;t===undefined?t=0:t<0&&(t+=r),n===undefined?n=r:n<0&&(n+=r),r=n-t;if(0<r){var i=new Float32Array(r),s=0;do i[s]=this[t],s+=1,t+=1;while(t<n);return i}return new Float32Array(0)});var t={version:1,precision:1e-6,FLOAT_MAX:3.402823466e38,select:function(t,n,r){return t?n:r},reciprocal:function(t){if(t!==0)return 1/t;throw"Division by zero"},truncate:function(t){return t|0},v2BuildZero:function(n){return n===undefined&&(n=new e(2)),n[0]=0,n[1]=0,n},v2BuildOne:function(n){return n===undefined&&(n=new e(2)),n[0]=1,n[1]=1,n},v2BuildXAxis:function(n){return n===undefined&&(n=new e(2)),n[0]=1,n[1]=0,n},v2BuildYAxis:function(n){return n===undefined&&(n=new e(2)),n[0]=0,n[1]=1,n},v2Build:function(n,r,i){return i===undefined&&(i=new e(2)),i[0]=n,i[1]=r,i},v2Copy:function(n,r){return r===undefined&&(r=new e(2)),r[0]=n[0],r[1]=n[1],r},v2Set:function(t,n){t[0]=n[0],t[1]=n[1]},v2Neg:function(n,r){return r===undefined&&(r=new e(2)),r[0]=-n[0],r[1]=-n[1],r},v2Add:function(n,r,i){return i===undefined&&(i=new e(2)),i[0]=n[0]+r[0],i[1]=n[1]+r[1],i},v2Add3:function(n,r,i,s){return s===undefined&&(s=new e(2)),s[0]=n[0]+r[0]+i[0],s[1]=n[1]+r[1]+i[1],s},v2Add4:function(n,r,i,s,o){return o===undefined&&(o=new e(2)),o[0]=n[0]+r[0]+i[0]+s[0],o[1]=n[1]+r[1]+i[1]+s[1],o},v2Sub:function(n,r,i){return i===undefined&&(i=new e(2)),i[0]=n[0]-r[0],i[1]=n[1]-r[1],i},v2Mul:function(n,r,i){return i===undefined&&(i=new e(2)),i[0]=n[0]*r[0],i[1]=n[1]*r[1],i},v2MulAdd:function(n,r,i,s){return s===undefined&&(s=new e(2)),s[0]=n[0]*r[0]+i[0],s[1]=n[1]*r[1]+i[1],s},v2Dot:function(t,n){return t[0]*n[0]+t[1]*n[1]},v2PerpDot:function(t,n){return t[0]*n[1]-t[1]*n[0]},v2LengthSq:function(t){var n=t[0],r=t[1];return n*n+r*r},v2Length:function(t){var n=t[0],r=t[1];return Math.sqrt(n*n+r*r)},v2Reciprocal:function(r,i){i===undefined&&(i=new e(2));var s=t.reciprocal;return i[0]=s(r[0]),i[1]=s(r[1]),i},v2Normalize:function(n,r){r===undefined&&(r=new e(2));var i=n[0],s=n[1],o=i*i+s*s;if(o>0){var u=1/Math.sqrt(o);r[0]=i*u,r[1]=s*u}else r[0]=0,r[1]=0;return r},v2Abs:function(n,r){r===undefined&&(r=new e(2));var i=Math.abs;return r[0]=i(n[0]),r[1]=i(n[1]),r},v2Max:function(n,r,i){i===undefined&&(i=new e(2));var s=Math.max;return i[0]=s(n[0],r[0]),i[1]=s(n[1],r[1]),i},v2Min:function(n,r,i){i===undefined&&(i=new e(2));var s=Math.min;return i[0]=s(n[0],r[0]),i[1]=s(n[1],r[1]),i},v2Equal:function(t,n,r){var i=Math.abs;return r===undefined&&(r=this.precision),i(t[0]-n[0])<=r&&i(t[1]-n[1])<=r},v2MaskEqual:function(n,r){var i=Math.abs,s=t.precision;return[i(n[0]-r[0])<=s,i(n[1]-r[1])<=s]},v2MaskLess:function(t,n){return[t[0]<n[0],t[1]<n[1]]},v2MaskGreater:function(t,n){return[t[0]>n[0],t[1]>n[1]]},v2MaskGreaterEq:function(t,n){return[t[0]>=n[0],t[1]>=n[1]]},v2MaskNot:function(t){return[!t[0],!t[1]]},v2MaskOr:function(t,n){return[t[0]||n[0],t[1]||n[1]]},v2MaskAnd:function(t,n){return[t[0]&&n[0],t[1]&&n[1]]},v2Select:function(n,r,i,s){return s===undefined&&(s=new e(2)),s[0]=n[0]?r[0]:i[0],s[1]=n[1]?r[1]:i[1],s},v2ScalarBuild:function(n,r){return r===undefined&&(r=new e(2)),r[0]=n,r[1]=n,r},v2ScalarMax:function(n,r,i){i===undefined&&(i=new e(2));var s=Math.max;return i[0]=s(n[0],r),i[1]=s(n[1],r),i},v2ScalarMin:function(n,r,i){i===undefined&&(i=new e(2));var s=Math.min;return i[0]=s(n[0],r),i[1]=s(n[1],r),i},v2ScalarAdd:function(n,r,i){return i===undefined&&(i=new e(2)),i[0]=n[0]+r,i[1]=n[1]+r,i},v2ScalarSub:function(n,r,i){return i===undefined&&(i=new e(2)),i[0]=n[0]-r,i[1]=n[1]-r,i},v2ScalarMul:function(n,r,i){return i===undefined&&(i=new e(2)),r===0?(i[0]=0,i[1]=0):(i[0]=n[0]*r,i[1]=n[1]*r),i},v2AddScalarMul:function(n,r,i,s){return s===undefined&&(s=new e(2)),s[0]=n[0]+r[0]*i,s[1]=n[1]+r[1]*i,s},v2EqualScalarMask:function(n,r){var i=Math.abs,s=t.precision;return[i(n[0]-r)<=s,i(n[1]-r)<=s]},v2LessScalarMask:function(t,n){return[t[0]<n,t[1]<n]},v2GreaterScalarMask:function(t,n){return[t[0]>n,t[1]>n]},v2GreaterEqScalarMask:function(t,n){return[t[0]>=n,t[1]>=n]},v2Lerp:function(n,r,i,s){return s===undefined&&(s=new e(2)),s[0]=n[0]+(r[0]-n[0])*i,s[1]=n[1]+(r[1]-n[1])*i,s},v3BuildZero:function(n){var r=n;return r===undefined&&(r=new e(3)),r[0]=0,r[1]=0,r[2]=0,r},v3BuildOne:function(n){var r=n;return r===undefined&&(r=new e(3)),r[0]=1,r[1]=1,r[2]=1,r},v3BuildXAxis:function(n){var r=n;return r===undefined&&(r=new e(3)),r[0]=1,r[1]=0,r[2]=0,r},v3BuildYAxis:function(n){var r=n;return r===undefined&&(r=new e(3)),r[0]=0,r[1]=1,r[2]=0,r},v3BuildZAxis:function(n){var r=n;return r===undefined&&(r=new e(3)),r[0]=0,r[1]=0,r[2]=1,r},v3Build:function(n,r,i,s){var o=s;return o===undefined&&(o=new e(3)),o[0]=n,o[1]=r,o[2]=i,o},v3Copy:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i},v3Set:function(t,n){t[0]=n[0],t[1]=n[1],t[2]=n[2]},v3Neg:function(n,r){return r===undefined&&(r=new e(3)),r[0]=-n[0],r[1]=-n[1],r[2]=-n[2],r},v3Add:function(n,r,i){var s=i;return s===undefined&&(s=new e(3)),s[0]=n[0]+r[0],s[1]=n[1]+r[1],s[2]=n[2]+r[2],s},v3Add3:function(n,r,i,s){return s===undefined&&(s=new e(3)),s[0]=n[0]+r[0]+i[0],s[1]=n[1]+r[1]+i[1],s[2]=n[2]+r[2]+i[2],s},v3Add4:function(n,r,i,s,o){return o===undefined&&(o=new e(3)),o[0]=n[0]+r[0]+i[0]+s[0],o[1]=n[1]+r[1]+i[1]+s[1],o[2]=n[2]+r[2]+i[2]+s[2],o},v3Sub:function(n,r,i){var s=i;return s===undefined&&(s=new e(3)),s[0]=n[0]-r[0],s[1]=n[1]-r[1],s[2]=n[2]-r[2],s},v3Mul:function(n,r,i){return i===undefined&&(i=new e(3)),i[0]=n[0]*r[0],i[1]=n[1]*r[1],i[2]=n[2]*r[2],i},v3MulAdd:function(n,r,i,s){return s===undefined&&(s=new e(3)),s[0]=n[0]*r[0]+i[0],s[1]=n[1]*r[1]+i[1],s[2]=n[2]*r[2]+i[2],s},v3Dot:function(t,n){return t[0]*n[0]+t[1]*n[1]+t[2]*n[2]},v3Cross:function(n,r,i){var s=i;s===undefined&&(s=new e(3));var o=n[0],u=n[1],a=n[2],f=r[0],l=r[1],c=r[2];return s[0]=u*c-a*l,s[1]=a*f-o*c,s[2]=o*l-u*f,s},v3LengthSq:function(t){var n=t[0],r=t[1],i=t[2];return n*n+r*r+i*i},v3Length:function(t){var n=t[0],r=t[1],i=t[2];return Math.sqrt(n*n+r*r+i*i)},v3Reciprocal:function(r,i){i===undefined&&(i=new e(3));var s=t.reciprocal;return i[0]=s(r[0]),i[1]=s(r[1]),i[2]=s(r[2]),i},v3Normalize:function(n,r){var i=r;i===undefined&&(i=new e(3));var s=n[0],o=n[1],u=n[2],a=s*s+o*o+u*u;if(a>0){var f=1/Math.sqrt(a);i[0]=s*f,i[1]=o*f,i[2]=u*f}else i[0]=0,i[1]=0,i[2]=0;return i},v3Abs:function(n,r){var i=r;i===undefined&&(i=new e(3));var s=Math.abs;return i[0]=s(n[0]),i[1]=s(n[1]),i[2]=s(n[2]),i},v3Max:function(n,r,i){var s=i;s===undefined&&(s=new e(3));var o=Math.max;return s[0]=o(n[0],r[0]),s[1]=o(n[1],r[1]),s[2]=o(n[2],r[2]),s},v3Min:function(n,r,i){var s=i;s===undefined&&(s=new e(3));var o=Math.min;return s[0]=o(n[0],r[0]),s[1]=o(n[1],r[1]),s[2]=o(n[2],r[2]),s},v3Equal:function(t,n,r){var i=Math.abs;return r===undefined&&(r=this.precision),i(t[0]-n[0])<=r&&i(t[1]-n[1])<=r&&i(t[2]-n[2])<=r},v3MaskEqual:function(n,r){var i=Math.abs,s=t.precision;return[i(n[0]-r[0])<=s,i(n[1]-r[1])<=s,i(n[2]-r[2])<=s]},v3MaskLess:function(t,n){return[t[0]<n[0],t[1]<n[1],t[2]<n[2]]},v3MaskGreater:function(t,n){return[t[0]>n[0],t[1]>n[1],t[2]>n[2]]},v3MaskGreaterEq:function(t,n){return[t[0]>=n[0],t[1]>=n[1],t[2]>=n[2]]},v3MaskNot:function(t){return[!t[0],!t[1],!t[2]]},v3MaskOr:function(t,n){return[t[0]||n[0],t[1]||n[1],t[2]||n[2]]},v3MaskAnd:function(t,n){return[t[0]&&n[0],t[1]&&n[1],t[2]&&n[2]]},v3Select:function(n,r,i,s){return s===undefined&&(s=new e(3)),s[0]=n[0]?r[0]:i[0],s[1]=n[1]?r[1]:i[1],s[2]=n[2]?r[2]:i[2],s},v3ScalarBuild:function(n,r){return r===undefined&&(r=new e(3)),r[0]=n,r[1]=n,r[2]=n,r},v3ScalarMax:function(n,r,i){i===undefined&&(i=new e(3));var s=Math.max;return i[0]=s(n[0],r),i[1]=s(n[1],r),i[2]=s(n[2],r),i},v3ScalarMin:function(n,r,i){i===undefined&&(i=new e(3));var s=Math.min;return i[0]=s(n[0],r),i[1]=s(n[1],r),i[2]=s(n[2],r),i},v3ScalarAdd:function(n,r,i){return i===undefined&&(i=new e(3)),i[0]=n[0]+r,i[1]=n[1]+r,i[2]=n[2]+r,i},v3ScalarSub:function(n,r,i){return i===undefined&&(i=new e(3)),i[0]=n[0]-r,i[1]=n[1]-r,i[2]=n[2]-r,i},v3ScalarMul:function(n,r,i){var s=i;return s===undefined&&(s=new e(3)),r===0?(s[0]=0,s[1]=0,s[2]=0):(s[0]=n[0]*r,s[1]=n[1]*r,s[2]=n[2]*r),s},v3AddScalarMul:function(n,r,i,s){return s===undefined&&(s=new e(3)),s[0]=n[0]+r[0]*i,s[1]=n[1]+r[1]*i,s[2]=n[2]+r[2]*i,s},v3EqualScalarMask:function(n,r){var i=Math.abs,s=t.precision;return[i(n[0]-r)<=s,i(n[1]-r)<=s,i(n[2]-r)<=s]},v3LessScalarMask:function(t,n){return[t[0]<n,t[1]<n,t[2]<n]},v3GreaterScalarMask:function(t,n){return[t[0]>n,t[1]>n,t[2]>n]},v3GreaterEqScalarMask:function(t,n){return[t[0]>=n,t[1]>=n,t[2]>=n]},v3Lerp:function(n,r,i,s){var o=s;return o===undefined&&(o=new e(3)),o[0]=n[0]+(r[0]-n[0])*i,o[1]=n[1]+(r[1]-n[1])*i,o[2]=n[2]+(r[2]-n[2])*i,o},v4BuildZero:function(n){var r=n;return r===undefined&&(r=new e(4)),r[0]=0,r[1]=0,r[2]=0,r[3]=0,r},v4BuildOne:function(n){var r=n;return r===undefined&&(r=new e(4)),r[0]=1,r[1]=1,r[2]=1,r[3]=1,r},v4Build:function(n,r,i,s,o){var u=o;return u===undefined&&(u=new e(4)),u[0]=n,u[1]=r,u[2]=i,u[3]=s,u},v4Copy:function(n,r){var i=r;return i===undefined&&(i=new e(4)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3],i},v4Set:function(t,n){t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3]},v4Neg:function(n,r){return r===undefined&&(r=new e(4)),r[0]=-n[0],r[1]=-n[1],r[2]=-n[2],r[3]=-n[3],r},v4Add:function(n,r,i){return i===undefined&&(i=new e(4)),i[0]=n[0]+r[0],i[1]=n[1]+r[1],i[2]=n[2]+r[2],i[3]=n[3]+r[3],i},v4Add3:function(n,r,i,s){return s===undefined&&(s=new e(4)),s[0]=n[0]+r[0]+i[0],s[1]=n[1]+r[1]+i[1],s[2]=n[2]+r[2]+i[2],s[3]=n[3]+r[3]+i[3],s},v4Add4:function(n,r,i,s,o){return o===undefined&&(o=new e(4)),o[0]=n[0]+r[0]+i[0]+s[0],o[1]=n[1]+r[1]+i[1]+s[1],o[2]=n[2]+r[2]+i[2]+s[2],o[3]=n[3]+r[3]+i[3]+s[3],o},v4Sub:function(n,r,i){return i===undefined&&(i=new e(4)),i[0]=n[0]-r[0],i[1]=n[1]-r[1],i[2]=n[2]-r[2],i[3]=n[3]-r[3],i},v4Mul:function(n,r,i){return i===undefined&&(i=new e(4)),i[0]=n[0]*r[0],i[1]=n[1]*r[1],i[2]=n[2]*r[2],i[3]=n[3]*r[3],i},v4MulAdd:function(n,r,i,s){return s===undefined&&(s=new e(4)),s[0]=n[0]*r[0]+i[0],s[1]=n[1]*r[1]+i[1],s[2]=n[2]*r[2]+i[2],s[3]=n[3]*r[3]+i[3],s},v4Dot:function(t,n){return t[0]*n[0]+t[1]*n[1]+t[2]*n[2]+t[3]*n[3]},v4LengthSq:function(t){var n=t[0],r=t[1],i=t[2],s=t[3];return n*n+r*r+i*i+s*s},v4Length:function(t){var n=t[0],r=t[1],i=t[2],s=t[3];return Math.sqrt(n*n+r*r+i*i+s*s)},v4Reciprocal:function(r,i){i===undefined&&(i=new e(4));var s=t.reciprocal;return i[0]=s(r[0]),i[1]=s(r[1]),i[2]=s(r[2]),i[3]=s(r[3]),i},v4Normalize:function(n,r){r===undefined&&(r=new e(4));var i=n[0],s=n[1],o=n[2],u=n[3],a=i*i+s*s+o*o+u*u;if(a>0){var f=1/Math.sqrt(a);r[0]=i*f,r[1]=s*f,r[2]=o*f,r[3]=u*f}else r[0]=0,r[1]=0,r[2]=0,r[3]=0;return r},v4Abs:function(n,r){r===undefined&&(r=new e(4));var i=Math.abs;return r[0]=i(n[0]),r[1]=i(n[1]),r[2]=i(n[2]),r[3]=i(n[3]),r},v4Max:function(n,r,i){i===undefined&&(i=new e(4));var s=Math.max;return i[0]=s(n[0],r[0]),i[1]=s(n[1],r[1]),i[2]=s(n[2],r[2]),i[3]=s(n[3],r[3]),i},v4Min:function(n,r,i){i===undefined&&(i=new e(4));var s=Math.min;return i[0]=s(n[0],r[0]),i[1]=s(n[1],r[1]),i[2]=s(n[2],r[2]),i[3]=s(n[3],r[3]),i},v4Equal:function(t,n,r){var i=Math.abs;return r===undefined&&(r=this.precision),i(t[0]-n[0])<=r&&i(t[1]-n[1])<=r&&i(t[2]-n[2])<=r&&i(t[3]-n[3])<=r},v4MaskEqual:function(n,r){var i=Math.abs,s=t.precision;return[i(n[0]-r[0])<=s,i(n[1]-r[1])<=s,i(n[2]-r[2])<=s,i(n[3]-r[3])<=s]},v4MaskLess:function(t,n){return[t[0]<n[0],t[1]<n[1],t[2]<n[2],t[3]<n[3]]},v4MaskGreater:function(t,n){return[t[0]>n[0],t[1]>n[1],t[2]>n[2],t[3]>n[3]]},v4MaskGreaterEq:function(t,n){return[t[0]>=n[0],t[1]>=n[1],t[2]>=n[2],t[3]>=n[3]]},v4MaskNot:function(t){return[!t[0],!t[1],!t[2],!t[3]]},v4MaskOr:function(t,n){return[t[0]||n[0],t[1]||n[1],t[2]||n[2],t[3]||n[3]]},v4MaskAnd:function(t,n){return[t[0]&&n[0],t[1]&&n[1],t[2]&&n[2],t[3]&&n[3]]},v4Many:function(t){return t[0]||t[1]||t[2]||t[3]},v4MaskAll:function(t){return t[0]&&t[1]&&t[2]&&t[3]},v4Select:function(n,r,i,s){return s===undefined&&(s=new e(4)),s[0]=n[0]?r[0]:i[0],s[1]=n[1]?r[1]:i[1],s[2]=n[2]?r[2]:i[2],s[3]=n[3]?r[3]:i[3],s},v4ScalarBuild:function(n,r){return r===undefined&&(r=new e(4)),r[0]=n,r[1]=n,r[2]=n,r[3]=n,r},v4ScalarMax:function(n,r,i){i===undefined&&(i=new e(4));var s=Math.max;return i[0]=s(n[0],r),i[1]=s(n[1],r),i[2]=s(n[2],r),i[3]=s(n[3],r),i},v4ScalarMin:function(n,r,i){i===undefined&&(i=new e(4));var s=Math.min;return i[0]=s(n[0],r),i[1]=s(n[1],r),i[2]=s(n[2],r),i[3]=s(n[3],r),i},v4ScalarAdd:function(n,r,i){return i===undefined&&(i=new e(4)),i[0]=n[0]+r,i[1]=n[1]+r,i[2]=n[2]+r,i[3]=n[3]+r,i},v4ScalarSub:function(n,r,i){return i===undefined&&(i=new e(4)),i[0]=n[0]-r,i[1]=n[1]-r,i[2]=n[2]-r,i[3]=n[3]-r,i},v4ScalarMul:function(r,i,s){return i===0?t.v4BuildZero(s):(s===undefined&&(s=new e(4)),s[0]=r[0]*i,s[1]=r[1]*i,s[2]=r[2]*i,s[3]=r[3]*i,s)},v4AddScalarMul:function(n,r,i,s){return s===undefined&&(s=new e(4)),s[0]=n[0]+r[0]*i,s[1]=n[1]+r[1]*i,s[2]=n[2]+r[2]*i,s[3]=n[3]+r[3]*i,s},v4ScalarEqual:function(n,r){var i=Math.abs,s=t.precision;return i(n[0]-r)<=s&&i(n[1]-r)<=s&&i(n[2]-r)<=s&&i(n[3]-r)<=s},v4EqualScalarMask:function(n,r){var i=Math.abs,s=t.precision;return[i(n[0]-r)<=s,i(n[1]-r)<=s,i(n[2]-r)<=s,i(n[3]-r)<=s]},v4LessScalarMask:function(t,n){return[t[0]<n,t[1]<n,t[2]<n,t[3]<n]},v4GreaterScalarMask:function(t,n){return[t[0]>n,t[1]>n,t[2]>n,t[3]>n]},v4GreaterEqScalarMask:function(t,n){return[t[0]>=n,t[1]>=n,t[2]>=n,t[3]>=n]},v4Lerp:function(n,r,i,s){return s===undefined&&(s=new e(4)),s[0]=n[0]+(r[0]-n[0])*i,s[1]=n[1]+(r[1]-n[1])*i,s[2]=n[2]+(r[2]-n[2])*i,s[3]=n[3]+(r[3]-n[3])*i,s},aabbBuild:function(n,r,i,s,o,u,a){var f=a;return f===undefined&&(f=new e(6)),f[0]=n,f[1]=r,f[2]=i,f[3]=s,f[4]=o,f[5]=u,f},aabbBuildEmpty:function(n){var r=this.FLOAT_MAX,i=n;return i===undefined&&(i=new e(6)),i[0]=r,i[1]=r,i[2]=r,i[3]=-r,i[4]=-r,i[5]=-r,i},aabbCopy:function(n,r){var i=r;return i===undefined&&(i=new e(6)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3],i[4]=n[4],i[5]=n[5],i},aabbSet:function(t,n){t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5]},aabbIsEmpty:function(t){return t[0]>t[3]},aabbMin:function(t,n){return n===undefined?t.slice(0,3):(n[0]=t[0],n[1]=t[1],n[2]=t[2],n)},aabbMax:function(t,n){return n===undefined?t.slice(3,6):(n[0]=t[3],n[1]=t[4],n[2]=t[5],n)},aabbGetCenterAndHalf:function(t,n,r){var i=(t[0]+t[3])*.5,s=(t[1]+t[4])*.5,o=(t[2]+t[5])*.5;n[0]=i,n[1]=s,n[2]=o,r[0]=t[3]-i,r[1]=t[4]-s,r[2]=t[5]-o},aabbIsInsidePlanes:function(t,n){var r=n.length,i=0;do{var s=n[i],o=s[0],u=s[1],a=s[2];if(o*(o<0?t[0]:t[3])+u*(u<0?t[1]:t[4])+a*(a<0?t[2]:t[5])<s[3])return!1;i+=1}while(i<r);return!0},aabbIsFullyInsidePlanes:function(t,n){var r=n.length,i=0;do{var s=n[i],o=s[0],u=s[1],a=s[2];if(o*(o>0?t[0]:t[3])+u*(u>0?t[1]:t[4])+a*(a>0?t[2]:t[5])<s[3])return!1;i+=1}while(i<r);return!0},aabbUnion:function(n,r,i){return i===undefined&&(i=new e(6)),i[0]=n[0]<r[0]?n[0]:r[0],i[1]=n[1]<r[1]?n[1]:r[1],i[2]=n[2]<r[2]?n[2]:r[2],i[3]=n[3]>r[3]?n[3]:r[3],i[4]=n[4]>r[4]?n[4]:r[4],i[5]=n[5]>r[5]?n[5]:r[5],i},aabbUnionArray:function(r,i){i===undefined&&(i=new e(6)),t.aabbCopy(r[0],i);var s=r.length;for(var o=1;o<s;o+=1){var u=r[o];i[0]=i[0]<u[0]?i[0]:u[0],i[1]=i[1]<u[1]?i[1]:u[1],i[2]=i[2]<u[2]?i[2]:u[2],i[3]=i[3]>u[3]?i[3]:u[3],i[4]=i[4]>u[4]?i[4]:u[4],i[5]=i[5]>u[5]?i[5]:u[5]}return i},aabbAddPoints:function(t,n){var r,i=n.length,s=t[0],o=t[1],u=t[2],a=t[3],f=t[4],l=t[5],c,h,p,d;for(r=0;r<i;r+=1)c=n[r],h=c[0],p=c[1],d=c[2],s=s<h?s:h,o=o<p?o:p,u=u<d?u:d,a=a>h?a:h,f=f>p?f:p,l=l>d?l:d;t[0]=s,t[1]=o,t[2]=u,t[3]=a,t[4]=f,t[5]=l},aabbTransform:function(n,r,i){i===undefined&&(i=new e(6));var s=(n[0]+n[3])*.5,o=(n[1]+n[4])*.5,u=(n[2]+n[5])*.5,a=n[3]-s,f=n[4]-o,l=n[5]-u,c=r[0],h=r[1],p=r[2],d=r[3],v=r[4],m=r[5],g=r[6],y=r[7],b=r[8],w=r[9]+(c*s+d*o+g*u),E=r[10]+(h*s+v*o+y*u),S=r[11]+(p*s+m*o+b*u),x=Math.abs,T=x(c)*a+x(d)*f+x(g)*l,N=x(h)*a+x(v)*f+x(y)*l,C=x(p)*a+x(m)*f+x(b)*l;return i[0]=w-T,i[1]=E-N,i[2]=S-C,i[3]=w+T,i[4]=E+N,i[5]=S+C,i},aabbIntercept:function(n,r,i){return i===undefined&&(i=new e(6)),i[0]=n[0]>r[0]?n[0]:r[0],i[1]=n[1]>r[1]?n[1]:r[1],i[2]=n[2]>r[2]?n[2]:r[2],i[3]=n[3]<r[3]?n[3]:r[3],i[4]=n[4]<r[4]?n[4]:r[4],i[5]=n[5]<r[5]?n[5]:r[5],i},aabbOverlaps:function(t,n){return t[0]<=n[3]&&t[1]<=n[4]&&t[2]<=n[5]&&t[3]>=n[0]&&t[4]>=n[1]&&t[5]>=n[2]},aabbSphereOverlaps:function(t,n,r){var i=n[0],s=n[1],o=n[2],u=r*r,a=t[0],f=t[1],l=t[2],c=t[3],h=t[4],p=t[5],d=0,v;return i<a?(v=a-i,d+=v*v):i>c&&(v=i-c,d+=v*v),s<f?(v=f-s,d+=v*v):s>h&&(v=s-h,d+=v*v),o<l?(v=l-o,d+=v*v):o>p&&(v=o-p,d+=v*v),d<=u},aabbIsInside:function(t,n){return t[0]>=n[0]&&t[1]>=n[1]&&t[2]>=n[2]&&t[3]<=n[3]&&t[4]<=n[4]&&t[5]<=n[5]},aabbTestInside:function(t,n){return t[0]<=n[3]&&t[1]<=n[4]&&t[2]<=n[5]&&t[3]>=n[0]&&t[4]>=n[1]&&t[5]>=n[2]?t[0]>=n[0]&&t[1]>=n[1]&&t[2]>=n[2]&&t[3]<=n[3]&&t[4]<=n[4]&&t[5]<=n[5]?2:1:0},m33BuildIdentity:function(n){var r=n;return r===undefined&&(r=new e(9)),r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=1,r[5]=0,r[6]=0,r[7]=0,r[8]=1,r},m33Build:function(n,r,i,s){var o,u=arguments.length;return u>=9?(u>9?(o=arguments[9],o===undefined&&(o=new e(9))):o=new e(9),o[0]=arguments[0],o[1]=arguments[1],o[2]=arguments[2],o[3]=arguments[3],o[4]=arguments[4],o[5]=arguments[5],o[6]=arguments[6],o[7]=arguments[7],o[8]=arguments[8]):(o=s,o===undefined&&(o=new e(9)),o[0]=n[0],o[1]=n[1],o[2]=n[2],o[3]=r[0],o[4]=r[1],o[5]=r[2],o[6]=i[0],o[7]=i[1],o[8]=i[2]),o},m33Copy:function(n,r){var i=r;return i===undefined&&(i=new e(9)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3],i[4]=n[4],i[5]=n[5],i[6]=n[6],i[7]=n[7],i[8]=n[8],i},m33FromAxisRotation:function(n,r,i){var s=i;s===undefined&&(s=new e(9));var o=Math.sin(r),u=Math.cos(r),a=1-u,f=n[0],l=n[1],c=n[2],h=a*f,p=a*l,d=a*c,v=o*f,m=o*l,g=o*c;return s[0]=h*f+u,s[1]=h*l-g,s[2]=h*c+m,s[3]=p*f+g,s[4]=p*l+u,s[5]=p*c-v,s[6]=d*f-m,s[7]=d*l+v,s[8]=d*c+u,s},m33FromQuat:function(n,r){var i=r;i===undefined&&(i=new e(9));var s=n[0],o=n[1],u=n[2],a=n[3],f=2*s*s,l=2*o*o,c=2*u*u,h=2*s*o,p=2*u*a,d=2*s*u,v=2*o*a,m=2*o*u,g=2*s*a;return i[0]=1-l-c,i[1]=h-p,i[2]=d+v,i[3]=h+p,i[4]=1-f-c,i[5]=m-g,i[6]=d-v,i[7]=m+g,i[8]=1-f-l,i},m33Right:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i},m33Up:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[3],i[1]=n[4],i[2]=n[5],i},m33At:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[6],i[1]=n[7],i[2]=n[8],i},m33SetRight:function(t,n){t[0]=n[0],t[1]=n[1],t[2]=n[2]},m33SetUp:function(t,n){t[3]=n[0],t[4]=n[1],t[5]=n[2]},m33SetAt:function(t,n){t[6]=n[0],t[7]=n[1],t[8]=n[2]},m33Transpose:function(n,r){r===undefined&&(r=new e(9));var i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=n[5],l=n[6],c=n[7],h=n[8];return r[0]=i,r[1]=u,r[2]=l,r[3]=s,r[4]=a,r[5]=c,r[6]=o,r[7]=f,r[8]=h,r},m33Determinant:function(t){var n=t[0],r=t[1],i=t[2],s=t[3],o=t[4],u=t[5],a=t[6],f=t[7],l=t[8];return n*(o*l-u*f)+r*(u*a-s*l)+i*(s*f-o*a)},m33Inverse:function(r,i){i===undefined&&(i=new e(9));var s=t.m33Determinant(r);if(s===0)return i[0]=i[1]=i[2]=0,i[3]=i[4]=i[5]=0,i[6]=i[7]=i[8]=0,i;var o=r[0],u=r[1],a=r[2],f=r[3],l=r[4],c=r[5],h=r[6],p=r[7],d=r[8],v=1/s;return i[0]=(l*d+c*-p)*v,i[1]=(p*a+d*-u)*v,i[2]=(u*c-a*l)*v,i[3]=(c*h+f*-d)*v,i[4]=(d*o+h*-a)*v,i[5]=(f*a-o*c)*v,i[6]=(f*p+l*-h)*v,i[7]=(h*u+p*-o)*v,i[8]=(o*l-f*u)*v,i},m33InverseTranspose:function(n,r){r===undefined&&(r=new e(9));var i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=n[5],l=n[6],c=n[7],h=n[8],p=i*(a*h-f*c)+s*(f*l-u*h)+o*(u*c-a*l);if(p===0)return r[0]=r[1]=r[2]=0,r[3]=r[4]=r[5]=0,r[6]=r[7]=r[8]=0,r;var d=1/p;return r[0]=(a*h+f*-c)*d,r[3]=(c*o+h*-s)*d,r[6]=(s*f-o*a)*d,r[1]=(f*l+u*-h)*d,r[4]=(h*i+l*-o)*d,r[7]=(u*o-i*f)*d,r[2]=(u*c+a*-l)*d,r[5]=(l*s+c*-i)*d,r[8]=(i*a-u*s)*d,r},m33Mul:function(n,r,i){var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=r[0],v=r[1],m=r[2],g=r[3],y=r[4],b=r[5],w=r[6],E=r[7],S=r[8];return i===undefined&&(i=new e(9)),i[0]=d*s+g*o+w*u,i[1]=v*s+y*o+E*u,i[2]=m*s+b*o+S*u,i[3]=d*a+g*f+w*l,i[4]=v*a+y*f+E*l,i[5]=m*a+b*f+S*l,i[6]=d*c+g*h+w*p,i[7]=v*c+y*h+E*p,i[8]=m*c+b*h+S*p,i},m33Transform:function(n,r,i){i===undefined&&(i=new e(3));var s=r[0],o=r[1],u=r[2];return i[0]=n[0]*s+n[3]*o+n[6]*u,i[1]=n[1]*s+n[4]*o+n[7]*u,i[2]=n[2]*s+n[5]*o+n[8]*u,i},m33Equal:function(t,n,r){var i=Math.abs;return r===undefined&&(r=this.precision),i(t[0]-n[0])<=r&&i(t[1]-n[1])<=r&&i(t[2]-n[2])<=r&&i(t[3]-n[3])<=r&&i(t[4]-n[4])<=r&&i(t[5]-n[5])<=r&&i(t[6]-n[6])<=r&&i(t[7]-n[7])<=r&&i(t[8]-n[8])<=r},m33MulM43:function(n,r,i){i===undefined&&(i=new e(12));var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=r[0],v=r[1],m=r[2],g=r[3],y=r[4],b=r[5],w=r[6],E=r[7],S=r[8];return i[0]=d*s+g*o+w*u,i[1]=v*s+y*o+E*u,i[2]=m*s+b*o+S*u,i[3]=d*a+g*f+w*l,i[4]=v*a+y*f+E*l,i[5]=m*a+b*f+S*l,i[6]=d*c+g*h+w*p,i[7]=v*c+y*h+E*p,i[8]=m*c+b*h+S*p,i[9]=r[9],i[10]=r[10],i[11]=r[11],i},m33MulM44:function(n,r,i){i===undefined&&(i=new e(16));var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=r[0],v=r[1],m=r[2],g=r[3],y=r[4],b=r[5],w=r[6],E=r[7],S=r[8],x=r[9],T=r[10],N=r[11];return i[0]=d*s+y*o+S*u,i[1]=v*s+b*o+x*u,i[2]=m*s+w*o+T*u,i[3]=g*s+E*o+N*u,i[4]=d*a+y*f+S*l,i[5]=v*a+b*f+x*l,i[6]=m*a+w*f+T*l,i[7]=g*a+E*f+N*l,i[8]=d*c+y*h+S*p,i[9]=v*c+b*h+x*p,i[10]=m*c+w*h+T*p,i[11]=g*c+E*h+N*p,i[12]=r[12],i[13]=r[13],i[14]=r[14],i[15]=r[15],i},m33ScalarAdd:function(n,r,i){i===undefined&&(i=new e(9));for(var s=0;s<9;s+=1)i[s]=n[s]+r;return i},m33ScalarSub:function(n,r,i){i===undefined&&(i=new e(9));for(var s=0;s<9;s+=1)i[s]=n[s]-r;return i},m33ScalarMul:function(n,r,i){i===undefined&&(i=new e(9));for(var s=0;s<9;s+=1)i[s]=n[s]*r;return i},m34BuildIdentity:function(n){var r=n;return r===undefined&&(r=new e(12)),r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r},m34Pos:function(n,r){return r===undefined&&(r=new e(3)),r[0]=n[3],r[1]=n[7],r[2]=n[11],r},m34Scale:function(n,r,i){i===undefined&&(i=new e(12));var s=r[0],o=r[1],u=r[2];return i[0]=n[0]*s,i[1]=n[1]*s,i[2]=n[2]*s,i[3]=n[3],i[4]=n[4]*o,i[5]=n[5]*o,i[6]=n[6]*o,i[7]=n[7],i[8]=n[8]*u,i[9]=n[9]*u,i[10]=n[10]*u,i[11]=n[11],i},m43BuildIdentity:function(n){var r=n;return r===undefined&&(r=new e(12)),r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=1,r[5]=0,r[6]=0,r[7]=0,r[8]=1,r[9]=0,r[10]=0,r[11]=0,r},m43Build:function(n,r,i,s,o,u,a,f,l,c,h,p,d){var v,m=arguments.length;return m>=12?(m>12?(v=arguments[12],v===undefined&&(v=new e(12))):v=new e(12),v[0]=arguments[0],v[1]=arguments[1],v[2]=arguments[2],v[3]=arguments[3],v[4]=arguments[4],v[5]=arguments[5],v[6]=arguments[6],v[7]=arguments[7],v[8]=arguments[8],v[9]=arguments[9],v[10]=arguments[10],v[11]=arguments[11]):(v=o,v===undefined&&(v=new e(12)),v[0]=n[0],v[1]=n[1],v[2]=n[2],v[3]=r[0],v[4]=r[1],v[5]=r[2],v[6]=i[0],v[7]=i[1],v[8]=i[2],v[9]=s[0],v[10]=s[1],v[11]=s[2]),v},m43BuildTranslation:function(n,r,i,s){var o;return 3<=arguments.length?(o=s,o===undefined&&(o=new e(12)),o[9]=n,o[10]=r,o[11]=i):(o=r,o===undefined&&(o=new e(12)),o[9]=n[0],o[10]=n[1],o[11]=n[2]),o[0]=1,o[1]=0,o[2]=0,o[3]=0,o[4]=1,o[5]=0,o[6]=0,o[7]=0,o[8]=1,o},m43Copy:function(n,r){var i=r;return i===undefined&&(i=new e(12)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3],i[4]=n[4],i[5]=n[5],i[6]=n[6],i[7]=n[7],i[8]=n[8],i[9]=n[9],i[10]=n[10],i[11]=n[11],i},m43FromM33V3:function(n,r,i){var s=i;return s===undefined&&(s=new e(12)),s[0]=n[0],s[1]=n[1],s[2]=n[2],s[3]=n[3],s[4]=n[4],s[5]=n[5],s[6]=n[6],s[7]=n[7],s[8]=n[8],s[9]=r[0],s[10]=r[1],s[11]=r[2],s},m43FromAxisRotation:function(n,r,i){var s=Math.sin(r),o=Math.cos(r),u=1-o,a=n[0],f=n[1],l=n[2],c=u*a,h=u*f,p=u*l,d=s*a,v=s*f,m=s*l,g=i;return g===undefined&&(g=new e(12)),g[0]=c*a+o,g[1]=c*f-m,g[2]=c*l+v,g[3]=h*a+m,g[4]=h*f+o,g[5]=h*l-d,g[6]=p*a-v,g[7]=p*f+d,g[8]=p*l+o,g[9]=0,g[10]=0,g[11]=0,g},m43FromQuatPos:function(n,r){var i=r;i===undefined&&(i=new e(12));var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=2*s*s,p=2*o*o,d=2*u*u,v=2*s*o,m=2*u*a,g=2*s*u,y=2*o*a,b=2*o*u,w=2*s*a;return i[0]=1-p-d,i[1]=v-m,i[2]=g+y,i[3]=v+m,i[4]=1-h-d,i[5]=b-w,i[6]=g-y,i[7]=b+w,i[8]=1-h-p,i[9]=f,i[10]=l,i[11]=c,i},m43FromRTS:function(n,r,i,s){var o=n[0],u=n[1],a=n[2],f=n[3],l=2*o*o,c=2*u*u,h=2*a*a,p=2*o*u,d=2*a*f,v=2*o*a,m=2*u*f,g=2*u*a,y=2*o*f,b=i[0],w=i[1],E=i[2],S=s;return S===undefined&&(S=new e(12)),S[0]=b*(1-c-h),S[1]=b*(p-d),S[2]=b*(v+m),S[3]=w*(p+d),S[4]=w*(1-l-h),S[5]=w*(g-y),S[6]=E*(v-m),S[7]=E*(g+y),S[8]=E*(1-l-c),S[9]=r[0],S[10]=r[1],S[11]=r[2],S},m43FromRT:function(n,r,i){var s=n[0],o=n[1],u=n[2],a=n[3],f=2*s*s,l=2*o*o,c=2*u*u,h=2*s*o,p=2*u*a,d=2*s*u,v=2*o*a,m=2*o*u,g=2*s*a,y=i;return y===undefined&&(y=new e(12)),y[0]=1-l-c,y[1]=h-p,y[2]=d+v,y[3]=h+p,y[4]=1-f-c,y[5]=m-g,y[6]=d-v,y[7]=m+g,y[8]=1-f-l,y[9]=r[0],y[10]=r[1],y[11]=r[2],y},m43Right:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i},m43Up:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[3],i[1]=n[4],i[2]=n[5],i},m43At:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[6],i[1]=n[7],i[2]=n[8],i},m43Pos:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[9],i[1]=n[10],i[2]=n[11],i},m43SetRight:function(t,n){t[0]=n[0],t[1]=n[1],t[2]=n[2]},m43SetUp:function(t,n){t[3]=n[0],t[4]=n[1],t[5]=n[2]},m43SetAt:function(t,n){t[6]=n[0],t[7]=n[1],t[8]=n[2]},m43SetPos:function(t,n){t[9]=n[0],t[10]=n[1],t[11]=n[2]},m43SetAxisRotation:function(t,n,r){var i=Math.sin(r),s=Math.cos(r),o=1-s,u=n[0],a=n[1],f=n[2],l=o*u,c=o*a,h=o*f,p=i*u,d=i*a,v=i*f;t[0]=l*u+s,t[1]=l*a-v,t[2]=l*f+d,t[3]=c*u+v,t[4]=c*a+s,t[5]=c*f-p,t[6]=h*u-d,t[7]=h*a+p,t[8]=h*f+s},m43InverseOrthonormal:function(n,r){r===undefined&&(r=new e(12));var i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=n[5],l=n[6],c=n[7],h=n[8],p=n[9],d=n[10],v=n[11];return r[0]=i,r[1]=u,r[2]=l,r[3]=s,r[4]=a,r[5]=c,r[6]=o,r[7]=f,r[8]=h,r[9]=-(p*i+d*s+v*o),r[10]=-(p*u+d*a+v*f),r[11]=-(p*l+d*c+v*h),r},m43Orthonormalize:function(r,i){var s=t.v3Normalize,o=t.v3Length,u=t.v3Dot,a=t.v3Cross,f=Math.abs,l=t.m43Right(r),c=t.m43Up(r),h=t.m43At(r),p=t.m43Pos(r),d=o(l),v=o(c),m=o(h);s(l,l),s(c,c),s(h,h);var g,y,b;if(d>0)if(v>0)if(m>0){var w=f(u(c,h)),E=f(u(h,l)),S=f(u(l,c));w<E?w<S?(g=c,y=h,b=l):(g=l,y=c,b=h):E<S?(g=h,y=l,b=c):(g=l,y=c,b=h)}else g=l,y=c,b=h;else g=h,y=l,b=c;else g=c,y=h,b=l;return a(g,y,b),s(b,b),a(b,g,y),s(y,y),i===undefined&&(i=new e(12)),i[0]=l[0],i[1]=l[1],i[2]=l[2],i[3]=c[0],i[4]=c[1],i[5]=c[2],i[6]=h[0],i[7]=h[1],i[8]=h[2],i[9]=p[0],i[10]=p[1],i[11]=p[2],i},m43Determinant:function(t){return t[0]*(t[4]*t[8]-t[5]*t[7])+t[1]*(t[5]*t[6]-t[3]*t[8])+t[2]*(t[3]*t[7]-t[4]*t[6])},m43Inverse:function(n,r){r===undefined&&(r=new e(12));var i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=n[5],l=n[6],c=n[7],h=n[8],p=n[9],d=n[10],v=n[11],m=i*(a*h-f*c)+s*(f*l-u*h)+o*(u*c-a*l);if(m===0)return r;r===undefined&&(r=new e(12));var g=1/m;return r[0]=(a*h+f*-c)*g,r[1]=(c*o+h*-s)*g,r[2]=(s*f-o*a)*g,r[3]=(f*l+u*-h)*g,r[4]=(h*i+l*-o)*g,r[5]=(u*o-i*f)*g,r[6]=(u*c+a*-l)*g,r[7]=(l*s+c*-i)*g,r[8]=(i*a-u*s)*g,r[9]=(u*(d*h-c*v)+a*(l*v-p*h)+f*(p*c-l*d))*g,r[10]=(l*(o*d-s*v)+c*(i*v-p*o)+h*(p*s-i*d))*g,r[11]=(p*(o*a-s*f)+d*(i*f-u*o)+v*(u*s-i*a))*g,r},m43Translate:function(t,n){t[9]+=n[0],t[10]+=n[1],t[11]+=n[2]},m43Scale:function(n,r,i){i===undefined&&(i=new e(12));var s=r[0],o=r[1],u=r[2];return i[0]=n[0]*s,i[1]=n[1]*s,i[2]=n[2]*s,i[3]=n[3]*o,i[4]=n[4]*o,i[5]=n[5]*o,i[6]=n[6]*u,i[7]=n[7]*u,i[8]=n[8]*u,i[9]=n[9],i[10]=n[10],i[11]=n[11],i},m43TransformVector:function(n,r,i){i===undefined&&(i=new e(3));var s=r[0],o=r[1],u=r[2];return i[0]=n[0]*s+n[3]*o+n[6]*u,i[1]=n[1]*s+n[4]*o+n[7]*u,i[2]=n[2]*s+n[5]*o+n[8]*u,i},m43TransformPoint:function(n,r,i){i===undefined&&(i=new e(3));var s=r[0],o=r[1],u=r[2];return i[0]=n[0]*s+n[3]*o+n[6]*u+n[9],i[1]=n[1]*s+n[4]*o+n[7]*u+n[10],i[2]=n[2]*s+n[5]*o+n[8]*u+n[11],i},m43Mul:function(n,r,i){var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11],g=r[0],y=r[1],b=r[2],w=r[3],E=r[4],S=r[5],x=r[6],T=r[7],N=r[8],C=i;return C===
undefined&&(C=new e(12)),C[0]=g*s+w*o+x*u,C[1]=y*s+E*o+T*u,C[2]=b*s+S*o+N*u,C[3]=g*a+w*f+x*l,C[4]=y*a+E*f+T*l,C[5]=b*a+S*f+N*l,C[6]=g*c+w*h+x*p,C[7]=y*c+E*h+T*p,C[8]=b*c+S*h+N*p,C[9]=g*d+w*v+x*m+r[9],C[10]=y*d+E*v+T*m+r[10],C[11]=b*d+S*v+N*m+r[11],C},m43MulM44:function(n,r,i){var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11],g=r[0],y=r[1],b=r[2],w=r[3],E=r[4],S=r[5],x=r[6],T=r[7],N=r[8],C=r[9],k=r[10],L=r[11],A=i;return A===undefined&&(A=new e(16)),A[0]=g*s+E*o+N*u,A[1]=y*s+S*o+C*u,A[2]=b*s+x*o+k*u,A[3]=w*s+T*o+L*u,A[4]=g*a+E*f+N*l,A[5]=y*a+S*f+C*l,A[6]=b*a+x*f+k*l,A[7]=w*a+T*f+L*l,A[8]=g*c+E*h+N*p,A[9]=y*c+S*h+C*p,A[10]=b*c+x*h+k*p,A[11]=w*c+T*h+L*p,A[12]=g*d+E*v+N*m+r[12],A[13]=y*d+S*v+C*m+r[13],A[14]=b*d+x*v+k*m+r[14],A[15]=w*d+T*v+L*m+r[15],A},m43Transpose:function(n,r){var i=r;i===undefined&&(i=new e(12));var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11];return i[0]=s,i[1]=a,i[2]=c,i[3]=d,i[4]=o,i[5]=f,i[6]=h,i[7]=v,i[8]=u,i[9]=l,i[10]=p,i[11]=m,i},m43MulTranspose:function(n,r,i){var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11],g=r[0],y=r[1],b=r[2],w=r[3],E=r[4],S=r[5],x=r[6],T=r[7],N=r[8],C=r[9],k=r[10],L=r[11],A=i;return A===undefined&&(A=new e(12)),A[0]=g*s+w*o+x*u,A[1]=g*a+w*f+x*l,A[2]=g*c+w*h+x*p,A[3]=g*d+w*v+x*m+C,A[4]=y*s+E*o+T*u,A[5]=y*a+E*f+T*l,A[6]=y*c+E*h+T*p,A[7]=y*d+E*v+T*m+k,A[8]=b*s+S*o+N*u,A[9]=b*a+S*f+N*l,A[10]=b*c+S*h+N*p,A[11]=b*d+S*v+N*m+L,A},m43Offset:function(n,r,i){i===undefined&&(i=new e(12));var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11],g=r[0],y=r[1],b=r[2];return i[0]=s,i[1]=o,i[2]=u,i[3]=a,i[4]=f,i[5]=l,i[6]=c,i[7]=h,i[8]=p,i[9]=s*g+a*y+c*b+d,i[10]=o*g+f*y+h*b+v,i[11]=u*g+l*y+p*b+m,i},m43NegOffset:function(n,r,i){i===undefined&&(i=new e(12));var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11],g=-r[0],y=-r[1],b=-r[2];return i[0]=s,i[1]=o,i[2]=u,i[3]=a,i[4]=f,i[5]=l,i[6]=c,i[7]=h,i[8]=p,i[9]=s*g+a*y+c*b+d,i[10]=o*g+f*y+h*b+v,i[11]=u*g+l*y+p*b+m,i},m43InverseTransposeProjection:function(n,r,i){i===undefined&&(i=new e(12));var s=.5/r[0],o=.5/r[1],u=.5/r[2],a=n[0]*s,f=n[1]*s,l=n[2]*s,c=n[3]*o,h=n[4]*o,p=n[5]*o,d=n[6]*u,v=n[7]*u,m=n[8]*u,g=n[9],y=n[10],b=n[11];return i[0]=a,i[1]=f,i[2]=l,i[3]=.5-(g*a+y*f+b*l),i[4]=c,i[5]=h,i[6]=p,i[7]=.5-(g*c+y*h+b*p),i[8]=d,i[9]=v,i[10]=m,i[11]=.5-(g*d+y*v+b*m),i},m43ScalarAdd:function(n,r,i){i===undefined&&(i=new e(12));for(var s=0;s<12;s+=1)i[s]=n[s]+r;return i},m43ScalarSub:function(n,r,i){i===undefined&&(i=new e(12));for(var s=0;s<12;s+=1)i[s]=n[s]-r;return i},m43ScalarMul:function(n,r,i){i===undefined&&(i=new e(12));for(var s=0;s<12;s+=1)i[s]=n[s]*r;return i},m44BuildIdentity:function(n){var r=n;return r===undefined&&(r=new e(16)),r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r},m44Build:function(n,r,i,s,o){var u,a=arguments.length;return a>=16?(a>16?(u=arguments[16],u===undefined&&(u=new e(16))):u=new e(16),u[0]=arguments[0],u[1]=arguments[1],u[2]=arguments[2],u[3]=arguments[3],u[4]=arguments[4],u[5]=arguments[5],u[6]=arguments[6],u[7]=arguments[7],u[8]=arguments[8],u[9]=arguments[9],u[10]=arguments[10],u[11]=arguments[11],u[12]=arguments[12],u[13]=arguments[13],u[14]=arguments[14],u[15]=arguments[15]):(u=o,u===undefined&&(u=new e(16)),u[0]=n[0],u[1]=n[1],u[2]=n[2],u[3]=n[3],u[4]=r[0],u[5]=r[1],u[6]=r[2],u[7]=r[3],u[8]=i[0],u[9]=i[1],u[10]=i[2],u[11]=i[3],u[12]=s[0],u[13]=s[1],u[14]=s[2],u[15]=s[3]),u},m44Copy:function(n,r){return r===undefined&&(r=new e(16)),r[0]=n[0],r[1]=n[1],r[2]=n[2],r[3]=n[3],r[4]=n[4],r[5]=n[5],r[6]=n[6],r[7]=n[7],r[8]=n[8],r[9]=n[9],r[10]=n[10],r[11]=n[11],r[12]=n[12],r[13]=n[13],r[14]=n[14],r[15]=n[15],r},m44Right:function(t,n){return n===undefined?t.slice(0,4):(n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n)},m44Up:function(t,n){return n===undefined?t.slice(4,8):(n[0]=t[4],n[1]=t[5],n[2]=t[6],n[3]=t[7],n)},m44At:function(t,n){return n===undefined?t.slice(8,12):(n[0]=t[8],n[1]=t[9],n[2]=t[10],n[3]=t[11],n)},m44Pos:function(t,n){return n===undefined?t.slice(12):(n[0]=t[12],n[1]=t[13],n[2]=t[14],n[3]=t[15],n)},m44SetRight:function(t,n){t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3]},m44SetUp:function(t,n){t[4]=n[0],t[5]=n[1],t[6]=n[2],t[7]=n[3]},m44SetAt:function(t,n){t[8]=n[0],t[9]=n[1],t[10]=n[2],t[11]=n[3]},m44SetPos:function(t,n){t[12]=n[0],t[13]=n[1],t[14]=n[2],t[15]=n[3]},m44Translate:function(t,n){t[12]+=n[0],t[13]+=n[1],t[14]+=n[2],t[15]+=n[3]},m44Scale:function(n,r,i){return i===undefined&&(i=new e(16)),i[0]=n[0]*r[0],i[1]=n[1]*r[0],i[2]=n[2]*r[0],i[3]=n[3],i[4]=n[4]*r[1],i[5]=n[5]*r[1],i[6]=n[6]*r[1],i[7]=n[7],i[8]=n[8]*r[2],i[9]=n[9]*r[2],i[10]=n[10]*r[2],i[11]=n[11],i[12]=n[12],i[13]=n[13],i[14]=n[14],i[15]=n[15],i},m44Transform:function(n,r,i){var s=r[0],o=r[1],u=r[2],a=r[3];return i===undefined&&(i=new e(4)),a!==1?(i[0]=n[0]*s+n[4]*o+n[8]*u+n[12]*a,i[1]=n[1]*s+n[5]*o+n[9]*u+n[13]*a,i[2]=n[2]*s+n[6]*o+n[10]*u+n[14]*a,i[3]=n[3]*s+n[7]*o+n[11]*u+n[15]*a):(i[0]=n[0]*s+n[4]*o+n[8]*u+n[12],i[1]=n[1]*s+n[5]*o+n[9]*u+n[13],i[2]=n[2]*s+n[6]*o+n[10]*u+n[14],i[3]=n[3]*s+n[7]*o+n[11]*u+n[15]),i},m44Mul:function(n,r,i){var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11],g=n[12],y=n[13],b=n[14],w=n[15],E=r[0],S=r[1],x=r[2],T=r[3],N=r[4],C=r[5],k=r[6],L=r[7],A=r[8],O=r[9],M=r[10],_=r[11],D=r[12],P=r[13],H=r[14],B=r[15];return i===undefined&&(i=new e(16)),i[0]=E*s+N*o+A*u+D*a,i[1]=S*s+C*o+O*u+P*a,i[2]=x*s+k*o+M*u+H*a,i[3]=T*s+L*o+_*u+B*a,i[4]=E*f+N*l+A*c+D*h,i[5]=S*f+C*l+O*c+P*h,i[6]=x*f+k*l+M*c+H*h,i[7]=T*f+L*l+_*c+B*h,i[8]=E*p+N*d+A*v+D*m,i[9]=S*p+C*d+O*v+P*m,i[10]=x*p+k*d+M*v+H*m,i[11]=T*p+L*d+_*v+B*m,i[12]=E*g+N*y+A*b+D*w,i[13]=S*g+C*y+O*b+P*w,i[14]=x*g+k*y+M*b+H*w,i[15]=T*g+L*y+_*b+B*w,i},m44Inverse:function(n,r){var i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=n[5],l=n[6],c=n[7],h=n[8],p=n[9],d=n[10],v=n[11],m=n[12],g=n[13],y=n[14],b=n[15];r===undefined&&(r=new e(16));var w=i*f-s*a,E=i*l-o*a,S=i*c-u*a,x=s*l-o*f,T=s*c-u*f,N=o*c-u*l,C=h*g-p*m,k=h*y-d*m,L=h*b-v*m,A=p*y-d*g,O=p*b-v*g,M=d*b-v*y,_=w*M-E*O+S*A+x*L-T*k+N*C;if(_===0)r[0]=0,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=0,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=0,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=0;else{var D=1/_;r[0]=(+(f*M)-l*O+c*A)*D,r[4]=(-(a*M)+l*L-c*k)*D,r[8]=(+(a*O)-f*L+c*C)*D,r[12]=(-(a*A)+f*k-l*C)*D,r[1]=(-(s*M)+o*O-u*A)*D,r[5]=(+(i*M)-o*L+u*k)*D,r[9]=(-(i*O)+s*L-u*C)*D,r[13]=(+(i*A)-s*k+o*C)*D,r[2]=(+(g*N)-y*T+b*x)*D,r[6]=(-(m*N)+y*S-b*E)*D,r[10]=(+(m*T)-g*S+b*w)*D,r[14]=(-(m*x)+g*E-y*w)*D,r[3]=(-(p*N)+d*T-v*x)*D,r[7]=(+(h*N)-d*S+v*E)*D,r[11]=(-(h*T)+p*S-v*w)*D,r[15]=(+(h*x)-p*E+d*w)*D}return r},m44Transpose:function(n,r){return r===undefined&&(r=new e(16)),r[0]=n[0],r[1]=n[4],r[2]=n[8],r[3]=n[12],r[4]=n[1],r[5]=n[5],r[6]=n[9],r[7]=n[13],r[8]=n[2],r[9]=n[6],r[10]=n[10],r[11]=n[14],r[12]=n[3],r[13]=n[7],r[14]=n[11],r[15]=n[15],r},m44ScalarAdd:function(n,r,i){i===undefined&&(i=new e(16));for(var s=0;s<16;s+=1)i[s]=n[s]+r;return i},m44ScalarSub:function(n,r,i){i===undefined&&(i=new e(16));for(var s=0;s<16;s+=1)i[s]=n[s]-r;return i},m44ScalarMul:function(n,r,i){i===undefined&&(i=new e(16));for(var s=0;s<16;s+=1)i[s]=n[s]*r;return i},quatBuild:function(n,r,i,s,o){var u=o;return u===undefined&&(u=new e(4)),u[0]=n,u[1]=r,u[2]=i,u[3]=s,u},quatCopy:function(n,r){var i=r;return i===undefined&&(i=new e(4)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3],i},quatIsSimilar:function(n,r,i){i===undefined&&(i=this.precision);var s=n;n[3]*r[3]<0&&(s=t.v4Neg(n));var o=t.v4LengthSq(t.v4Sub(s,r)),u=i*i;return o<u},quatLength:function(n){return t.v4Length(n)},quatDot:function(n,r){return t.v4Dot(n,r)},quatMul:function(n,r,i){i===undefined&&(i=new e(4));var s=n[0],o=n[1],u=n[2],a=n[3],f=r[0],l=r[1],c=r[2],h=r[3],p=c*o-l*u,d=f*u-c*s,v=l*s-f*o;return i[0]=s*h+f*a+p,i[1]=o*h+l*a+d,i[2]=u*h+c*a+v,i[3]=h*a-(f*s+l*o+c*u),i},quatMulTranslate:function(t,n,r,i,s,o){var u=t[0],a=t[1],f=t[2],l=t[3],c=r[0],h=r[1],p=r[2],d=r[3],v=f*h-a*p,m=u*p-f*c,g=a*c-u*h;s[0]=c*l+u*d+v,s[1]=h*l+a*d+m,s[2]=p*l+f*d+g,s[3]=l*d-(u*c+a*h+f*p);var y=n[0],b=n[1],w=n[2],E=i[0],S=i[1],x=i[2],T=l*l-(u*u+a*a+f*f),N=E*T,C=S*T,k=x*T;T=u*E+a*S+f*x;var L=T+T;N+=u*L,C+=a*L,k+=f*L,v=f*S-a*x,m=u*x-f*E,g=a*E-u*S;var A=l+l;N+=v*A,C+=m*A,k+=g*A,o[0]=N+y,o[1]=C+b,o[2]=k+w},quatNormalize:function(n,r){var i=t.quatDot(n,n);if(i===0)return t.v4BuildZero(r);var s=1/Math.sqrt(i);return t.v4ScalarMul(n,s,r)},quatConjugate:function(n,r){return r===undefined&&(r=new e(4)),r[0]=-n[0],r[1]=-n[1],r[2]=-n[2],r[3]=n[3],r},quatLerp:function(n,r,i,s){s===undefined&&(s=new e(4));var o=n[0],u=n[1],a=n[2],f=n[3],l=r[0],c=r[1],h=r[2],p=r[3];return s[0]=(l-o)*i+o,s[1]=(c-u)*i+u,s[2]=(h-a)*i+a,s[3]=(p-f)*i+f,s},cosMinSlerpAngle:Math.cos(Math.PI/40),quatSlerp:function(r,i,s,o){var u=o;u===undefined&&(u=new e(4));var a=r[0],f=r[1],l=r[2],c=r[3],h=i[0],p=i[1],d=i[2],v=i[3],m=a*h+f*p+l*d+c*v,g=m;g<0&&(a=-a,f=-f,l=-l,c=-c,g=-g);if(g>t.cosMinSlerpAngle){if(g>1-1e-6)return u[0]=a,u[1]=f,u[2]=l,u[3]=c,u;var y=s;m<=0&&(y=-s);var b=(h-a)*y+a,w=(p-f)*y+f,E=(d-l)*y+l,S=(v-c)*y+c,x=Math.sqrt(b*b+w*w+E*E+S*S),T=1/x;return u[0]=b*T,u[1]=w*T,u[2]=E*T,u[3]=S*T,u}var N=Math.sin,C=Math.acos(g),k=1/N(C),L=N((1-s)*C)*k;return a*=L,f*=L,l*=L,c*=L,L=N(s*C)*k,h*=L,p*=L,d*=L,v*=L,u[0]=a+h,u[1]=f+p,u[2]=l+d,u[3]=c+v,u},quatFromM43:function(n,r){var i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=n[5],l=n[6],c=n[7],h=n[8],p,d,v,m,g,y=i+a+h+1;y>t.precision?(m=Math.sqrt(y)/2,p=(f-c)/(4*m),d=(l-o)/(4*m),v=(s-u)/(4*m)):i>a&&i>h?(g=Math.sqrt(1+i-a-h)*2,m=(f-c)/g,p=.25*g,d=(u+s)/g,v=(l+o)/g):a>h?(g=Math.sqrt(1+a-i-h)*2,m=(l-o)/g,p=(u+s)/g,d=.25*g,v=(c+f)/g):(g=Math.sqrt(1+h-i-a)*2,m=(s-u)/g,p=(l+o)/g,d=(c+f)/g,v=.25*g);var b=t.quatNormalize([p,d,v,m],r);return t.quatConjugate(b,r)},quatFromAxisRotation:function(r,i,s){var o=.5*i,u=Math.sin(o),a=Math.cos(o),f=s;return f===undefined&&(f=new e(4)),f[0]=r[0]*u,f[1]=r[1]*u,f[2]=r[2]*u,f[3]=a,t.quatNormalize(f,f)},quatToAxisRotation:function(r,i){i===undefined&&(i=new e(4));var s=r[3],o=Math.acos(s)*2,u=1-s*s;if(u<t.precision)i[0]=1,i[1]=0,i[2]=0,i[3]=o;else{var a=1/Math.sqrt(u);i[0]=r[0]*a,i[1]=r[1]*a,i[2]=r[2]*a,i[3]=o}return i},quatTransformVector:function(n,r,i){var s=n[0],o=n[1],u=n[2],a=n[3],f=r[0],l=r[1],c=r[2],h=a*a-(s*s+o*o+u*u),p=f*h,d=l*h,v=c*h;h=s*f+o*l+u*c;var m=h+h;p+=s*m,d+=o*m,v+=u*m;var g=u*l-o*c,y=s*c-u*f,b=o*f-s*l,w=a+a;return p+=g*w,d+=y*w,v+=b*w,i===undefined&&(i=new e(3)),i[0]=p,i[1]=d,i[2]=v,i},quatEqual:function(t,n,r){r===undefined&&(r=this.precision);var i=Math.abs;return i(t[0]-n[0])<=r&&i(t[1]-n[1])<=r&&i(t[2]-n[2])<=r&&i(t[3]-n[3])<=r},quatPosBuild:function(n,r,i,s,o,u,a,f){var l;return arguments.length<7?(l=i,l===undefined&&(l=new e(7)),l[0]=n[0],l[1]=n[1],l[2]=n[2],l[3]=n[3],l[4]=r[0],l[5]=r[1],l[6]=r[2]):(l=f,l===undefined&&(l=new e(7)),l[0]=n,l[1]=r,l[2]=i,l[3]=s,l[4]=o,l[5]=u,l[6]=a),l},quatPosTransformVector:function(n,r,i){return t.quatTransformVector(n,r,i)},quatPosTransformPoint:function(n,r){var i=n.slice(4,7),s=t.quatTransformVector(n,r);return t.v3Add(s,i)},quatPosMul:function(n,r){var i=r.slice(4,7),s=t.quatMul(n,r),o=t.quatPosTransformPoint(n,i);return s[4]=o[0],s[5]=o[1],s[6]=o[2],s},isVisibleBox:function(t,n,r){var i=Math.abs,s=t[0],o=t[1],u=t[2],a=n[0],f=n[1],l=n[2],c=r[0],h=r[1],p=r[2],d=r[3],v=r[4],m=r[5],g=r[6],y=r[7],b=r[8],w=r[9],E=r[10],S=r[11],x=c*a,T=h*a,N=p*a,C=d*a,k=v*f,L=m*f,A=g*f,O=y*f,M=b*l,_=w*l,D=E*l,P=S*l,H=c*s+v*o+b*u+r[12],B=h*s+m*o+w*u+r[13],j=p*s+g*o+E*u+r[14],F=d*s+y*o+S*u+r[15];return!(H-F>i(x-C)+i(k-O)+i(M-P)||H+F<-(i(x+C)+i(k+O)+i(M+P))||B-F>i(T-C)+i(L-O)+i(_-P)||B+F<-(i(T+C)+i(L+O)+i(_+P))||j-F>i(N-C)+i(A-O)+i(D-P)||j+F<-(i(N+C)+i(A+O)+i(D+P))||F+F<-(i(C+C)+i(O+O)+i(P+P)))},isVisibleBoxOrigin:function(t,n){var r=Math.abs,i=t[0],s=t[1],o=t[2],u=n[0]*i,a=n[1]*i,f=n[2]*i,l=n[3]*i,c=n[4]*s,h=n[5]*s,p=n[6]*s,d=n[7]*s,v=n[8]*o,m=n[9]*o,g=n[10]*o,y=n[11]*o,b=n[12],w=n[13],E=n[14],S=n[15];return!(b-S>r(u-l)+r(c-d)+r(v-y)||b+S<-(r(u+l)+r(c+d)+r(v+y))||w-S>r(a-l)+r(h-d)+r(m-y)||w+S<-(r(a+l)+r(h+d)+r(m+y))||E-S>r(f-l)+r(p-d)+r(g-y)||E+S<-(r(f+l)+r(p+d)+r(g+y))||S+S<-(r(l+l)+r(d+d)+r(y+y)))},isVisibleSphere:function(t,n,r){var i=Math.abs,s=t[0],o=t[1],u=t[2],a=r[0],f=r[1],l=r[2],c=r[3],h=r[4],p=r[5],d=r[6],v=r[7],m=r[8],g=r[9],y=r[10],b=r[11],w=a,E=f,S=l,x=c,T=h,N=p,C=d,k=v,L=m,A=g,O=y,M=b,_=a*s+h*o+m*u+r[12],D=f*s+p*o+g*u+r[13],P=l*s+d*o+y*u+r[14],H=c*s+v*o+b*u+r[15],B=-n;return!(_-H>n*(i(w-x)+i(T-k)+i(L-M))||_+H<B*(i(w+x)+i(T+k)+i(L+M))||D-H>n*(i(E-x)+i(N-k)+i(A-M))||D+H<B*(i(E+x)+i(N+k)+i(A+M))||P-H>n*(i(S-x)+i(C-k)+i(O-M))||P+H<B*(i(S+x)+i(C+k)+i(O+M))||H+H<B*(i(x+x)+i(k+k)+i(M+M)))},isVisibleSphereOrigin:function(t,n){var r=Math.abs,i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=n[5],l=n[6],c=n[7],h=n[8],p=n[9],d=n[10],v=n[11],m=n[12],g=n[13],y=n[14],b=n[15],w=-t;return!(m-b>t*(r(i-u)+r(a-c)+r(h-v))||m+b<w*(r(i+u)+r(a+c)+r(h+v))||g-b>t*(r(s-u)+r(f-c)+r(p-v))||g+b<w*(r(s+u)+r(f+c)+r(p+v))||y-b>t*(r(o-u)+r(l-c)+r(d-v))||y+b<w*(r(o+u)+r(l+c)+r(d+v))||b+b<w*(r(u+u)+r(c+c)+r(v+v)))},isVisibleSphereUnit:function(t){var n=Math.abs,r=t[0],i=t[1],s=t[2],o=t[3],u=t[4],a=t[5],f=t[6],l=t[7],c=t[8],h=t[9],p=t[10],d=t[11],v=t[12],m=t[13],g=t[14],y=t[15];return!(v-y>n(r-o)+n(u-l)+n(c-d)||v+y<-(n(r+o)+n(u+l)+n(c+d))||m-y>n(i-o)+n(a-l)+n(h-d)||m+y<-(n(i+o)+n(a+l)+n(h+d))||g-y>n(s-o)+n(f-l)+n(p-d)||g+y<-(n(s+o)+n(f+l)+n(p+d))||y+y<-(n(o+o)+n(l+l)+n(d+d)))},transformBox:function(n,r,i){var s=Math.abs,o=i[0],u=i[1],a=i[2],f=i[3],l=i[4],c=i[5],h=i[6],p=i[7],d=i[8],v=n[0],m=n[1],g=n[2],y=r[0],b=r[1],w=r[2],E=new e(3);E[0]=o*v+f*m+h*g+i[9],E[1]=u*v+l*m+p*g+i[10],E[2]=a*v+c*m+d*g+i[11];var S=new e(3);return S[0]=s(o)*y+s(f)*b+s(h)*w,S[1]=s(u)*y+s(l)*b+s(p)*w,S[2]=s(a)*y+s(c)*b+s(d)*w,{center:E,halfExtents:E}},planeNormalize:function(n,r){r===undefined&&(r=new e(4));var i=n[0],s=n[1],o=n[2],u=i*i+s*s+o*o;if(u>0){var a=1/Math.sqrt(u);r[0]=i*a,r[1]=s*a,r[2]=o*a,r[3]=n[3]*a}else r[0]=0,r[1]=0,r[2]=0,r[3]=0;return r},extractFrustumPlanes:function(n,r){var i=t.planeNormalize,s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11],g=n[12],y=n[13],b=n[14],w=n[15],E=r||[];return E[0]=i([a+s,h+f,m+p,-(w+g)],E[0]),E[1]=i([a-s,h-f,m-p,-(w-g)],E[1]),E[2]=i([a-o,h-l,m-d,-(w-y)],E[2]),E[3]=i([a+o,h+l,m+d,-(w+y)],E[3]),E[4]=i([a+u,h+c,m+v,-(w+b)],E[4]),E[5]=i([a-u,h-c,m-v,-(w-b)],E[5]),E},isInsidePlanesPoint:function(t,n){var r=t[0],i=t[1],s=t[2],o=n.length,u=0;do{var a=n[u];if(a[0]*r+a[1]*i+a[2]*s<a[3])return!1;u+=1}while(u<o);return!0},isInsidePlanesSphere:function(t,n,r){var i=t[0],s=t[1],o=t[2],u=r.length,a=0;do{var f=r[a];if(f[0]*i+f[1]*s+f[2]*o<f[3]-n)return!1;a+=1}while(a<u);return!0},isInsidePlanesBox:function(t,n,r){var i=t[0],s=t[1],o=t[2],u=n[0],a=n[1],f=n[2],l=i+u,c=s+a,h=o+f,p=i-u,d=s-a,v=o-f,m=r.length,g=0;do{var y=r[g],b=y[0],w=y[1],E=y[2];if(b*(b<0?p:l)+w*(w<0?d:c)+E*(E<0?v:h)<y[3])return!1;g+=1}while(g<m);return!0},extractIntersectingPlanes:function(t,n){var r=t[0],i=t[1],s=t[2],o=t[3],u=t[4],a=t[5],f=n.length,l=[],c=0,h=0;do{var p=n[h],d=p[0],v=p[1],m=p[2];d*(d>0?r:o)+v*(v>0?i:u)+m*(m>0?s:a)<p[3]&&(l[c]=p,c+=1),h+=1}while(h<f);return l}};if(typeof Float32Array!="undefined"){var n=new Float32Array([1,2,3]);n[0]=t.FLOAT_MAX,t.FLOAT_MAX=n[0],e=Float32Array}TurbulenzEngine.hasOwnProperty("VMath")&&(TurbulenzEngine.VMath=t);var r={skipAsserts:!1,assert:function(t,n){t||this.skipAsserts||this.breakInDebugger.doesNotExist()},beget:function(t){var n=function(){};return n.prototype=t,new n},log:function(t,n){var r=window.console;if(r)switch(arguments.length){case 1:r.log(arguments[0]);break;case 2:r.log(arguments[0],arguments[1]);break;case 3:r.log(arguments[0],arguments[1],arguments[2]);break;case 4:r.log(arguments[0],arguments[1],arguments[2],arguments[3]);break;default:var i=[].splice.call(arguments,0);r.log(i.join(" "))}},nearestLowerPow2:function(t){return t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,t|=t>>>16,t-(t>>>1)},nearestUpperPow2:function(t){return t-=1,t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,t|=t>>>16,t+1},ajax:function(t){var n="",r=t.method,i=t.data||{},s=t.encrypt,o=null,u=t.url,a=t.requestHandler,f=t.callback;if(s){i.requestUrl=u;var l=JSON.stringify(i);r==="POST"&&(l=TurbulenzEngine.encrypt(l)),n+="data="+encodeURIComponent(l)+"&",n+="gameSessionId="+encodeURIComponent(i.gameSessionId),o=TurbulenzEngine.generateSignature(l)}else if(i){var c;for(c in i)i.hasOwnProperty(c)&&(n.length!==0&&(n+="&"),r==="POST"?n+=c+"="+i[c]:n+=encodeURIComponent(c)+"="+encodeURIComponent(i[c]))}var h=function(t,n){var r=this.xhr;this.xhr.onreadystatechange=null,this.xhr=null;var i;i=JSON.parse(t);if(s){var o=r.getResponseHeader("X-TZ-Signature"),a=TurbulenzEngine.verifySignature(t,o);t=null,TurbulenzEngine.setTimeout(function(){var e=i.requestUrl;if(a)if(!TurbulenzEngine.encryptionEnabled||e===u){f(i,n),f=null;return}n===400?f(i,n,"Verification Failed"):f({msg:"Verification failed",ok:!1},400,"Verification Failed"),f=null},0)}else t=null,TurbulenzEngine.setTimeout(function(){f(i,n),f=null},0)},p=function(i,s,u){var a;if(window.XMLHttpRequest)a=new window.XMLHttpRequest;else{if(!window.ActiveXObject){t.error&&t.error("No XMLHTTPRequest object could be created");return}a=new window.ActiveXObject("Microsoft.XMLHTTP")}u.xhr=a;var l=function(){if(a.readyState===4&&TurbulenzEngine&&!TurbulenzEngine.isUnloading()){var t=a.responseText,n=a.status,r=n!==0&&a.statusText||"No connection or cross domain request";if(a.getAllResponseHeaders()===""&&t===""&&n===200&&r==="OK"){s("",0);return}s.call(u,t,n)}};a.open(r,n&&r!=="POST"?i+"?"+n:i,!0),f&&(a.onreadystatechange=l),o&&a.setRequestHeader("X-TZ-Signature",o),r==="POST"?(a.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8"),a.send(n)):a.send()};if(a)a.request({src:u,requestFn:p,responseFilter:t.responseFilter,onload:h});else{var d={src:u};p(u,h,d)}},ajaxStatusCodes:{0:"No Connection, Timeout Or Cross Domain Request",100:"Continue",101:"Switching Protocols",200:"OK",201:"Created",202:"Accepted",203:"Non-Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",300:"Multiple Choices",301:"Moved Permanently",302:"Found",303:"See Other",304:"Not Modified",305:"Use Proxy",307:"Temporary Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Time-out",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Request Entity Too Large",414:"Request-URI Too Large",415:"Unsupported Media Type",416:"Requested range not satisfiable",417:"Expectation Failed",429:"Too Many Requests",480:"Temporarily Unavailable",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Time-out",505:"HTTP Version not supported"}},i={v2ToArray:function(t){return[t[0],t[1]]},arrayToV2:function(t,n,r){return t.v2Build(n[0],n[1],r)},v3ToArray:function(t){return[t[0],t[1],t[2]]},arrayToV3:function(t,n,r){return t.v3Build(n[0],n[1],n[2],r)},v4ToArray:function(t){return[t[0],t[1],t[2],t[3]]},arrayToV4:function(t,n,r){return t.v4Build(n[0],n[1],n[2],n[3],r)},quatToArray:function(t){return[t[0],t[1],t[2],t[3]]},arrayToQuat:function(t,n,r){return t.quatBuild(n[0],n[1],n[2],n[3],r)},aabbToArray:function(t){return[t[0],t[1],t[2],t[3],t[4],t[5]]},arrayToAABB:function(t,n,r){return t.aabbBuild(n[0],n[1],n[2],n[3],n[4],n[5],r)},quatPosToArray:function(t){return[t[0],t[1],t[2],t[3],t[4],t[5],t[6]]},arrayToQuatPos:function(t,n,r){return t.quatPosBuild(n[0],n[1],n[2],n[3],n[4],n[5],n[6],r)},m33ToArray:function(t){return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8]]},arrayToM33:function(t,n,r){return t.m33Build(n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7],n[8],r)},m43ToArray:function(t){return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11]]},arrayToM43:function(t,n,r){return t.m43Build(n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7],n[8],n[9],n[10],n[11],r)},m34ToArray:function(t){return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11]]},m44ToArray:function(t){return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15]]},arrayToM44:function(t,n,r){return t.m44Build(n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7],n[8],n[9],n[10],n[11],n[12],n[13],n[14],n[15],r)}},s=function(){function e(){}return e.version=1,e.prototype.add=function(){this.referenceCount+=1},e.prototype.remove=function(){this.referenceCount-=1,this.referenceCount===0&&(this.destroyedObserver&&this.destroyedObserver.notify(this.object),this.object.destroy(),this.object=null)},e.prototype.subscribeDestroyed=function(e){this.destroyedObserver||(this.destroyedObserver=l.create()),this.destroyedObserver.subscribe(e)},e.prototype.unsubscribeDestroyed=function(e){this.destroyedObserver.unsubscribe(e)},e.create=function(n){var r=new e;return r.object=n,r.referenceCount=0,r},e}(),o={profiles:{},sortMode:{alphabetical:0,duration:1,max:2,min:3,calls:4},start:function(t){var n=this.profiles[t];n||(n={name:t,calls:0,duration:0,min:Number.MAX_VALUE,max:0,sumOfSquares:0},this.profiles[t]=n),n.start=TurbulenzEngine.time},stop:function(t){var n=TurbulenzEngine.time,r=this.profiles[t];if(r){var i=n-r.start;r.duration+=i,r.calls+=1,r.sumOfSquares+=i*i,i>r.max&&(r.max=i),i<r.min&&(r.min=i)}},reset:function(){this.profiles={}},getReport:function(t,n){var r=[],i,s=0,u;for(u in this.profiles)this.profiles.hasOwnProperty(u)&&(i=this.profiles[u],s<i.duration&&(s=i.duration),r.push(i));var a;t===o.sortMode.alphabetical?a=function(t,n){return t.name<n.name?-1:t.name>n.name?1:0}:t===o.sortMode.max?a=function(t,n){return n.max-t.max}:t===o.sortMode.min?a=function(t,n){return n.min-t.min}:t===o.sortMode.calls?a=function(t,n){return n.calls-t.calls}:a=function(t,n){return n.duration-t.duration},r.sort(a);var f,l="",c=n?n.precision:8,h=n?n.percentagePrecision:1,p=n?n.seperator:" ",d=r.length,v,m,g;for(g=0;g<d;g+=1)i=r[g],f=i.name,f+=p+i.calls,f+=p+i.duration.toFixed(c),f+=p+i.max.toFixed(c),f+=p+i.min.toFixed(c),m=i.duration/i.calls,f+=p+m.toFixed(c),v=Math.sqrt(i.sumOfSquares/i.calls-m*m),f+=p+v.toFixed(c),f+=p+(100*i.duration/s).toFixed(h)+"%\n",l+=f;return l}},u={};u.createArray=function(t){var n={},r=[];t.head&&(t=t.head);var i=function(t){var s=n[t.url];s||(s={},n[t.url]=s);var o=t.functionName===""?"(anonymous)":t.functionName,u=s[o];u||(u={},s[o]=u);var a=u[t.lineNumber];if(!a){var f={functionName:o,numberOfCalls:t.numberOfCalls,totalTime:t.totalTime,selfTime:t.selfTime,url:t.url,lineNumber:t.lineNumber};r[r.length]=f,u[t.lineNumber]=f}else a.totalTime+=t.totalTime,a.selfTime+=t.selfTime,a.numberOfCalls+=t.numberOfCalls;var l=typeof t.children=="function"?t.children():t.children;if(l){var c=l.length,h;for(h=0;h<c;h+=1)i(l[h])}};return i(t),r},u.sort=function(t,n,r){n||(n="totalTime");var i=function(e,t){return e[n]-t[n]},s=function(e,t){return t[n]-e[n]};r===!1?t.sort(i):t.sort(s)};var a=function(){function e(e,t,n){return this.escapeNodeOffset=t,this.externalNode=n,this.extents=e,this}return e.version=1,e.prototype.isLeaf=function(){return!!this.externalNode},e.prototype.reset=function(e,t,n,r,i,s,o,u){this.escapeNodeOffset=o,this.externalNode=u;var a=this.extents;a[0]=e,a[1]=t,a[2]=n,a[3]=r,a[4]=i,a[5]=s},e.prototype.clear=function(){this.escapeNodeOffset=1,this.externalNode=undefined;var e=this.extents,t=Number.MAX_VALUE;e[0]=t,e[1]=t,e[2]=t,e[3]=-t,e[4]=-t,e[5]=-t},e.create=function(n,r,i){return new e(n,r,i)},e}(),f=function(){function e(e){this.numNodesLeaf=4,this.nodes=[],this.endNode=0,this.needsRebuild=!1,this.needsRebound=!1,this.numAdds=0,this.numUpdates=0,this.numExternalNodes=0,this.startUpdate=2147483647,this.endUpdate=-2147483647,this.highQuality=e,this.ignoreY=!1,this.nodesStack=new Array(32)}return e.version=1,e}();f.prototype.add=function(t,n){var r=this.endNode;t.aabbTreeIndex=r;var i=new this.arrayConstructor(6);i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3],i[4]=n[4],i[5]=n[5],this.nodes[r]=a.create(i,1,t),this.endNode=r+1,this.needsRebuild=!0,this.numAdds+=1,this.numExternalNodes+=1},f.prototype.remove=function(t){var n=t.aabbTreeIndex;if(n!==undefined){if(this.numExternalNodes>1){var r=this.nodes;r[n].clear();var i=this.endNode;if(n+1>=i){while(!r[i-1].externalNode)i-=1;this.endNode=i}else this.needsRebuild=!0;this.numExternalNodes-=1}else this.clear();delete t.aabbTreeIndex}},f.prototype.findParent=function(t){var n=this.nodes,r=t,i=0,s;do r-=1,i+=1,s=n[r];while(s.escapeNodeOffset<=i);return s},f.prototype.update=function(t,n){var r=t.aabbTreeIndex;if(r!==undefined){var i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=n[5],l=this.needsRebuild,c=this.needsRebound,h=this.nodes,p=h[r],d=p.extents,v=l||c||d[0]>i||d[1]>s||d[2]>o||d[3]<u||d[4]<a||d[5]<f;d[0]=i,d[1]=s,d[2]=o,d[3]=u,d[4]=a,d[5]=f;if(v&&!l&&1<h.length){this.numUpdates+=1,this.startUpdate>r&&(this.startUpdate=r),this.endUpdate<r&&(this.endUpdate=r);if(!c)if(2*this.numUpdates>this.numExternalNodes)this.needsRebound=!0;else{var m=this.findParent(r),g=m.extents;if(g[0]>i||g[1]>s||g[2]>o||g[3]<u||g[4]<a||g[5]<f)this.needsRebound=!0}else this.numUpdates>3*this.numExternalNodes&&(this.needsRebuild=!0,this.numAdds=this.numUpdates)}}else this.add(t,n)},f.prototype.needsFinalize=function(){return this.needsRebuild||this.needsRebound},f.prototype.finalize=function(){this.needsRebuild?this.rebuild():this.needsRebound&&this.rebound()},f.prototype.rebound=function(){var t=this.nodes;if(t.length>1){var n=this.startUpdate,r=this.endUpdate,i=this.nodesStack,s=0,o=0;for(;;){var u=t[o],a=o,f=o+u.escapeNodeOffset,l=o+1,c;do{c=t[l];var h=l+c.escapeNodeOffset;if(!(l<r))break;c.externalNode||h>n&&(i[s]=o,s+=1,o=l),l=h}while(l<f);if(o===a){l=o+1,c=t[l];var p=c.extents,d=p[0],v=p[1],m=p[2],g=p[3],y=p[4],b=p[5];l+=c.escapeNodeOffset;while(l<f)c=t[l],p=c.extents,d>p[0]&&(d=p[0]),v>p[1]&&(v=p[1]),m>p[2]&&(m=p[2]),g<p[3]&&(g=p[3]),y<p[4]&&(y=p[4]),b<p[5]&&(b=p[5]),l+=c.escapeNodeOffset;p=u.extents,p[0]=d,p[1]=v,p[2]=m,p[3]=g,p[4]=y,p[5]=b,r=o;if(!(0<s))break;s-=1,o=i[s]}}}this.needsRebuild=!1,this.needsRebound=!1,this.numAdds=0,this.startUpdate=2147483647,this.endUpdate=-2147483647},f.prototype.rebuild=function(){if(this.numExternalNodes>0){var t=this.nodes,n,r,i;if(this.numExternalNodes===t.length)n=t,r=t.length,t=[],this.nodes=t;else{n=[],n.length=this.numExternalNodes,r=0,i=this.endNode;for(var s=0;s<i;s+=1){var o=t[s];o.externalNode&&(t[s]=undefined,n[r]=o,r+=1)}n.length>r&&(n.length=r)}var u;if(r>1){r>this.numNodesLeaf&&this.numAdds>0&&(this.highQuality?this.sortNodesHighQuality(n):this.ignoreY?this.sortNodesNoY(n):this.sortNodes(n)),t.length=this.predictNumNodes(0,r,0),this.recursiveBuild(n,0,r,0),i=t[0].escapeNodeOffset,t.length>i&&(t.length=i),this.endNode=i,u=t[0];var a=u.extents,f=a[3]-a[0],l=a[4]-a[1],c=a[5]-a[2];this.ignoreY=4*l<(f<=c?f:c)}else u=n[0],u.externalNode.aabbTreeIndex=0,t.length=1,t[0]=u,this.endNode=1;n=null}this.needsRebuild=!1,this.needsRebound=!1,this.numAdds=0,this.numUpdates=0,this.startUpdate=2147483647,this.endUpdate=-2147483647},f.prototype.sortNodes=function(t){function i(e){var t=e.extents;return t[0]+t[3]}function s(e){var t=e.extents;return t[1]+t[4]}function o(e){var t=e.extents;return t[2]+t[5]}function u(e){var t=e.extents;return-(t[0]+t[3])}function a(e){var t=e.extents;return-(t[1]+t[4])}function f(e){var t=e.extents;return-(t[2]+t[5])}function p(e,t,r){var d=t+r>>1;h===0?c?l(e,t,d,r,u):l(e,t,d,r,i):h===2?c?l(e,t,d,r,f):l(e,t,d,r,o):c?l(e,t,d,r,a):l(e,t,d,r,s),h===0?h=2:h===2?h=1:h=0,c=!c,t+n<d&&p(e,t,d),d+n<r&&p(e,d,r)}var n=this.numNodesLeaf,r=t.length,l=this.nthElement,c=!1,h=0;p(t,0,r)},f.prototype.sortNodesNoY=function(t){function i(e){var t=e.extents;return t[0]+t[3]}function s(e){var t=e.extents;return t[2]+t[5]}function o(e){var t=e.extents;return-(t[0]+t[3])}function u(e){var t=e.extents;return-(t[2]+t[5])}function c(e,t,r){var h=t+r>>1;l===0?f?a(e,t,h,r,o):a(e,t,h,r,i):f?a(e,t,h,r,u):a(e,t,h,r,s),l===0?l=2:l=0,f=!f,t+n<h&&c(e,t,h),h+n<r&&c(e,h,r)}var n=this.numNodesLeaf,r=t.length,a=this.nthElement,f=!1,l=0;c(t,0,r)},f.prototype.sortNodesHighQuality=function(t){function i(e){var t=e.extents;return t[0]+t[3]}function s(e){var t=e.extents;return t[1]+t[4]}function o(e){var t=e.extents;return t[2]+t[5]}function u(e){var t=e.extents;return t[0]+t[2]+t[3]+t[5]}function a(e){var t=e.extents;return t[0]-t[2]+t[3]-t[5]}function f(e){var t=e.extents;return-(t[0]+t[3])}function l(e){var t=e.extents;return-(t[1]+t[4])}function c(e){var t=e.extents;return-(t[2]+t[5])}function h(e){var t=e.extents;return-(t[0]+t[2]+t[3]+t[5])}function p(e){var t=e.extents;return-(t[0]-t[2]+t[3]-t[5])}function g(e,t,r){var y=t+r>>1;d(e,t,y,r,i);var b=v(e,t,y)+v(e,y,r);d(e,t,y,r,s);var w=v(e,t,y)+v(e,y,r);d(e,t,y,r,o);var E=v(e,t,y)+v(e,y,r);d(e,t,y,r,u);var S=v(e,t,y)+v(e,y,r);d(e,t,y,r,a);var x=v(e,t,y)+v(e,y,r);b<=w&&b<=E&&b<=S&&b<=x?m?d(e,t,y,r,f):d(e,t,y,r,i):E<=w&&E<=S&&E<=x?m?d(e,t,y,r,c):d(e,t,y,r,o):w<=S&&w<=x?m?d(e,t,y,r,l):d(e,t,y,r,s):S<=x?m?d(e,t,y,r,h):d(e,t,y,r,u):m?d(e,t,y,r,p):d(e,t,y,r,a),m=!m,t+n<y&&g(e,t,y),y+n<r&&g(e,y,r)}var n=this.numNodesLeaf,r=t.length,d=this.nthElement,v=this.calculateSAH,m=!1;g(t,0,r)},f.prototype.calculateSAH=function(t,n,r){var i,s,o,u,a,f,l,c;i=t[n],s=i.extents,o=s[0],u=s[1],a=s[2],f=s[3],l=s[4],c=s[5];for(var h=n+1;h<r;h+=1)i=t[h],s=i.extents,o>s[0]&&(o=s[0]),u>s[1]&&(u=s[1]),a>s[2]&&(a=s[2]),f<s[3]&&(f=s[3]),l<s[4]&&(l=s[4]),c<s[5]&&(c=s[5]);return f-o+(l-u)+(c-a)},f.prototype.nthElement=function(t,n,r,i,s){function o(e,t,n){return e<t?t<n?t:e<n?n:e:e<n?e:t<n?n:t}function u(e,t,n,r){var i=t+1;while(i!==n){var s=e[i],o=r(s),u=i,a=i-1;while(u!==t&&o<r(e[a]))e[u]=e[a],u-=1,a-=1;u!==i&&(e[u]=s),i+=1}}while(i-n>8){var a=o(s(t[n]),s(t[n+(i-n>>1)]),s(t[i-1])),f=n,l=i,c;for(;;f+=1){while(s(t[f])<a)f+=1;do l-=1;while(a<s(t[l]));if(f>=l){c=f;break}var h=t[f];t[f]=t[l],t[l]=h}c<=r?n=c:i=c}u(t,n,i,s)},f.prototype.recursiveBuild=function(t,n,r,i){var s=this.nodes,o=i;i+=1;var u,f,l,c,h,p,d,v,m;if(n+this.numNodesLeaf>=r){v=t[n],d=v.extents,u=d[0],f=d[1],l=d[2],c=d[3],h=d[4],p=d[5],v.externalNode.aabbTreeIndex=i,this.replaceNode(s,i,v);for(var g=n+1;g<r;g+=1)v=t[g],d=v.extents,u>d[0]&&(u=d[0]),f>d[1]&&(f=d[1]),l>d[2]&&(l=d[2]),c<d[3]&&(c=d[3]),h<d[4]&&(h=d[4]),p<d[5]&&(p=d[5]),i+=1,v.externalNode.aabbTreeIndex=i,this.replaceNode(s,i,v);m=s[i]}else{var y=n+r>>1;n+1>=y?(v=t[n],v.externalNode.aabbTreeIndex=i,this.replaceNode(s,i,v)):this.recursiveBuild(t,n,y,i),m=s[i],d=m.extents,u=d[0],f=d[1],l=d[2],c=d[3],h=d[4],p=d[5],i+=m.escapeNodeOffset,y+1>=r?(v=t[y],v.externalNode.aabbTreeIndex=i,this.replaceNode(s,i,v)):this.recursiveBuild(t,y,r,i),m=s[i],d=m.extents,u>d[0]&&(u=d[0]),f>d[1]&&(f=d[1]),l>d[2]&&(l=d[2]),c<d[3]&&(c=d[3]),h<d[4]&&(h=d[4]),p<d[5]&&(p=d[5])}var b=s[o];if(b!==undefined)b.reset(u,f,l,c,h,p,i+m.escapeNodeOffset-o);else{var w=new this.arrayConstructor(6);w[0]=u,w[1]=f,w[2]=l,w[3]=c,w[4]=h,w[5]=p,s[o]=a.create(w,i+m.escapeNodeOffset-o)}},f.prototype.replaceNode=function(e,t,n){var r=e[t];e[t]=n;if(r!==undefined){do t+=1;while(e[t]!==undefined);e[t]=r}},f.prototype.predictNumNodes=function(e,t,n){n+=1;if(e+this.numNodesLeaf>=t)n+=t-e;else{var r=e+t>>1;e+1>=r?n+=1:n=this.predictNumNodes(e,r,n),r+1>=t?n+=1:n=this.predictNumNodes(r,t,n)}return n},f.prototype.getVisibleNodes=function(t,n,r){var i=0;if(this.numExternalNodes>0){var s=this.nodes,o=this.endNode,u=t.length,a=r===undefined?n.length:r,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T=0;for(;;){f=s[T],l=f.extents,h=l[0],p=l[1],d=l[2],v=l[3],m=l[4],g=l[5],y=!0,b=0;do{w=t[b],E=w[0],S=w[1],x=w[2];if(E*(E<0?h:v)+S*(S<0?p:m)+x*(x<0?d:g)<w[3]){y=!1;break}b+=1}while(b<u);if(y)if(f.externalNode){n[a]=f.externalNode,a+=1,i+=1,T+=1;if(T>=o)break}else{y=!0,b=0;do{w=t[b],E=w[0],S=w[1],x=w[2];if(E*(E>0?h:v)+S*(S>0?p:m)+x*(x>0?d:g)<w[3]){y=!1;break}b+=1}while(b<u);if(y){c=T+f.escapeNodeOffset,T+=1;do f=s[T],f.externalNode&&(n[a]=f.externalNode,a+=1,i+=1),T+=1;while(T<c);if(T>=o)break}else T+=1}else{T+=f.escapeNodeOffset;if(T>=o)break}}}return i},f.prototype.getOverlappingNodes=function(t,n,r){if(this.numExternalNodes>0){var i=t[0],s=t[1],o=t[2],u=t[3],a=t[4],f=t[5],l=this.nodes,c=this.endNode,h,p,d,v=0,m=r===undefined?n.length:r,g=0;for(;;){h=l[g],p=h.extents;var y=p[0],b=p[1],w=p[2],E=p[3],S=p[4],x=p[5];if(i<=E&&s<=S&&o<=x&&u>=y&&a>=b&&f>=w)if(h.externalNode){n[m]=h.externalNode,m+=1,v+=1,g+=1;if(g>=c)break}else if(u>=E&&a>=S&&f>=x&&i<=y&&s<=b&&o<=w){d=g+h.escapeNodeOffset,g+=1;do h=l[g],h.externalNode&&(n[m]=h.externalNode,m+=1,v+=1),g+=1;while(g<d);if(g>=c)break}else g+=1;else{g+=h.escapeNodeOffset;if(g>=c)break}}return v}return 0},f.prototype.getSphereOverlappingNodes=function(t,n,r){if(this.numExternalNodes>0
){var i=n*n,s=t[0],o=t[1],u=t[2],a=this.nodes,f=this.endNode,l,c,h=r.length,p=0;for(;;){l=a[p],c=l.extents;var d=c[0],v=c[1],m=c[2],g=c[3],y=c[4],b=c[5],w=0,E;s<d?(E=d-s,w+=E*E):s>g&&(E=s-g,w+=E*E),o<v?(E=v-o,w+=E*E):o>y&&(E=o-y,w+=E*E),u<m?(E=m-u,w+=E*E):u>b&&(E=u-b,w+=E*E);if(w<=i){p+=1;if(l.externalNode){r[h]=l.externalNode,h+=1;if(p>=f)break}}else{p+=l.escapeNodeOffset;if(p>=f)break}}}},f.prototype.getOverlappingPairs=function(t,n){if(this.numExternalNodes>0){var r=this.nodes,i=this.endNode,s,o,u,a,f=0,l=n===undefined?t.length:n,c=0,h;for(;;){s=r[c];while(!s.externalNode)c+=1,s=r[c];c+=1;if(!(c<i))break;o=s.externalNode,a=s.extents;var p=a[0],d=a[1],v=a[2],m=a[3],g=a[4],y=a[5];h=c;for(;;){u=r[h],a=u.extents;if(p<=a[3]&&d<=a[4]&&v<=a[5]&&m>=a[0]&&g>=a[1]&&y>=a[2]){h+=1;if(u.externalNode){t[l]=o,t[l+1]=u.externalNode,l+=2,f+=2;if(h>=i)break}}else{h+=u.escapeNodeOffset;if(h>=i)break}}}return f}return 0},f.prototype.getRootNode=function(){return this.nodes[0]},f.prototype.getNodes=function(){return this.nodes},f.prototype.getEndNodeIndex=function(){return this.endNode},f.prototype.clear=function(){this.nodes=[],this.endNode=0,this.needsRebuild=!1,this.needsRebound=!1,this.numAdds=0,this.numUpdates=0,this.numExternalNodes=0,this.startUpdate=2147483647,this.endUpdate=-2147483647},f.rayTest=function(t,n,r){function v(e,t){var n=e[0],r=e[1],i=e[2],s=e[3],v=e[4],m=e[5];if(n<=o&&o<=s&&r<=u&&u<=v&&i<=a&&a<=m)return 0;var g,y,b,w,E;f>=0?(E=n-o,g=E===0?0:E*h,E=s-o,y=E===0?0:E*h):(g=(s-o)*h,y=(n-o)*h),l>=0?(E=r-u,b=E===0?0:E*p,E=v-u,w=E===0?0:E*p):(b=(v-u)*p,w=(r-u)*p);if(g>w||b>y)return undefined;b>g&&(g=b),w<y&&(y=w);var S,x;return c>=0?(E=i-a,S=E===0?0:E*d,E=m-a,x=E===0?0:E*d):(S=(m-a)*d,x=(i-a)*d),g>x||S>y?undefined:(S>g&&(g=S),x<y&&(y=x),g<0&&(g=y),0<=g&&g<t?g:undefined)}function y(e,t,i){var s=e.getNodes(),o=s[t],u=v(o.extents,i);if(u===undefined)return i;if(o.externalNode){var a=r(e,o.externalNode,n,u,i);a&&(g=a,i=a.factor)}else{var f=m.length,l;for(l=0;l<f;l+=1){var c=m[l];if(u>c.distance)break}m.splice(l-1,0,{tree:e,nodeIndex:t,distance:u})}return i}var i=n.origin,s=n.direction,o=i[0],u=i[1],a=i[2],f=s[0],l=s[1],c=s[2],h=1/f,p=1/l,d=1/c,m=[],g=null,b=n.maxFactor,w,E;for(E=0;E<t.length;E+=1)w=t[E],w.endNode!==0&&(b=y(w,0,b));while(m.length!==0){var S=m.pop();if(S.distance>=b)continue;var x=S.nodeIndex;w=S.tree;var T=w.getNodes(),N=T[x],C=x+N.escapeNodeOffset,k=x+1;do b=y(w,k,b),k+=T[k].escapeNodeOffset;while(k<C)}return g},f.create=function(t){return new f(t?!0:!1)},function(){f.prototype.arrayConstructor=Array;if(typeof Float32Array!="undefined"){var e=new Float32Array(4),t=Object.prototype.toString.call(e);t==="[object Float32Array]"&&(f.prototype.arrayConstructor=Float32Array)}}();var l=function(){function e(){}return e.prototype.subscribe=function(e){var t=this.subscribers,n=t.length;for(var r=0;r<n;r+=1)if(t[r]===e)return;t.push(e)},e.prototype.unsubscribe=function(e){var t=this.subscribers,n=t.length;for(var r=0;r<n;r+=1)if(t[r]===e){t.splice(r,1);break}},e.prototype.unsubscribeAll=function(){this.subscribers.length=0},e.prototype.notify=function(e,t,n,r,i,s,o,u,a,f,l,c){var h=this.subscribers,p=this.subscribers.length,d=0;while(d<p)h[d].apply(null,arguments),h.length===p?d+=1:p=h.length},e.create=function(){var n=new e;return n.subscribers=[],n},e}();c.prototype={version:1,DDSF_CAPS:1,DDSF_HEIGHT:2,DDSF_WIDTH:4,DDSF_PITCH:8,DDSF_PIXELFORMAT:4096,DDSF_MIPMAPCOUNT:131072,DDSF_LINEARSIZE:524288,DDSF_DEPTH:8388608,DDSF_ALPHAPIXELS:1,DDSF_FOURCC:4,DDSF_RGB:64,DDSF_RGBA:65,DDSF_COMPLEX:8,DDSF_TEXTURE:4096,DDSF_MIPMAP:4194304,DDSF_CUBEMAP:512,DDSF_CUBEMAP_POSITIVEX:1024,DDSF_CUBEMAP_NEGATIVEX:2048,DDSF_CUBEMAP_POSITIVEY:4096,DDSF_CUBEMAP_NEGATIVEY:8192,DDSF_CUBEMAP_POSITIVEZ:16384,DDSF_CUBEMAP_NEGATIVEZ:32768,DDSF_CUBEMAP_ALL_FACES:64512,DDSF_VOLUME:2097152,FOURCC_UNKNOWN:0,FOURCC_R8G8B8:20,FOURCC_A8R8G8B8:21,FOURCC_X8R8G8B8:22,FOURCC_R5G6B5:23,FOURCC_X1R5G5B5:24,FOURCC_A1R5G5B5:25,FOURCC_A4R4G4B4:26,FOURCC_R3G3B2:27,FOURCC_A8:28,FOURCC_A8R3G3B2:29,FOURCC_X4R4G4B4:30,FOURCC_A2B10G10R10:31,FOURCC_A8B8G8R8:32,FOURCC_X8B8G8R8:33,FOURCC_G16R16:34,FOURCC_A2R10G10B10:35,FOURCC_A16B16G16R16:36,FOURCC_L8:50,FOURCC_A8L8:51,FOURCC_A4L4:52,FOURCC_DXT1:827611204,FOURCC_DXT2:844388420,FOURCC_DXT3:861165636,FOURCC_DXT4:877942852,FOURCC_DXT5:894720068,FOURCC_D16_LOCKABLE:70,FOURCC_D32:71,FOURCC_D24X8:77,FOURCC_D16:80,FOURCC_D32F_LOCKABLE:82,FOURCC_L16:81,FOURCC_R16F:111,FOURCC_G16R16F:112,FOURCC_A16B16G16R16F:113,FOURCC_R32F:114,FOURCC_G32R32F:115,FOURCC_A32B32G32R32F:116,BGRPIXELFORMAT_B5G6R5:1,BGRPIXELFORMAT_B8G8R8A8:2,BGRPIXELFORMAT_B8G8R8:3,processBytes:function(t){if(!this.isValidHeader(t))return;var n=4,r=this.parseHeader(t,n);n+=124,this.width=r.dwWidth,this.height=r.dwHeight,r.dwCaps2&this.DDSF_VOLUME&&r.dwDepth>0?this.depth=r.dwDepth:this.depth=1,r.dwFlags&this.DDSF_MIPMAPCOUNT?this.numLevels=r.dwMipMapCount:this.numLevels=1;if(r.dwCaps2&this.DDSF_CUBEMAP){var i=0;i+=r.dwCaps2&this.DDSF_CUBEMAP_POSITIVEX?1:0,i+=r.dwCaps2&this.DDSF_CUBEMAP_NEGATIVEX?1:0,i+=r.dwCaps2&this.DDSF_CUBEMAP_POSITIVEY?1:0,i+=r.dwCaps2&this.DDSF_CUBEMAP_NEGATIVEY?1:0,i+=r.dwCaps2&this.DDSF_CUBEMAP_POSITIVEZ?1:0,i+=r.dwCaps2&this.DDSF_CUBEMAP_NEGATIVEZ?1:0;if(i!==6||this.width!==this.height)return;this.numFaces=i}else this.numFaces=1;var s=!1,o=0,u=this.gd;if(r.ddspf.dwFlags&this.DDSF_FOURCC)switch(r.ddspf.dwFourCC){case this.FOURCC_DXT1:this.format=u.PIXELFORMAT_DXT1,o=8,s=!0;break;case this.FOURCC_DXT2:case this.FOURCC_DXT3:this.format=u.PIXELFORMAT_DXT3,o=16,s=!0;break;case this.FOURCC_DXT4:case this.FOURCC_DXT5:case this.FOURCC_RXGB:this.format=u.PIXELFORMAT_DXT5,o=16,s=!0;break;case this.FOURCC_R8G8B8:this.bgrFormat=this.BGRPIXELFORMAT_B8G8R8,o=3;break;case this.FOURCC_A8R8G8B8:this.bgrFormat=this.BGRPIXELFORMAT_B8G8R8A8,o=4;break;case this.FOURCC_R5G6B5:this.bgrFormat=this.BGRPIXELFORMAT_B5G6R5,o=2;break;case this.FOURCC_A8:this.format=u.PIXELFORMAT_A8,o=1;break;case this.FOURCC_A8B8G8R8:this.format=u.PIXELFORMAT_R8G8B8A8,o=4;break;case this.FOURCC_L8:this.format=u.PIXELFORMAT_L8,o=1;break;case this.FOURCC_A8L8:this.format=u.PIXELFORMAT_L8A8,o=2;break;case this.FOURCC_UNKNOWN:case this.FOURCC_ATI1:case this.FOURCC_ATI2:case this.FOURCC_X8R8G8B8:case this.FOURCC_X8B8G8R8:case this.FOURCC_A2B10G10R10:case this.FOURCC_A2R10G10B10:case this.FOURCC_A16B16G16R16:case this.FOURCC_R16F:case this.FOURCC_A16B16G16R16F:case this.FOURCC_R32F:case this.FOURCC_A32B32G32R32F:case this.FOURCC_L16:case this.FOURCC_X1R5G5B5:case this.FOURCC_A1R5G5B5:case this.FOURCC_A4R4G4B4:case this.FOURCC_R3G3B2:case this.FOURCC_A8R3G3B2:case this.FOURCC_X4R4G4B4:case this.FOURCC_A4L4:case this.FOURCC_D16_LOCKABLE:case this.FOURCC_D32:case this.FOURCC_D24X8:case this.FOURCC_D16:case this.FOURCC_D32F_LOCKABLE:case this.FOURCC_G16R16:case this.FOURCC_G16R16F:case this.FOURCC_G32R32F:break;default:return}else if(r.ddspf.dwFlags===this.DDSF_RGBA&&r.ddspf.dwRGBBitCount===32)r.ddspf.dwRBitMask===255&&r.ddspf.dwGBitMask===65280&&r.ddspf.dwBBitMask===16711680&&r.ddspf.dwABitMask===4278190080?this.format=u.PIXELFORMAT_R8G8B8A8:this.bgrFormat=this.BGRPIXELFORMAT_B8G8R8A8,o=4;else if(r.ddspf.dwFlags===this.DDSF_RGB&&r.ddspf.dwRGBBitCount===32)r.ddspf.dwRBitMask===255&&r.ddspf.dwGBitMask===65280&&r.ddspf.dwBBitMask===16711680?this.format=u.PIXELFORMAT_R8G8B8A8:this.bgrFormat=this.BGRPIXELFORMAT_B8G8R8A8,o=4;else if(r.ddspf.dwFlags===this.DDSF_RGB&&r.ddspf.dwRGBBitCount===24)r.ddspf.dwRBitMask===255&&r.ddspf.dwGBitMask===65280&&r.ddspf.dwBBitMask===16711680?this.format=u.PIXELFORMAT_R8G8B8:this.bgrFormat=this.BGRPIXELFORMAT_B8G8R8,o=3;else if(r.ddspf.dwFlags===this.DDSF_RGB&&r.ddspf.dwRGBBitCount===16)r.ddspf.dwRBitMask===63488&&r.ddspf.dwGBitMask===2016&&r.ddspf.dwBBitMask===31?this.format=u.PIXELFORMAT_R5G6B5:this.bgrFormat=this.BGRPIXELFORMAT_B5G6R5,o=2;else{if(r.ddspf.dwRGBBitCount!==8)return;this.format=u.PIXELFORMAT_L8,o=1}var a=0;for(var f=0;f<this.numFaces;f+=1){var l=this.width,c=this.height,h=this.depth;for(var p=0;p<this.numLevels;p+=1){var d=s?Math.floor((l+3)/4):l,v=s?Math.floor((c+3)/4):c;a+=d*v*h*o,l=l>1?l>>1:1,c=c>1?c>>1:1,h=h>1?h>>1:1}}if(t.length<n+a)return;this.bytesPerPixel=o;var m=t.subarray(n);t=null;var g=!1;switch(this.bgrFormat){case this.BGRPIXELFORMAT_B8G8R8:this.format=u.PIXELFORMAT_R8G8B8,g=!0;break;case this.BGRPIXELFORMAT_B8G8R8A8:this.format=u.PIXELFORMAT_R8G8B8A8,g=!0;break;case this.BGRPIXELFORMAT_B5G6R5:this.format=u.PIXELFORMAT_R5G6B5,g=!0;break;default:}g&&(m=this.convertBGR2RGB(m)),this.format===u.PIXELFORMAT_DXT1?u.isSupported("TEXTURE_DXT1")||(m=this.convertDXT1ToRGBA(m)):this.format===u.PIXELFORMAT_DXT3?u.isSupported("TEXTURE_DXT3")||(m=this.convertDXT3ToRGBA(m)):this.format===u.PIXELFORMAT_DXT5&&(u.isSupported("TEXTURE_DXT5")||(m=this.convertDXT5ToRGBA(m))),this.data=m},parseHeader:function(t,n){function r(){var e=t[n]+t[n+1]*256+t[n+2]*65536+t[n+3]*16777216;return n+=4,e}function i(){return{dwSize:r(),dwFlags:r(),dwFourCC:r(),dwRGBBitCount:r(),dwRBitMask:r(),dwGBitMask:r(),dwBBitMask:r(),dwABitMask:r()}}var s={dwSize:r(),dwFlags:r(),dwHeight:r(),dwWidth:r(),dwPitchOrLinearSize:r(),dwDepth:r(),dwMipMapCount:r(),dwReserved1:[r(),r(),r(),r(),r(),r(),r(),r(),r(),r(),r()],ddspf:i(),dwCaps1:r(),dwCaps2:r(),dwReserved2:[r(),r(),r()]};return s},isValidHeader:function(t){return 68===t[0]&&68===t[1]&&83===t[2]&&32===t[3]},convertBGR2RGB:function(t){var n=this.bytesPerPixel,r=this.width,i=this.height,s=this.numLevels,o=this.numFaces,u=0;for(var a=0;a<s;a+=1)u+=r*i,r=r>1?Math.floor(r/2):1,i=i>1?Math.floor(i/2):1;var f=u*n*o,l=0;if(n===3||n===4){do{var c=t[l];t[l]=t[l+2],t[l+2]=c,l+=n}while(l<f)}else if(n===2){var h=new Uint16Array(u*o),p=0,d=0,v,m,g,y=31,b=2016;do{var w=t[p+1]<<8|t[p];p+=2,v=(w&y)<<11,m=w&b,g=w>>11&y,h[d]=v|m|g,d+=1}while(l<f);return h}return t},decode565:function(t,n){var r=t>>11&31,i=t>>5&63,s=t&31;return n[0]=r<<3|r>>2,n[1]=i<<2|i>>4,n[2]=s<<3|s>>2,n[3]=255,n},decodeColor:function(t,n,r,i,s){var o=s.cache,u=c.prototype.decode565,a=t[n+1]<<8|t[n];n+=2;var f=t[n+1]<<8|t[n];n+=2;var l,h,p,d,v;if(a!==f){l=u(a,o[0]),h=u(f,o[1]),p=o[2],d=o[3];if(a>f){for(v=0;v<3;v+=1){var m=l[v],g=h[v];p[v]=(m*2+g)/3|0,d[v]=(m+g*2)/3|0}p[3]=255,d[3]=255}else{for(v=0;v<3;v+=1)p[v]=l[v]+h[v]>>1,d[v]=0;p[3]=255,d[3]=0}}else{l=u(a,o[0]),h=l,p=l,d=o[1];for(v=0;v<4;v+=1)d[v]=0}var y=s.colorArray;y[0]=l,y[1]=h,y[2]=p,y[3]=d;var b,w,E;if(r)for(v=0;v<4;v+=1)b=t[n+v],w=i[v],w[0]=y[b&3],w[1]=y[b>>2&3],w[2]=y[b>>4&3],w[3]=y[b>>6&3];else for(v=0;v<4;v+=1)b=t[n+v],w=i[v],E=y[b&3],w[0][0]=E[0],w[0][1]=E[1],w[0][2]=E[2],w[0][3]=E[3],E=y[b>>2&3],w[1][0]=E[0],w[1][1]=E[1],w[1][2]=E[2],w[1][3]=E[3],E=y[b>>4&3],w[2][0]=E[0],w[2][1]=E[1],w[2][2]=E[2],w[2][3]=E[3],E=y[b>>6&3],w[3][0]=E[0],w[3][1]=E[1],w[3][2]=E[2],w[3][3]=E[3]},decodeDXT3Alpha:function(t,n,r){for(var i=0;i<4;i+=1){var s=t[n+1]<<8|t[n];n+=2;var o=r[i];s?(o[0][3]=(s&15)*17,o[1][3]=(s>>4&15)*17,o[2][3]=(s>>8&15)*17,o[3][3]=(s>>12&15)*17):(o[0][3]=0,o[1][3]=0,o[2][3]=0,o[3][3]=0)}},decodeDXT5Alpha:function(t,n,r,i){var s=t[n];n+=1;var o=t[n];n+=1;var u=i.alphaArray;u[0]=s,u[1]=o,s>o?(u[2]=(s*6+o*1)/7|0,u[3]=(s*5+o*2)/7|0,u[4]=(s*4+o*3)/7|0,u[5]=(s*3+o*4)/7|0,u[6]=(s*2+o*5)/7|0,u[7]=(s*1+o*6)/7|0):s<o?(u[2]=(s*4+o*1)/5|0,u[3]=(s*3+o*2)/5|0,u[4]=(s*2+o*3)/5|0,u[5]=(s*1+o*4)/5|0,u[6]=0,u[7]=255):(u[2]=s,u[3]=s,u[4]=s,u[5]=s,u[6]=0,u[7]=255);var a;for(var f=0;f<2;f+=1){var l=t[n]|t[n+1]<<8|t[n+2]<<16;n+=3,a=r[f*2],a[0][3]=u[l&7],a[1][3]=u[l>>3&7],a[2][3]=u[l>>6&7],a[3][3]=u[l>>9&7],a=r[f*2+1],a[0][3]=u[l>>12&7],a[1][3]=u[l>>15&7],a[2][3]=u[l>>18&7],a[3][3]=u[l>>21&7]}},convertDXT1ToRGBA:function(t){var n=this.decodeColor,r={cache:[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)],colorArray:new Array(4)},i;return this.hasDXT1Alpha(t)?(this.format=this.gd.PIXELFORMAT_R5G5B5A1,i=this.encodeR5G5B5A1):(this.format=this.gd.PIXELFORMAT_R5G6B5,i=this.encodeR5G6B5),t=this.convertToRGBA16(t,function(t,i,s){n(t,i,!0,s,r)},i,8),t},convertDXT3ToRGBA:function(t){var n=this.decodeColor,r=this.decodeDXT3Alpha,i={cache:[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)],colorArray:new Array(4)};return t=this.convertToRGBA16(t,function(t,s,o){n(t,s+8,!1,o,i),r(t,s,o)},this.encodeR4G4B4A4,16),this.format=this.gd.PIXELFORMAT_R4G4B4A4,t},convertDXT5ToRGBA:function(t){var n=this.decodeColor,r=this.decodeDXT5Alpha,i={cache:[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)],colorArray:new Array(4),alphaArray:new Uint8Array(8)};return t=this.convertToRGBA16(t,function(t,s,o){n(t,s+8,!1,o,i),r(t,s,o,i)},this.encodeR4G4B4A4,16),this.format=this.gd.PIXELFORMAT_R4G4B4A4,t},convertToRGBA32:function(t,n,r){var i,s=this.width,o=this.height,u=this.numLevels,a=this.numFaces,f=0;for(i=0;i<u;i+=1)f+=s*o,s=s>1?s>>1:1,o=o>1?o>>1:1;var l=new Uint8Array(f*4*a),c=0,h=0,p=[[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)],[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)],[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)],[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)]];for(var d=0;d<a;d+=1){s=this.width,o=this.height;for(var v=0;v<u;v+=1){var m=s>4?4:s,g=o>4?4:o,y=o+3>>2,b=s+3>>2,w=s*4,E=m*4,S=w*(g-1);for(var x=0;x<y;x+=1){for(var T=0;T<b;T+=1){n(t,c,p);var N=h;for(var C=0;C<g;C+=1){var k=p[C],L=N;for(var A=0;A<m;A+=1){var O=k[A];l[L]=O[0],l[L+1]=O[1],l[L+2]=O[2],l[L+3]=O[3],L+=4}N+=w}c+=r,h+=E}h+=S}s=s>1?s>>1:1,o=o>1?o>>1:1}}return l},hasDXT1Alpha:function(t){var n=t.length,r,i,s;for(r=0;r<n;r+=8){var o=t[r+1]<<8|t[r],u=t[r+3]<<8|t[r+2];if(o<=u)for(i=0;i<4;i+=1){s=t[r+4+i];if(s===0)continue;if((s&3)===3||(s>>2&3)===3||(s>>4&3)===3||(s>>6&3)===3)return!0}}return!1},encodeR5G6B5:function(t){return(t[2]&248)>>>3|(t[1]&252)<<3|(t[0]&248)<<8},encodeR5G5B5A1:function(t){return t[3]>>>7|(t[2]&248)>>>2|(t[1]&248)<<3|(t[0]&248)<<8},encodeR4G4B4A4:function(t){return t[3]>>>4|t[2]&240|(t[1]&240)<<4|(t[0]&240)<<8},convertToRGBA16:function(t,n,r,i){var s,o=this.width,u=this.height,a=this.numLevels,f=this.numFaces,l=0;for(s=0;s<a;s+=1)l+=o*u,o=o>1?o>>1:1,u=u>1?u>>1:1;var c=new Uint16Array(l*1*f),h=0,p=0,d=[[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)],[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)],[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)],[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)]];for(var v=0;v<f;v+=1){o=this.width,u=this.height;for(var m=0;m<a;m+=1){var g=o>4?4:o,y=u>4?4:u,b=u+3>>2,w=o+3>>2,E=o*1,S=g*1,x=E*(y-1);for(var T=0;T<b;T+=1){for(var N=0;N<w;N+=1){n(t,h,d);var C=p;for(var k=0;k<y;k+=1){var L=d[k],A=C;for(var O=0;O<g;O+=1){var M=L[O];c[A]=r(M),A+=1}C+=E}h+=i,p+=S}p+=x}o=o>1?o>>1:1,u=u>1?u>>1:1}}return c}},c.create=function(t){function r(e,t,n,r){return e.charCodeAt(0)+t.charCodeAt(0)*256+n.charCodeAt(0)*65536+r.charCodeAt(0)*16777216}var n=new c;n.gd=t.gd,n.onload=t.onload,n.onerror=t.onerror,n.FOURCC_ATI1=r("A","T","I","1"),n.FOURCC_ATI2=r("A","T","I","2"),n.FOURCC_RXGB=r("R","X","G","B");var i=t.src;if(i){n.src=i;var s;if(window.XMLHttpRequest)s=new window.XMLHttpRequest;else{if(!window.ActiveXObject)return t.onerror&&t.onerror("No XMLHTTPRequest object could be created"),null;s=new window.ActiveXObject("Microsoft.XMLHTTP")}s.onreadystatechange=function(){if(s.readyState===4){if(!TurbulenzEngine||!TurbulenzEngine.isUnloading()){var e=s.status,t=s.status!==0&&s.statusText||"No connection";if(e===200&&t==="OK"&&s.getAllResponseHeaders()===""&&s.responseText===""){n.onload("",0);return}if(e===200||e===0){var r;if(s.responseType==="arraybuffer")r=s.response;else if(s.mozResponseArrayBuffer)r=s.mozResponseArrayBuffer;else{var i=s.responseText,o=i.length;r=[],r.length=o;for(var u=0;u<o;u+=1)r[u]=i.charCodeAt(u)&255}e===0&&window.location.protocol==="file:"&&(e=200),n.processBytes(new Uint8Array(r)),n.data?n.onload&&n.onload(n.data,n.width,n.height,n.format,n.numLevels,n.numFaces>1,n.depth,e):n.onerror&&n.onerror()}else n.onerror&&n.onerror()}s.onreadystatechange=null,s=null}},s.open("GET",t.src,!0),s.hasOwnProperty&&s.hasOwnProperty("responseType")?s.responseType="arraybuffer":s.overrideMimeType?s.overrideMimeType("text/plain; charset=x-user-defined"):s.setRequestHeader("Content-Type","text/plain; charset=x-user-defined"),s.send(null)}else n.processBytes(t.data),n.data?n.onload&&n.onload(n.data,n.width,n.height,n.format,n.numLevels,n.numFaces>1,n.depth):n.onerror&&n.onerror();return n},h.prototype={version:1,setData:function(t){var n=this.gd,r=this.target;n.bindTexture(r,this.glTexture),this.updateData(t),n.bindTexture(r,null)},createGLTexture:function(t){var n=this.gd,r=n.gl,i;if(this.cubemap)i=r.TEXTURE_CUBE_MAP;else{if(this.depth>1)return!1;i=r.TEXTURE_2D}this.target=i;var s=r.createTexture();return this.glTexture=s,n.bindTexture(i,s),r.texParameteri(i,r.TEXTURE_MAG_FILTER,r.LINEAR),this.mipmaps||1<this.numDataLevels?r.texParameteri(i,r.TEXTURE_MIN_FILTER,r.LINEAR_MIPMAP_NEAREST):r.texParameteri(i,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(i,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(i,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),this.updateData(t),n.bindTexture(i,null),!0},updateData:function(t){function i(e){return Math.floor(Math.log(e)/Math.LN2)}var n=this.gd,r=n.gl,s=this.mipmaps&&this.numDataLevels!==1+Math.max(i(this.width),i(this.height)),o=this.format,u,a,f,l=null,c;if(o===n.PIXELFORMAT_A8)u=r.ALPHA,a=r.UNSIGNED_BYTE,f=1,t&&!t.src&&(t instanceof Uint8Array?l=t:l=new Uint8Array(t));else if(o===n.PIXELFORMAT_L8)u=r.LUMINANCE,a=r.UNSIGNED_BYTE,f=1,t&&!t.src&&(t instanceof Uint8Array?l=t:l=new Uint8Array(t));else if(o===n.PIXELFORMAT_L8A8)u=r.LUMINANCE_ALPHA,a=r.UNSIGNED_BYTE,f=2,t&&!t.src&&(t instanceof Uint8Array?l=t:l=new Uint8Array(t));else if(o===n.PIXELFORMAT_R5G5B5A1)u=r.RGBA,a=r.UNSIGNED_SHORT_5_5_5_1,f=1,t&&!t.src&&(t instanceof Uint16Array?l=t:l=new Uint16Array(t));else if(o===n.PIXELFORMAT_R5G6B5)u=r.RGB,a=r.UNSIGNED_SHORT_5_6_5,f=1,t&&!t.src&&(t instanceof Uint16Array?l=t:l=new Uint16Array(t));else if(o===n.PIXELFORMAT_R4G4B4A4)u=r.RGBA,a=r.UNSIGNED_SHORT_4_4_4_4,f=1,t&&!t.src&&(t instanceof Uint16Array?l=t:l=new Uint16Array(t));else if(o===n.PIXELFORMAT_R8G8B8A8)u=r.RGBA,a=r.UNSIGNED_BYTE,f=4,t&&!t.src&&(t instanceof Uint8Array?typeof Uint8ClampedArray!="undefined"&&t instanceof Uint8ClampedArray?l=new Uint8Array(t.buffer):l=t:l=new Uint8Array(t));else if(o===n.PIXELFORMAT_R8G8B8)u=r.RGB,a=r.UNSIGNED_BYTE,f=3,t&&!t.src&&(t instanceof Uint8Array?typeof Uint8ClampedArray!="undefined"&&t instanceof Uint8ClampedArray?l=new Uint8Array(t.buffer):l=t:l=new Uint8Array(t));else if(o===n.PIXELFORMAT_D24S8)u=r.DEPTH_STENCIL,a=r.UNSIGNED_INT,f=1,t&&!t.src&&(l=new Uint32Array(t));else{if(o!==n.PIXELFORMAT_DXT1&&o!==n.PIXELFORMAT_DXT3&&o!==n.PIXELFORMAT_DXT5)return;c=n.compressedTexturesExtension;if(!c)return;o===n.PIXELFORMAT_DXT1?(u=c.COMPRESSED_RGBA_S3TC_DXT1_EXT,f=8):o===n.PIXELFORMAT_DXT3?(u=c.COMPRESSED_RGBA_S3TC_DXT3_EXT,f=16):(u=c.COMPRESSED_RGBA_S3TC_DXT5_EXT,f=16);if(u===undefined)return;t&&!t.src&&(t instanceof Uint8Array?l=t:l=new Uint8Array(t))}var h=t&&0<this.numDataLevels?this.numDataLevels:1,d=this.width,v=this.height,m=0,g,y,b,w;if(this.cubemap){if(t&&t instanceof p)return;g=r.TEXTURE_CUBE_MAP;for(var E=0;E<6;E+=1){var S=r.TEXTURE_CUBE_MAP_POSITIVE_X+E;for(y=0;y<h;y+=1)c?(b=Math.floor((d+3)/4)*Math.floor((v+3)/4)*f,l?h===1?w=l:w=l.subarray(m,m+b):w=new Uint8Array(b),n.WEBGL_compressed_texture_s3tc?r.compressedTexImage2D(S,y,u,d,v,0,w):c.compressedTexImage2D(S,y,u,d,v,0,w)):(b=d*v*f,l?(h===1?w=l:w=l.subarray(m,m+b),r.texImage2D(S,y,u,d,v,0,u,a,w)):t?r.texImage2D(S,y,u,u,a,t):(a===r.UNSIGNED_SHORT_5_6_5||a===r.UNSIGNED_SHORT_5_5_5_1||a===r.UNSIGNED_SHORT_4_4_4_4?w=new Uint16Array(b):w=new Uint8Array(b),r.texImage2D(S,y,u,d,v,0,u,a,w))),m+=b,d=d>1?Math.floor(d/2):1,v=v>1?Math.floor(v/2):1;d=this.width,v=this.height}}else if(t&&t instanceof p)g=r.TEXTURE_2D,r.texImage2D(g,0,u,u,a,t.video);else{g=r.TEXTURE_2D;for(y=0;y<h;y+=1)c?(b=Math.floor((d+3)/4)*Math.floor((v+3)/4)*f,l?h===1?w=l:w=l.subarray(m,m+b):w=new Uint8Array(b),n.WEBGL_compressed_texture_s3tc?r.compressedTexImage2D(g,y,u,d,v,0,w):c.compressedTexImage2D(g,y,u,d,v,0,w)):(b=d*v*f,l?(h===1?w=l:w=l.subarray(m,m+b),r.texImage2D(g,y,u,d,v,0,u,a,w)):t?r.texImage2D(g,y,u,u,a,t):(a===r.UNSIGNED_SHORT_5_6_5||a===r.UNSIGNED_SHORT_5_5_5_1||a===r.UNSIGNED_SHORT_4_4_4_4?w=new Uint16Array(b):w=new Uint8Array(b),r.texImage2D(g,y,u,d,v,0,u,a,w))),m+=b,d=d>1?Math.floor(d/2):1,v=v>1?Math.floor(v/2):1}s&&r.generateMipmap(g)},updateMipmaps:function(t){if(this.mipmaps){if(this.depth>1){TurbulenzEngine.callOnError("3D texture mipmap generation unsupported");return}if(this.cubemap&&t!==5)return;var n=this.gd,r=n.gl,i=this.target;n.bindTexture(i,this.glTexture),r.generateMipmap(i),n.bindTexture(i,null)}},destroy:function(){var t=this.gd;if(t){var n=this.glTexture;if(n){var r=t.gl;r&&(t.unbindTexture(n),r.deleteTexture(n)),delete this.glTexture}delete this.sampler,delete this.gd}},typedArrayIsValid:function(t){var n=this.gd,r=this.format;if(n){if(r===n.PIXELFORMAT_A8||r===n.PIXELFORMAT_L8||r===n.PIXELFORMAT_S8)return(t instanceof Uint8Array||typeof Uint8ClampedArray!="undefined"&&t instanceof Uint8ClampedArray)&&t.length===this.width*this.height*this.depth;if(r===n.PIXELFORMAT_L8A8)return(t instanceof Uint8Array||typeof Uint8ClampedArray!="undefined"&&t instanceof Uint8ClampedArray)&&t.length===2*this.width*this.height*this.depth;if(r===n.PIXELFORMAT_R8G8B8)return(t instanceof Uint8Array||typeof Uint8ClampedArray!="undefined"&&t instanceof Uint8ClampedArray)&&t.length===3*this.width*this.height*this.depth;if(r===n.PIXELFORMAT_R8G8B8A8)return(t instanceof Uint8Array||typeof Uint8ClampedArray!="undefined"&&t instanceof Uint8ClampedArray)&&t.length===4*this.width*this.height*this.depth;if(r===n.PIXELFORMAT_R5G5B5A1||r===n.PIXELFORMAT_R5G6B5||r===n.PIXELFORMAT_R4G4B4A4)return t instanceof Uint16Array&&t.length===this.width*this.height*this.depth}return!1}},h.create=function(t,n){var r=new h;r.gd=t,r.mipmaps=n.mipmaps,r.dynamic=n.dynamic,r.renderable=n.renderable,r.numDataLevels=0,r.id=++t.counters.textures;var i=n.src;if(i){r.name=n.name||i;var s,o=n.data;o?o[0]===137&&o[1]===80&&o[2]===78&&o[3]===71?s=".png":o[0]!==255||o[1]!==216||o[2]!==255||o[3]!==224&&o[3]!==225?o[0]===68&&o[1]===68&&o[2]===83&&o[3]===32?s=".dds":s=i.slice(-4):s=".jpg":s=i.slice(-4);if(s===".dds"||s===".tga"){if(s===".tga"&&typeof vt!="undefined"){var u={gd:t,onload:function(t,i,s,o,u){r.width=i,r.height=s,r.depth=1,r.format=o,r.cubemap=!1;var a=r.createGLTexture(t);n.onload&&n.onload(a?r:null,u)},onerror:function(){r.failed=!0,n.onload&&n.onload(null)},data:undefined,src:undefined};return o?u.data=o:u.src=i,vt.create(u),r}if(s===".dds"&&typeof c!="undefined"){var a={gd:t,onload:function(t,i,s,o,u,a,f,l){r.width=i,r.height=s,r.format=o,r.cubemap=a,r.depth=f,r.numDataLevels=u;var c=r.createGLTexture(t);n.onload&&n.onload(c?r:null,l)},onerror:function(){r.failed=!0,n.onload&&n.onload(null)},data:undefined,src:undefined};return o?a.data=o:a.src=i,c.create(a),r}return TurbulenzEngine.callOnError("Missing image loader required for "+i),r=h.create(t,{name:n.name||i,width:2,height:2,depth:1,format:"R8G8B8A8",cubemap:!1,mipmaps:n.mipmaps,dynamic:n.dynamic,renderable:n.renderable,data:[255,20,147,255,255,0,0,255,255,255,255,255,255,20,147,255]}),n.onload&&(TurbulenzEngine?TurbulenzEngine.setTimeout(function(){n.onload(r,200)},0):window.setTimeout(function(){n.onload(r,200)},0)),r}var f=new Image;f.onload=function(){r.width=f.width,r.height=f.height,r.depth=1,r.format=t.PIXELFORMAT_R8G8B8A8,r.cubemap=!1;var i=r.createGLTexture(f);n.onload&&n.onload(i?r:null,200)},f.onerror=function(){r.failed=!0,n.onload&&n.onload(null)},o?s===".jpg"||s===".jpeg"?i="data:image/jpeg;base64,"+TurbulenzEngine.base64Encode(o):s===".png"&&(i="data:image/png;base64,"+TurbulenzEngine.base64Encode(o)):f.crossOrigin="anonymous",f.src=i}else{if(""===i&&n.onload)return null;var l=n.format;typeof l=="string"&&(l=t["PIXELFORMAT_"+l]),r.width=n.width,r.height=n.height,r.depth=n.depth,r.format=l,r.cubemap=n.cubemap,r.name=n.name;var p=r.createGLTexture(n.data);p||(r=null),n.renderable&&(t.PIXELFORMAT_D16===l?r.glDepthAttachment=t.gl.DEPTH_ATTACHMENT:t.PIXELFORMAT_D24S8===l&&(r.glDepthAttachment=t.gl.DEPTH_STENCIL_ATTACHMENT)),n.onload&&n.onload(r,200)}return r},p.prototype={version:1,play:function(t){var n=this.video;this.playing||(this.playing=!0,this.paused=!1),t===undefined&&(t=0);if(.01<Math.abs(n.currentTime-t))try{n.currentTime=t}catch(r){}return n.play(),!0},stop:function(){var t=this.playing;if(t){this.playing=!1,this.paused=!1;var n=this.video;n.pause(),n.currentTime=0}return t},pause:function(){return this.playing?(this.paused||(this.paused=!0,this.video.pause()),!0):!1},resume:function(t){if(this.paused){this.paused=!1;var n=this.video;if(t!==undefined&&.01<Math.abs(n.currentTime-t))try{n.currentTime=t}catch(r){}return n.play(),!0}return!1},rewind:function(){return this.playing?(this.video.currentTime=0,!0):!1},destroy:function(){this.stop(),this.video&&(this.elementAdded&&(this.elementAdded=!1,TurbulenzEngine.canvas.parentElement.removeChild(this.video)),this.video=null)}},p.create=function(t){var n=new p,r=t.onload,i=t.looping,s=t.src,o=navigator.userAgent.toLowerCase(),u=document.createElement("video");u.preload="auto",u.autobuffer=!0,u.muted=!0,i?u.loop!==undefined&&!o.match(/firefox/)?u.loop=!0:u.onended=function(){u.src=s,u.play()}:u.onended=function(){n.playing=!1},n.video=u,n.src=s,n.playing=!1,n.paused=!1,o.match(/safari/)&&!o.match(/chrome/)&&(u.setAttribute("style","visibility: hidden;"),TurbulenzEngine.canvas.parentElement.appendChild(u),n.elementAdded=!0);if(u.webkitDecodedFrameCount!==undefined){var a=-1,f=0;Object.defineProperty(n,"tell",{get:function(){return a!==this.video.webkitDecodedFrameCount&&(a=this.video.webkitDecodedFrameCount,f=this.video.currentTime),f},enumerable:!0,configurable:!1})}else Object.defineProperty(n,"tell",{get:function(){return this.video.currentTime},enumerable:!0,configurable:!1});Object.defineProperty(n,"looping",{get:function(){return i},enumerable:!0,configurable:!1});var l=function(){r&&(r(null),r=null),u.removeEventListener("error",l),u=null,n.video=null,n.playing=!1};u.addEventListener("error",l,!1);var c=function(){n.length=u.duration,n.width=u.videoWidth,n.height=u.videoHeight,r&&(r(n,200),r=null),u.removeEventListener("progress",h),u.removeEventListener("canplaythrough",c)},h=function(){0<u.buffered.length&&u.buffered.end(0)>=u.duration&&c()};return u.addEventListener("progress",h,!1),u.addEventListener("canplaythrough",c,!1),u.crossorigin="anonymous",u.src=s,n},d.prototype={version:1,destroy:function(){var t=this.gd;if(t){var n=this.glBuffer;if(n){var r=t.gl;r&&r.deleteRenderbuffer(n),delete this.glBuffer}delete this.gd}}},d.create=function(t,n){var r=new d,i=n.width,s=n.height,o=n.format;typeof o=="string"&&(o=t["PIXELFORMAT_"+o]);if(o!==t.PIXELFORMAT_D24S8&&o!==t.PIXELFORMAT_D16)return null;var u=t.gl,a=u.createRenderbuffer();u.bindRenderbuffer(u.RENDERBUFFER,a);var f,l;return t.PIXELFORMAT_D16===o?(f=u.DEPTH_COMPONENT16,l=u.DEPTH_ATTACHMENT):(f=u.DEPTH_STENCIL,l=u.DEPTH_STENCIL_ATTACHMENT),u.renderbufferStorage(u.RENDERBUFFER,f,i,s),r.width=u.getRenderbufferParameter(u.RENDERBUFFER,u.RENDERBUFFER_WIDTH),r.height=u.getRenderbufferParameter(u.RENDERBUFFER,u.RENDERBUFFER_HEIGHT),u.bindRenderbuffer(u.RENDERBUFFER,null),r.width<i||r.height<s?(u.deleteRenderbuffer(a),null):(r.gd=t,r.format=o,r.glDepthAttachment=l,r.glBuffer=a,r.id=++t.counters.renderBuffers,r)},v.prototype={version:1,oldViewportBox:[],oldScissorBox:[],copyBox:function(t,n){t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3]},bind:function(){var t=this.gd,n=t.gl;this.colorTexture0&&(t.unbindTexture(this.colorTexture0.glTexture),this.colorTexture1&&(t.unbindTexture(this.colorTexture1.glTexture),this.colorTexture2&&(t.unbindTexture(this.colorTexture2.glTexture),this.colorTexture3&&t.unbindTexture(this.colorTexture3.glTexture)))),this.depthTexture&&t.unbindTexture(this.depthTexture.glTexture),n.bindFramebuffer(n.FRAMEBUFFER,this.glObject);var r=t.drawBuffersExtension;r&&(t.WEBGL_draw_buffers?r.drawBuffersWEBGL(this.buffers):r.drawBuffersEXT(this.buffers));var i=t.state;return this.copyBox(this.oldViewportBox,i.viewportBox),this.copyBox(this.oldScissorBox,i.scissorBox),t.setViewport(0,0,this.width,this.height),t.setScissor(0,0,this.width,this.height),!0},unbind:function(){var t=this.gd,n=t.gl;n.bindFramebuffer(n.FRAMEBUFFER,null);var r=t.drawBuffersExtension;if(r){var i=[n.BACK];t.WEBGL_draw_buffers?r.drawBuffersWEBGL(i):r.drawBuffersEXT(i)}t.setViewport.apply(t,this.oldViewportBox),t.setScissor.apply(t,this.oldScissorBox),this.colorTexture0&&(this.colorTexture0.updateMipmaps(this.face),this.colorTexture1&&(this.colorTexture1.updateMipmaps(this.face),this.colorTexture2&&(this.colorTexture2.updateMipmaps(this.face),this.colorTexture3&&this.colorTexture3.updateMipmaps(this.face)))),this.depthTexture&&this.depthTexture.updateMipmaps(this.face)},destroy:function(){var t=this.gd;if(t){var n=this.glObject;if(n){var r=t.gl;r&&r.deleteFramebuffer(n),delete this.glObject}delete this.colorTexture0,delete this.colorTexture1,delete this.colorTexture2,delete this.colorTexture3,delete this.depthBuffer,delete this.depthTexture,delete this.gd}}},v.create=function(t,n){var r=new v,i=n.colorTexture0,s=i?n.colorTexture1||null:null,o=s?n.colorTexture2||null:null,u=o?n.colorTexture3||null:null,a=n.depthBuffer||null,f=n.depthTexture||null,l=n.face,c=t.maxSupported("RENDERTARGET_COLOR_TEXTURES");if(s&&c<2)return null;if(o&&c<3)return null;if(u&&c<4)return null;var h=t.gl,p=h.COLOR_ATTACHMENT0,d=h.createFramebuffer();h.bindFramebuffer(h.FRAMEBUFFER,d);var m,g;if(i){m=i.width,g=i.height;var y=i.glTexture;if(y===undefined)return TurbulenzEngine.callOnError("Color texture is not a Texture"),h.bindFramebuffer(h.FRAMEBUFFER,null),h.deleteFramebuffer(d),null;i.cubemap?h.framebufferTexture2D(h.FRAMEBUFFER,p,h.TEXTURE_CUBE_MAP_POSITIVE_X+l,y,0):h.framebufferTexture2D(h.FRAMEBUFFER,p,h.TEXTURE_2D,y,0),s&&(y=s.glTexture,s.cubemap?h.framebufferTexture2D(h.FRAMEBUFFER,p+1,h.TEXTURE_CUBE_MAP_POSITIVE_X+l,y,0):h.framebufferTexture2D(h.FRAMEBUFFER,p+1,h.TEXTURE_2D,y,0),o&&(y=o.glTexture,s.cubemap?h.framebufferTexture2D(h.FRAMEBUFFER,p+2,h.TEXTURE_CUBE_MAP_POSITIVE_X+l,y,0):h.framebufferTexture2D(h.FRAMEBUFFER,p+2,h.TEXTURE_2D,y,0),u&&(y=u.glTexture,s.cubemap?h.framebufferTexture2D(h.FRAMEBUFFER,p+3,h.TEXTURE_CUBE_MAP_POSITIVE_X+l,y,0):h.framebufferTexture2D(h.FRAMEBUFFER,p+3,h.TEXTURE_2D,y,0))))}else if(f)m=f.width,g=f.height;else{if(!a)return TurbulenzEngine.callOnError("No RenderBuffers or Textures specified for this RenderTarget"),h.bindFramebuffer(h.FRAMEBUFFER,null),h.deleteFramebuffer(d),null;m=a.width,g=a.height}f?h.framebufferTexture2D(h.FRAMEBUFFER,f.glDepthAttachment,h.TEXTURE_2D,f.glTexture,0):a&&h.framebufferRenderbuffer(h.FRAMEBUFFER,a.glDepthAttachment,h.RENDERBUFFER,a.glBuffer);var b=h.checkFramebufferStatus(h.FRAMEBUFFER);h.bindFramebuffer(h.FRAMEBUFFER,null);if(b!==h.FRAMEBUFFER_COMPLETE)return h.deleteFramebuffer(d),null;r.gd=t,r.glObject=d,r.colorTexture0=i,r.colorTexture1=s,r.colorTexture2=o,r.colorTexture3=u,r.depthBuffer=a,r.depthTexture=f,r.width=m,r.height=g,r.face=l;if(t.drawBuffersExtension){var w;i?(w=[p],s&&(w.push(p+1),o&&(w.push(p+2),u&&w.push(p+3)))):w=[h.NONE],r.buffers=w}return r.id=++t.counters.renderTargets,r},m.prototype={version:1,map:function(t,n){t===undefined&&(t=0),n===undefined&&(n=this.numIndices);var r=this.gd,i=r.gl,s=this.format,o;s===i.UNSIGNED_BYTE?o=new Uint8Array(n):s===i.UNSIGNED_SHORT?o=new Uint16Array(n):o=new Uint32Array(n);var u=0,a=function(){var t=arguments.length;for(var n=0;n<t;n+=1)o[u]=arguments[n],u+=1};return a.write=a,a.data=o,a.offset=t,a.getNumWrittenIndices=function(){return u},a.write=a,a},unmap:function(t){if(t){var n=this.gd,r=n.gl,i=t.data;delete t.data;var s=t.offset;delete t.write;var o=t.getNumWrittenIndices();if(!o)return;o<i.length&&(i=i.subarray(0,o)),n.setIndexBuffer(this),o<this.numIndices?r.bufferSubData(r.ELEMENT_ARRAY_BUFFER,s,i):r.bufferData(r.ELEMENT_ARRAY_BUFFER,i,this.usage)}},setData:function(t,n,r){n===undefined&&(n=0),r===undefined&&(r=this.numIndices);var i=this.gd,s=i.gl,o,u=this.format;u===s.UNSIGNED_BYTE?t instanceof Uint8Array?o=t:o=new Uint8Array(t):u===s.UNSIGNED_SHORT?(t instanceof Uint16Array?o=t:o=new Uint16Array(t),n*=2):u===s.UNSIGNED_INT&&(t instanceof Uint32Array?o=t:o=new Uint32Array(t),n*=4),t=undefined,r<o.length&&(o=o.subarray(0,r)),i.setIndexBuffer(this),r<this.numIndices?s.bufferSubData(s.ELEMENT_ARRAY_BUFFER,n,o):s.bufferData(s.ELEMENT_ARRAY_BUFFER,o
,this.usage)},destroy:function(){var t=this.gd;if(t){var n=this.glBuffer;if(n){var r=t.gl;r&&(t.unsetIndexBuffer(this),r.deleteBuffer(n)),delete this.glBuffer}delete this.gd}}},m.create=function(t,n){var r=t.gl,i=new m;i.gd=t;var s=n.numIndices;i.numIndices=s;var o=n.format;typeof o=="string"&&(o=t["INDEXFORMAT_"+o]),i.format=o;var u;return o===r.UNSIGNED_BYTE?u=1:o===r.UNSIGNED_SHORT?u=2:u=4,i.stride=u,i["transient"]=n["transient"]||!1,i.dynamic=n.dynamic||i["transient"],i.usage=i["transient"]?r.STREAM_DRAW:i.dynamic?r.DYNAMIC_DRAW:r.STATIC_DRAW,i.glBuffer=r.createBuffer(),n.data?i.setData(n.data,0,s):(t.setIndexBuffer(i),r.bufferData(r.ELEMENT_ARRAY_BUFFER,s*u,i.usage)),i.id=++t.counters.indexBuffers,i},g.prototype={version:1},g.create=function(t,n){var r=new g,i=n.length;r.length=i;for(var s=0;s<i;s+=1){var o=n[s];typeof o=="string"?r[s]=t["SEMANTIC_"+o]:r[s]=o}return r},y.prototype={version:1,map:function(t,n){t===undefined&&(t=0),n===undefined&&(n=this.numVertices);var r=this.gd,i=r.gl,s=this.stride,o=this.attributes,u=o.length,a,f,l=0;if(this.hasSingleFormat){var c=n*s,h=o[0].format;h===i.FLOAT?a=new Float32Array(c):h===i.BYTE?a=new Int8Array(c):h===i.UNSIGNED_BYTE?a=new Uint8Array(c):h===i.SHORT?a=new Int16Array(c):h===i.UNSIGNED_SHORT?a=new Uint16Array(c):h===i.INT?a=new Int32Array(c):h===i.UNSIGNED_INT&&(a=new Uint32Array(c)),f=function(){var t=arguments.length,n=0;for(var r=0;r<u;r+=1){var i=o[r],s=i.numComponents,f=0,c;do if(n<t){var h=arguments[n];n+=1;if(typeof h!="number"){if(f===0){var p=h.length;p>s&&(p=s);if(i.normalized){var d=i.normalizationScale;for(c=0;c<p;c+=1)a[l]=h[c]*d,l+=1,f+=1}else for(c=0;c<p;c+=1)a[l]=h[c],l+=1,f+=1;while(f<s)l+=1,f+=1;break}return TurbulenzEngine.callOnError("Missing values for attribute "+r),null}i.normalized&&(h*=i.normalizationScale),a[l]=h,l+=1,f+=1}else l+=1,f+=1;while(f<s)}}}else{var p=0,d=n*this.strideInBytes;a=new ArrayBuffer(d);if(typeof DataView!="undefined"&&"setFloat32"in DataView.prototype){var v=new DataView(a);f=function(){var t=arguments.length,n=0;for(var r=0;r<u;r+=1){var i=o[r],s=i.numComponents,a=i.typedSetter,f=i.componentStride,c=0,h;do if(n<t){var d=arguments[n];n+=1;if(typeof d!="number"){if(c===0){var m=d.length;m>s&&(m=s);if(i.normalized){var g=i.normalizationScale;for(h=0;h<m;h+=1)a.call(v,p,d[h]*g,!0),p+=f,c+=1,l+=1}else for(h=0;h<m;h+=1)a.call(v,p,d[h],!0),p+=f,c+=1,l+=1;while(c<s)l+=1,c+=1;break}return TurbulenzEngine.callOnError("Missing values for attribute "+r),null}i.normalized&&(d*=i.normalizationScale),a.call(v,p,d,!0),p+=f,c+=1,l+=1}else l+=1,c+=1;while(c<s)}}}else f=function(){var t=arguments.length,n=0,r;for(var i=0;i<u;i+=1){var s=o[i],f=s.numComponents;r=new s.typedArray(a,p,f),p+=s.stride;var c=0,h;do if(n<t){var d=arguments[n];n+=1;if(typeof d!="number"){if(c===0){var v=d.length;v>f&&(v=f);if(s.normalized){var m=s.normalizationScale;for(h=0;h<v;h+=1)r[c]=d[h]*m,c+=1,l+=1}else for(h=0;h<v;h+=1)r[c]=d[h],c+=1,l+=1;while(c<f)c+=1,l+=1;break}return TurbulenzEngine.callOnError("Missing values for attribute "+i),null}s.normalized&&(d*=s.normalizationScale),r[c]=d,c+=1,l+=1}else c+=1,l+=1;while(c<f)}}}return f.data=a,f.offset=t,f.getNumWrittenVertices=function(){return Math.floor(l/s)},f.getNumWrittenValues=function(){return l},f.write=f,f},unmap:function(t){if(t){var n=t.data;delete t.data,delete t.write;var r=t.getNumWrittenVertices();if(!r)return;var i=t.offset,s=this.strideInBytes;if(this.hasSingleFormat){var o=t.getNumWrittenValues();o<n.length&&(n=n.subarray(0,o))}else{var u=r*s;u<n.byteLength&&(n=n.slice(0,u))}var a=this.gd,f=a.gl;a.bindVertexBuffer(this.glBuffer),r<this.numVertices?f.bufferSubData(f.ARRAY_BUFFER,i*s,n):f.bufferData(f.ARRAY_BUFFER,n,this.usage)}},setData:function(t,n,r){n===undefined&&(n=0),r===undefined&&(r=this.numVertices);var i=this.gd,s=i.gl,o=this.strideInBytes;if(t.constructor===ArrayBuffer){i.bindVertexBuffer(this.glBuffer),r<this.numVertices?s.bufferSubData(s.ARRAY_BUFFER,n*o,t):s.bufferData(s.ARRAY_BUFFER,t,this.usage);return}var u=this.attributes,a=this.numAttributes,f,l,c,h;if(this.hasSingleFormat){f=u[0],l=f.format,l===s.FLOAT?t instanceof Float32Array||(h=Float32Array):l===s.BYTE?t instanceof Int8Array||(h=Int8Array):l===s.UNSIGNED_BYTE?t instanceof Uint8Array||(h=Uint8Array):l===s.SHORT?t instanceof Int16Array||(h=Int16Array):l===s.UNSIGNED_SHORT?t instanceof Uint16Array||(h=Uint16Array):l===s.INT?t instanceof Int32Array||(h=Int32Array):l===s.UNSIGNED_INT&&(t instanceof Uint32Array||(h=Uint32Array));var p=this.stride,d=r*p;h?(f.normalized&&(t=this.scaleValues(t,f.normalizationScale,d)),c=new h(t),d<c.length&&(c=c.subarray(0,d))):c=t,d<t.length&&(c=c.subarray(0,d))}else{var v=r*o;c=new ArrayBuffer(v);var m=0,g=0,y,b,w,E,S,x;if(typeof DataView!="undefined"&&"setFloat32"in DataView.prototype){var T=new DataView(c);for(y=0;y<r;y+=1)for(w=0;w<a;w+=1){f=u[w],E=f.numComponents,S=f.componentStride;var N=f.typedSetter;if(f.normalized){x=f.normalizationScale;for(b=0;b<E;b+=1)N.call(T,g,t[m]*x,!0),g+=S,m+=1}else for(b=0;b<E;b+=1)N.call(T,g,t[m],!0),g+=S,m+=1}}else for(y=0;y<r;y+=1)for(w=0;w<a;w+=1){f=u[w],E=f.numComponents;var C=new f.typedArray(c,g,E);g+=f.stride;if(f.normalized){x=f.normalizationScale;for(b=0;b<E;b+=1)C[b]=t[m]*x,m+=1}else for(b=0;b<E;b+=1)C[b]=t[m],m+=1}}t=undefined,i.bindVertexBuffer(this.glBuffer),r<this.numVertices?s.bufferSubData(s.ARRAY_BUFFER,n*o,c):s.bufferData(s.ARRAY_BUFFER,c,this.usage)},scaleValues:function(t,n,r){r===undefined&&(r=t.length);var i=new t.constructor(r);for(var s=0;s<r;s+=1)i[s]=t[s]*n;return i},bindAttributes:function(t,n,r){var i=this.gd,s=i.gl,o=this.attributes,u=this.strideInBytes,a=0;for(var f=0;f<t;f+=1){var l=o[f],c=n[f];a|=1<<c,s.vertexAttribPointer(c,l.numComponents,l.format,l.normalized,u,r),r+=l.stride}return a},setAttributes:function(t){var n=this.gd,r=t.length;this.numAttributes=r,this.attributes=[];var i=0,s=0,o=!0;for(var u=0;u<r;u+=1){var a=t[u];typeof a=="string"&&(a=n["VERTEXFORMAT_"+a]),this.attributes[u]=a,i+=a.stride,s+=a.numComponents,o&&u&&a.format!==this.attributes[u-1].format&&(o=!1)}return this.strideInBytes=i,this.stride=s,this.hasSingleFormat=o,i},resize:function(t){if(t!==this.strideInBytes*this.numVertices){var n=this.gd,r=n.gl;n.bindVertexBuffer(this.glBuffer);var i=r.ARRAY_BUFFER;r.bufferData(i,t,this.usage);var s=r.getBufferParameter(i,r.BUFFER_SIZE);this.numVertices=Math.floor(s/this.strideInBytes)}},destroy:function(){var t=this.gd;if(t){var n=this.glBuffer;if(n){var r=t.gl;r&&(t.unbindVertexBuffer(n),r.deleteBuffer(n)),delete this.glBuffer}delete this.gd}}},y.create=function(t,n){var r=t.gl,i=new y;i.gd=t;var s=n.numVertices;i.numVertices=s;var o=i.setAttributes(n.attributes);i["transient"]=n["transient"]||!1,i.dynamic=n.dynamic||i["transient"],i.usage=i["transient"]?r.STREAM_DRAW:i.dynamic?r.DYNAMIC_DRAW:r.STATIC_DRAW,i.glBuffer=r.createBuffer();var u=s*o;return n.data?i.setData(n.data,0,s):(t.bindVertexBuffer(i.glBuffer),r.bufferData(r.ARRAY_BUFFER,u,i.usage)),i.id=++t.counters.vertexBuffers,i},b.prototype={version:1,updateParametersData:function(t){var n=t.gl;this.dirty=!1;var r=this.parameters;for(var i in r)if(r.hasOwnProperty(i)){var s=r[i];if(s.dirty){s.dirty=0;var o=s.info,u=s.location;if(o&&null!==u){var a=o.values,f;o.type==="float"?(f=o.columns,4===f?n.uniform4fv(u,a):3===f?n.uniform3fv(u,a):2===f?n.uniform2fv(u,a):1===o.rows?n.uniform1f(u,a[0]):n.uniform1fv(u,a)):o.sampler!==undefined?t.setTexture(s.textureUnit,a,o.sampler):(f=o.columns,4===f?n.uniform4iv(u,a):3===f?n.uniform3iv(u,a):2===f?n.uniform2iv(u,a):1===o.rows?n.uniform1i(u,a[0]):n.uniform1iv(u,a))}}}},initializeParameters:function(t){var n=t.gl,r=this.glProgram;t.setProgram(r);var i=this.parameters;for(var s in i)if(i.hasOwnProperty(s)){var o=i[s],u=o.info;if(u){var a=n.getUniformLocation(r,s);if(null!==a){o.location=a;if(u.sampler)n.uniform1i(a,o.textureUnit);else{var f=u.values,l;u.type==="float"?(l=u.columns,4===l?n.uniform4fv(a,f):3===l?n.uniform3fv(a,f):2===l?n.uniform2fv(a,f):1===u.rows?n.uniform1f(a,f[0]):n.uniform1fv(a,f)):(l=u.columns,4===l?n.uniform4iv(a,f):3===l?n.uniform3iv(a,f):2===l?n.uniform2iv(a,f):1===u.rows?n.uniform1i(a,f[0]):n.uniform1iv(a,f))}}}}},destroy:function(){delete this.glProgram,delete this.semanticsMask,delete this.parameters,delete this.states,delete this.statesSet}},b.create=function(t,n,r){function O(e,t){var n=e.length,r;for(r=0;r<n;r+=1)if(e[r]!==t[r])return!1;return!0}var i=t.gl,s=new b;s.name=r.name||null;var o=n.programs,u=n.parameters,a=r.parameters,f=r.programs,l=r.semantics,c=r.states,h=f.join(":"),p=n.linkedPrograms[h],d,v,m,g;if(p===undefined){d=i.createProgram();var y=f.length;for(m=0;m<y;m+=1){var w=o[f[m]];w&&i.attachShader(d,w)}var E=l.length;v=0;for(g=0;g<E;g+=1){var S=l[g],x=t["SEMANTIC_"+S];x!==undefined&&(v|=1<<x,i.bindAttribLocation(d,x,"ATTR"+x))}i.linkProgram(d),n.linkedPrograms[h]={glProgram:d,semanticsMask:v}}else d=p.glProgram,v=p.semanticsMask;s.glProgram=d,s.semanticsMask=v;var T=0,N={};s.parameters=N;var C=a?a.length:0;for(m=0;m<C;m+=1){var k=a[m],L={};N[k]=L;var A=u[k];L.info=A,A&&(L.location=null,A.sampler?(L.textureUnit=T,T+=1):L.textureUnit=undefined)}s.numTextureUnits=T,s.numParameters=C;var M=t.stateHandlers,_=[],D={};s.states=_,s.statesSet=D;for(g in c)if(c.hasOwnProperty(g)){var P=M[g];if(P){var H=P.parse(c[g]);if(H!==null){if(O(P.defaultValues,H))continue;_.push({name:g,set:P.set,reset:P.reset,values:H}),D[g]=!0}else TurbulenzEngine.callOnError("Unknown value for state "+g+": "+c[g])}}return s},w.prototype={version:1,getPass:function(t){var n=this.passes,r=n.length;if(typeof t=="string")for(var i=0;i<r;i+=1){var s=n[i];if(s.name===t)return s}else{t|=0;if(t<r)return n[t]}return null},activate:function(t){this.device=t,this.initialized||(this.shader.initialize(t),this.initialize(t))},deactivate:function(){this.device=null},checkProperties:function(t){var n={},r;for(r in this)r!=="version"&&r!=="name"&&r!=="id"&&r!=="passes"&&r!=="numPasses"&&r!=="device"&&r!=="numParameters"&&(n[r]=this[r]);if(n){var i=this.passes;i.length===1?t.setParametersImmediate(t,i,n):t.setParametersDeferred(t,i,n);for(r in n)n.hasOwnProperty(r)&&delete this[r]}},initialize:function(t){if(this.initialized)return;var n=this.passes;if(n){var r=n.length,i;for(i=0;i<r;i+=1)n[i].initializeParameters(t)}Object.defineProperty&&this.initializeParametersSetters(t),this.initialized=!0},initializeParametersSetters:function(t){function r(e,n){return function(r){this.device?t.setTexture(n.textureUnit,r,n.info.sampler):(e.dirty=!0,n.dirty=1,n.info.values=r)}}function i(e,t){function s(n){if(typeof n!="number"){var i=r.values,s=Math.min(r.numValues,n.length);for(var o=0;o<s;o+=1)i[o]=n[o];t.dirty=Math.max(s,t.dirty||0)}else r.values[0]=n,t.dirty=t.dirty||1;e.dirty=!0}var r=t.info,i=t.location;switch(r.columns){case 1:if(1===r.numValues)return function(e){this.device?n.uniform1f(i,e):s(e)};return function(e){this.device?n.uniform1fv(i,e):s(e)};case 2:return function(e){this.device?n.uniform2fv(i,e):s(e)};case 3:return function(e){this.device?n.uniform3fv(i,e):s(e)};case 4:return function(e){this.device?n.uniform4fv(i,e):s(e)};default:return null}}function s(e,t){function s(n){if(typeof n!="number"){var i=r.values,s=Math.min(r.numValues,n.length);for(var o=0;o<s;o+=1)i[o]=n[o];t.dirty=Math.max(s,t.dirty||0)}else r.values[0]=n,t.dirty=t.dirty||1;e.dirty=!0}var r=t.info,i=t.location;switch(r.columns){case 1:if(1===r.numValues)return function(e){this.device?n.uniform1i(i,e):s(e)};return function(e){this.device?n.uniform1iv(i,e):s(e)};case 2:return function(e){this.device?n.uniform2iv(i,e):s(e)};case 3:return function(e){this.device?n.uniform3iv(i,e):s(e)};case 4:return function(e){this.device?n.uniform4iv(i,e):s(e)};default:return null}}var n=t.gl,o=this.passes,u=o.length,a,f,l,c,h,p;if(u===1){a=o[0],f=a.parameters;for(l in f)f.hasOwnProperty(l)&&(c=f[l],h=c.info,h&&undefined!==c.location&&(h.sampler?p=r(a,c):h.type==="float"?p=i(a,c):p=s(a,c),Object.defineProperty(this,l,{set:p,enumerable:!1,configurable:!1})));this.checkProperties=null}else Object.defineProperty(this,"device",{writable:!0,enumerable:!1,configurable:!1}),Object.defineProperty(this,"version",{writable:!1,enumerable:!1,configurable:!1}),Object.defineProperty(this,"name",{writable:!1,enumerable:!1,configurable:!1}),Object.defineProperty(this,"id",{writable:!1,enumerable:!1,configurable:!1}),Object.defineProperty(this,"passes",{writable:!1,enumerable:!1,configurable:!1}),Object.defineProperty(this,"numParameters",{writable:!1,enumerable:!1,configurable:!1})},destroy:function(){var t=this.passes;if(t){var n=t.length,r;for(r=0;r<n;r+=1)t[r].destroy();t.length=0,delete this.passes}delete this.device}},w.create=function(t,n,r,i){var s=new w;s.initialized=!1,s.shader=n,s.name=r;var o=i.length,u,a=0;s.passes=[],s.numPasses=o;for(u=0;u<o;u+=1){var f=i[u];f.parameters&&(a+=f.parameters.length),s.passes[u]=b.create(t,n,f)}return s.numParameters=a,s.device=null,s.id=++t.counters.techniques,s},E.prototype={version:1,getTechnique:function(t){if(typeof t=="string")return this.techniques[t];var n=this.techniques;for(var r in n)if(n.hasOwnProperty(r)){if(t===0)return n[r];t-=1}return null},getParameter:function(t){if(typeof t=="string")return this.parameters[t];t|=0;var n=this.parameters;for(var r in n)if(n.hasOwnProperty(r)){if(t===0)return n[r];t-=1}return null},initialize:function(t){if(this.initialized)return;var n=t.gl,r,i=this.programs;for(r in i)if(i.hasOwnProperty(r)){var s=i[r],o=n.getShaderParameter(s,n.COMPILE_STATUS);if(!o){var u=n.getShaderInfoLog(s);TurbulenzEngine.callOnError('Program "'+r+'" failed to compile: '+u)}}var a=this.linkedPrograms;for(r in a)if(a.hasOwnProperty(r)){var f=a[r],l=f.glProgram;if(l){var c=n.getProgramParameter(l,n.LINK_STATUS);if(!c){var h=n.getProgramInfoLog(l);TurbulenzEngine.callOnError('Program "'+r+'" failed to link: '+h)}}}this.initialized=!0},destroy:function(){var t=this.gd;if(t){var n=t.gl,r,i=this.techniques;if(i){for(r in i)i.hasOwnProperty(r)&&i[r].destroy();delete this.techniques}var s=this.linkedPrograms;if(s){if(n)for(r in s)if(s.hasOwnProperty(r)){var o=s[r],u=o.glProgram;u&&(n.deleteProgram(u),delete o.glProgram)}delete this.linkedPrograms}var a=this.programs;if(a){if(n)for(r in a)a.hasOwnProperty(r)&&n.deleteShader(a[r]);delete this.programs}delete this.samplers,delete this.parameters,delete this.gd}}},E.create=function(t,n){var r=t.gl,i=new E;i.initialized=!1;var s=n.techniques,o=n.parameters,u=n.programs,a=n.samplers,f;i.gd=t,i.name=n.name;var l={};i.programs=l;for(f in u)if(u.hasOwnProperty(f)){var c=u[f],h;c.type==="fragment"?h=r.FRAGMENT_SHADER:c.type==="vertex"&&(h=r.VERTEX_SHADER);var p=r.createShader(h);r.shaderSource(p,c.code),r.compileShader(p),l[f]=p}var d={};i.linkedPrograms=d;var v=t.DEFAULT_SAMPLER,m=t.maxAnisotropy;i.samplers={};var g;for(f in a)if(a.hasOwnProperty(f)){g=a[f];var y=g.MaxAnisotropy;y?y>m&&(y=m):y=v.maxAnisotropy,g={minFilter:g.MinFilter||v.minFilter,magFilter:g.MagFilter||v.magFilter,wrapS:g.WrapS||v.wrapS,wrapT:g.WrapT||v.wrapT,wrapR:g.WrapR||v.wrapR,maxAnisotropy:y},g.wrapS===10496&&(g.wrapS=r.CLAMP_TO_EDGE),g.wrapT===10496&&(g.wrapT=r.CLAMP_TO_EDGE),g.wrapR===10496&&(g.wrapR=r.CLAMP_TO_EDGE),i.samplers[f]=t.createSampler(g)}var b=0;i.parameters={};for(f in o)if(o.hasOwnProperty(f)){var S=o[f];S.columns||(S.columns=1),S.rows||(S.rows=1),S.numValues=S.columns*S.rows;var x=S.type;if(x==="float"||x==="int"||x==="bool"){var T=S.values;T?x==="float"?S.values=new Float32Array(T):S.values=new Int32Array(T):x==="float"?S.values=new Float32Array(S.numValues):S.values=new Int32Array(S.numValues),S.sampler=undefined}else g=i.samplers[f],g||(g=v,i.samplers[f]=v),S.sampler=g,S.values=null;S.name=f,i.parameters[f]=S,b+=1}i.numParameters=b;var N={},C=0;i.techniques=N;for(f in s)s.hasOwnProperty(f)&&(N[f]=w.create(t,i,f,s[f]),C+=1);return i.numTechniques=C,i.id=++t.counters.shaders,i},S.create=function(t){var n=new S;if(t)for(var r in t)t.hasOwnProperty(r)&&(n[r]=t[r]);return n};var x=function(t){return Float32Array.prototype.map===undefined&&(Float32Array.prototype.map=function(t,n){function i(){var e=arguments.length;for(var n=0;n<e;n+=1){var i=arguments[n];typeof i=="number"?(r[t]=i,t+=1):(r.setData(i,t,i.length),t+=i.length)}}t===undefined&&(t=0);var r=this;return n===undefined&&(n=this.length),i},Float32Array.prototype.unmap=function(){},Float32Array.prototype.setData=function(t,n,r){n===undefined&&(n=0),r===undefined&&(r=this.length);for(var i=0;i<r;i+=1,n+=1)this[n]=t[i]}),new Float32Array(t.numFloats)};T.prototype={version:1,setTechniqueParameters:function(t,n){if(t<8){t+=48,this[t]=n;var r=this.endTechniqueParameters;if(n)r<=t&&(this.endTechniqueParameters=t+1);else{while(48<r&&!this[r-1])r-=1;this.endTechniqueParameters=r}}},setVertexBuffer:function(t,n){if(t<16){t*=3,this[t]=n;var r=this.endStreams;if(n)r<=t&&(this.endStreams=t+3);else{while(0<r&&!this[r-3])r-=3;this.endStreams=r}}},setSemantics:function(t,n){t<16&&(this[t*3+1]=n)},setOffset:function(t,n){t<16&&(this[t*3+2]=n)},getTechniqueParameters:function(t){return t<8?this[t+48]:undefined},getVertexBuffer:function(t){return t<16?this[t*3+0]:undefined},getSemantics:function(t){return t<16?this[t*3+1]:undefined},getOffset:function(t){return t<16?this[t*3+2]:undefined},addInstance:function(t){if(t){var n=this.endInstances;this.endInstances=n+1,this[n]=t}},removeInstances:function(){this.endInstances=56},getNumInstances:function(){return this.endInstances-56}},T.create=function(){return new T},N.prototype={version:1,SEMANTIC_POSITION:0,SEMANTIC_POSITION0:0,SEMANTIC_BLENDWEIGHT:1,SEMANTIC_BLENDWEIGHT0:1,SEMANTIC_NORMAL:2,SEMANTIC_NORMAL0:2,SEMANTIC_COLOR:3,SEMANTIC_COLOR0:3,SEMANTIC_COLOR1:4,SEMANTIC_SPECULAR:4,SEMANTIC_FOGCOORD:5,SEMANTIC_TESSFACTOR:5,SEMANTIC_PSIZE0:6,SEMANTIC_BLENDINDICES:7,SEMANTIC_BLENDINDICES0:7,SEMANTIC_TEXCOORD:8,SEMANTIC_TEXCOORD0:8,SEMANTIC_TEXCOORD1:9,SEMANTIC_TEXCOORD2:10,SEMANTIC_TEXCOORD3:11,SEMANTIC_TEXCOORD4:12,SEMANTIC_TEXCOORD5:13,SEMANTIC_TEXCOORD6:14,SEMANTIC_TEXCOORD7:15,SEMANTIC_TANGENT:14,SEMANTIC_TANGENT0:14,SEMANTIC_BINORMAL0:15,SEMANTIC_BINORMAL:15,SEMANTIC_PSIZE:6,SEMANTIC_ATTR0:0,SEMANTIC_ATTR1:1,SEMANTIC_ATTR2:2,SEMANTIC_ATTR3:3,SEMANTIC_ATTR4:4,SEMANTIC_ATTR5:5,SEMANTIC_ATTR6:6,SEMANTIC_ATTR7:7,SEMANTIC_ATTR8:8,SEMANTIC_ATTR9:9,SEMANTIC_ATTR10:10,SEMANTIC_ATTR11:11,SEMANTIC_ATTR12:12,SEMANTIC_ATTR13:13,SEMANTIC_ATTR14:14,SEMANTIC_ATTR15:15,PIXELFORMAT_A8:0,PIXELFORMAT_L8:1,PIXELFORMAT_L8A8:2,PIXELFORMAT_R5G5B5A1:3,PIXELFORMAT_R5G6B5:4,PIXELFORMAT_R4G4B4A4:5,PIXELFORMAT_R8G8B8A8:6,PIXELFORMAT_R8G8B8:7,PIXELFORMAT_D24S8:8,PIXELFORMAT_D16:9,PIXELFORMAT_DXT1:10,PIXELFORMAT_DXT3:11,PIXELFORMAT_DXT5:12,drawIndexed:function(t,n,r){var i=this.gl,s=this.activeIndexBuffer,o;r?o=r*s.stride:o=0;var u=s.format,a=this.attributeMask,f=this.activeTechnique,l=f.passes,c=l.length,h;f.checkProperties&&f.checkProperties(this);if(1===c)h=l[0].semanticsMask&a,h!==this.clientStateMask&&this.enableClientState(h),i.drawElements(t,n,u,o);else for(var p=0;p<c;p+=1){var d=l[p];h=d.semanticsMask&a,h!==this.clientStateMask&&this.enableClientState(h),this.setPass(d),i.drawElements(t,n,u,o)}},draw:function(t,n,r){var i=this.gl,s=this.attributeMask,o=this.activeTechnique,u=o.passes,a=u.length,f;o.checkProperties&&o.checkProperties(this);if(1===a)f=u[0].semanticsMask&s,f!==this.clientStateMask&&this.enableClientState(f),i.drawArrays(t,r,n);else for(var l=0;l<a;l+=1){var c=u[l];f=c.semanticsMask&s,f!==this.clientStateMask&&this.enableClientState(f),this.setPass(c),i.drawArrays(t,r,n)}},setTechniqueParameters:function(){var t=this.activeTechnique,n=t.passes,r=1===n.length?this.setParametersImmediate:this.setParametersDeferred,i=arguments.length;for(var s=0;s<i;s+=1)r(this,n,arguments[s])},setParametersImmediate:function(t,n,r){var i=t.gl,s=n[0].parameters;for(var o in r){var u=s[o];if(u!==undefined){var a=r[o];if(a!==undefined){var f=u.info,l,c;f.type==="float"?(l=f.columns,c=u.location,4===l?i.uniform4fv(c,a):3===l?i.uniform3fv(c,a):2===l?i.uniform2fv(c,a):1===f.rows?i.uniform1f(c,a):i.uniform1fv(c,a)):f.sampler!==undefined?t.setTexture(u.textureUnit,a,f.sampler):(l=f.columns,c=u.location,4===l?i.uniform4iv(c,a):3===l?i.uniform3iv(c,a):2===l?i.uniform2iv(c,a):1===f.rows?i.uniform1i(c,a):i.uniform1iv(c,a))}else delete r[o]}}},setParametersCaching:function(t,n,r){var i=t.gl,s=n[0].parameters;for(var o in r){var u=s[o];if(u!==undefined){var a=r[o];if(u.value!==a)if(a!==undefined){u.value=a;var f=u.info,l,c;f.type==="float"?(l=f.columns,c=u.location,4===l?i.uniform4fv(c,a):3===l?i.uniform3fv(c,a):2===l?i.uniform2fv(c,a):1===f.rows?i.uniform1f(c,a):i.uniform1fv(c,a)):f.sampler!==undefined?t.setTexture(u.textureUnit,a,f.sampler):(l=f.columns,c=u.location,4===l?i.uniform4iv(c,a):3===l?i.uniform3iv(c,a):2===l?i.uniform2iv(c,a):1===f.rows?i.uniform1i(c,a):i.uniform1iv(c,a))}else delete r[o]}}},setParametersDeferred:function(t,n,r){var i=n.length,s=Math.min,o=Math.max;for(var u=0;u<i;u+=1){var a=n[u],f=a.parameters;a.dirty=!0;for(var l in r){var c=f[l];if(c){var h=r[l];if(h!==undefined){var p=c.info;if(p.sampler)p.values=h,c.dirty=1;else if(typeof h!="number"){var d=p.values,v=s(p.numValues,h.length);for(var m=0;m<v;m+=1)d[m]=h[m];c.dirty=o(v,c.dirty||0)}else p.values[0]=h,c.dirty=c.dirty||1}else delete r[l]}}}},setTechnique:function(t){var n=this.activeTechnique;if(n!==t){n&&n.deactivate(),this.activeTechnique=t,t.activate(this);var r=t.passes;1===r.length&&this.setPass(r[0])}},setTechniqueCaching:function(t){var n=t.passes[0],r=this.activeTechnique;r!==t&&(r&&r.deactivate(),this.activeTechnique=t,t.activate(this),this.setPass(n));var i=n.parameters;for(var s in i)i.hasOwnProperty(s)&&(i[s].value=null)},setStream:function(t,n,r){r?r*=t.strideInBytes:r=0,this.bindVertexBuffer(t.glBuffer);var i=n,s=i.length;s>t.numAttributes&&(s=t.numAttributes),this.attributeMask|=t.bindAttributes(s,i,r)},setIndexBuffer:function(t){if(this.activeIndexBuffer!==t){this.activeIndexBuffer=t;var n;t?n=t.glBuffer:n=null;var r=this.gl;r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,n)}},drawArray:function(t,n,r){var i=this.gl,s=i.ELEMENT_ARRAY_BUFFER,o=this.setParametersCaching,u=this.setParametersDeferred,a=n.length,f=t.length;f>1&&r&&(r>0?t.sort(this._drawArraySortPositive):t.sort(this._drawArraySortNegative));var l=this.activeIndexBuffer,c=this.attributeMask,h=null,p=null,d=-1,v=null,m=null,g=0,y=!1,b=null,w=null,E=null,S=null,x=0,T=0,N=0,C=0,k=0;l&&(x=l.format,T=l.stride);for(var L=0;L<f;L+=1){var A=t[L],O=A.technique,M=A.endTechniqueParameters,_=A.endStreams,D=A.endInstances,P=A.indexBuffer,H=A.primitive,B=A.count,j=A.firstIndex;if(p!==O){p=O,w=O.passes,N=w.length,1===N?(this.setTechniqueCaching(O),h=o,C=w[0].semanticsMask&c,C!==this.clientStateMask&&this.enableClientState(C)):(this.setTechnique(O),h=u),O.checkProperties&&O.checkProperties(this);for(k=0;k<a;k+=1)h(this,w,n[k])}for(k=48;k<M;k+=1)m=A[k],m&&h(this,w,m);y=d===_;for(g=0;y&&g<_;g+=3)y=v[g]===A[g]&&v[g+1]===A[g+1]&&v[g+2]===A[g+2];if(!y){d=_,v=A;for(g=0;g<_;g+=3)b=A[g],b&&this.setStream(b,A[g+1],A[g+2]);c=this.attributeMask,1===N&&(C=w[0].semanticsMask&c,C!==this.clientStateMask&&this.enableClientState(C))}if(P){l!==P&&(l=P,i.bindBuffer(s,P.glBuffer),x=P.format,T=P.stride),j*=T;if(1===N){k=56;if(k<D){do h(this,w,A[k]),i.drawElements(H,B,x,j),k+=1;while(k<D)}else i.drawElements(H,B,x,j)}else{k=56;if(k<D){do{h(this,w,A[k]);for(E=0;E<N;E+=1)S=w[E],C=S.semanticsMask&c,C!==this.clientStateMask&&this.enableClientState(C),this.setPass(S),i.drawElements(H,B,x,j);k+=1}while(k<D)}else for(E=0;E<N;E+=1)S=w[E],C=S.semanticsMask&c,C!==this.clientStateMask&&this.enableClientState(C),this.setPass(S),i.drawElements(H,B,x,j)}}else if(1===N){k=56;if(k<D){do h(this,w,A[k]),i.drawArrays(H,j,B),k+=1;while(k<D)}else i.drawArrays(H,j,B)}else{k=56;if(k<D){do{h(this,w,A[k]);for(E=0;E<N;E+=1)S=w[E],C=S.semanticsMask&c,C!==this.clientStateMask&&this.enableClientState(C),this.setPass(S),i.drawArrays(H,j,B);k+=1}while(k<D)}else for(E=0;E<N;E+=1)S=w[E],C=S.semanticsMask&c,C!==this.clientStateMask&&this.enableClientState(C),this.setPass(S),i.drawArrays(H,j,B)}}this.activeIndexBuffer=l},beginDraw:function(t,n,r,i){this.immediatePrimitive=t;if(n){var s,o=this.immediateSemantics,u=i,a=u.length;o.length=a;for(s=0;s<a;s+=1){var f=u[s];typeof f=="string"&&(f=this["SEMANTIC_"+f]),o[s]=f}var l=this.immediateVertexBuffer,c=l.strideInBytes,h=c*l.numVertices,p=l.setAttributes(r);p!==c&&(l.numVertices=Math.floor(h/p));var d=p*n;return d>h&&l.resize(d),l.map(0,n)}return null},endDraw:function(t){var n=this.immediateVertexBuffer,r=t.getNumWrittenVertices();n.unmap(t);if(r){var i=this.gl,s=n.strideInBytes,o=0,u=n.attributes,a=this.immediateSemantics,f=a.length,l=0;for(var c=0;c<f;c+=1){var h=u[c],p=a[c];l|=1<<p,i.vertexAttribPointer(p,h.numComponents,h.format,h.normalized,s,o),o+=h.stride}this.attributeMask|=l,this.draw(this.immediatePrimitive,r,0)}},setViewport:function(t,n,r,i){var s=this.state.viewportBox;if(s[0]!==t||s[1]!==n||s[2]!==r||s[3]!==i)s[0]=t,s[1]=n,s[2]=r,s[3]=i,this.gl.viewport(t,n,r,i)},setScissor:function(t,n,r,i){var s=this.state.scissorBox;if(s[0]!==t||s[1]!==n||s[2]!==r||s[3]!==i)s[0]=t,s[1]=n,s[2]=r,s[3]=i,this.gl.scissor(t,n,r,i)},clear:function(t,n,r){var i=this.gl,s=this.state,o=0;if(t){o+=i.COLOR_BUFFER_BIT;var u=s.clearColor,a=t[0],f=t[1],l=t[2],c=t[3];if(u[0]!==a||u[1]!==f||u[2]!==l||u[3]!==c)u[0]=a,u[1]=f,u[2]=l,u[3]=c,i.clearColor(a,f,l,c)}typeof n=="number"&&(o+=i.DEPTH_BUFFER_BIT,s.clearDepth!==n&&(s.clearDepth=n,i.clearDepth(n)),typeof r=="number"&&(o+=i.STENCIL_BUFFER_BIT,s.clearStencil!==r&&(s.clearStencil=r,i.clearStencil(r))));if(o){var h=s.colorMask,p=h[0]||h[1]||h[2]||h[3],d=s.depthMask,v=s.program;t&&(p||i.colorMask(!0,!0,!0,!0)),typeof n=="number"&&(d||i.depthMask(!0)),v&&i.useProgram(null),i.clear(o),t&&(p||i.colorMask(!1,!1,!1,!1)),typeof n=="number"&&(d||i.depthMask(!1)),v&&i.useProgram(v)}},beginFrame:function(){var t=this.gl;this.attributeMask=0;var n=this.clientStateMask,r;if(n){for(r=0;r<16;r+=1)n&1<<r&&t.disableVertexAttribArray(r);this.clientStateMask=0}return this.resetStates(),this.setScissor(0,0,this.width,this.height),this.setViewport(0,0,this.width,this.height),!document.hidden&&!document.webkitHidden},beginRenderTarget:function(t){return this.activeRenderTarget=t,t.bind()},endRenderTarget:function(){this.activeRenderTarget.unbind(),this.activeRenderTarget=null},beginOcclusionQuery:function(){return!1},endOcclusionQuery:function(){},endFrame:function(){var t=this.gl;this.activeTechnique&&(this.activeTechnique.deactivate(),this.activeTechnique=null),this.activeIndexBuffer&&this.setIndexBuffer(null);var n=this.state;n.program&&(n.program=null,t.useProgram(null)),this.numFrames+=1;var r=TurbulenzEngine.getTime(),i=r-this.previousFrameTime;i>=1e3&&(this.fps=this.numFrames/(i*.001),this.numFrames=0,this.previousFrameTime=r);var s=t.canvas,o=t.drawingBufferWidth||s.width,u=t.drawingBufferHeight||s.height;if(this.width!==o||this.height!==u)this.width=o,this.height=u,this.setViewport(0,0,o,u),this.setScissor(0,0,o,u);this.checkFullScreen()},createTechniqueParameters:function(t){return S.create(t)},createSemantics:function(t){return g.create(this,t)},createVertexBuffer:function(t){return y.create(this,t)},createIndexBuffer:function(t){return m.create(this,t)},createTexture:function(t){return h.create(this,t)},createVideo:function(t){return p.create(t)},createShader:function(t){return E.create(this,t)},createTechniqueParameterBuffer:function(t){return x(t)},createRenderBuffer:function(t){return d.create(this,t)},createRenderTarget:function(t){return v.create(this,t)},createOcclusionQuery:function(){return null},createDrawParameters:function(t){return T.create(t)},isSupported:function(t){var n=this.gl;if("OCCLUSION_QUERIES"===t)return!1;if("NPOT_MIPMAPPED_TEXTURES"===t)return!1;if("TEXTURE_DXT1"===t||"TEXTURE_DXT3"===t||"TEXTURE_DXT5"===t){var r=this.compressedTexturesExtension;if(r){var i=n.getParameter(n.COMPRESSED_TEXTURE_FORMATS);if(i){var s;"TEXTURE_DXT1"===t?s=r.COMPRESSED_RGBA_S3TC_DXT1_EXT:"TEXTURE_DXT3"===t?s=r.COMPRESSED_RGBA_S3TC_DXT3_EXT:s=r.COMPRESSED_RGBA_S3TC_DXT5_EXT;var o=i.length;for(var u=0;u<o;u+=1)if(i[u]===s)return!0}}return!1}return"TEXTURE_ETC1"===t?!1:"INDEXFORMAT_UINT"===t?n.getExtension("OES_element_index_uint")?!0:!1:"FILEFORMAT_WEBM"===t?"webm"in this.supportedVideoExtensions:"FILEFORMAT_MP4"===t?"mp4"in this.supportedVideoExtensions:"FILEFORMAT_JPG"===t?!0:"FILEFORMAT_PNG"===t?!0:"FILEFORMAT_DDS"===t?typeof c!="undefined":"FILEFORMAT_TGA"===t?typeof vt!="undefined":undefined},maxSupported:function(t){var n=this.gl;if("ANISOTROPY"===t)return this.maxAnisotropy;if("TEXTURE_SIZE"===t)return n.getParameter(n.MAX_TEXTURE_SIZE);if("CUBEMAP_TEXTURE_SIZE"===t)return n.getParameter(n.MAX_CUBE_MAP_TEXTURE_SIZE);if("3D_TEXTURE_SIZE"===t)return 0;if("RENDERTARGET_COLOR_TEXTURES"===t)return this.drawBuffersExtension?this.WEBGL_draw_buffers?n.getParameter(this.drawBuffersExtension.MAX_COLOR_ATTACHMENTS_WEBGL):n.getParameter(this.drawBuffersExtension.MAX_COLOR_ATTACHMENTS_EXT):1;return"RENDERBUFFER_SIZE"===t?n.getParameter(n.MAX_RENDERBUFFER_SIZE):0},loadTexturesArchive:function(t){var n=t.src;return typeof dt!="undefined"?(dt.create({gd:this,src:n,mipmaps:t.mipmaps,ontextureload:function(n){t.ontextureload(n)},onload:function(n,r){t.onload&&t.onload(!0,r)},onerror:function(){t.onload&&t.onload(!1,status)}}),!0):(TurbulenzEngine.callOnError("Missing archive loader required for "+n),!1)},getScreenshot:function(t,n,r,i,s){var o=this.gl,u=o.canvas;if(t)return u.toDataURL("image/jpeg");n===undefined&&(n=0),r===undefined&&(r=0);var a=this.activeRenderTarget;a||(a=u),i===undefined&&(i=a.width),s===undefined&&(s=a.height);var f=new Uint8Array(4*i*s);return o.readPixels(n,r,i,s,o.RGBA,o.UNSIGNED_BYTE,f),f},flush:function(){this.gl.flush()},finish:function(){this.gl.finish()},_drawArraySortPositive:function(t,n){return n.sortKey-t.sortKey},_drawArraySortNegative:function(t,n){return t.sortKey-n.sortKey},checkFullScreen:function(){var t=this.fullscreen;this.oldFullscreen!==t&&(this.oldFullscreen=t,this.requestFullScreen(t))},requestFullScreen:function(t){if(t){var n=this.gl.canvas;n.webkitRequestFullScreenWithKeys?n.webkitRequestFullScreenWithKeys():n.requestFullScreenWithKeys?n.requestFullScreenWithKeys():n.webkitRequestFullScreen?n.webkitRequestFullScreen(n.ALLOW_KEYBOARD_INPUT):n.mozRequestFullScreen?n.mozRequestFullScreen():n.requestFullScreen?n.requestFullScreen():n.requestFullscreen&&n.requestFullscreen()}else document.webkitCancelFullScreen?document.webkitCancelFullScreen():document.cancelFullScreen?document.cancelFullScreen():document.exitFullscreen&&document.exitFullscreen()},createSampler:function(t){var n=t.minFilter.toString()+":"+t.magFilter.toString()+":"+t.wrapS.toString()+":"+t.wrapT.toString()+":"+t.wrapR.toString()+":"+t.maxAnisotropy.toString(),r=this.cachedSamplers,i=r[n];return i?i:(r[n]=t,t)},unsetIndexBuffer:function(t){if(this.activeIndexBuffer===t){this.activeIndexBuffer=null;var n=this.gl;n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null)}},bindVertexBuffer:function(t){if(this.bindedVertexBuffer!==t){this.bindedVertexBuffer=t;var n=this.gl;n.bindBuffer(n.ARRAY_BUFFER,t)}},unbindVertexBuffer:function(t){if(this.bindedVertexBuffer===t){this.bindedVertexBuffer=null;var n=this.gl;n.bindBuffer(n.ARRAY_BUFFER,null)}},bindTextureUnit:function(t,n,r){var i=this.state,s=this.gl;i.activeTextureUnit!==t&&(i.activeTextureUnit=t,s.activeTexture(s.TEXTURE0+t)),s.bindTexture(n,r)},bindTexture:function(t,n){var r=this.state,i=this.gl,s=r.maxTextureUnit-1;r.activeTextureUnit!==s&&(r.activeTextureUnit=s,i.activeTexture(i.TEXTURE0+s)),i.bindTexture(t,n)},unbindTexture:function(t){var n=this.state,r=n.lastMaxTextureUnit,i=n.textureUnits;for(var s=0;s<r;s+=1){var o=i[s];o.texture===t&&(o.texture=null,this.bindTextureUnit(s,o.target,null))}},setSampler:function(t,n){if(t){var r=this.gl;r.texParameteri(n,r.TEXTURE_MIN_FILTER,t.minFilter),r.texParameteri(n,r.TEXTURE_MAG_FILTER,t.magFilter),r.texParameteri(n,r.TEXTURE_WRAP_S,t.wrapS),r.texParameteri(n,r.TEXTURE_WRAP_T,t.wrapT),this.TEXTURE_MAX_ANISOTROPY_EXT&&r.texParameteri(n,this.TEXTURE_MAX_ANISOTROPY_EXT,t.maxAnisotropy)}},setPass:function(t){var n=this.gl,r=this.state,i=t.statesSet,s=t.states,o=s.length,u,a;for(u=0;u<o;u+=1)a=s[u],a.set.apply(a,a.values);var f=r.renderStatesToReset,l=f.length;for(u=0;u<l;u+=1)a=f[u],a.name in i||a.reset();r.renderStatesToReset=s;var c=r.lastMaxTextureUnit,h=r.textureUnits,p=t.numTextureUnits;if(p<c){var d=p;do{var v=h[d];v.texture&&(v.texture=null,this.bindTextureUnit(d,v.target,null)),d+=1}while(d<c)}r.lastMaxTextureUnit=p;var m=t.glProgram;r.program!==m&&(r.program=m,n.useProgram(m)),t.dirty&&t.updateParametersData(this)},enableClientState:function(t)
{var n=this.gl,r=this.clientStateMask;this.clientStateMask=t;var i=r&~t,s=~r&t,o;if(i){(i&255)===0?(i>>=8,o=8):o=0;do 0!==(1&i)&&n.disableVertexAttribArray(o),o+=1,i>>=1;while(i)}if(s){(s&255)===0?(s>>=8,o=8):o=0;do 0!==(1&s)&&n.enableVertexAttribArray(o),o+=1,s>>=1;while(s)}},setTexture:function(t,n,r){var i=this.state,s=this.gl,o=i.textureUnits[t],u=o.target,a=o.texture;if(n){var f=n.target,l=n.glTexture;if(a!==l||u!==f)o.target=f,o.texture=l,i.activeTextureUnit!==t&&(i.activeTextureUnit=t,s.activeTexture(s.TEXTURE0+t)),u!==f&&a&&s.bindTexture(u,null),s.bindTexture(f,l),n.sampler!==r&&(n.sampler=r,this.setSampler(r,f))}else u&&a&&(o.target=0,o.texture=null,i.activeTextureUnit!==t&&(i.activeTextureUnit=t,s.activeTexture(s.TEXTURE0+t)),s.bindTexture(u,null))},setProgram:function(t){var n=this.state;n.program!==t&&(n.program=t,this.gl.useProgram(t))},syncState:function(){var t=this.state,n=this.gl;t.depthTestEnable?n.enable(n.DEPTH_TEST):n.disable(n.DEPTH_TEST),n.depthFunc(t.depthFunc),n.depthMask(t.depthMask),t.blendEnable?n.enable(n.BLEND):n.disable(n.BLEND),n.blendFunc(t.blendSrc,t.blendDst),t.cullFaceEnable?n.enable(n.CULL_FACE):n.disable(n.CULL_FACE),n.cullFace(t.cullFace),n.frontFace(t.frontFace);var r=t.colorMask;n.colorMask(r[0],r[1],r[2],r[3]),t.stencilTestEnable?n.enable(n.STENCIL_TEST):n.disable(n.STENCIL_TEST),n.stencilFunc(t.stencilFunc,t.stencilRef,t.stencilMask),n.stencilOp(t.stencilFail,t.stencilZFail,t.stencilZPass),t.polygonOffsetFillEnable?n.enable(n.POLYGON_OFFSET_FILL):n.disable(n.POLYGON_OFFSET_FILL),n.polygonOffset(t.polygonOffsetFactor,t.polygonOffsetUnits),n.lineWidth(t.lineWidth),n.activeTexture(n.TEXTURE0+t.activeTextureUnit);var i=this.state.viewportBox;n.viewport(i[0],i[1],i[2],i[3]),i=this.state.scissorBox,n.scissor(i[0],i[1],i[2],i[3]);var s=t.clearColor;n.clearColor(s[0],s[1],s[2],s[3]),n.clearDepth(t.clearDepth),n.clearStencil(t.clearStencil)},resetStates:function(){var t=this.state,n=t.lastMaxTextureUnit,r=t.textureUnits;for(var i=0;i<n;i+=1){var s=r[i];s.texture&&(this.bindTextureUnit(i,s.target,null),s.texture=null,s.target=0)}},destroy:function(){delete this.activeTechnique,delete this.activeIndexBuffer,delete this.bindedVertexBuffer,this.immediateVertexBuffer&&(this.immediateVertexBuffer.destroy(),delete this.immediateVertexBuffer),delete this.gl}},N.create=function(t,n){function C(e){T.depthTestEnable!==e&&(T.depthTestEnable=e,e?i.enable(i.DEPTH_TEST):i.disable(i.DEPTH_TEST))}function k(e){T.depthFunc!==e&&(T.depthFunc=e,i.depthFunc(e))}function L(e){T.depthMask!==e&&(T.depthMask=e,i.depthMask(e))}function A(e){T.blendEnable!==e&&(T.blendEnable=e,e?i.enable(i.BLEND):i.disable(i.BLEND))}function O(e,t){if(T.blendSrc!==e||T.blendDst!==t)T.blendSrc=e,T.blendDst=t,i.blendFunc(e,t)}function M(e){T.cullFaceEnable!==e&&(T.cullFaceEnable=e,e?i.enable(i.CULL_FACE):i.disable(i.CULL_FACE))}function _(e){T.cullFace!==e&&(T.cullFace=e,i.cullFace(e))}function D(e){T.frontFace!==e&&(T.frontFace=e,i.frontFace(e))}function P(e,t,n,r){var s=T.colorMask;if(s[0]!==e||s[1]!==t||s[2]!==n||s[3]!==r)s[0]=e,s[1]=t,s[2]=n,s[3]=r,i.colorMask(e,t,n,r)}function H(e){T.stencilTestEnable!==e&&(T.stencilTestEnable=e,e?i.enable(i.STENCIL_TEST):i.disable(i.STENCIL_TEST))}function B(e,t,n){if(T.stencilFunc!==e||T.stencilRef!==t||T.stencilMask!==n)T.stencilFunc=e,T.stencilRef=t,T.stencilMask=n,i.stencilFunc(e,t,n)}function j(e,t,n){if(T.stencilFail!==e||T.stencilZFail!==t||T.stencilZPass!==n)T.stencilFail=e,T.stencilZFail=t,T.stencilZPass=n,i.stencilOp(e,t,n)}function F(e){T.polygonOffsetFillEnable!==e&&(T.polygonOffsetFillEnable=e,e?i.enable(i.POLYGON_OFFSET_FILL):i.disable(i.POLYGON_OFFSET_FILL))}function I(e,t){if(T.polygonOffsetFactor!==e||T.polygonOffsetUnits!==t)T.polygonOffsetFactor=e,T.polygonOffsetUnits=t,i.polygonOffset(e,t)}function q(e){T.lineWidth!==e&&(T.lineWidth=e,i.lineWidth(e))}function R(){T.depthTestEnable||(T.depthTestEnable=!0,i.enable(i.DEPTH_TEST))}function U(){var e=m;T.depthFunc!==e&&(T.depthFunc=e,i.depthFunc(e))}function z(){T.depthMask||(T.depthMask=!0,i.depthMask(!0))}function W(){T.blendEnable&&(T.blendEnable=!1,i.disable(i.BLEND))}function X(){var e=y,t=b;if(T.blendSrc!==e||T.blendDst!==t)T.blendSrc=e,T.blendDst=t,i.blendFunc(e,t)}function V(){T.cullFaceEnable||(T.cullFaceEnable=!0,i.enable(i.CULL_FACE))}function $(){var e=w;T.cullFace!==e&&(T.cullFace=e,i.cullFace(e))}function J(){var e=E;T.frontFace!==e&&(T.frontFace=e,i.frontFace(e))}function K(){var e=T.colorMask;if(e[0]!==!0||e[1]!==!0||e[2]!==!0||e[3]!==!0)e[0]=!0,e[1]=!0,e[2]=!0,e[3]=!0,i.colorMask(!0,!0,!0,!0)}function Q(){T.stencilTestEnable&&(T.stencilTestEnable=!1,i.disable(i.STENCIL_TEST))}function G(){var e=S;if(T.stencilFunc!==e||T.stencilRef!==0||T.stencilMask!==4294967295)T.stencilFunc=e,T.stencilRef=0,T.stencilMask=4294967295,i.stencilFunc(e,0,4294967295)}function Y(){var e=x;if(T.stencilFail!==e||T.stencilZFail!==e||T.stencilZPass!==e)T.stencilFail=e,T.stencilZFail=e,T.stencilZPass=e,i.stencilOp(e,e,e)}function Z(){T.polygonOffsetFillEnable&&(T.polygonOffsetFillEnable=!1,i.disable(i.POLYGON_OFFSET_FILL))}function et(){if(T.polygonOffsetFactor!==0||T.polygonOffsetUnits!==0)T.polygonOffsetFactor=0,T.polygonOffsetUnits=0,i.polygonOffset(0,0)}function tt(){T.lineWidth!==1&&(T.lineWidth=1,i.lineWidth(1))}function nt(e){return typeof e!="boolean"?[e?!0:!1]:[e]}function rt(e){return typeof e!="number"?null:[e]}function it(e){if(typeof e=="object"){var t=e[0],n=e[1];return typeof t!="number"?null:typeof n!="number"?null:[t,n]}return null}function st(e){if(typeof e=="object"){var t=e[0],n=e[1],r=e[2];return typeof t!="number"?null:typeof n!="number"?null:typeof r!="number"?null:[t,n,r]}return null}function ot(e){return typeof e!="number"?null:[e]}function ut(e){if(typeof e=="object"){var t=e[0],n=e[1];return typeof t!="number"?null:typeof n!="number"?null:[t,n]}return null}function at(e){if(typeof e=="object"){var t=e[0],n=e[1],r=e[2],i=e[3];return typeof t!="number"?null:typeof n!="number"?null:typeof r!="number"?null:typeof i!="number"?null:[t,n,r,i]}return null}var r=function(t,n,r){if(t.getContext){var i={alpha:!1,stencil:!0,antialias:!1},s=n.multisample;s!==undefined&&1<s&&(i.antialias=!0);var o=r.length,u;for(u=0;u<o;u+=1)try{var a=t.getContext(r[u],i);if(a)return a}catch(f){}}return null},i=r(t,n,["webgl","experimental-webgl"]);if(!i)return null;var s=i.drawingBufferWidth||t.width,o=i.drawingBufferHeight||t.height;i.enable(i.SCISSOR_TEST),i.depthRange(0,1),i.pixelStorei(i.UNPACK_ALIGNMENT,1);var u=new N;u.gl=i,u.width=s,u.height=o;var a=i.getSupportedExtensions();a?a=a.join(" "):a="",u.extensions=a,u.shadingLanguageVersion=i.getParameter(i.SHADING_LANGUAGE_VERSION),u.rendererVersion=i.getParameter(i.VERSION),u.renderer=i.getParameter(i.RENDERER),u.vendor=i.getParameter(i.VENDOR),a.indexOf("WEBGL_compressed_texture_s3tc")!==-1?(u.WEBGL_compressed_texture_s3tc=!0,a.indexOf("WEBKIT_WEBGL_compressed_texture_s3tc")!==-1?u.compressedTexturesExtension=i.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"):a.indexOf("MOZ_WEBGL_compressed_texture_s3tc")!==-1?u.compressedTexturesExtension=i.getExtension("MOZ_WEBGL_compressed_texture_s3tc"):u.compressedTexturesExtension=i.getExtension("WEBGL_compressed_texture_s3tc")):a.indexOf("WEBKIT_WEBGL_compressed_textures")!==-1&&(u.compressedTexturesExtension=i.getExtension("WEBKIT_WEBGL_compressed_textures"));var f;a.indexOf("EXT_texture_filter_anisotropic")!==-1&&(a.indexOf("MOZ_EXT_texture_filter_anisotropic")!==-1?f=i.getExtension("MOZ_EXT_texture_filter_anisotropic"):a.indexOf("WEBKIT_EXT_texture_filter_anisotropic")!==-1?f=i.getExtension("WEBKIT_EXT_texture_filter_anisotropic"):f=i.getExtension("EXT_texture_filter_anisotropic")),f?(u.TEXTURE_MAX_ANISOTROPY_EXT=f.TEXTURE_MAX_ANISOTROPY_EXT,u.maxAnisotropy=i.getParameter(f.MAX_TEXTURE_MAX_ANISOTROPY_EXT)):u.maxAnisotropy=1,i.getExtension("OES_element_index_uint"),a.indexOf("WEBGL_draw_buffers")!==-1?(u.WEBGL_draw_buffers=!0,u.drawBuffersExtension=i.getExtension("WEBGL_draw_buffers")):a.indexOf("EXT_draw_buffers")!==-1&&(u.drawBuffersExtension=i.getExtension("EXT_draw_buffers")),u.PRIMITIVE_POINTS=i.POINTS,u.PRIMITIVE_LINES=i.LINES,u.PRIMITIVE_LINE_LOOP=i.LINE_LOOP,u.PRIMITIVE_LINE_STRIP=i.LINE_STRIP,u.PRIMITIVE_TRIANGLES=i.TRIANGLES,u.PRIMITIVE_TRIANGLE_STRIP=i.TRIANGLE_STRIP,u.PRIMITIVE_TRIANGLE_FAN=i.TRIANGLE_FAN,u.INDEXFORMAT_UBYTE=i.UNSIGNED_BYTE,u.INDEXFORMAT_USHORT=i.UNSIGNED_SHORT,u.INDEXFORMAT_UINT=i.UNSIGNED_INT;var l=function(t){return t===i.BYTE?127:t===i.UNSIGNED_BYTE?255:t===i.SHORT?32767:t===i.UNSIGNED_SHORT?65535:t===i.INT?2147483647:t===i.UNSIGNED_INT?4294967295:1},c=function(t,n,r,s,o){var u={numComponents:n,stride:r,componentStride:r/n,format:s,name:o,normalized:undefined,normalizationScale:undefined,typedSetter:undefined,typedArray:undefined};return t?(u.normalized=!0,u.normalizationScale=l(s)):(u.normalized=!1,u.normalizationScale=1),typeof DataView!="undefined"&&"setFloat32"in DataView.prototype?s===i.BYTE?u.typedSetter=DataView.prototype.setInt8:s===i.UNSIGNED_BYTE?u.typedSetter=DataView.prototype.setUint8:s===i.SHORT?u.typedSetter=DataView.prototype.setInt16:s===i.UNSIGNED_SHORT?u.typedSetter=DataView.prototype.setUint16:s===i.INT?u.typedSetter=DataView.prototype.setInt32:s===i.UNSIGNED_INT?u.typedSetter=DataView.prototype.setUint32:u.typedSetter=DataView.prototype.setFloat32:s===i.BYTE?u.typedArray=Int8Array:s===i.UNSIGNED_BYTE?u.typedArray=Uint8Array:s===i.SHORT?u.typedArray=Int16Array:s===i.UNSIGNED_SHORT?u.typedArray=Uint16Array:s===i.INT?u.typedArray=Int32Array:s===i.UNSIGNED_INT?u.typedArray=Uint32Array:u.typedArray=Float32Array,u};u.VERTEXFORMAT_BYTE4=c(0,4,4,i.BYTE,"BYTE4"),u.VERTEXFORMAT_BYTE4N=c(1,4,4,i.BYTE,"BYTE4N"),u.VERTEXFORMAT_UBYTE4=c(0,4,4,i.UNSIGNED_BYTE,"UBYTE4"),u.VERTEXFORMAT_UBYTE4N=c(1,4,4,i.UNSIGNED_BYTE,"UBYTE4N"),u.VERTEXFORMAT_SHORT2=c(0,2,4,i.SHORT,"SHORT2"),u.VERTEXFORMAT_SHORT2N=c(1,2,4,i.SHORT,"SHORT2N"),u.VERTEXFORMAT_SHORT4=c(0,4,8,i.SHORT,"SHORT4"),u.VERTEXFORMAT_SHORT4N=c(1,4,8,i.SHORT,"SHORT4N"),u.VERTEXFORMAT_USHORT2=c(0,2,4,i.UNSIGNED_SHORT,"USHORT2"),u.VERTEXFORMAT_USHORT2N=c(1,2,4,i.UNSIGNED_SHORT,"USHORT2N"),u.VERTEXFORMAT_USHORT4=c(0,4,8,i.UNSIGNED_SHORT,"USHORT4"),u.VERTEXFORMAT_USHORT4N=c(1,4,8,i.UNSIGNED_SHORT,"USHORT4N"),u.VERTEXFORMAT_FLOAT1=c(0,1,4,i.FLOAT,"FLOAT1"),u.VERTEXFORMAT_FLOAT2=c(0,2,8,i.FLOAT,"FLOAT2"),u.VERTEXFORMAT_FLOAT3=c(0,3,12,i.FLOAT,"FLOAT3"),u.VERTEXFORMAT_FLOAT4=c(0,4,16,i.FLOAT,"FLOAT4"),u.DEFAULT_SAMPLER={minFilter:i.LINEAR_MIPMAP_LINEAR,magFilter:i.LINEAR,wrapS:i.REPEAT,wrapT:i.REPEAT,wrapR:i.REPEAT,maxAnisotropy:1},u.cachedSamplers={};var h=1,p=i.getParameter(i.MAX_TEXTURE_IMAGE_UNITS);h<p&&(h=p),p=i.getParameter(i.MAX_COMBINED_TEXTURE_IMAGE_UNITS),h<p&&(h=p);var d=[];d.length=h;for(var v=0;v<h;v+=1)d[v]={texture:null,target:0};var m=i.LEQUAL,y=i.SRC_ALPHA,b=i.ONE_MINUS_SRC_ALPHA,w=i.BACK,E=i.CCW,S=i.ALWAYS,x=i.KEEP,T={depthTestEnable:!0,blendEnable:!1,cullFaceEnable:!0,stencilTestEnable:!1,polygonOffsetFillEnable:!1,depthMask:!0,depthFunc:m,blendSrc:y,blendDst:b,cullFace:w,frontFace:E,colorMask:[!0,!0,!0,!0],stencilFunc:S,stencilRef:0,stencilMask:4294967295,stencilFail:x,stencilZFail:x,stencilZPass:x,polygonOffsetFactor:0,polygonOffsetUnits:0,lineWidth:1,renderStatesToReset:[],viewportBox:[0,0,s,o],scissorBox:[0,0,s,o],clearColor:[0,0,0,1],clearDepth:1,clearStencil:0,activeTextureUnit:0,maxTextureUnit:h,lastMaxTextureUnit:0,textureUnits:d,program:null};u.state=T,u.counters={textures:0,vertexBuffers:0,indexBuffers:0,renderTargets:0,renderBuffers:0,shaders:0,techniques:0};var ft={},lt=function(t,n,r,i,s){ft[t]={set:n,reset:r,parse:i,defaultValues:s}};lt("DepthTestEnable",C,R,nt,[!0]),lt("DepthFunc",k,U,rt,[m]),lt("DepthMask",L,z,nt,[!0]),lt("BlendEnable",A,W,nt,[!1]),lt("BlendFunc",O,X,it,[y,b]),lt("CullFaceEnable",M,V,nt,[!0]),lt("CullFace",_,$,rt,[w]),lt("FrontFace",D,J,rt,[E]),lt("ColorMask",P,K,at,[!0,!0,!0,!0]),lt("StencilTestEnable",H,Q,nt,[!1]),lt("StencilFunc",B,G,st,[S,0,4294967295]),lt("StencilOp",j,Y,st,[x,x,x]),lt("PolygonOffsetFillEnable",F,Z,nt,[!1]),lt("PolygonOffset",I,et,ut,[0,0]),lt("LineWidth",q,tt,ot,[1]),u.stateHandlers=ft,u.syncState(),u.videoRam=0,u.desktopWidth=window.screen.width,u.desktopHeight=window.screen.height,Object.defineProperty?(Object.defineProperty(u,"fullscreen",{get:function(){return document.fullscreenEnabled||document.mozFullScreen||document.webkitIsFullScreen||!1},set:function(t){u.requestFullScreen(t)},enumerable:!0,configurable:!1}),u.checkFullScreen=function(){}):(u.fullscreen=!1,u.oldFullscreen=!1),u.clientStateMask=0,u.attributeMask=0,u.activeTechnique=null,u.activeIndexBuffer=null,u.bindedVertexBuffer=null,u.activeRenderTarget=null,u.immediateVertexBuffer=u.createVertexBuffer({numVertices:16384,attributes:["FLOAT4"],dynamic:!0,"transient":!0}),u.immediatePrimitive=-1,u.immediateSemantics=g.create(this,[]),u.fps=0,u.numFrames=0,u.previousFrameTime=TurbulenzEngine.getTime();var ct=document.createElement("video"),ht={};return ct&&(ct.canPlayType("video/webm")&&(ht.webm=!0),ct.canPlayType("video/mp4")&&(ht.mp4=!0)),u.supportedVideoExtensions=ht,ct=null,u},C.prototype={version:1,update:function(){if(!this.isWindowFocused)return;this.updateGamePad()},addEventListener:function(t,n){var r,i,s;if(this.handlers.hasOwnProperty(t)){s=this.handlers[t];if(n){i=s.length;for(r=0;r<i;r+=1)if(s[r]===n)return;s.push(n)}}},removeEventListener:function(t,n){var r,i,s;if(this.handlers.hasOwnProperty(t)){s=this.handlers[t];if(n){i=s.length;for(r=0;r<i;r+=1)if(s[r]===n){s.splice(r,1);break}}}},lockMouse:function(){return this.isHovering&&this.isWindowFocused?(this.isMouseLocked=!0,this.hideMouse(),this.requestBrowserLock(),this.setEventHandlersLock(),!0):!1},unlockMouse:function(){return this.isMouseLocked?(this.isMouseLocked=!1,this.showMouse(),this.requestBrowserUnlock(),this.setEventHandlersUnlock(),this.isOutsideEngine&&(this.isOutsideEngine=!1,this.isHovering=!1,this.setEventHandlersMouseLeave(),this.sendEventToHandlers(this.handlers.mouseleave)),this.sendEventToHandlers(this.handlers.mouselocklost),!0):!1},isLocked:function(){return this.isMouseLocked},hideMouse:function(){return this.isHovering?(this.isCursorHidden||(this.isCursorHidden=!0,this.previousCursor=document.body.style.cursor,document.body.style.cursor="none",this.webkit&&(this.ignoreNextMouseMoves=2)),!0):!1},showMouse:function(){return this.isCursorHidden&&!this.isMouseLocked?(this.isCursorHidden=!1,document.body.style.cursor=this.previousCursor,!0):!1},isHidden:function(){return this.isCursorHidden},isFocused:function(){return this.isWindowFocused},convertToUnicode:function(t){var n=this.keyCodeToUnicode,r={},i=t.length,s,o;for(s=0;s<i;s+=1)o=t[s],r[o]=n[o]||"";return r},keyCodes:{A:0,B:1,C:2,D:3,E:4,F:5,G:6,H:7,I:8,J:9,K:10,L:11,M:12,N:13,O:14,P:15,Q:16,R:17,S:18,T:19,U:20,V:21,W:22,X:23,Y:24,Z:25,NUMBER_0:100,NUMBER_1:101,NUMBER_2:102,NUMBER_3:103,NUMBER_4:104,NUMBER_5:105,NUMBER_6:106,NUMBER_7:107,NUMBER_8:108,NUMBER_9:109,LEFT:200,RIGHT:201,UP:202,DOWN:203,LEFT_SHIFT:300,RIGHT_SHIFT:301,LEFT_CONTROL:302,RIGHT_CONTROL:303,LEFT_ALT:304,RIGHT_ALT:305,ESCAPE:400,TAB:401,SPACE:402,BACKSPACE:403,RETURN:404,GRAVE:500,MINUS:501,EQUALS:502,LEFT_BRACKET:503,RIGHT_BRACKET:504,SEMI_COLON:505,APOSTROPHE:506,COMMA:507,PERIOD:508,SLASH:509,BACKSLASH:510,F1:600,F2:601,F3:602,F4:603,F5:604,F6:605,F7:606,F8:607,F9:608,F10:609,F11:610,F12:611,NUMPAD_0:612,NUMPAD_1:613,NUMPAD_2:614,NUMPAD_3:615,NUMPAD_4:616,NUMPAD_5:617,NUMPAD_6:618,NUMPAD_7:619,NUMPAD_8:620,NUMPAD_9:621,NUMPAD_ENTER:622,NUMPAD_DIVIDE:623,NUMPAD_MULTIPLY:624,NUMPAD_ADD:625,NUMPAD_SUBTRACT:626,LEFT_WIN:627,RIGHT_WIN:628,LEFT_OPTION:629,RIGHT_OPTION:630,CAPS_LOCK:631,INSERT:632,DELETE:633,HOME:634,END:635,PAGE_UP:636,PAGE_DOWN:637,BACK:638},mouseCodes:{BUTTON_0:0,BUTTON_1:1,BUTTON_2:2,DELTA_X:100,DELTA_Y:101,MOUSE_WHEEL:102},padCodes:{UP:0,LEFT:1,DOWN:2,RIGHT:3,A:4,B:5,X:6,Y:7,LEFT_TRIGGER:8,RIGHT_TRIGGER:9,LEFT_SHOULDER:10,RIGHT_SHOULDER:11,LEFT_THUMB:12,LEFT_THUMB_X:13,LEFT_THUMB_Y:14,RIGHT_THUMB:15,RIGHT_THUMB_X:16,RIGHT_THUMB_Y:17,START:18,BACK:19},sendEventToHandlers:function(t,n,r,i,s,o,u){var a,f=t.length;if(f)for(a=0;a<f;a+=1)t[a](n,r,i,s,o,u)},sendEventToHandlersASync:function(t,n,r,i,s,o,u){var a=C.prototype.sendEventToHandlers;TurbulenzEngine.setTimeout(function(){a(t,n,r,i,s,o,u)},0)},updateGamePad:function(){var t,n,r=navigator.gamepads||navigator.webkitGamepads||navigator.webkitGetGamepads&&navigator.webkitGetGamepads();if(r){var i=this.padAxisDeadZone,s=this.maxAxisRange,o=this.sendEventToHandlersASync,u=this.handlers,a=this.padButtons,f=this.padMap,l=0,c=0,h=0,p=0,d=r.length;for(var v=0;v<d;v+=1){var m=r[v];if(m){var g=m.buttons;if(this.padTimestampUpdate<m.timestamp){this.padTimestampUpdate=m.timestamp;var y=g.length;for(var b=0;b<y;b+=1){var w=g[b];if(a[b]!==w){a[b]=w;var E=f[b];E!==undefined&&(w?o(u.paddown,E):o(u.padup,E))}}}var S=m.axes;if(S.length<=4){var x=S[0],T=-S[1];t=x*x+T*T,t>i*i&&(t=Math.sqrt(t),x/=t,T/=t,t>s&&(t=s),t-=i,n=t/(s-i),l=x*n,c=T*n);var N=S[2],C=-S[3];t=N*N+C*C,t>i*i&&(t=Math.sqrt(t),N/=t,C/=t,t>s&&(t=s),t-=i,n=t/(s-i),h=N*n,p=C*n),o(u.padmove,l,c,g[6],h,p,g[7])}break}}}},getLocale:function(){return""},getCanvasPosition:function(t,n){t.offsetX!==undefined?(n.x=t.offsetX,n.y=t.offsetY):t.layerX!==undefined&&(n.x=t.layerX,n.y=t.layerY)},resetKeyStates:function(){var t,n=this.pressedKeys,r=this.handlers.keyup;for(t in n)n.hasOwnProperty(t)&&n[t]&&(t=parseInt(t,10),n[t]=!1,this.sendEventToHandlers(r,t))},onMouseOver:function(t){var n={},r=this.handlers.mouseover;t.stopPropagation(),t.preventDefault(),this.getCanvasPosition(t,n),this.lastX=t.screenX,this.lastY=t.screenY,this.sendEventToHandlers(r,n.x,n.y)},onMouseMove:function(t){var n=this.handlers.mousemove,r,i;t.stopPropagation(),t.preventDefault();if(this.ignoreNextMouseMoves){this.ignoreNextMouseMoves-=1;return}if(t.movementX!==undefined)r=t.movementX,i=t.movementY;else if(t.mozMovementX!==undefined)r=t.mozMovementX,i=t.mozMovementY;else if(t.webkitMovementX!==undefined)r=t.webkitMovementX,i=t.webkitMovementY;else{r=t.screenX-this.lastX,i=t.screenY-this.lastY;if(0===r&&0===i)return}this.lastX=t.screenX,this.lastY=t.screenY,this.sendEventToHandlers(n,r,i)},onWheel:function(t){var n=this.handlers.mousewheel,r;t.stopPropagation(),t.preventDefault(),t.wheelDelta?window.opera?r=t.wheelDelta<0?1:-1:r=t.wheelDelta>0?1:-1:r=t.detail<0?1:-1,this.sendEventToHandlers(n,r)},emptyEvent:function(t){t.stopPropagation(),t.preventDefault()},onWindowFocus:function(){this.isHovering&&window.document.activeElement===this.canvas&&this.addInternalEventListener(window,"mousedown",this.onMouseDown)},onFocus:function(){var t=this.canvas,n=this.handlers,r=n.focus;this.isWindowFocused||(this.isWindowFocused=!0,window.focus(),t.focus(),this.setEventHandlersFocus(),t.oncontextmenu=function(){return!1},this.sendEventToHandlers(r))},onBlur:function(){if(this.ignoreNextBlur){this.ignoreNextBlur=!1;return}var t=this.canvas,n=this.handlers,r=n.blur;this.isMouseLocked&&this.unlockMouse(),this.isWindowFocused&&(this.isWindowFocused=!1,this.resetKeyStates(),this.setEventHandlersBlur(),t.oncontextmenu=null,this.sendEventToHandlers(r))},onMouseDown:function(t){var n=this.handlers;if(this.isHovering){var r=n.mousedown,i=t.button,s={};this.onFocus(),t.stopPropagation(),t.preventDefault(),i<3&&(i=this.mouseMap[i]),this.getCanvasPosition(t,s),this.sendEventToHandlers(r,i,s.x,s.y)}else this.onBlur()},onMouseUp:function(t){var n=this.handlers.mouseup;if(this.isHovering){var r=t.button,i={};t.stopPropagation(),t.preventDefault(),r<3&&(r=this.mouseMap[r]),this.getCanvasPosition(t,i),this.sendEventToHandlers(n,r,i.x,i.y)}},onKeyDown:function(t){var n=this.handlers.keydown,r=this.pressedKeys,i=this.keyCodes;t.stopPropagation(),t.preventDefault();var s=t.keyCode;s=this.keyMap[s];var o=t.keyLocation||t.location;undefined!==s&&i.ESCAPE!==s&&(2===o&&(s+=1),r[s]||(r[s]=!0,this.sendEventToHandlers(n,s)))},onKeyUp:function(t){var n=this.handlers.keyup,r=this.pressedKeys,i=this.keyCodes;t.stopPropagation(),t.preventDefault();var s=t.keyCode;s=this.keyMap[s];var o=t.keyLocation||t.location;s===i.ESCAPE?this.unlockMouse():undefined!==s&&(2===o&&(s+=1),r[s]&&(r[s]=!1,this.sendEventToHandlers(n,s),(627===s||628===s)&&this.macosx&&this.resetKeyStates()))},onTouchStart:function(t){var n=this.handlers.touchstart;t.preventDefault(),this.addTouches(t.changedTouches),t=this.convertW3TouchEventToTurbulenzTouchEvent(t),this.sendEventToHandlers(n,t)},onTouchEnd:function(t){var n=this.handlers.touchend;t.preventDefault(),t=this.convertW3TouchEventToTurbulenzTouchEvent(t),this.removeTouches(t.changedTouches),this.sendEventToHandlers(n,t)},onTouchMove:function(t){var n=this.handlers.touchmove;t.preventDefault(),this.addTouches(t.changedTouches),t=this.convertW3TouchEventToTurbulenzTouchEvent(t),this.sendEventToHandlers(n,t)},onTouchEnter:function(t){var n=this.handlers.touchenter;t.preventDefault(),t=this.convertW3TouchEventToTurbulenzTouchEvent(t),this.sendEventToHandlers(n,t)},onTouchLeave:function(t){var n=this.handlers.touchleave;t.preventDefault(),t=this.convertW3TouchEventToTurbulenzTouchEvent(t),this.sendEventToHandlers(n,t)},onTouchCancel:function(t){var n=this.handlers.touchcancel;t.preventDefault(),t=this.convertW3TouchEventToTurbulenzTouchEvent(t),this.removeTouches(t.changedTouches),this.sendEventToHandlers(n,t)},convertW3TouchEventToTurbulenzTouchEvent:function(t){var n=this.convertW3TouchListToTurbulenzTouchList(t.changedTouches),r=this.convertW3TouchListToTurbulenzTouchList(t.targetTouches),i=this.convertW3TouchListToTurbulenzTouchList(t.touches),s={changedTouches:n,gameTouches:r,touches:i};return gt.create(s)},convertW3TouchListToTurbulenzTouchList:function(t){var n=t.length,r=[],i,s;r.length=n;for(s=0;s<n;s+=1)i=this.getTouchById(t[s].identifier),r[s]=i;return r},convertW3TouchToTurbulenzTouch:function(t){var n=this.canvas,r=n.getBoundingClientRect(),i={force:t.force||t.webkitForce||0,identifier:t.identifier,isGameTouch:t.target===n,positionX:t.pageX-r.left,positionY:t.pageY-r.top,radiusX:t.radiusX||t.webkitRadiusX||1,radiusY:t.radiusY||t.webkitRadiusY||1,rotationAngle:t.rotationAngle||t.webkitRotationAngle||0};return mt.create(i)},addTouches:function(t){var n=t.length,r,i;for(r=0;r<n;r+=1)i=this.convertW3TouchToTurbulenzTouch(t[r]),this.addTouch(i)},removeTouches:function(t){var n=t.length,r,i;for(r=0;r<n;r+=1)i=t[r].identifier,this.removeTouchById(i)},addTouch:function(t){this.touches[t.identifier]=t},getTouchById:function(t){return this.touches[t]},removeTouchById:function(t){delete this.touches[t]},canvasOnMouseOver:function(t){var n=this.handlers.mouseenter;this.isMouseLocked?this.isOutsideEngine=!1:(this.isHovering=!0,this.lastX=t.screenX,this.lastY=t.screenY,this.setEventHandlersMouseEnter(),this.sendEventToHandlers(n))},canvasOnMouseOut:function(){var t=this.handlers.mouseleave;this.isMouseLocked?this.isOutsideEngine=!0:(this.isHovering=!1,this.isCursorHidden&&this.showMouse(),this.setEventHandlersMouseLeave(),this.sendEventToHandlers(t))},canvasOnMouseDown:function(t){var n=this.handlers.mouseenter;return this.canvas.onmousedown=null,this.isHovering||(this.isHovering=!0,this.lastX=t.screenX,this.lastY=t.screenY,this.setEventHandlersMouseEnter(),this.sendEventToHandlers(n),this.onMouseDown(t)),!1},onFullscreenChanged:function(){this.isMouseLocked&&(document.fullscreenEnabled||document.mozFullScreen||document.webkitIsFullScreen?(this.ignoreNextMouseMoves=2,this.requestBrowserLock()):this.unlockMouse())},setEventHandlersMouseEnter:function(){this.isFocused()||this.addInternalEventListener(window,"mousedown",this.onMouseDown),this.addInternalEventListener(window,"mouseup",this.onMouseUp),this.addInternalEventListener(window,"mousemove",this.onMouseOver),this.addInternalEventListener(window,"DOMMouseScroll",this.onWheel),this.addInternalEventListener(window,"mousewheel",this.onWheel),this.addInternalEventListener(window,"click",this.emptyEvent)},setEventHandlersMouseLeave:function(){this.isFocused()||this.removeInternalEventListener(window,"mousedown",this.onMouseDown),this.removeInternalEventListener(window,"mouseup",this.onMouseUp),this.removeInternalEventListener(window,"mousemove",this.onMouseOver),this.removeInternalEventListener(window,"DOMMouseScroll",this.onWheel),this.removeInternalEventListener(window,"mousewheel",this.onWheel),this.removeInternalEventListener(window,"click",this.emptyEvent)},setEventHandlersFocus:function(){this.addInternalEventListener(window,"keydown",this.onKeyDown),this.addInternalEventListener(window,"keyup",this.onKeyUp)},setEventHandlersBlur:function(){this.removeInternalEventListener(window,"keydown",this.onKeyDown),this.removeInternalEventListener(window,"keyup",this.onKeyUp),this.removeInternalEventListener(window,"mousedown",this.onMouseDown)},setEventHandlersLock:function(){this.removeInternalEventListener(window,"mousemove",this.onMouseOver),this.addInternalEventListener(window,"mousemove",this.onMouseMove),this.addInternalEventListener(document,"fullscreenchange",this.onFullscreenChanged),this.addInternalEventListener(document,"mozfullscreenchange",this.onFullscreenChanged),this.addInternalEventListener(document,"webkitfullscreenchange",this.onFullscreenChanged)},setEventHandlersUnlock:function(){this.removeInternalEventListener(document,"webkitfullscreenchange",this.onFullscreenChanged),this.removeInternalEventListener(document,"mozfullscreenchange",this.onFullscreenChanged),this.removeInternalEventListener(document,"fullscreenchange",this.onFullscreenChanged),this.removeInternalEventListener(window,"mousemove",this.onMouseMove),this.addInternalEventListener(window,"mousemove",this.onMouseOver)},setEventHandlersCanvas:function(){var t=this.canvas;this.addInternalEventListener(t,"mouseover",this.canvasOnMouseOver),this.addInternalEventListener(t,"mouseout",this.canvasOnMouseOut),this.addInternalEventListener(t,"mousedown",this.canvasOnMouseDown)},setEventHandlersWindow:function(){this.addInternalEventListener(window,"blur",this.onBlur),this.addInternalEventListener(window,"focus",this.onWindowFocus)},removeEventHandlersWindow:function(){this.removeInternalEventListener(window,"blur",this.onBlur),this.removeInternalEventListener(window,"focus",this.onWindowFocus)},setEventHandlersTouch:function(){var t=this.canvas;this.addInternalEventListener(t,"touchstart",this.onTouchStart),this.addInternalEventListener(t,"touchend",this.onTouchEnd),this.addInternalEventListener(t,"touchenter",this.onTouchEnter),this.addInternalEventListener(t,"touchleave",this.onTouchLeave),this.addInternalEventListener(t,"touchmove",this.onTouchMove),this.addInternalEventListener(t,"touchcancel",this.onTouchCancel)},addInternalEventListener:function(t,n,r){var i=this.elementEventFlags[t];i||(this.elementEventFlags[t]=i={});if(!i[n]){i[n]=!0;var s=this.boundFunctions[r];s||(this.boundFunctions[r]=s=r.bind(this)),t.addEventListener(n,s,!1)}},removeInternalEventListener:function(t,n,r){var i=this.elementEventFlags[t];if(i&&i[n]){i[n]=!1;var s=this.boundFunctions[r];t.removeEventListener(n,s,!1)}},destroy:function(){this.isLocked()&&this.setEventHandlersUnlock(),this.isHovering&&this.setEventHandlersMouseLeave(),this.isWindowFocused&&this.setEventHandlersBlur(),this.removeEventHandlersWindow();var t=this.canvas;t.onmouseover=null,t.onmouseout=null,t.onmousedown=null},isSupported:function(t){var n=this.canvas;if(n&&t==="POINTER_LOCK"){var r="pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document,i=n.requestPointerLock||n.mozRequestPointerLock||n.webkitRequestPointerLock;if(r&&i)return!0}return!1}},C.create=function(t){var n=new C;n.lastX=0,n.lastY=0,n.touches={},n.boundFunctions={},n.elementEventFlags={},n.canvas=t,n.isMouseLocked=!1,n.isHovering=!1,n.isWindowFocused=!1,n.isCursorHidden=!1,n.isOutsideEngine=!1,n.previousCursor="",n.ignoreNextMouseMoves=0,n.ignoreNextBlur=!1,n.pressedKeys={},n.handlers={keydown:[],keyup:[],mousedown:[],mouseup:[],mousewheel:[],mouseover:[],mousemove:[],paddown:[],padup:[],padmove:[],mouseenter:[],mouseleave:[],focus:[],blur:[],mouselocklost:[],touchstart:[],touchend:[],touchenter:[],touchleave:[],touchmove:[],touchcancel:[]};var r={},i=n.keyCodes;for(var s in i)if(i.hasOwnProperty(s)){var o=i[s];r[o]=s}r[i.SPACE]=" ",r[i.NUMBER_0]="0",r[i.NUMBER_1]="1",r[i.NUMBER_2]="2",r[i.NUMBER_3]="3",r[i.NUMBER_4]="4",r[i.NUMBER_5]="5",r[i.NUMBER_6]="6",r[i.NUMBER_7]="7",r[i.NUMBER_8]="8",r[i.NUMBER_9]="9",r[i.GRAVE]="`",r[i.MINUS]="-",r[i.EQUALS]="=",r[i.LEFT_BRACKET]="[",r[i.RIGHT_BRACKET]="]",r[i.SEMI_COLON]=";",r[i.APOSTROPHE]="'",r[i.COMMA]=",",r[i.PERIOD]=".",r[i.SLASH]="/",r[i.BACKSLASH]="\\";var u={};u[65]=0,u[66]=1,u[67]=2,u[68]=3,u[69]=4,u[70]=5,u[71]=6,u[72]=7,u[73]=8,u[74]=9,u[75]=10,u[76]=11,u[77]=12,u[78]=13,u[79]=14,u[80]=15,u[81]=16,u[82]=17,u[83]=18,u[84]=19,u[85]=20,u[86]=21,u[87]=22,u[88]=23,u[89]=24,u[90]=25,u[48]=100,u[49]=101,u[50]=102,u[51]=103,u[52]=104,u[53]=105,u[54]=106,u[55]=107,u[56]=108,u[57]=109,u[37]=200,u[39]=201,u[38]=202,u[40]=203,u[16]=300,u[17]=302,u[18]=304,u[0]=305,u[27]=400,u[9]=401,u[32]=402,u[8]=403,u[13]=404,u[223]=500,u[173]=501,u[189]=501,u[61]=502,u[187]=502,u[219]=503,u[221]=504,u[59]=505,u[186]=505,u[192]=500,u[188]=507,u[190]=508,u[222]=506,navigator.appVersion.indexOf("Mac")!==-1&&(u[0]=500),u[112]=600,u[113]=601,u[114]=602,u[115]=603,u[116]=604,u[117]=605,u[118]=606,u[119]=607,u[120]=608,u[121]=609,u[122]=610,u[123]=611,u[96]=612,u[97]=613,u[98]=614,u[99]=615,u[100]=616,u[12]=617,u[101]=617,u[144]=617,u[102]=618,u[103]=619,u[104]=620,u[105]=621,u[111]=623,u[191]=623,u[106]=624,u[107]=625,u[109]=626,u[91]=627,u[224]=627,u[92]=628,u[93]=628,u[20]=631,u[45]=632,u[46]=633,u[36]=634,u[35]=635,u[33]=636,u[34]=637,n.keyMap=u;var a={0:0,1:2,2:1};n.mouseMap=a;var f={0:4,1:5,2:6,3:7,4:10,5:11,8:19,9:18,10:12,11:15,12:0,13:2,14:1,15:3};n.padMap=f,n.keyCodeToUnicode=r,n.padButtons=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],n.padMap=f,n.padAxisDeadZone=.26,n.maxAxisRange=1,n.padTimestampUpdate=0;var l=t.requestPointerLock||t.mozRequestPointerLock||t.webkitRequestPointerLock;if(l){var c=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock;n.onPointerLockChanged=function(){var t=document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement;t!==n.canvas&&n.unlockMouse()},n.onPointerLockError=function(){n.unlockMouse()},"mozPointerLockElement"in document?(n.setEventHandlersPointerLock=function(){this.ignoreNextBlur=!0,document.addEventListener("mozpointerlockchange",this.onPointerLockChanged,!1),document.addEventListener("mozpointerlockerror",this.onPointerLockError,!1)},n.setEventHandlersPointerUnlock=function(){this.ignoreNextBlur=!1,document.removeEventListener("mozpointerlockchange",this.onPointerLockChanged,!1),document.removeEventListener("mozpointerlockerror",this.onPointerLockError,!1)}):"webkitPointerLockElement"in document?(n.setEventHandlersPointerLock=function(){document.addEventListener("webkitpointerlockchange",this.onPointerLockChanged,!1),document.addEventListener("webkitpointerlockerror",this.onPointerLockError,!1)},n.setEventHandlersPointerUnlock=function(){document.removeEventListener("webkitpointerlockchange",this.onPointerLockChanged,!1),document.removeEventListener("webkitpointerlockerror",this.onPointerLockError,!1)}):"pointerLockElement"in document&&(n.setEventHandlersPointerLock=function(){document.addEventListener("pointerlockchange",this.onPointerLockChanged,!1),document.addEventListener("pointerlockerror",this.onPointerLockError,!1)},n.setEventHandlersPointerUnlock=function(){document.removeEventListener("pointerlockchange",this.onPointerLockChanged,!1),document.removeEventListener("pointerlockerror",this.onPointerLockError,!1)}),n.requestBrowserLock=function(){var n=document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement;n!==t&&(this.setEventHandlersPointerLock(),l.call(t))},n.requestBrowserUnlock=function(){this.setEventHandlersPointerUnlock();var n=document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement;n===t&&c.call(document)}}else{var h=navigator.pointer||navigator.webkitPointer;h?(n.requestBrowserLock=function(){h.isLocked||h.lock(t)},n.requestBrowserUnlock=function(){h.isLocked&&h.unlock()}):(n.requestBrowserLock=function(){},n.requestBrowserUnlock=function(){})}n.setEventHandlersCanvas(),n.setEventHandlersWindow(),n.setEventHandlersTouch();var p=TurbulenzEngine.getSystemInfo();return n.macosx="Darwin"===p.osName,n.webkit=/WebKit/.test(navigator.userAgent),n},k.prototype={version:1,WebSocketConstructor:window.WebSocket?window.WebSocket:window.MozWebSocket,createWebSocket:function(t,n){var r=this.WebSocketConstructor
;if(r){var i;return n?i=new r(t,n):i=new r(t),typeof i.destroy=="undefined"&&(i.destroy=function(){this.onopen=null,this.onerror=null,this.onclose=null,this.onmessage=null,this.close()}),i}return null},update:function(){}},k.create=function(){var t=new k;return t};var L={CONTACT_SLOP:.015,CONTACT_BAUMGRAUTE:.35,CONTACT_STATIC_BAUMGRAUTE:.65,CONTACT_MAX_Y_SEPERATION:.05,CONTACT_MAX_SQ_XZ_SEPERATION:2*.245*.245,CONTACT_INHERIT_SQ_SEPERATION:1.6875,CONTACT_EQUAL_SQ_SEPERATION:3e-6,GJK_EPA_DISTANCE_THRESHOLD:1e-4,GJK_FRACTIONAL_THRESHOLD:1e-4,CONTINUOUS_LINEAR_SQ:.35,CONTINUOUS_ANGULAR_SQ:.25,CONTINUOUS_LINEAR_BULLET:.75,CONTINUOUS_ANGULAR_BULLET:.5,CONTINUOUS_SLOP:.015,SLEEP_LINEAR_SQ:.01,SLEEP_ANGULAR_SQ:.1,SLEEP_DELAY:60,MAX_ANGULAR:Math.PI,QUADRATIC_THRESHOLD:1e-8,DONT_NORMALIZE_THRESHOLD:1e-8,COLLINEAR_THRESHOLD:1e-10,COPLANAR_THRESHOLD:1e-16},A=function(t,n){for(var r in n)if(n.hasOwnProperty(r)){var i=n[r];if(i===null||i===undefined)continue;typeof i=="object"&&r!=="shape"&&r!=="userData"&&r!=="world"&&r!=="object"&&r!=="arbiters"&&r!=="islandRoot"&&r!=="island"&&r!=="bodyA"&&r!=="bodyB"&&r!=="triangleArray"&&("slice"in i?i=i.slice():i=A({},i)),t[r]=i}return t};O.prototype={version:1};var M=function(n,r,i){i||Object.defineProperty(n,"margin",{get:function(){return this._private.collisionRadius},set:function(t){var n=this._private;n.halfExtents[0]+=t-n.collisionRadius,n.halfExtents[1]+=t-n.collisionRadius,n.halfExtents[2]+=t-n.collisionRadius,n.radius+=t-n.collisionRadius,n.collisionRadius=t},enumerable:!0}),Object.defineProperty(n,"halfExtents",{get:function(){return t.v3Copy(this._private.halfExtents)},enumerable:!0}),Object.defineProperty(n,"inertia",{get:function(){return t.v3Copy(this._private.inertia)},enumerable:!0}),Object.defineProperty(n,"radius",{get:function(){return this._private.radius},enumerable:!0}),Object.defineProperty(n,"type",{value:r,enumerable:!0})};_.prototype={version:1,type:"PLANE",rayTest:function(n){var r=n.direction,i=n.origin,s=r[0],o=r[1],u=r[2],a=i[0],f=i[1],l=i[2],c=this.normal,h=c[0],p=c[1],d=c[2],v=s*h+o*p+u*d;if(v*v<L.COPLANAR_THRESHOLD)return null;var m=(this.distance-(a*h+f*p+l*d))/v;if(0<=m&&m<=n.maxFactor){v>0&&(h=-h,p=-p,d=-d);var g=a+s*m,y=f+o*m,b=l+u*m;return{factor:m,hitPoint:t.v3Build(g,y,b),hitNormal:t.v3Build(h,p,d)}}return null}},_.create=function(n){var r=new O,i=new _;r._private=i,i._public=r,i.collisionRadius=n.margin!==undefined?n.margin:.04,i.distance=n.distance;var s=i.normal=t.v3Copy(n.normal),o=Math.abs,u=Number.MAX_VALUE;return i.radius=u,o(s[0])===1?i.halfExtents=t.v3Build(o(i.distance),u,u):o(s[1])===1?i.halfExtents=t.v3Build(u,o(i.distance),u):o(s[2])===1&&(i.halfExtents=t.v3Build(u,u,o(i.distance))),i.center=undefined,i.inertia=t.v3BuildZero(),M(r,"PLANE"),r},D.prototype={version:1,type:"CAPSULE",rayTestCap:function(n,r,i){var s=n.origin,o=n.direction,u=s[0],a=s[1],f=s[2],l=o[0],c=o[1],h=o[2],p=this.capsuleRadius,d=l*l+c*c+h*h,v=a-r,m=2*(l*u+c*v+h*f),g=u*u+v*v+f*f-p*p,y=m*m-4*d*g;if(y<0)return null;var b,w=1,E,S=1/(2*d),x=Math.sqrt(y);b=(-m-x)*S,E=a+c*b;if(b<0||i*(E-r)<0)b+=2*x*S,E=a+c*b,w=-1;if(i*(E-r)>=0&&0<=b&&b<=n.maxFactor){var T=u+l*b,N=f+h*b,C=w/p;return{factor:b,hitPoint:t.v3Build(T,E,N),hitNormal:t.v3Build(T*C,(E-r)*C,N*C)}}return null},rayTest:function(n){var r=n.origin,i=n.direction,s=r[0],o=r[1],u=r[2],a=i[0],f=i[1],l=i[2],c=n.maxFactor,h=this.capsuleRadius,p=this.halfHeight,d=h*h,v,m=1,g,y,b,w=a*a+l*l;if(w>=L.QUADRATIC_THRESHOLD){var E=2*(s*a+u*l),S=s*s+u*u-d,x=E*E-4*w*S,T=1/(2*w);if(x<L.QUADRATIC_THRESHOLD)v=-E*T;else if(x>0){var N=Math.sqrt(x);v=(-E-N)*T,v<0&&(v+=N*2*T,m=-1)}var C;y=o+f*v;if(-p<=y&&y<=p)return 0<=v&&v<=c?(g=s+a*v,b=u+l*v,C=m/h,{factor:v,hitPoint:t.v3Build(g,y,b),hitNormal:t.v3Build(g*C,0,b*C)}):null}return this.rayTestCap(n,p,1)||this.rayTestCap(n,-p,-1)},localSupportWithoutMargin:function(t,n){n[0]=0,n[1]=t[1]>=0?this.halfHeight:-this.halfHeight,n[2]=0}},D.create=function(n){var r=new O,i=new D;r._private=i,i._public=r;var s=n.margin!==undefined?n.margin:.04,o=n.radius,u=n.height,a=.5*u,f=o+a,l=o+s,c=f+s,h=o+s,p=2*l,d=2*c,v=2*h;p*=p,d*=d,v*=v;var m=1/12;return i.radius=f+s,i.capsuleRadius=o,i.halfHeight=a,i.halfExtents=t.v3Build(l,c,h),i.inertia=t.v3Build(m*(d+v),m*(p+v),m*(p+d)),i.collisionRadius=o+s,i.center=undefined,Object.defineProperty(r,"margin",{get:function(){return this._private.collisionRadius-this._private.capsuleRadius},set:function(t){var n=this._private;n.collisionRadius=n.capsuleRadius+t,n.halfExtents[0]=n.capsuleRadius+t,n.halfExtents[1]=n.capsuleRadius+n.halfHeight+t,n.halfExtents[2]=n.capsuleRadius+t,n.radius=n.capsuleRadius+n.halfHeight+t},enumerable:!0}),M(r,"CAPSULE",!0),r},P.prototype={version:1,type:"SPHERE",rayTest:function(n){var r=n.origin,i=n.direction,s=this.sphereRadius,o=i[0],u=i[1],a=i[2],f=r[0],l=r[1],c=r[2],h=o*o+u*u+a*a,p=2*(f*o+l*u+c*a),d=f*f+l*l+c*c-s*s,v,m=p*p-4*h*d;if(m<=0)return null;var g=1,y=1/(2*h),b=Math.sqrt(m);v=(-p-b)*y,v<0&&(v+=b*2*y,g=-1);if(0<=v&&v<n.maxFactor){var w=f+o*v,E=l+u*v,S=c+a*v,x=g/s;return{factor:v,hitPoint:t.v3Build(w,E,S),hitNormal:t.v3Build(w*x,E*x,S*x)}}return null},localSupportWithoutMargin:function(t,n){n[0]=n[1]=n[2]=0}},P.create=function(n){var r=new O,i=new P;r._private=i,i._public=r;var s=n.margin!==undefined?n.margin:.04,o=n.radius,u=.4*o*o;return i.sphereRadius=o,i.radius=i.sphereRadius+s,i.collisionRadius=o+s,i.halfExtents=t.v3Build(o+s,o+s,o+s),i.inertia=t.v3Build(u,u,u),i.center=undefined,Object.defineProperty(r,"margin",{get:function(){return this._private.collisionRadius-this._private.radius},set:function(t){var n=this._private;n.collisionRadius=n.radius+t,n.halfExtents[0]=n.collisionRadius,n.halfExtents[1]=n.collisionRadius,n.halfExtents[2]=n.collisionRadius,n.radius=n.collisionRadius},enumerable:!0}),M(r,"SPHERE",!0),r},H.prototype={version:1,type:"BOX",rayTest:function(n){var r=n.origin,i=n.direction,s=r[0],o=r[1],u=r[2],a=i[0],f=i[1],l=i[2],c=this.halfExtents,h=c[0],p=c[1],d=c[2],v,m,g,y,b,w;if(a!==0&&(a>0&&s<=-h||a<0&&s>=h)){y=a>0?s>=-h?h:-h:s<=h?-h:h,g=(y-s)/a;if(v===undefined||g<v)b=o+f*g,w=u+l*g,-p<=b&&b<=p&&-d<=w&&w<=d&&(v=g,m=0)}if(f!==0&&(f>0&&o<=-p||f<0&&o>=p)){y=f>0?o>=-p?p:-p:o<=p?-p:p,g=(y-o)/f;if(v===undefined||g<v)b=s+a*g,w=u+l*g,-h<=b&&b<=h&&-d<=w&&w<=d&&(v=g,m=1)}if(l!==0&&(l>0&&u<=-d||l<0&&u>=d)){y=l>0?u>=-d?d:-d:u<=d?-d:d,g=(y-u)/l;if(v===undefined||g<v)b=o+f*g,w=s+a*g,-p<=b&&b<=p&&-h<=w&&w<=h&&(v=g,m=2)}return v!==undefined&&v<n.maxFactor?{hitPoint:t.v3Build(s+a*v,o+f*v,u+l*v),hitNormal:t.v3Build(m===0?a>0?-1:1:0,m===1?f>0?-1:1:0,m===2?l>0?-1:1:0),factor:v}:null},localSupportWithoutMargin:function(t,n){var r=t[0],i=t[1],s=t[2],o=this.halfExtents,u=o[0],a=o[1],f=o[2];n[0]=r<0?-u:u,n[1]=i<0?-a:a,n[2]=s<0?-f:f}},H.create=function(n){var r=new O,i=new H;r._private=i,i._public=r;var s=n.margin!==undefined?n.margin:.04,o=n.halfExtents,u=o[0]+s,a=o[1]+s,f=o[2]+s,l=2*u,c=2*a,h=2*f;return l*=l,c*=c,h*=h,i.center=undefined,i.radius=Math.sqrt(u*u+a*a+f*f),i.halfExtents=t.v3Build(u,a,f),i.inertia=t.v3Build(1/12*(c+h),1/12*(l+h),1/12*(l+c)),i.collisionRadius=s,M(r,"BOX"),r},B.prototype={version:1,type:"CYLINDER",rayTest:function(n){var r=n.origin,i=n.direction,s=r[0],o=r[1],u=r[2],a=i[0],f=i[1],l=i[2],c=n.maxFactor,h=this.cylinderRadius,p=this.halfHeight,d=h*h,v=a*a+l*l,m=2*(s*a+u*l),g=s*s+u*u-d,y,b=1,w,E,S,x,T,N=m*m-4*v*g;if(N>=0){T=1/(2*v);var C=Math.sqrt(N);y=(-m-C)*T,y<0&&(y+=C*2*T,b=-1),E=o+f*y;if(-p<=E&&E<=p)return 0<=y&&y<=c?(w=s+a*y,S=u+l*y,x=b/h,{factor:y,hitPoint:t.v3Build(w,E,S),hitNormal:t.v3Build(w*x,0,S*x)}):null}if(f*f>=L.COPLANAR_THRESHOLD){x=f<0?-1:1,E=-x*p,T=1/f,y=(E-o)*T,y<0&&(E=x*p,y=(E-o)*T);if(0<=y&&y<=c){w=s+a*y,S=u+l*y;if(w*w+S*S<=d)return{factor:y,hitPoint:t.v3Build(w,E,S),hitNormal:t.v3Build(0,-x,0)}}}return null},localSupportWithoutMargin:function(t,n){var r=t[0],i=t[2],s=r*r+i*i;if(s===0){t[1]>0?(n[0]=this.cylinderRadius,n[1]=this.halfHeight,n[2]=0):(n[0]=0,n[1]=-this.halfHeight,n[2]=-this.cylinderRadius);return}var o=this.cylinderRadius/Math.sqrt(s);n[0]=r*o,n[1]=(t[1]>0?1:-1)*this.halfHeight,n[2]=i*o}},B.create=function(n){var r=new O,i=new B;r._private=i,i._public=r;var s=n.margin!==undefined?n.margin:.04,o=n.halfExtents,u=o[0]+s,a=o[1]+s,f=o[2]+s,l=u*u,c=4*a*a,h=1/12*c+.25*l,p=.5*l;return i.center=undefined,i.radius=Math.sqrt(u*u+a*a+f*f),i.halfExtents=t.v3Build(u,a,f),i.cylinderRadius=o[0],i.halfHeight=o[1],i.inertia=t.v3Build(h,p,h),i.collisionRadius=s,M(r,"CYLINDER"),r},j.prototype={version:1,type:"CONE",rayTest:function(n){var r=n.origin,i=n.direction,s=r[0],o=r[1],u=r[2],a=i[0],f=i[1],l=i[2],c=n.maxFactor,h=this.coneRadius,p=this.halfHeight,d=h/(2*p);d*=d;var v=o-p,m=a*a+l*l-d*f*f,g=2*(s*a+u*l-d*v*f),y=s*s+u*u-d*v*v,b,w=1,E,S,x,T=g*g-4*m*y;if(T>=0){var N=1/(2*m),C=Math.sqrt(T);b=(-g-C)*N,S=o+f*b;if(b<0||S<-p||S>p){b+=2*C*N,w=-1,S=o+f*b;if(b<0||S<-p||S>p)b=undefined}}var k;if(f!==0){k=(-p-o)/f,E=s+a*k,x=u+l*k;if(k<0||E*E+x*x>h*h)k=undefined}if(k===undefined&&b===undefined)return null;if(k===undefined||b!==undefined&&b<k){if(b>=c)return null;E=s+a*b,S=o+f*b,x=u+l*b;var L=d*(S-p),A=w/Math.sqrt(E*E+L*L+x*x);return{hitPoint:t.v3Build(E,S,x),hitNormal:t.v3Build(A*E,A*L,A*x),factor:b}}return k>=c?null:(E=s+a*k,S=o+f*k,x=u+l*k,{hitPoint:t.v3Build(E,S,x),hitNormal:t.v3Build(0,o<-p?-1:1,0),factor:k})},localSupportWithoutMargin:function(t,n){var r=t[0],i=t[1],s=t[2],o=Math.sqrt(r*r+s*s);-this.coneRadius*o+2*this.halfHeight*i>0?(n[0]=n[2]=0,n[1]=this.halfHeight):(o===0?(n[0]=this.coneRadius,n[2]=0):(n[0]=r*this.coneRadius/o,n[2]=s*this.coneRadius/o),n[1]=-this.halfHeight)}},j.create=function(n){var r=new O,i=new j;r._private=i,i._public=r;var s=n.margin!==undefined?n.margin:.04,o=n.radius,u=n.height,a=.5*u,f=o+s,l=a+s,c=o+s,h=2*f,p=2*l,d=2*c;h*=h,p*=p,d*=d;var v=1/12;return i.halfHeight=a,i.coneRadius=o,i.radius=Math.sqrt(f*f+l*l+c*c),i.halfExtents=t.v3Build(f,l,c),i.inertia=t.v3Build(v*(p+d),v*(h+d),v*(h+p)),i.collisionRadius=s,i.center=undefined,M(r,"CONE"),r},F.prototype={version:1},I.prototype={version:1,TRIANGLE_SIZE:17,rayTest:function(n){function s(e,n,i,s,o){var u=i.direction,a=u[0],f=u[1],l=u[2],c=i.origin,h=c[0],p=c[1],d=c[2],v=n.index,m=r[v],g=r[v+1],y=r[v+2],b=a*m+f*g+l*y;if(b*b<L.COPLANAR_THRESHOLD)return null;var w=r[v+16],E=r[v+3],S=r[v+4],x=r[v+5],T=(w-(h*m+p*g+d*y))/b;if(T<0||T>=o)return null;b>0&&(m=-m,g=-g,y=-y,b=-b);var N=h+a*T,C=p+f*T,k=d+l*T,A=N-E,O=C-S,M=k-x,_=r[v+12],D=r[v+13],P=r[v+14],H=r[v+15],B=r[v+6],j=r[v+7],F=r[v+8],I=r[v+9],q=r[v+10],R=r[v+11],U=A*B+O*j+M*F,z=A*I+O*q+M*R,W=P*z-D*U;if(W>0||W<H)return null;var X=P*U-_*z;return X>0||W+X<H?null:{factor:T,hitPoint:t.v3Build(N,C,k),hitNormal:t.v3Build(m,g,y)}}var r=this.triangles,i=this.spatialMap;if(i)return f.rayTest([i],n,s);var o=null,u=n.maxFactor,a={index:0},l,c=this.numTriangles*I.prototype.TRIANGLE_SIZE;for(l=0;l<c;l+=I.prototype.TRIANGLE_SIZE){a.index=l;var h=s(null,a,n,0,u);h&&(o=h,u=o.factor)}return o}},F.create=function(t){var n=new F,r=new I;n._private=r,r._public=n;var i=t.vertices,s=i.length/3,o=t.indices,u=o.length/3,a=t.minExtent,l=t.maxExtent,c,h,p;if(!a||!l){var d=i[0],v=i[1],m=i[2],g=d,y=v,b=m,w=i.length;for(var E=3;E<w;E+=3)c=i[E],h=i[E+1],p=i[E+2],d>c?d=c:g<c&&(g=c),v>h?v=h:y<h&&(y=h),m>p?m=p:b<p&&(b=p);a=[d,v,m],l=[g,y,b]}var S=new Float32Array(6);S[0]=a[0],S[1]=a[1],S[2]=a[2],S[3]=l[0],S[4]=l[1],S[5]=l[2],r.vertices=t.dontCopy?i:new Float32Array(i),r.numVertices=s,r.indices=t.dontCopy?o:s<65536?new Uint16Array(o):new Uint32Array(o),r.numTriangles=u,r.extents=S,Object.defineProperty(n,"vertices",{value:r.vertices,enumerable:!0}),Object.defineProperty(n,"indices",{value:r.indices,enumerable:!0});var x=new Float32Array(I.prototype.TRIANGLE_SIZE*u),T=null;u>=8&&(T=f.create(!0));var N;for(N=0;N<u;N+=1){var C=N*3,k=N*I.prototype.TRIANGLE_SIZE,L=o[C]*3,A=o[C+1]*3,O=o[C+2]*3,M=i[L],_=i[L+1],D=i[L+2],P=i[A],H=i[A+1],B=i[A+2],j=i[O],q=i[O+1],R=i[O+2],U=P-M,z=H-_,W=B-D;c=j-M,h=q-_,p=R-D;var X=z*p-W*h,V=W*c-U*p,$=U*h-z*c,J=1/Math.sqrt(X*X+V*V+$*$),K=(X*M+V*_+$*D)*J,Q=U*c+z*h+W*p,G=U*U+z*z+W*W,Y=c*c+h*h+p*p,Z=Q*Q-G*Y;x[k]=X*J,x[k+1]=V*J,x[k+2]=$*J,x[k+3]=M,x[k+4]=_,x[k+5]=D,x[k+6]=U,x[k+7]=z,x[k+8]=W,x[k+9]=c,x[k+10]=h,x[k+11]=p,x[k+12]=G,x[k+13]=Y,x[k+14]=Q,x[k+15]=Z,x[k+16]=K;if(T){S=new Float32Array(6),S[0]=Math.min(M,P,j),S[1]=Math.min(_,H,q),S[2]=Math.min(D,B,R),S[3]=Math.max(M,P,j),S[4]=Math.max(_,H,q),S[5]=Math.max(D,B,R);var et={index:k};T.add(et,S)}}return T&&T.finalize(),r.triangles=x,r.spatialMap=T,n};var q={isPlanar:function(t){var n=L.COPLANAR_THRESHOLD,r=t[0],i=t[1],s=t[2],o=t[3]-r,u=t[4]-i,a=t[5]-s,f=t[6]-r,l=t[7]-i,c=t[8]-s,h=u*c-a*l,p=a*f-o*c,d=o*l-u*f,v=1/Math.sqrt(h*h+p*p+d*d);h*=v,p*=v,d*=v;var m=-(r*h+i*p+s*d),g,y=t.length;for(g=0;g<y;g+=3){var b=t[g]*h+t[g+1]*p+t[g+2]*d+m;if(b*b>n)return!1}return!0},makePlanarConvexHull:function(t){var n=1e-6,r=t[0],i=t[1],s=t[2],o=t[3]-r,u=t[4]-i,a=t[5]-s,f=t[6]-r,l=t[7]-i,c=t[8]-s,h=u*c-a*l,p=a*f-o*c,d=o*l-u*f,v,m,g;h*h+d*d<n?(v=1,m=g=0):(v=-d,m=0,g=h);var y=p*g-d*m,b=d*v-h*g,w=h*m-p*v,E=t.length/3,S=new Float32Array(E*2),x,T,N,C;for(C=0;C<E;C+=1)x=t[C*3],T=t[C*3+1],N=t[C*3+2],S[C*2]=x*v+T*m+N*g,S[C*2+1]=x*y+T*b+N*w;var k=0;r=S[0],i=S[1];for(C=2;C<E*2;C+=2){x=S[C],T=S[C+1];if(x<r||x===r&&T<i)k=C/2,r=x,i=T}var L={};L[k]=0;var A=1,O=[],M=k;for(;;){var _,D,P,H=-1;for(C=0;C<E*2;C+=2){if(C===k*2)continue;x=S[C],T=S[C+1];var B=(x-r)*(x-r)+(T-i)*(T-i);if(H===-1){H=C/2,_=x,D=T,P=B;continue}var j=(_-r)*(T-i)-(D-i)*(x-r);if(j<0||j===0&&B>P)H=C/2,_=x,D=T,P=B}if(H in L)break;L[H]=A,A+=1,k!==M&&(O.push(M),O.push(k),O.push(H)),k=H,r=S[H*2],i=S[H*2+1]}return this.createArray(t,O,L,A)},makeConvexHull:function(t){var n=0,r=t[0],i=t[1],s=t[2],o,u,a,f,l=t.length/3;for(o=3;o<l*3;o+=3){u=t[o],a=t[o+1],f=t[o+2];if(u<r||u===r&&(a<i||a===i&&f<s))n=o/3,r=u,i=a,s=f}var c=-1,h=-2,p=0,d,v;for(o=0;o<l*3;o+=3){if(o===n*3)continue;u=t[o],a=t[o+1],d=u-r,v=a-i;var m=d*d+v*v;if(m===0){c===-1&&(c=o/3);continue}var g=v/Math.sqrt(m);if(g>h||g===h&&m>p)h=g,p=m,c=o/3}var y={},b=[n,c,c,n],w={};w[n]=0,w[c]=1;var E=2,S=[];while(b.length>0){c=b.pop(),n=b.pop();if(n+":"+c in y)continue;var x=-1,T,N,C,k,A;r=t[n*3],i=t[n*3+1],s=t[n*3+2];var O=t[c*3]-r,M=t[c*3+1]-i,_=t[c*3+2]-s,D=1/(O*O+M*M*_*_);for(o=0;o<l*3;o+=3){if(o===n*3||o===c*3)continue;u=t[o],a=t[o+1],f=t[o+2];var P=((u-r)*O+(a-i)*M+(f-s)*_)*D,H=u-(r+O*P),B=a-(i+M*P),j=f-(s+_*P),F=H*H+B*B+j*j;if(F<=L.COLLINEAR_THRESHOLD)continue;if(x===-1){x=o/3,T=H,N=B,C=j,k=F,A=P;continue}var I=B*C-j*N,q=j*T-H*C,R=H*N-B*T,U=H*(M*C-_*N)+B*(_*T-O*C)+j*(O*N-M*T);if(U*U<L.COPLANAR_THRESHOLD)if(H*T+B*N+j*C>=0){if(F>k||F===k&&P>A)x=o/3,T=H,N=B,C=j,k=F,A=P}else{d=u-r,v=a-i;var z=f-s;I=v*_-z*M,q=z*O-d*_,R=d*M-v*O;var W=!0,X;for(X=0;X<l*3;X+=3)if(I*(t[X]-r)+q*(t[X+1]-i)+R*(t[X+2]-s)<0){W=!1;break}W&&(x=o/3,T=H,N=B,C=j,k=F,A=P)}else{var V=I*O+q*M+R*_;if(V<0||V<=L.COLLINEAR_THRESHOLD&&F>k)x=o/3,T=H,N=B,C=j,k=F,A=P}}x in w||(w[x]=E,E+=1),n+":"+c in y||c+":"+x in y||x+":"+n in y||(S.push(n),S.push(c),S.push(x),y[n+":"+c]=!0,y[c+":"+x]=!0,y[x+":"+n]=!0,b.push(x),b.push(c),b.push(n),b.push(x))}return this.createArray(t,S,w,E)},createArray:function(t,n,r,i){var s=new Float32Array(i*3),o=n.length,u=i<65536?new Uint16Array(o):new Uint32Array(o),a=t.length/3,f;for(f=0;f<a;f+=1){if(!(f in r))continue;var l=r[f]*3;s[l]=t[f*3],s[l+1]=t[f*3+1],s[l+2]=t[f*3+2]}for(f=0;f<o;f+=1)u[f]=r[n[f]];return F.create({vertices:s,indices:u,dontCopy:!0})._private}};R.prototype={version:1,type:"TRIANGLE_MESH",rayTest:function(t){return this.triangleArray.rayTest(t)}},R.create=function(n){var r=new O,i=new R;r._private=i,i._public=r;var s=n.margin!==undefined?n.margin:.04,o=n.triangleArray._private,u=o.extents,a=u[0],f=u[1],l=u[2],c=u[3],h=u[4],p=u[5],d=.5*(c-a)+s,v=.5*(h-f)+s,m=.5*(p-l)+s,g=.5*(a+c),y=.5*(f+h),b=.5*(l+p);return i.triangleArray=o,i.radius=Math.sqrt(d*d+v*v+m*m),i.halfExtents=t.v3Build(d,v,m),g!==0||y!==0||b!==0?i.center=t.v3Build(g,y,b):i.center=undefined,i.inertia=t.v3Build(0,0,0),i.collisionRadius=s,M(r,"TRIANGLE_MESH"),Object.defineProperty(r,"triangleArray",{get:function(){return this._private.triangleArray},enumerable:!0}),r},U.prototype={version:1,type:"CONVEX_HULL",rayTest:function(t){var n=this.triangleArray;return n===undefined?null:n.rayTest(t)},localSupportWithoutMargin:function(t,n){var r=t[0],i=t[1],s=t[2],o=this.supportTopology,u=this.triangleArray.vertices;this.lastSupport===undefined&&(this.lastSupport=0);var a=this.lastSupport,f=o[a],l=u[f]*r+u[f+1]*i+u[f+2]*s;for(;;){var c=-1,h,p=o[a+1];for(h=0;h<p;h+=1){var d=o[a+2+h];f=o[d];var v=u[f]*r+u[f+1]*i+u[f+2]*s;v>l&&(l=v,c=d)}if(c!==-1){a=c;continue}break}this.lastSupport=a,f=o[a],n[0]=u[f],n[1]=u[f+1],n[2]=u[f+2]}},U.create=function(n){var r=new O,i=new U;r._private=i,i._public=r;var s=n.margin!==undefined?n.margin:.04,o=n.points,u=o[0],a=o[1],f=o[2],l=u,c=a,h=f,p=o.length,d,v,m,g;for(d=3;d<p;d+=3)v=o[d],m=o[d+1],g=o[d+2],u>v?u=v:l<v&&(l=v),a>m?a=m:c<m&&(c=m),f>g?f=g:h<g&&(h=g);var y=.5*(l-u)+s,b=.5*(c-a)+s,w=.5*(h-f)+s,E=.5*(u+l),S=.5*(a+c),x=.5*(f+h),T=2*y,N=2*b,C=2*w;T*=T,N*=N,C*=C;var k=1/12;i.points=new Float32Array(o),i.radius=Math.sqrt(y*y+b*b+w*w),i.halfExtents=t.v3Build(y,b,w),E!==0||S!==0||x!==0?i.center=t.v3Build(E,S,x):i.center=undefined,i.inertia=t.v3Build(k*(N+C),k*(T+C),k*(T+N)),i.collisionRadius=s;if(o.length<9)throw"At present time, WebGL PhysicsDevice does not permit a convex hull to contain less than 3 vertices";var L=q.isPlanar(o);L?i.triangleArray=q.makePlanarConvexHull(o):i.triangleArray=q.makeConvexHull(o);var A=[];o=i.triangleArray.vertices,p=o.length;for(d=0;d<p;d+=3)A[d/3]=[];var _;if(L)for(d=0;d<p/3;d+=1)_=(d+1)%(p/3),A[d].push(_),A[_].push(d);else{var D=i.triangleArray.indices;p=D.length;for(d=0;d<p;d+=3){var P=D[d],H=D[d+1],B=D[d+2];A[P].push(H),A[H].push(B),A[B].push(P)}}p=o.length;if(L&&p>=18||!L&&p>=30)for(d=0;d<p;d+=3){var j=Number.MAX_VALUE;v=o[d],m=o[d+1],g=o[d+2];var F;for(_=0;_<p;_+=3){var I=v*o[_]+m*o[_+1]+g*o[_+2];I<j&&(j=I,F=_)}A[d/3].push(F/3)}var R=[],z=0;for(d=0;d<p/3;d+=1)R.push(z),z+=A[d].length+2;i.supportTopology=z>65536?new Int32Array(z):new Int16Array(z);var W=0;for(d=0;d<p/3;d+=1){i.supportTopology[W]=d*3,W+=1;var X=A[d];i.supportTopology[W]=X.length,W+=1;for(_=0;_<X.length;_+=1)i.supportTopology[W]=R[X[_]],W+=1}return M(r,"CONVEX_HULL"),r},z.prototype={version:1,calculateExtents:function(t){this._private.calculateExtents(t)},calculateTransform:function(n,r){var i=this._private.transform;r?t.m43NegOffset(i,r,n):(n[0]=i[0],n[1]=i[1],n[2]=i[2],n[3]=i[3],n[4]=i[4],n[5]=i[5],n[6]=i[6],n[7]=i[7],n[8]=i[8],n[9]=i[9],n[10]=i[10],n[11]=i[11])},clone:function(){return z.create(this)}},W.prototype={version:1,computeDeltaVelocity:function(n,r,i,s){var o=s||this.velocity,u=!1;o[0]=i[9]-r[9],o[1]=i[10]-r[10],o[2]=i[11]-r[11];if(o[0]!==0||o[1]!==0||o[2]!==0)u=!0;o[0]/=n,o[1]/=n,o[2]/=n;var a=r[0]*i[0]+r[3]*i[3]+r[6]*i[6],f=r[0]*i[1]+r[3]*i[4]+r[6]*i[7],l=r[0]*i[2]+r[3]*i[5]+r[6]*i[8],c=r[1]*i[0]+r[4]*i[3]+r[7]*i[6],h=r[1]*i[1]+r[4]*i[4]+r[7]*i[7],p=r[1]*i[2]+r[4]*i[5]+r[7]*i[8],d=r[2]*i[0]+r[5]*i[3]+r[8]*i[6],v=r[2]*i[1]+r[5]*i[4]+r[8]*i[7],m=r[2]*i[2]+r[5]*i[5]+r[8]*i[8],g,y,b,w,E,S=a+h+m+1;S>t.precision?(w=Math.sqrt(S)/2,g=(p-v)/(4*w),y=(d-l)/(4*w),b=(f-c)/(4*w)):a>h&&a>m?(E=Math.sqrt(1+a-h-m)*2,w=(p-v)/E,g=.25*E,y=(c+f)/E,b=(d+l)/E):h>m?(E=Math.sqrt(1+h-a-m)*2,w=(d-l)/E,g=(c+f)/E,y=.25*E,b=(v+p)/E):(E=Math.sqrt(1+m-a-h)*2,w=(f-c)/E,g=(d+l)/E,y=(v+p)/E,b=.25*E);var x=Math.acos(w)*2,T=1-w*w;if(T<t.precision||x===0)o[3]=o[4]=o[5]=0;else{var N=x/(n*Math.sqrt(T));o[3]=g*N,o[4]=y*N,o[5]=b*N,u=!0}return u},calculateSweptExtents:function(t){var n=this.shape,r=n.radius,i=this.startTransform,s=i[9],o=i[10],u=i[11],a=this.transform,f=a[9],l=a[10],c=a[11],h;s>f&&(h=s,s=f,f=h),o>l&&(h=o,o=l,l=h),u>c&&(h=u,u=c,c=h),t[0]=s-r,t[1]=o-r,t[2]=u-r,t[3]=f+r,t[4]=l+r,t[5]=c+r},calculateExtents:function(t){var n=this.shape,r=n.center,i=n.halfExtents,s=i[0],o=i[1],u=i[2],a=this.transform,f=a[0],l=a[1],c=a[2],h=a[3],p=a[4],d=a[5],v=a[6],m=a[7],g=a[8],y=a[9],b=a[10],w=a[11];if(r){var E=r[0],S=r[1],x=r[2];if(E!==0||S!==0||x!==0)y+=f*E+h*S+v*x,b+=l*E+p*S+m*x,w+=c*E+d*S+g*x}var T=(f<0?-f*s:f>0?f*s:0)+(h<0?-h*o:h>0?h*o:0)+(v<0?-v*u:v>0?v*u:0),N=(l<0?-l*s:l>0?l*s:0)+(p<0?-p*o:p>0?p*o:0)+(m<0?-m*u:m>0?m*u:0),C=(c<0?-c*s:c>0?c*s:0)+(d<0?-d*o:d>0?d*o:0)+(g<0?-g*u:g>0?g*u:0);t[0]=y-T,t[1]=b-N,t[2]=w-C,t[3]=y+T,t[4]=b+N,t[5]=w+C},rayTest:function(n){var r=this.transform,i={origin:at.prototype.m43InverseOrthonormalTransformPoint(r,n.origin),direction:at.prototype.m43InverseOrthonormalTransformVector(r,n.direction),maxFactor:n.maxFactor},s=this.shape.rayTest(i);return s!==null&&(s.hitPoint=t.m43TransformPoint(r,s.hitPoint),s.hitNormal=t.m43TransformVector(r,s.hitNormal)),s},integratePositionWithVelocities:function(t,n,r,i){var s=this.velocity,o=Math.sqrt;n[9]=t[9]+r*s[i],n[10]=t[10]+r*s[i+1],n[11]=t[11]+r*s[i+2];var u=s[i+3]*r,a=s[i+4]*r,f=s[i+5]*r,l=t[0],c=t[1],h=t[2],p=t[3],d=t[4],v=t[5],m=t[6],g=t[7],y=t[8],b=l-f*c+a*h,w=c+f*l-u*h,E=h-a*l+u*c,S=p-f*d+a*v,x=d+f*p-u*v,T=v-a*p+u*d,N=m-f*g+a*y,C=g+f*m-u*y,k=y-a*m+u*g,L=1/o(b*b+w*w+E*E);b*=L,w*=L,E*=L,L=-(b*S+w*x+E*T),S+=b*L,x+=w*L,T+=E*L,L=1/o(S*S+x*x+T*T),S*=L,x*=L,T*=L,L=-(b*N+w*C+E*k),N+=b*L,C+=w*L,k+=E*L,L=-(S*N+x*C+T*k),N+=S*L,C+=x*L,k+=T*L,L=1/o(N*N+C*C+k*k),N*=L,C*=L,k*=L,n[0]=b,n[1]=w,n[2]=E,n[3]=S,n[4]=x,n[5]=T,n[6]=N,n[7]=C,n[8]=k},applyBiasVelocities:function(t){var n=this.velocity;this.integratePositionWithVelocities(this.transform,this.startTransform,t,6),n[6]=n[7]=n[8]=0,n[9]=n[10]=n[11]=0},integratePosition:function(t){this.integratePositionWithVelocities(this.startTransform,this.transform,t,0)},refreshInertiaTensor:function(){var t=this.transform,n=this.inverseInertiaLocal,r=n[0],i=n[1],s=n[2],o=t[0],u=t[1],a=t[2],f=t[3],l=t[4],c=t[5],h=t[6],p=t[7],d=t[8],v=this.inverseInertia;v[0]=o*o*r+f*f*i+h*h*s,v[1]=o*u*r+f*l*i+h*p*s,v[2]=o*a*r+f*c*i+h*d*s,v[3]=u*o*r+l*f*i+p*h*s,v[4]=u*u*r+l*l*i+p*p*s,v[5]=u*a*r+l*c*i+p*d*s,v[6]=a*o*r+c*f*i+d*h*s,v[7]=a*u*r+c*l*i+d*p*s,v[8]=a*a*r+c*c*i+d*d*s},integrateVelocity:function(t,n){var r=this.velocity,i=Math.pow,s=i(1-this.linearDamping,n);r[0]=(r[0]+n*t[0])*s,r[1]=(r[1]+n*t[1])*s,r[2]=(r[2]+n*t[2])*s;var o=i(1-this.angularDamping,n),u=r[3]*o,a=r[4]*o,f=r[5]*o,l=L.MAX_ANGULAR/n,c=u*u+a*a+f*f;if(c>l*l){var h=l/Math.sqrt(c);u*=h,a*=h,f*=h}r[3]=u,r[4]=a,r[5]=f},isActiveVelocity:function(t,n){var r=this.shape.radius,i=this.velocity,s=i[0],o=i[1],u=i[2],a=s*s+o*o+u*u;return a>t*r*r?!0:(s=i[3],o=i[4],u=i[5],s*s+o*o+u*u>n?!0:!1)},isActive:function(){return this.permitSleep?this.isActiveVelocity(L.SLEEP_LINEAR_SQ,L.SLEEP_ANGULAR_SQ)?(this.wakeTimeStamp=this.world.timeStamp,!0):this.wakeTimeStamp+L.SLEEP_DELAY>this.world.timeStamp:!0}},W.uniqueId=0,z.sharedInverseInertiaLocal=t.v3BuildZero(),z.sharedInverseInertia=new Float32Array([0,0,0,0,0,0,0,0,0]),z.create=function(n){var r=new z,i=new W(n,r);r._private=i,r.userData="userData"in n?n.userData:null,Object.defineProperty(r,"shape",{value:n.shape,enumerable:!0});var s=n.kinematic!==undefined?n.kinematic:!1;Object.defineProperty(r,"transform",{get:function(){return t.m43Copy(this._private.transform)},set:function(n){var r=this._private;if(r.kinematic||!r.world)t.m43Copy(n,r.transform),r.world&&r.world.wakeBody(r)},enumerable:!0});var o=n.group!==undefined?n.group:ft.prototype.FILTER_STATIC;Object.defineProperty(r,"group",{value:o,enumerable:!0});var u=n.mask!==undefined?n.mask:ft.prototype.FILTER_ALL^ft.prototype.FILTER_STATIC;return Object.defineProperty(r,"mask",{value:u,enumerable:!0}),Object.defineProperty(r,"friction",{get:function(){return this._private.friction},set:function(t){var n=this._private;n.friction=t;var r=n.arbiters,i,s=r.length;for(i=0;i<s;i+=1)r[i].invalidateParameters()},enumerable:!0}),Object.defineProperty(r,"restitution",{get:function(){return this._private.restitution},set:function(t){var n=this._private;n.restitution=t;var r=n.arbiters,i,s=r.length;for(i=0;i<s;i+=1)r[i].invalidateParameters()},enumerable:!0}),Object.defineProperty(r,"kinematic",{value:s,enumerable:!0}),i.group=o,i.mask=u,i.kinematic=s,i.fixedRotation=!s,i.mass=0,i.inverseMass=0,i.inverseInertiaLocal=z.sharedInverseInertiaLocal,i.inverseInertia=z.sharedInverseInertia,i.collisionObject=!0,i.permitSleep=!1,i.sweepFrozen=!0,i.active=s,n.onPreSolveContact||n.onAddedContacts||n.onProcessedContacts||n.onRemovedContacts?i.contactCallbacks=new X(n,u):i.contactCallbacks=null,r},V.prototype={version:1,calculateExtents:z.prototype.calculateExtents,calculateTransform:z.prototype.calculateTransform,clone:function(){return V.create(this)}},V.create=function(n){var r=new V,i=new W(n,r);r._private=i,r.userData="userData"in n?n.userData:null,Object.defineProperty(r,"shape",{value:n.shape,enumerable:!0}),Object.defineProperty(r,"linearVelocity",{get:function(){var n=this._private.velocity;return t.v3Build(n[0],n[1],n[2])},set:function(t){var n=this._private.velocity;n[0]=t[0],n[1]=t[1],n[2]=t[2]},enumerable:!0}),Object.defineProperty(r,"angularVelocity",{get:function(){var n=this._private.velocity;return t.v3Build(n[3],n[4],n[5])},set:function(t){var n=this._private.velocity;n[3]=t[0],n[4]=t[1],n[5]=t[2]},enumerable:!0}),Object.defineProperty(r,"transform",{get:function(){return t.m43Copy(this._private.transform)},set:function(n){var r=this._private;t.m43Copy(n,r.transform);var i=r.arbiters,s,o=i.length;for(s=0;s<o;s+=1)i[s].skipDiscreteCollisions=!1},enumerable:!0}),Object.defineProperty(r,"active",{get:function(){return this._private.active},set:function(t){var n=this._private;if(t===n.active)n.world&&t&&(n.wakeTimeStamp=n.world.timeStamp);else if(n.world)if(t)n.world.wakeBody(n);else{var r=n.world.activeBodies;r[r.indexOf(n)]=r[r.length-1],r.pop(),n.active=!1;var i=n.arbiters,s,o=i.length;for(s=0;s<o;s+=1){var u=i[s];if(!u.active)continue;u.active=!1;var a=n.world.activeArbiters;a[a.indexOf(u)]=a[a.length-1],a.pop()}n.world.syncBody(n)}else n.active=t},enumerable:!0});var s=n.group!==undefined?n.group:ft.prototype.FILTER_DYNAMIC;Object.defineProperty(r,"group",{value:s,enumerable:!0});var o=n.mask!==undefined?n.mask:ft.prototype.FILTER_ALL;Object.defineProperty(r,"mask",{value:o,enumerable:!0}),Object.defineProperty(r,"friction",{get:function(){return this._private.friction},set:function(t){var n=this._private;n.friction=t;var r=n.arbiters,i,s=r.length;for(i=0;i<s;i+=1)r[i].invalidateParameters()},enumerable:!0}),Object.defineProperty(r,"restitution",{get:function(){return this._private.restitution},set:function(t){var n=this._private;n.restitution=t;var r=n.arbiters,i,s=r.length;for(i=0;i<s;i+=1)r[i].invalidateParameters()},enumerable:!0}),Object.defineProperty(r,"linearDamping",{get:function(){return this._private.linearDamping},set:function(t){this._private.linearDamping=t},enumerable:!0}),Object.defineProperty(r,"angularDamping",{get:function(){return this._private.angularDamping},set:function(t){this._private.angularDamping=t},enumerable:!0});var u=n.kinematic!==undefined?n.kinematic:!1;Object.defineProperty(r,"kinematic",{value:u,enumerable:!0});var a=n.mass!==undefined?n.mass:1;Object.defineProperty(r,"mass",{value:a,enumerable:!0});var f=n.inertia?t.v3Copy(n.inertia):t.v3ScalarMul(n.shape.inertia,a);return Object.defineProperty(r,"inertia",{get:function(){return t.v3Copy(f)},enumerable:!0}),i.group=s,i.mask=o,i.active=n.active!==undefined?n.active:n.frozen!==undefined?!n.frozen:!0,i.kinematic=u,i.fixedRotation=u||(n.fixedRotation!==undefined?n.fixedRotation:!1),i.inverseInertiaLocal=i.fixedRotation?t.v3BuildZero():t.v3Build(1/f[0],1/f[1],1/f[2]),i.inverseInertia=t.m33BuildIdentity(),i.mass=a,i.inverseMass=u?0:1/i.mass,i.collisionObject=!1,i.permitSleep=n.permitSleep!==undefined?n.permitSleep:!u,i.sweepFrozen=u,n.onPreSolveContact||n.onAddedContacts||n.onProcessedContacts||n.onRemovedContacts?i.contactCallbacks=new X(n,o):i.contactCallbacks=null,r},$.prototype={version:1,preStep:function(){},applyCachedImpulses:function(){},computeAndApplyImpulses:function(){}},$.create=function(t,n){var r=new $;return r.world=null,r.userData=null,A(r,n),r.type=t,r};var J=function(t,n){t.userData=n.userData;var r=t._private;r.world=null,r.bodyA=n.bodyA._private,Object.defineProperty(t,"bodyA",{value:n.bodyA,enumerable:!0}),r.bodyB=n.bodyB?n.bodyB._private:null,Object.defineProperty(t,"bodyB",{value:n.bodyB,enumerable:!0}),r.active=n.active!==undefined?n.active:!0,Object.defineProperty(t,"active",{get:function(){return this._private.active},set:function(t){var n=this._private;if(t===n.active)n.world&&t&&(n.wakeTimeStamp=n.world.timeStamp);else if(n.world)if(t)n.world.wakeConstraint(n);else{var r=n.world.activeConstraints;r[r.indexOf(n)]=r[r.length-1],r.pop(),n.active=!1}else n.active=t},enumerable:!0})};K.prototype={version:1,type:"POINT2POINT"},Q.prototype={version:1,preStep:function(t,n){var r=this.bodyA,i=this.bodyB,s=this.data,o=s[0],u=s[1],a=s[2],f=s[3],l=s[4],c=s[5],h=r.transform,p=s[6]=h[0]*o+h[3]*u+h[6]*a,d=s[7]=h[1]*o+h[4]*u+h[7]*a,v=s[8]=h[2]*o+h[5]*u+h[8]*a,m,g,y,b;i&&(b=i.transform,m=s[9]=b[0]*f+b[3]*l+b[6]*c,g=s[10]=b[1]*f+b[4]*l+b[7]*c,y=s[11]=b[2]*f+b[5]*l+b[8]*c);var w=r.inverseInertia;s[12]=-v*w[3]+d*w[6],s[13]=-v*w[4]+d*w[7],s[14]=-v*w[5]+d*w[8],s[15]=v*w[0]+ -p*w[6],s[16]=v*w[1]+ -p*w[7],s[17]=v*w[2]+ -p*w[8],s[18]=-d*w[0]+p*w[3],s[19]=-d*w[1]+p*w[4],s[20]=-d*w[2]+p*w[5];var E=r.inverseMass+(i?i.inverseMass:0),S=E+s[13]*-v+s[14]*d,x=E+s[15]*v+s[17]*-p,T=E+s[18]*-d+s[19]*p,N=s[12]*v+s[14]*-p,C=s[12]*-d+s[13]*p,k=s[15]*-d+s[16]*p;i&&(w=i.inverseInertia,s[21]=-y*w[3]+g*w[6],s[22]=-y*w[4]+g*w[7],s[23]=-y*w[5]+g*w[8],s[24]=y*w[0]+ -m*w[6],s[25]=y*w[1]+ -m*w[7],s[26]=y*w[2]+ -m*w[8],s[27]=-g*w[0]+m*w[3],s[28]=-g*w[1]+m*w[4],s[29]=-g*w[2]+m*w[5],S+=s[22]*-y+s[23]*g,x+=s[24]*y+s[26]*-m,T+=s[27]*-g+s[28]*m,N+=s[21]*y+s[23]*-m,C+=s[21]*-g+s[22]*m,k+=s[24]*-g+s[25]*m);var L=s[30],A=2/n*L*s[31]/(1-L),O=L/(A*A),M=1/(1+O);s[33]=1-O*M;var _=x*T-k*k,D=C*k-N*T,P=N*k-C*x,H=M/(S*_+N*D+C*P);s[34]=H*_,s[35]=H*D,s[36]=H*P,s[37]=H*(S*T-C*C),s[38]=H*(N*C-S*k),s[39]=H*(S*x-N*N);var B=p+h[9],j=d+h[10],F=v+h[11];i?(B-=m+b[9],j-=g+b[10],F-=y+b[11]):(B-=f,j-=l,F-=c);var I=-L/n;s[43]=B*I,s[44]=j*I,s[45]=F*I,s[40]*=t,s[41]*=t,s[42]*=t},applyCachedImpulses:function(){var t=this.data,n=t[40],r=t[41],i=t[42],s=this.bodyA,o=s.velocity,u=s.inverseMass;o[0]+=n*u,o[1]+=r*u,o[2]+=i*u,o[3]-=t[12]*n+t[15]*r+t[18]*i,o[4]-=t[13]*n+t[16]*r+t[19]*i,o[5]-=t[14]*n+t[17]*r+t[20]*i;var a=this.bodyB;a&&(o=a.velocity,u=a.inverseMass,o[0]-=n*u,o[1]-=r*u,o[2]-=i*u,o[3]+=t[21]*n+t[24]*r+t[27]*i,o[4]+=t[22]*n+t[25]*r+t[28]*i,o[5]+=t[23]*n+t[26]*r+t[29]*i)},computeAndApplyImpulses:function(){var t=this.bodyA,n=this.bodyB,r=this.data,i=r[40],s=r[41],o=r[42],u=t.velocity,a=r[43]-(u[0]+u[4]*r[8]-u[5]*r[7]),f=r[44]-(u[1]+u[5]*r[6]-u[3]*r[8]),l=r[45]-(u[2]+u[3]*r[7]-u[4]*r[6]),c;n&&(c=n.velocity,a+=c[0]+c[4]*r[11]-c[5]*r[10],f+=c[1]+c[5]*r[9]-c[3]*r[11],l+=c[2]+c[3]*r[10]-c[4]*r[9]);var h=r[33];i=i*h+r[34]*a+r[35]*f+r[36]*l,s=s*h+r[35]*a+r[37]*f+r[38]*l,o=o*h+r[36]*a+r[38]*f+r[39]*l;var p=r[32];if(p!==0){var d=i*i+s*s+o*o;d>p*p&&(d=p/Math.sqrt(d),i*=d,s*=d,o*=d)}var v=i-r[40],m=s-r[41],g=o-r[42];r[40]=i,r[41]=s,r[42]=o;var y=t.inverseMass;u[0]+=v*y,u[1]+=m*y,u[2]+=g*y,u[3]-=r[12]*v+r[15]*m+r[18]*g,u[4]-=r[13]*v+r[16]*m+r[19]*g,u[5]-=r[14]*v+r[17]*m+r[20]*g,n&&(y=n.inverseMass,c[0]-=v*y,c[1]-=m*y,c[2]-=g*y,c[3]+=r[21]*v+r[24]*m+r[27]*g,c[4]+=r[22]*v+r[25]*m+r[28]*g,c[5]+=r[23]*v+r[26]*m+r[29]*g)}},K.create=function(n){var r=new K,i=new Q;r._private=i,J(r,n);var s=i.data;s[0]=n.pivotA[0],s[1]=n.pivotA[1],s[2]=n.pivotA[2],Object.defineProperty(r,"pivotA",{get:function(){var n=this._private.data;return t.v3Build(n[0],n[1],n[2])},set:function(t){var n=this._private.data;n[0]=t[0],n[1]=t[1],n[2]=t[2]},enumerable:!0});if(n.pivotB)s[3]=n.pivotB[0],s[4]=n.pivotB[1],s[5]=n.pivotB[2];else{var o=t.m43TransformPoint(i.bodyA.transform,n.pivotA);s[3]=o[0],s[4]=o[1],s[5]=o[2]}return Object.defineProperty(r,"pivotB",{get:function(){var n=this._private.data;return t.v3Build(n[3],n[4],n[5])},set:function(t){var n=this._private.data;n[3]=t[0],n[4]=t[1],n[5]=t[2]},enumerable:!0}),s[30]=n.force!==undefined?n.force:.3,Object.defineProperty(r,"force",{get:function(){return this._private.data[30]},set:function(t){this._private.data[30]=t},enumerable:!0}),s[31]=n.damping!==undefined?n.damping:1,Object.defineProperty(r,"damping",{get:function(){return this._private.data[31]},set:function(t){this._private.data[31]=t},enumerable:!0}),s[32]=n.impulseClamp!==undefined?n.impulseClamp:0,Object.defineProperty(r,"impulseClamp",{get:function(){return this._private.data[32]},set:function(t){this._private.data[32]=t},enumerable:!0}),r},G.prototype={version:1,jump:function(){var t=this._private,n=t.rigidBody._private,r=n.world;r&&(n.velocity[1]=Math.sqrt(-2*(this.maxJumpHeight-this.stepHeight)*r.gravity[1]),n.transform[10]+=
this.stepHeight,r.wakeBody(n))},calculateExtents:function(t){this._private.rigidBody.calculateExtents(t)},calculateTransform:function(t,n){this._private.rigidBody.calculateTransform(t,n)}},Y.prototype={version:1,onGroundConvexCallback:function(t){return t.hitNormal[1]>=.26}},G.create=function(n){var r=new G,i=new Y;r._private=i,r.userData=n.userData!==undefined?n.userData:null,Object.defineProperty(r,"crouch",{get:function(){return this._private.crouch},set:function(t){var n=this._private;if(!n.dead&&t!==n.crouch){var r=n.rigidBody._private,i=r.shape;n.crouch=t,t?(i.halfHeight=this.crouchHeight*.5-this.radius,r.transform[10]-=(this.height-this.crouchHeight)*.5):(i.halfHeight=this.height*.5-this.radius,r.transform[10]+=(this.height-this.crouchHeight)*.5),r.world&&r.world.wakeBody(r)}},enumerable:!0}),Object.defineProperty(r,"dead",{get:function(){return this._private.dead},set:function(t){var n=this._private;if(n.dead!==t){var r=n.rigidBody._private,i=r.shape;n.dead=t,t?(i.halfHeight=0,r.transform[10]-=(this.height-this.radius)*.5):(i.halfHeight=this.height*.5-this.radius,r.transform[10]+=(this.height-this.radius)*.5),r.world&&r.world.wakeBody(r)}},enumerable:!0}),Object.defineProperty(r,"height",{value:n.height,enumerable:!0}),Object.defineProperty(r,"radius",{value:n.radius,enumerable:!0}),Object.defineProperty(r,"stepHeight",{value:n.stepHeight!==undefined?n.stepHeight:.35,enumerable:!0}),r.maxJumpHeight=n.maxJumpHeight!==undefined?n.maxJumpHeight:1,Object.defineProperty(r,"crouchHeight",{value:n.crouchHeight!==undefined?n.crouchHeight:.5*n.height,enumerable:!0}),Object.defineProperty(r,"onGround",{get:function(){var t=this._private,n=t.rigidBody._private;if(n.world){var r=n.transform,i=t.start,s=t.end;i[9]=r[9],i[10]=r[10],i[11]=r[11],s[9]=r[9],s[10]=r[10]-this.stepHeight*.5,s[11]=r[11];var o=n.world.convexSweepTest({shape:n.shape._public,from:i,to:s,group:ft.prototype.FILTER_CHARACTER},this.onGroundConvexCallback);return o!==null}return!1},enumerable:!0}),Object.defineProperty(r,"position",{get:function(){var n=this._private.rigidBody;return t.m43Pos(n._private.transform)},set:function(t){var n=this._private.rigidBody,r=n._private.transform;r[9]=t[0],r[10]=t[1],r[11]=t[2],n.transform=n._private.transform,n.active=!0},enumerable:!0}),Object.defineProperty(r,"velocity",{get:function(){var t=this._private.rigidBody;return t.linearVelocity},set:function(t){var n=this._private.rigidBody;n.linearVelocity=t,n.active=!0},enumerable:!0});var s=n.group!==undefined?n.group:ft.prototype.FILTER_CHARACTER;Object.defineProperty(r,"group",{value:s,enumerable:!0});var o=n.mask!==undefined?n.mask:ft.prototype.FILTER_ALL;Object.defineProperty(r,"mask",{value:o,enumerable:!0});var u=D.create({radius:r.radius,height:2*(r.height*.5-r.radius),margin:0}),a=V.create({shape:u,mass:n.mass,transform:n.transform,linearVelocity:n.velocity,group:s,mask:o,friction:n.friction,restitution:n.restitution,linearDamping:n.linearDamping,angularDamping:n.angularDamping,fixedRotation:!0});return i.rigidBody=a,a._private._public=r,r},Z.prototype={version:1,removeVertex:function(t){this.numVertices-=1;var n=this.simplex,r=t*9,i=this.numVertices*9;n[r]=n[i],n[r+1]=n[i+1],n[r+2]=n[i+2],n[r+3]=n[i+3],n[r+4]=n[i+4],n[r+5]=n[i+5],n[r+6]=n[i+6],n[r+7]=n[i+7],n[r+8]=n[i+8]},reduceVertices:function(t){this.numVertices>=4&&t[3]===0&&(this.numVertices-=1);var n=this.simplex,r;this.numVertices>=3&&t[2]===0&&(this.numVertices-=1,r=this.numVertices*9,n[18]=n[r],n[19]=n[r+1],n[20]=n[r+2],n[21]=n[r+3],n[22]=n[r+4],n[23]=n[r+5],n[24]=n[r+6],n[25]=n[r+7],n[26]=n[r+8]),this.numVertices>=2&&t[1]===0&&(this.numVertices-=1,r=this.numVertices*9,n[9]=n[r],n[10]=n[r+1],n[11]=n[r+2],n[12]=n[r+3],n[13]=n[r+4],n[14]=n[r+5],n[15]=n[r+6],n[16]=n[r+7],n[17]=n[r+8]),this.numVertices>=1&&t[0]===0&&(this.numVertices-=1,r=this.numVertices*9,n[0]=n[r],n[1]=n[r+1],n[2]=n[r+2],n[3]=n[r+3],n[4]=n[r+4],n[5]=n[r+5],n[6]=n[r+6],n[7]=n[r+7],n[8]=n[r+8])},updateClosestPoints:function(){var t=this.numVertices;if(t===0)return!1;var n=this.simplex,r=this.closest,i;if(t===1)return r[0]=n[3],r[1]=n[4],r[2]=n[5],r[3]=n[6],r[4]=n[7],r[5]=n[8],!0;var s=n[0],o=n[1],u=n[2],a=n[9],f=n[10],l=n[11];if(t===2){var c=s-a,h=o-f,p=u-l,d=s*c+o*h+u*p;if(d>0){var v=c*c+h*h+p*p;if(d<v){d/=v;var m=1-d;return r[0]=n[3]*m+n[12]*d,r[1]=n[4]*m+n[13]*d,r[2]=n[5]*m+n[14]*d,r[3]=n[6]*m+n[15]*d,r[4]=n[7]*m+n[16]*d,r[5]=n[8]*m+n[17]*d,!0}this.removeVertex(0)}else this.removeVertex(1);for(i=0;i<6;i+=1)r[i]=n[i+3];return!0}var g=this.cachedCoords,y,b,w;if(t===3)return this.closestPointTriangle(0,9,18,g),this.reduceVertices(g),y=g[0],b=g[1],w=g[2],r[0]=y*n[3]+b*n[12]+w*n[21],r[1]=y*n[4]+b*n[13]+w*n[22],r[2]=y*n[5]+b*n[14]+w*n[23],r[3]=y*n[6]+b*n[15]+w*n[24],r[4]=y*n[7]+b*n[16]+w*n[25],r[5]=y*n[8]+b*n[17]+w*n[26],!0;if(t===4){var E=this.closestPointTetrahedron(g);if(E){this.reduceVertices(g),y=g[0],b=g[1],w=g[2];var S=g[3];return r[0]=y*n[3]+b*n[12]+w*n[21]+S*n[30],r[1]=y*n[4]+b*n[13]+w*n[22]+S*n[31],r[2]=y*n[5]+b*n[14]+w*n[23]+S*n[32],r[3]=y*n[6]+b*n[15]+w*n[24]+S*n[33],r[4]=y*n[7]+b*n[16]+w*n[25]+S*n[34],r[5]=y*n[8]+b*n[17]+w*n[26]+S*n[35],!0}return!1}return!1},closestPointTetrahedron:function(t){var n=this.simplex,r=n[0],i=n[1],s=n[2],o=n[9],u=n[10],a=n[11],f=n[18],l=n[19],c=n[20],h=n[27],p=n[28],d=n[29],v=o-r,m=u-i,g=a-s,y=f-r,b=l-i,w=c-s,E=h-r,S=p-i,x=d-s,T=f-o,N=l-u,C=c-a,k=h-o,L=p-u,A=d-a,O,M,_,D,P;O=m*w-g*b,M=g*y-v*w,_=v*b-m*y,D=E*O+S*M+x*_,P=-(r*O+i*M+s*_);var H=P*D<=0;O=b*x-w*S,M=w*E-y*x,_=y*S-b*E,D=v*O+m*M+g*_,P=-(r*O+i*M+s*_);var B=P*D<=0;O=S*g-x*m,M=x*v-E*g,_=E*m-S*v,D=y*O+b*M+w*_,P=-(r*O+i*M+s*_);var j=P*D<=0;O=L*C-A*N,M=A*T-k*C,_=k*N-L*T,D=v*O+m*M+g*_,P=o*O+u*M+a*_;var F=P*D<=0;t[0]=t[1]=t[2]=t[3]=0;if(!H&&!B&&!j&&!F)return!1;var I=this.tempCoords,q=Number.MAX_VALUE,R;return H&&(R=this.closestPointTriangle(0,9,18,I,!0),R<q&&(q=R,t[0]=I[0],t[1]=I[1],t[2]=I[2],t[3]=0)),B&&(R=this.closestPointTriangle(0,18,27,I,!0),R<q&&(q=R,t[0]=I[0],t[1]=0,t[2]=I[1],t[3]=I[2])),j&&(R=this.closestPointTriangle(0,27,9,I,!0),R<q&&(q=R,t[0]=I[0],t[1]=I[2],t[2]=0,t[3]=I[1])),F&&(R=this.closestPointTriangle(9,27,18,I,!0),R<q&&(q=R,t[0]=0,t[1]=I[0],t[2]=I[2],t[3]=I[1])),!0},closestPointTriangle:function(t,n,r,i,s){var o=this.simplex,u=o[t],a=o[t+1],f=o[t+2],l=o[n],c=o[n+1],h=o[n+2],p=o[r],d=o[r+1],v=o[r+2],m=u-l,g=a-c,y=f-h,b=u-p,w=a-d,E=f-v,S=u*m+a*g+f*y,x=u*b+a*w+f*E;if(S<=0&&x<=0)return i[0]=1,i[1]=i[2]=0,s?u*u+a*a+f*f:undefined;var T=l*m+c*g+h*y,N=l*b+c*w+h*E;if(T>=0&&N<=T)return i[1]=1,i[0]=i[2]=0,s?l*l+c*c+h*h:undefined;var C,k,L,A,O=S*N-T*x;if(O<=0&&S>=0&&T<=0)return C=S/(S-T),i[0]=1-C,i[1]=C,i[2]=0,s?(k=u-C*m,L=a-C*g,A=f-C*y,k*k+L*L+A*A):undefined;var M=p*m+d*g+v*y,_=p*b+d*w+v*E;if(_>=0&&M<=_)return i[0]=i[1]=0,i[2]=1,s?p*p+d*d+v*v:undefined;var D=M*x-S*_;if(D<=0&&x>=0&&_<=0)return C=x/(x-_),i[0]=1-C,i[1]=0,i[2]=C,s?(k=u-C*b,L=a-C*w,A=f-C*E,k*k+L*L+A*A):undefined;var P=T*_-M*N;if(P<=0&&N-T>=0&&M-_>=0)return C=(N-T)/(N-T+(M-_)),i[0]=0,i[1]=1-C,i[2]=C,s?(k=l*(1-C)+p*C,L=c*(1-C)+d*C,A=h*(1-C)+v*C,k*k+L*L+A*A):undefined;var H=1/(P+D+O);C=D*H;var B=O*H;return i[0]=1-C-B,i[1]=C,i[2]=B,s?(k=u-m*C-b*B,L=a-g*C-w*B,A=f-y*C-E*B,k*k+L*L+A*A):undefined},evaluate:function(t,n,r){var i=t.axis,s=t.shapeA,o=t.shapeB;this.numVertices=0;var u,a,f;u=a=f=Number.MAX_VALUE;var l=0,c=100,h=!1,p=Number.MAX_VALUE,d=n[0],v=n[1],m=n[2],g=n[3],y=n[4],b=n[5],w=n[6],E=n[7],S=n[8],x=n[9],T=n[10],N=n[11],C=r[0],k=r[1],A=r[2],O=r[3],M=r[4],_=r[5],D=r[6],P=r[7],H=r[8],B=r[9],j=r[10],F=r[11],I=i[0],q=i[1],R=i[2],U,z=t.closestA,W=t.closestB,X=this.closest,V=this.simplex,$=1e-4;for(;;){l+=1,z[0]=-(d*I+v*q+m*R),z[1]=-(g*I+y*q+b*R),z[2]=-(w*I+E*q+S*R),W[0]=C*I+k*q+A*R,W[1]=O*I+M*q+_*R,W[2]=D*I+P*q+H*R,s.localSupportWithoutMargin(z,z),o.localSupportWithoutMargin(W,W);var J=z[0],K=z[1],Q=z[2],G=z[0]=d*J+g*K+w*Q+x,Y=z[1]=v*J+y*K+E*Q+T,Z=z[2]=m*J+b*K+S*Q+N;J=W[0],K=W[1],Q=W[2];var et=W[0]=C*J+O*K+D*Q+B,tt=W[1]=k*J+M*K+P*Q+j,nt=W[2]=A*J+_*K+H*Q+F,rt=G-et,it=Y-tt,st=Z-nt,ot=!1,ut=this.numVertices*9,at;for(at=0;at<ut;at+=9)J=rt-V[at],K=it-V[at+1],Q=st-V[at+2],J*J+K*K+Q*Q<$&&(ot=!0);ot||(J=rt-u,K=it-a,Q=st-f,ot=J*J+K*K+Q*Q<$);if(ot){h=!0;break}var ft=I*rt+q*it+R*st;if(p-ft<=p*L.GJK_FRACTIONAL_THRESHOLD){h=!0;break}u=V[ut]=rt,a=V[ut+1]=it,f=V[ut+2]=st,V[ut+3]=G,V[ut+4]=Y,V[ut+5]=Z,V[ut+6]=et,V[ut+7]=tt,V[ut+8]=nt,this.numVertices+=1;if(!this.updateClosestPoints()){h=!1;break}J=X[0]-X[3],K=X[1]-X[4],Q=X[2]-X[5],U=J*J+K*K+Q*Q;if(U<=L.GJK_EPA_DISTANCE_THRESHOLD){h=!0;break}I=J,q=K,R=Q;var lt=p;p=U;if(lt-p<=L.GJK_FRACTIONAL_THRESHOLD*lt){h=!0;break}if(l>=c){h=!0;break}if(this.numVertices===4)break}U=I*I+q*q+R*R;if(U<L.DONT_NORMALIZE_THRESHOLD)return i[0]=I,i[1]=q,i[2]=R,undefined;var ct=1/Math.sqrt(U);return i[0]=I*ct,i[1]=q*ct,i[2]=R*ct,h?(z[0]=X[0],z[1]=X[1],z[2]=X[2],W[0]=X[3],W[1]=X[4],W[2]=X[5],Math.sqrt(p)):undefined}},Z.create=function(){var t=new Z;return t.simplex=new Float32Array(36),t.numVertices=0,t.closest=new Float32Array(6),t.cachedCoords=new Float32Array(4),t.tempCoords=new Float32Array(4),t},et.prototype={version:1,MAX_VERTICES:64,MAX_FACES:128,bind:function(t,n,r,i){t.edge[n]=i,t.adjFace[n]=r,r.edge[i]=n,r.adjFace[i]=t},append:function(t,n){n.leaf0=null,n.leaf1=t.root,t.root&&(t.root.leaf0=n),t.root=n,t.count+=1},remove:function(t,n){var r=n.leaf0,i=n.leaf1;i&&(i.leaf0=r),r&&(r.leaf1=i),n===t.root&&(t.root=i),t.count-=1},findBest:function(){var t=this.hull.root,n=t.distance*t.distance,r;for(r=t.leaf1;r!==null;r=r.leaf1){var i=r.distance*r.distance;i<n&&(t=r,n=i)}return t},getEdgeDistance:function(t,n,r){var i=this.vertex_store,s=i[n],o=i[n+1],u=i[n+2],a=i[r],f=i[r+1],l=i[r+2],c=a-s,h=f-o,p=l-u,d=t.normal,v=d[0],m=d[1],g=d[2],y=h*g-p*m,b=p*v-c*g,w=c*m-h*v,E=s*y+o*b+u*w;if(E<=0){var S=c*c+h*h+p*p,x=s*c+o*h+u*p,T=a*c+f*p+l*p;if(x>=0)return Math.sqrt(s*s+o*o+u*u);if(T<=0)return Math.sqrt(a*a+f*f+l*l);var N=s*a+o*f+u*l,C=(s*s+o*o+u*u)*(a*a+f*f+l*l)-N*N;return C>=0?Math.sqrt(C/S):0}return undefined},buildNewFace:function(t,n,r,i){var s=this.stock.root;if(s===null)return null;s.pass=0,s.vertex[0]=t,s.vertex[1]=n,s.vertex[2]=r;var o=this.vertex_store,u=o[t],a=o[t+1],f=o[t+2],l=o[n],c=o[n+1],h=o[n+2],p=o[r],d=o[r+1],v=o[r+2],m=l-u,g=c-a,y=h-f,b=p-u,w=d-a,E=v-f,S=s.normal,x=S[0]=g*E-y*w,T=S[1]=y*b-m*E,N=S[2]=m*w-g*b,C=x*x+T*T+N*N;if(C>L.DONT_NORMALIZE_THRESHOLD){s.distance=this.getEdgeDistance(s,t,n),s.distance===undefined&&(s.distance=this.getEdgeDistance(s,n,r)),s.distance===undefined&&(s.distance=this.getEdgeDistance(s,r,t));var k=1/Math.sqrt(C);s.distance===undefined&&(s.distance=(u*x+a*T+f*N)*k);if(i||s.distance>=-0.000001)return S[0]*=k,S[1]*=k,S[2]*=k,this.remove(this.stock,s),this.append(this.hull,s),s}return null},expandFace:function(t,n,r,i,s){if(r.pass!==t){var o=r.normal,u=o[0],a=o[1],f=o[2],l=this.vertex_store,c=l[n],h=l[n+1],p=l[n+2],d=(i+1)%3;if(u*c+a*h+f*p-r.distance<-0.000001){var v=this.buildNewFace(r.vertex[d],r.vertex[i],n,!1);if(v)return this.bind(v,0,r,i),s.cf?this.bind(s.cf,1,v,2):s.ff=v,s.cf=v,s.numFaces+=1,!0}else{var m=(i+2)%3;r.pass=t;if(this.expandFace(t,n,r.adjFace[d],r.edge[d],s)&&this.expandFace(t,n,r.adjFace[m],r.edge[m],s))return this.remove(this.hull,r),this.append(this.stock,r),!0}}return!1},evaluate:function(n,r,i,s){var o=r.shapeA,u=r.shapeB,a=this.hull,f=this.stock;while(a.root){var l=a.root;this.remove(a,l),this.append(f,l)}var c=n[27],h=n[28],p=n[29],d,v,m=n[0]-c,g=n[1]-h,y=n[2]-p,b=n[9]-c,w=n[10]-h,E=n[11]-p,S=n[18]-c,x=n[19]-h,T=n[20]-p;m*(w*T-E*x)+g*(E*S-b*T)+y*(b*x-w*S)<0?(d=9,v=0):(d=0,v=9);var N=this.vertex_store,C;for(C=0;C<9;C+=1)N[C]=n[d+C],N[9+C]=n[v+C],N[18+C]=n[18+C],N[27+C]=n[27+C];var k=this.buildNewFace(0,9,18,!0),A=this.buildNewFace(9,0,27,!0),O=this.buildNewFace(18,9,27,!0),M=this.buildNewFace(0,18,27,!0),_=36;if(a.count!==4)return t.v3Build(n[3],n[4],n[5],r.closestA),t.v3Build(n[6],n[7],n[8],r.closestB),0;var D=this.findBest(),P=0,H=0;this.bind(k,0,A,0),this.bind(k,1,O,0),this.bind(k,2,M,0),this.bind(A,1,M,2),this.bind(A,2,O,1),this.bind(O,2,M,1);var B=i[0],j=i[1],F=i[2],I=i[3],q=i[4],R=i[5],U=i[6],z=i[7],W=i[8],X=i[9],V=i[10],$=i[11],J=s[0],K=s[1],Q=s[2],G=s[3],Y=s[4],Z=s[5],et=s[6],tt=s[7],nt=s[8],rt=s[9],it=s[10],st=s[11],ot=r.closestA,ut=r.closestB,at=this.horizon,ft,lt,ct,ht;for(;H<100;H+=1){if(_>=this.MAX_VERTICES*9)break;at.cf=at.ff=null,at.numFaces=0;var pt=_;_+=9,P+=1,D.pass=P,ft=D.normal,lt=ft[0],ct=ft[1],ht=ft[2],ot[0]=B*lt+j*ct+F*ht,ot[1]=I*lt+q*ct+R*ht,ot[2]=U*lt+z*ct+W*ht,ut[0]=-(J*lt+K*ct+Q*ht),ut[1]=-(G*lt+Y*ct+Z*ht),ut[2]=-(et*lt+tt*ct+nt*ht),o.localSupportWithoutMargin(ot,ot),u.localSupportWithoutMargin(ut,ut),c=ot[0],h=ot[1],p=ot[2],m=B*c+I*h+U*p+X,g=j*c+q*h+z*p+V,y=F*c+R*h+W*p+$,c=ut[0],h=ut[1],p=ut[2],b=J*c+G*h+et*p+rt,w=K*c+Y*h+tt*p+it,E=Q*c+Z*h+nt*p+st;var dt,vt,mt;N[pt+3]=m,N[pt+4]=g,N[pt+5]=y,N[pt+6]=b,N[pt+7]=w,N[pt+8]=E,N[pt]=dt=m-b,N[pt+1]=vt=g-w,N[pt+2]=mt=y-E;var gt=lt*dt+ct*vt+ht*mt-D.distance;if(!(gt>L.GJK_EPA_DISTANCE_THRESHOLD))break;var yt,bt=!0;for(yt=0;yt<3&&bt;yt+=1)bt=bt&&this.expandFace(P,pt,D.adjFace[yt],D.edge[yt],at);if(!(bt&&at.numFaces>=3))break;this.bind(at.cf,1,at.ff,2),this.remove(a,D),this.append(f,D),D=this.findBest()}ft=D.normal,lt=ft[0],ct=ft[1],ht=ft[2];var wt=D.distance,Et=lt*wt,St=ct*wt,xt=ht*wt;S=D.vertex[0],x=D.vertex[1],T=D.vertex[2];var Tt=N[S]-Et,Nt=N[S+1]-St,Ct=N[S+2]-xt,kt=N[x]-Et,Lt=N[x+1]-St,At=N[x+2]-xt,Ot=N[T]-Et,Mt=N[T+1]-St,_t=N[T+2]-xt;c=Lt*_t-At*Mt,h=At*Ot-kt*_t,p=kt*Mt-Lt*Ot;var Dt=Math.sqrt(c*c+h*h+p*p);c=Mt*Ct-_t*Nt,h=_t*Tt-Ot*Ct,p=Ot*Nt-Mt*Tt;var Pt=Math.sqrt(c*c+h*h+p*p);c=Nt*At-Ct*Lt,h=Ct*kt-Tt*At,p=Tt*Lt-Nt*kt;var Ht=Math.sqrt(c*c+h*h+p*p),Bt=1/(Dt+Pt+Ht);Dt*=Bt,Pt*=Bt,Ht*=Bt,ot[0]=ot[1]=ot[2]=0,ut[0]=ut[1]=ut[2]=0;for(C=0;C<3;C+=1)ot[C]+=Dt*N[S+3+C]+Pt*N[x+3+C]+Ht*N[T+3+C],ut[C]+=Dt*N[S+6+C]+Pt*N[x+6+C]+Ht*N[T+6+C];var jt=r.axis;return jt[0]=-lt,jt[1]=-ct,jt[2]=-ht,-D.distance}},et.create=function(){var n=new et,r;n.vertex_store=new Float32Array(n.MAX_VERTICES*9);var i=[];for(r=0;r<n.MAX_FACES;r+=1)i[r]={normal:t.v3BuildZero(),distance:0,vertex:new Int16Array(3),adjFace:[null,null,null],edge:new Int16Array(3),leaf0:null,leaf1:null,pass:0};n.hull={root:null,count:0},n.stock={root:null,count:0},n.horizon={cf:null,ff:null,numFaces:0};for(r=0;r<n.MAX_FACES;r+=1)n.append(n.stock,i[n.MAX_FACES-r-1]);return n};var tt={};tt.contactPool=[],tt.contactPoolSize=0,tt.allocate=function(){var t;return this.contactPoolSize===0?t=new Float32Array(52):(this.contactPoolSize-=1,t=this.contactPool[this.contactPoolSize]),t[51]=1,t},tt.deallocate=function(t){this.contactPool[this.contactPoolSize]=t,this.contactPoolSize+=1,t[40]=0},nt.create=function(){var n=new nt;return Object.defineProperty(n,"localPointOnA",{get:function(){var n=this._private;return t.v3Build(n[0],n[1],n[2])},set:function(t){var n=this._private;n[0]=t[0],n[1]=t[1],n[2]=t[2]},enumerable:!0}),Object.defineProperty(n,"localPointOnB",{get:function(){var n=this._private;return t.v3Build(n[3],n[4],n[5])},set:function(t){var n=this._private;n[3]=t[0],n[4]=t[1],n[5]=t[2]},enumerable:!0}),Object.defineProperty(n,"worldNormalOnB",{get:function(){var n=this._private;return t.v3Build(n[12],n[13],n[14])},set:function(t){var n=this._private;n[12]=t[0],n[13]=t[1],n[14]=t[2]},enumerable:!0}),Object.defineProperty(n,"added",{get:function(){var t=this._private;return 0<t[51]},enumerable:!0}),Object.defineProperty(n,"distance",{get:function(){var t=this._private;return t[21]},enumerable:!0}),n},tt.publicContacts=[nt.create(),nt.create(),nt.create()],tt.callbackContacts=[],rt.prototype={version:1,insertContact:function(t,n,r,i,s){var o=r[0],u=r[1],a=r[2],f=o*o+u*u+a*a;if(f<L.DONT_NORMALIZE_THRESHOLD)return;var l=1/Math.sqrt(f);o*=l,u*=l,a*=l;var c=this.objectA,h=this.objectB,p=c.transform,d=h.transform,v=t[0]-p[9],m=t[1]-p[10],g=t[2]-p[11],y=p[0]*v+p[1]*m+p[2]*g,b=p[3]*v+p[4]*m+p[5]*g,w=p[6]*v+p[7]*m+p[8]*g,E=0,S=0,x=Number.MAX_VALUE,T=this.contacts,N,C,k;while(S<T.length){var A=T[S];if(!s&&o*A[12]+u*A[13]+a*A[14]<.9){T[S]=T[T.length-1],T.pop(),tt.deallocate(A),this.contactFlags|=4;continue}N=y-A[0],C=b-A[1],k=w-A[2];var O=N*N+C*C+k*k;if(O<L.CONTACT_EQUAL_SQ_SEPERATION){E=A[40],T[S]=T[T.length-1],T.pop(),tt.deallocate(A),this.contactFlags|=4,x=O;continue}O<L.CONTACT_INHERIT_SQ_SEPERATION&&O<x&&(E=A[40],x=O),S+=1}var M=tt.allocate();M[0]=y,M[1]=b,M[2]=w,M[6]=v,M[7]=m,M[8]=g,M[9]=v=n[0]-d[9],M[10]=m=n[1]-d[10],M[11]=g=n[2]-d[11],M[3]=d[0]*v+d[1]*m+d[2]*g,M[4]=d[3]*v+d[4]*m+d[5]*g,M[5]=d[6]*v+d[7]*m+d[8]*g,M[21]=i,M[12]=o,M[13]=u,M[14]=a;var _,D;f=o*o+a*a,f<L.DONT_NORMALIZE_THRESHOLD?(M[15]=_=1,M[16]=0,M[17]=D=0):(l=1/Math.sqrt(f),M[15]=_=-a*l,M[16]=0,M[17]=D=o*l),M[18]=u*D,M[19]=a*_-o*D,M[20]=-(u*_),M[40]=E;var P,H;P=c.contactCallbacks,null!==P&&0!==(P.mask&h.group)&&(P.onPreSolveContact&&(H=tt.publicContacts[0],H._private=M,P.onPreSolveContact(c._public,h._public,H)),!P.added&&P.deferred&&(P.added=!0,c.world.contactCallbackObjects.push(c)),P.trigger&&(this.trigger=!0,c.sweepFrozen=!1,h.sweepFrozen=!1)),P=h.contactCallbacks,null!==P&&0!==(P.mask&c.group)&&(P.onPreSolveContact&&(H=tt.publicContacts[0],H._private=M,P.onPreSolveContact(c._public,h._public,H)),!P.added&&P.deferred&&(P.added=!0,h.world.contactCallbackObjects.push(h)),P.trigger&&(this.trigger=!0,c.sweepFrozen=!1,h.sweepFrozen=!1)),this.contactFlags|=1,T.push(M);if(T.length===4){var B=T[0][21],j=0;for(S=1;S<4;S+=1)M=T[S],M[21]<B&&(B=M[21],j=S);var F,I=-Number.MAX_VALUE,q=T[0],R=T[1],U=T[2],z=T[3],W=q[6]+q[9],X=q[7]+q[10],V=q[8]+q[11],$=R[6]+R[9],J=R[7]+R[10],K=R[8]+R[11],Q=U[6]+U[9],G=U[7]+U[10],Y=U[8]+U[11];N=z[6]+z[9],C=z[7]+z[10],k=z[8]+z[11];var Z=$-W,et=J-X,nt=K-V,rt=Q-W,it=G-X,st=Y-V,ot=N-W,ut=C-X,at=k-V,ft,lt,ct,ht;j!==1&&(ft=it*at-st*ut,lt=st*ot-rt*at,ct=rt*ut-it*ot,ht=ft*ft+lt*lt+ct*ct,ht>I&&(I=ht,F=1)),j!==2&&(ft=et*at-nt*ut,lt=nt*ot-Z*at,ct=Z*ut-et*ot,ht=ft*ft+lt*lt+ct*ct,ht>I&&(I=ht,F=2)),j!==3&&(ft=et*st-nt*it,lt=nt*rt-Z*st,ct=Z*it-et*rt,ht=ft*ft+lt*lt+ct*ct,ht>I&&(I=ht,F=3));if(j!==0){var pt=Q-$,dt=G-J,vt=Y-K,mt=N-$,gt=C-J,yt=k-K;ft=dt*yt-vt*gt,lt=vt*mt-pt*yt,ct=pt*gt-dt*mt,ht=ft*ft+lt*lt+ct*ct,ht>I&&(I=ht,F=0)}M=T[F],T[F]=T[3],T.pop(),tt.deallocate(M),this.contactFlags|=4}},refreshContacts:function(){var t=this.contacts,n=this.objectA,r=this.objectB,i=n.transform,s=r.transform,o=i[0],u=i[1],a=i[2],f=i[3],l=i[4],c=i[5],h=i[6],p=i[7],d=i[8],v=i[9],m=i[10],g=i[11],y=s[0],b=s[1],w=s[2],E=s[3],S=s[4],x=s[5],T=s[6],N=s[7],C=s[8],k=s[9],A=s[10],O=s[11],M,_=0;while(_<t.length){M=t[_];var D=M[0],P=M[1],H=M[2],B=M[6]=o*D+f*P+h*H,j=M[7]=u*D+l*P+p*H,F=M[8]=a*D+c*P+d*H;D=M[3],P=M[4],H=M[5];var I=M[9]=y*D+E*P+T*H,q=M[10]=b*D+S*P+N*H,R=M[11]=w*D+x*P+C*H;D=B+v-(I+k),P=j+m-(q+A),H=F+g-(R+O);var U=M[12],z=M[13],W=M[14],X=M[21]=U*D+z*P+W*H;if(X>L.CONTACT_MAX_Y_SEPERATION){t[_]=t[t.length-1],t.pop(),tt.deallocate(M),this.contactFlags|=4;continue}D-=U*X,P-=z*X,H-=W*X;if(D*D+P*P+H*H>L.CONTACT_MAX_SQ_XZ_SEPERATION){t[_]=t[t.length-1],t.pop(),tt.deallocate(M),this.contactFlags|=4;continue}_+=1}return this.contactFlags|=2,t.length===0},preStep:function(t,n){if(this.trigger){this.activeContacts.length=0;return}var r=this.objectA,i=this.objectB,s=r.inverseMass+i.inverseMass,o=r.velocity,u=i.velocity,a=r.inverseInertia,f=a[0],l=a[1],c=a[2],h=a[3],p=a[4],d=a[5],v=a[6],m=a[7],g=a[8];a=i.inverseInertia;var y=a[0],b=a[1],w=a[2],E=a[3],S=a[4],x=a[5],T=a[6],N=a[7],C=a[8],k=this.activeContacts;k.length=0;var A=r.collisionObject||i.collisionObject?L.CONTACT_STATIC_BAUMGRAUTE:L.CONTACT_BAUMGRAUTE,O=this.contacts,M,_=O.length;for(M=0;M<_;M+=1){var D=O[M];if(D[21]>0)continue;k[k.length]=D,D[41]=D[42]=0;var P,H,B,j,F,I,q=D[12],R=D[13],U=D[14],z=D[6],W=D[7],X=D[8],V=D[9],$=D[10],J=D[11],K,Q,G,Y=s;P=W*U-X*R,H=X*q-z*U,B=z*R-W*q,D[22]=K=f*P+h*H+v*B,D[23]=Q=l*P+p*H+m*B,D[24]=G=c*P+d*H+g*B,Y+=P*K+H*Q+B*G,j=$*U-J*R,F=J*q-V*U,I=V*R-$*q,D[25]=K=-(y*j+E*F+T*I),D[26]=Q=-(b*j+S*F+N*I),D[27]=G=-(w*j+x*F+C*I),Y-=j*K+F*Q+I*G,D[45]=1/Y,D[43]=A*Math.min(0,D[21]+L.CONTACT_SLOP)/n,D[44]=0;var Z=o[0]-u[0],et=o[1]-u[1],tt=o[2]-u[2];Z+=o[4]*X-o[5]*W,et+=o[5]*z-o[3]*X,tt+=o[3]*W-o[4]*z,Z-=u[4]*J-u[5]*$,et-=u[5]*V-u[3]*J,tt-=u[3]*$-u[4]*V;var nt=(Z*q+et*R+tt*U)*this.restitution;nt*nt<.01&&(nt=0),D[50]=nt;var rt=s;q=D[15],R=D[16],U=D[17],P=W*U-X*R,H=X*q-z*U,B=z*R-W*q,D[28]=K=f*P+h*H+v*B,D[29]=Q=l*P+p*H+m*B,D[30]=G=c*P+d*H+g*B,rt+=P*K+H*Q+B*G,j=$*U-J*R,F=J*q-V*U,I=V*R-$*q,D[31]=K=-(y*j+E*F+T*I),D[32]=Q=-(b*j+S*F+N*I),D[33]=G=-(w*j+x*F+C*I),rt-=j*K+F*Q+I*G;var it=s;q=D[18],R=D[19],U=D[20],P=W*U-X*R,H=X*q-z*U,B=z*R-W*q,D[34]=K=f*P+h*H+v*B,D[35]=Q=l*P+p*H+m*B,D[36]=G=c*P+d*H+g*B,it+=P*K+H*Q+B*G,j=$*U-J*R,F=J*q-V*U,I=V*R-$*q,D[37]=K=-(y*j+E*F+T*I),D[38]=Q=-(b*j+S*F+N*I),D[39]=G=-(w*j+x*F+C*I),it-=j*K+F*Q+I*G;var st=0;st+=P*D[28]+H*D[29]+B*D[30],st-=j*D[31]+F*D[32]+I*D[33];var ot=1/(rt*it-st*st);D[46]=it*ot,D[47]=-st*ot,D[48]=rt*ot,D[40]*=t}},applyCachedImpulses:function(){if(this.trigger)return;var t=this.objectA,n=this.objectB,r=t.velocity,i=n.velocity,s=t.inverseMass,o=n.inverseMass,u=this.activeContacts,a;for(a=0;a<u.length;a+=1){var f=u[a],l=f[40],c=f[12]*l,h=f[13]*l,p=f[14]*l;r[0]+=c*s,r[1]+=h*s,r[2]+=p*s,i[0]-=c*o,i[1]-=h*o,i[2]-=p*o,r[3]+=f[22]*l,r[4]+=f[23]*l,r[5]+=f[24]*l,i[3]+=f[25]*l,i[4]+=f[26]*l,i[5]+=f[27]*l}},computeAndApplyBiasImpulses:function(){if(this.trigger)return;var t=this.objectA,n=this.objectB,r=t.velocity,i=r[6],s=r[7],o=r[8],u=r[9],a=r[10],f=r[11];r=n.velocity;var l=r[6],c=r[7],h=r[8],p=r[9],d=r[10],v=r[11],m=t.inverseMass,g=n.inverseMass,y=this.activeContacts,b=y.length,w,E;for(E=0;E<b;E+=1){w=y[E];var S=w[12],x=w[13],T=w[14],N=w[6],C=w[7],k=w[8],L=w[9],A=w[10],O=w[11],M=w[45]*(S*(l+(d*O-v*A)-(i+(a*k-f*C)))+x*(c+(v*L-p*O)-(s+(f*N-u*k)))+T*(h+(p*A-d*L)-(o+(u*C-a*N)))-w[43]),_=w[44],D=_+M;D<0&&(D=0),M=D-_,w[44]=D,S*=M,x*=M,T*=M,i+=S*m,s+=x*m,o+=T*m,l-=S*g,c-=x*g,h-=T*g,u+=w[22]*M,a+=w[23]*M,f+=w[24]*M,p+=w[25]*M,d+=w[26]*M,v+=w[27]*M}r=t.velocity,r[6]=i,r[7]=s,r[8]=o,r[9]=u,r[10]=a,r[11]=f,r=n.velocity,r[6]=l,r[7]=c,r[8]=h,r[9]=p,r[10]=d,r[11]=v},computeAndApplyImpulses:function(){if(this.trigger)return;var t=this.objectA,n=this.objectB,r=t.velocity,i=r[0],s=r[1],o=r[2],u=r[3],a=r[4],f=r[5];r=n.velocity;var l=r[0],c=r[1],h=r[2],p=r[3],d=r[4],v=r[5],m=t.inverseMass,g=n.inverseMass,y=this.friction,b=this.activeContacts,w=b.length,E,S;for(S=0;S<w;S+=1){E=b[S];var x=E[12],T=E[13],N=E[14],C=E[15],k=E[16],L=E[17],A=E[18],O=E[19],M=E[20],_=E[6],D=E[7],P=E[8],H=E[9],B=E[10],j=E[11],F=E[45]*(x*(l+(d*j-v*B)-(i+(a*P-f*D)))+T*(c+(v*H-p*j)-(s+(f*_-u*P)))+N*(h+(p*B-d*H)-(o+(u*D-a*_)))-E[50]),I=E[40],q=I+F;q<0&&(q=0,F=-I),E[40]=q,x*=F,T*=F,N*=F,i+=x*m,s+=T*m,o+=N*m,l-=x*g,c-=T*g,h-=N*g,u+=E[22]*F,a+=E[23]*F,f+=E[24]*F,p+=E[25]*F,d+=E[26]*F,v+=E[27]*F,x=l-i+(d*j-v*B)-(a*P-f*D),T=c-s+(v*H-p*j)-(f*_-u*P),N=h-o+(p*B-d*H)-(u*D-a*_);var R=C*x+k*T+L*N,U=A*x+O*T+M*N;F=R*E[46]+U*E[47];var z=R*E[47]+U*E[48];I=E[41];var W=E[42];q=I+F;var X=W+z,V=y*E[40],$=q*q+X*X;$>V*V&&($=V/Math.sqrt($),q*=$,X*=$,F=q-I,z=X-W),E[41]=q,E[42]=X,x=C*F+A*z,T=k*F+O*z,N=L*F+M*z,i+=x*m,s+=T*m,o+=N*m,l-=x*g,c-=T*g,h-=N*g,u+=E[28]*F+E[34]*z,a+=E[29]*F+E[35]*z,f+=E[30]*F+E[36]*z,p+=E[31]*F+E[37]*z,d+=E[32]*F+E[38]*z,v+=E[33]*F+E[39]*z}r=t.velocity,r[0]=i,r[1]=s,r[2]=o,r[3]=u,r[4]=a,r[5]=f,r=n.velocity,r[0]=l,r[1]=c,r[2]=h,r[3]=p,r[4]=d,r[5]=v},invalidateParameters:function(){this.restitution=this.objectA.restitution*this.objectB.restitution,this.friction=this.objectA.friction*this.objectB.friction}},rt.arbiterPool=[],rt.arbiterPoolSize=0,rt.allocate=function(t,n,r,i){var s;return this.arbiterPoolSize===0?s=new rt:(s=this.arbiterPool[this.arbiterPoolSize-1],this.arbiterPoolSize-=1),s.active=!0,s.shapeA=t,s.shapeB=n,s.objectA=r,s.objectB=i,s.invalidateParameters(),s},rt.deallocate=function(t){t.shapeA=null,t.shapeB=null,t.objectA=null,t.objectB=null,t.skipDiscreteCollisions=!1,t.activeContacts.length=0,t.contactFlags=0,t.trigger=!1,this.arbiterPool[this.arbiterPoolSize]=t,this.arbiterPoolSize+=1},it.prototype={version:1},it.islandPool=[],it.islandPoolSize=0,it.allocate=function(){var t;return this.islandPoolSize===0?t=new it:(t=this.islandPool[this.islandPoolSize-1],this.islandPoolSize-=1),t},it.deallocate=function(t){this.islandPool[this.islandPoolSize]=t,this.islandPoolSize+=1,t.wakeTimeStamp=0},st.prototype={type:"TRIANGLE_MESH_TRIANGLE",version:1,localSupportWithoutMargin:function(t,n){var r=t[0],i=t[1],s=t[2],o=this.triangleArray.triangles,u=this.index,a=o[u+3],f=o[u+4],l=o[u+5],c=o[u+6],h=o[u+7],p=o[u+8],d=o[u+9],v=o[u+10],m=o[u+11],g=r*c+i*h+s*p,y=r*d+i*v+s*m;g<=0&&y<=0?(n[0]=a,n[1]=f,n[2]=l):g>=y?(n[0]=a+c,n[1]=f+h,n[2]=l+p):(n[0]=a+d,n[1]=f+v,n[2]=l+m)}},st.trianglePool=[],st.trianglePoolSize=0,st.allocate=function(){var t;return this.trianglePoolSize===0?t=new st:(t=this.trianglePool[this.trianglePoolSize-1],this.trianglePoolSize-=1),t},st.deallocate=function(t){this.trianglePool[this.trianglePoolSize]=t,this.trianglePoolSize+=1,this.triangleArray=null},ot.prototype={version:1},ot.eventPool=[],ot.eventPoolSize=0,ot.allocate=function(){var t;return this.eventPoolSize===0?t=new ot:(t=this.eventPool[this.eventPoolSize-1],this.eventPoolSize-=1),t},ot.deallocate=function(t){this.eventPool[this.eventPoolSize]=t,this.eventPoolSize+=1,t.concave&&(st.deallocate(t.shapeB),t.concave=!1),t.objectA=null,t.objectB=null,t.shapeA=null,t.shapeB=null},ut.prototype={version:1,update:function(){this._private.update()},rayTest:function(t){return this._private.rayTest(t)},convexSweepTest:function(t){return this._private.convexSweepTest(t)},addCollisionObject:function(t){return this._private.addBody(t._private)},removeCollisionObject:function(t){return this._private.removeBody(t._private)},addRigidBody:function(t){return this._private.addBody(t._private)},removeRigidBody:function(t){return this._private.removeBody(t._private)},addConstraint:function(t){return this._private.addConstraint(t._private)},removeConstraint:function(t){return this._private.removeConstraint(t._private)},addCharacter:function(t){return this._private.addBody(t._private.rigidBody._private)},removeCharacter:function(t){return this._private.removeBody(t._private.rigidBody._private)},flush:function(){this._private.flush()}},at.prototype={version:1,m43InverseOrthonormalTransformVector:function(t,n,r){r===undefined&&(r=new Float32Array(3));var i=n[0],s=n[1],o=n[2];return r[0]=t[0]*i+t[1]*s+t[2]*o,r[1]=t[3]*i+t[4]*s+t[5]*o,r[2]=t[6]*i+t[7]*s+t[8]*o,r},m43InverseOrthonormalTransformPoint:function(t,n,r){r===undefined&&(r=new Float32Array(3));var i=n[0]-t[9],s=n[1]-t[10],o=n[2]-t[11];return r[0]=t[0]*i+t[1]*s+t[2]*o,r[1]=t[3]*i+t[4]*s+t[5]*o,r[2]=t[6]*i+t[7]*s+t[8]*o,r},trianglePlaneDiscard:function(n,r,i,s,o){this.planeAxis===undefined&&(this.planeAxis=t.v3BuildZero(),this.planeSA=t.v3BuildZero(),this.planeSB=t.v3BuildZero());var u=this.planeAxis,a=this.planeSA,f=this.planeSB,l=i.triangles,c=l[s],h=l[s+1],p=l[s+2],d=l[s+16],v=o[0],m=o[1],g=o[2],y=o[3],b=o[4],w=o[5],E=o[6],S=o[7],x=o[8],T=o[9],N=o[10],C=o[11],k=c*v+h*y+p*E,L=c*m+h*b+p*S,A=c*g+h*w+p*x;v=r[0],m=r[1],g=r[2],y=r[3],b=r[4],w=r[5],E=r[6],S=r[7],x=r[8],T-=r[9],N-=r[10],C-=r[11],c=v*k+m*L+g*A,h=y*k+b*L+w*A,p=E*k+S*L+x*A,d+=k*T+L*N+A*C,u[0]=c,u[1]=h,u[2]=p,n.localSupportWithoutMargin(u,a),u[0]=-c,u[1]=-h,u[2]=-p,n.localSupportWithoutMargin(u,f);var O=a[0]*c+a[1]*h+a[2]*p-d,M=f[0]*c+f[1]*h+f[2]*p-d;if(O*M<=0)return!1;var _;return O*O<M*M?_=O:_=M,_<0!=O*M<0&&(_=-_),_-n.collisionRadius>0},filtered:function(t,n){return t===n?!0:(t.collisionObject||t.kinematic)&&(n.collisionObject||n.kinematic)?!0:(t.mask&n.group)===0||(n.mask&t.group)===0?!0:!1},narrowPhase:function(n,r,i,s){this.narrowTriangle===undefined&&(this.narrowTriangle=st.allocate(),this.narrowCache={axis:t.v3Build(1,0,0),shapeA:null,shapeB:null,closestA:t.v3BuildZero(),closestB:t.v3BuildZero()},this.narrowCache2={axis:this.narrowCache.axis,shapeA:null,shapeB:null,closestA:this.narrowCache.closestA,closestB:this.narrowCache.closestB},this.narrowFakeBody={transform:t.m43BuildIdentity(),shape:null},this.narrowTransform=t.m43BuildIdentity(),this.narrowExtents=new Float32Array(6));var o=null,u=i.arbiters,a=s.arbiters,f=u.length<=a.length?u:a,l=0,c=f.length;for(l=0;l<c;l+=1){var h=f[l];if(h.shapeA===n&&h.shapeB===r&&h.objectA===i&&h.objectB===s){o=h;break}}if(o!==null&&o.skipDiscreteCollisions){o.skipDiscreteCollisions=!1;return}var p=o===null;p&&(o=rt.allocate(n,r,i,s));var d=this.narrowCache;d.shapeA=n,d.shapeB=r;if(o.contacts.length!==0){var v=o.contacts[0];d.axis[0]=v[12],d.axis[1]=v[13],d.axis[2]=v[14]}var m,g=!1;if(n.type==="TRIANGLE_MESH"||r.type==="TRIANGLE_MESH"){var y,b,w,E,S=this.narrowTriangle,x=this.narrowCache2;n.type==="TRIANGLE_MESH"?(y=n,w=i.transform,b=r,E=s.transform,x.shapeA=S,x.shapeB=d.shapeB):(y=r,w=s.transform,b=n,E=i.transform,x.shapeA=d.shapeA,x.shapeB=S);var T=y.triangleArray;S.triangleArray=T,S.collisionRadius=y.collisionRadius;var N;if(T.spatialMap){var C=this.narrowTransform,k=this.narrowFakeBody,L=this.narrowExtents;t.m43InverseOrthonormal(w,C),t.m43Mul(E,C,k.transform),k.shape=b,W.prototype.calculateExtents.call(k,L);var A=this.persistantTrianglesList;N=T.spatialMap.getOverlappingNodes(L,A,0);for(l=0;l<N;l+=1){var O=A[l].index;S.index=O,A[l]=undefined,this.trianglePlaneDiscard(b,E,T,O,w)||(m=this.contactPairTest(x,i.transform,s.transform),m<0&&(o.insertContact(x.closestA,x.closestB,x.axis,m,!0),g=!0))}}else{N=T.numTriangles;for(l=0;l<N;l+=1)S.index=l*I.prototype.TRIANGLE_SIZE,this.trianglePlaneDiscard(b,E,T,S.index,w)||(m=this.contactPairTest(x,i.transform,s.transform),m<0&&(o.insertContact(x.closestA,x.closestB,x.axis,m,!0),g=!0))}}else m=this.contactPairTest(d,i.transform,s.transform),m<0&&(o.insertContact(d.closestA,d.closestB,d.axis,m,!1),g=!0);g?(p&&(this.activeArbiters.push(o),o.active=!0,i.arbiters.push(o),s.arbiters.push(o)),i.permitSleep&&!i.active&&this.wakeBody(i),s.permitSleep&&!s.active&&this.wakeBody(s),o.active||(o.active=!0,this.activeArbiters.push(o))):p&&rt.deallocate(o)},computeSleeping:function(t){function n(e,t){var n=r(e),i=r(t);n!==i&&(n.islandRank<i.islandRank?n.islandRoot=i:n.islandRank>i.islandRank?i.islandRoot=n:(i.islandRoot=n,n.islandRank+=1))}function r(e){if(e===e.islandRoot)return e;var t=e,n=null,r;while(t!==t.islandRoot)r=t.islandRoot,t.islandRoot=n,n=t,t=r;while(n!==null)r=n.islandRoot,n.islandRoot=t,n=r;return t}var i,s,o=this.activeArbiters,u=this.activeBodies,a=this.activeConstraints,f,l=o.length;for(f=0;f<l;f+=1){var c=o[f];i=c.objectA,s=c.objectB,i.permitSleep&&s.permitSleep&&n(i,s)}l=a.length;var h;for(f=0;f<l;f+=1)h=a[f],i=h.bodyA,s=h.bodyB,i&&i.permitSleep&&n(i,h),s&&s.permitSleep&&n(s,h);var p=[],d,v,m;while(u.length>0)v=u.pop(),m=r(v),d=m.island,d||(d=m.island=it.allocate(),p.push(d),d.active=!1),v.island=d,d.bodies.push(v),d.active=d.active||v.isActive(t),v.wakeTimeStamp>d.wakeTimeStamp&&(d.wakeTimeStamp=v.wakeTimeStamp);while(a.length>0)h=a.pop(),m=r(h),d=m.island,d||(d=m.island=it.allocate(),p.push(d),d.active=!0),h.island=d,d.constraints.push(h),h.wakeTimeStamp>d.wakeTimeStamp&&(d.wakeTimeStamp=h.wakeTimeStamp);while(p.length>0){d=p.pop();if(d.active){while(d.bodies.length>0)v=d.bodies.pop(),v.wakeTimeStamp=d.wakeTimeStamp,u.push(v),v.islandRoot=v,v.islandRank=0,v.island=null;while(d.constraints.length>0)h=d.constraints.pop(),h.wakeTimeStamp=d.wakeTimeStamp,a.push(h),h.islandRoot=h,h.islandRank=0,h.island=null;it.deallocate(d)}else{l=d.bodies.length;for(f=0;f<l;f+=1)v=d.bodies[f],v.velocity[0]=v.velocity[1]=v.velocity[2]=0,v.velocity[3]=v.velocity[4]=v.velocity[5]=0,v.active=!1,this.syncBody(v),v.islandRoot=v,v.islandRank=0;l=d.constraints.length;for(f=0;f<l;f+=1)h=d.constraints[f],h.active=!1,h.islandRoot=h,h.islandRank=0}}},wakeIsland:function(t){while(t.bodies.length>0){var n=t.bodies.pop();n.wakeTimeStamp=this.timeStamp+(this.midStep?0:1),this.activeBodies.push(n);var r,i=n.arbiters,s=i.length;for(r=0;r<s;r+=1){var o=i[r];o.active||(o.active=!0,this.activeArbiters.push(o))}n.active=!0,n.island=null,this.syncBody(n)}while(t.constraints.length>0){var u=t.constraints.pop();u.wakeTimeStamp=this.timeStamp+(this.midStep?0:1),this.activeConstraints.push(u),u.active=!0,u.island=null}it.deallocate(t)},wakeRelated:function(t){var n=t.constraints,r,i=n.length;for(r=0;r<i;r+=1)this.wakeConstraint(n[r]);var s=t.arbiters;i=s.length;for(r=0;r<i;r+=1){var o=s[r];o.active||(o.active=!0,this.activeArbiters.push(o)),o.objectA.permitSleep&&!o.objectA.active&&this.wakeBody(o.objectA),o.objectB.permitSleep&&!o.objectB.active&&this.wakeBody(o.objectB)}},wakeBody:function(t){t.collisionObject&&!t.kinematic?(this.wakeRelated(t),this.syncBody(t)):t.kinematic?(t.delaySleep=!0,t.active||(t.active=!0,this.activeKinematics.push(t),this.wakeRelated(t),this.syncBody(t))):(t.wakeTimeStamp=this.timeStamp+(this.midStep?0:1),t.active||(t.island?this.wakeIsland(t.island):(t.active=!0,this.activeBodies.push(t),this.wakeRelated(t),this.syncBody(t)),this
.syncBody(t)))},syncBody:function(t){var n=this.syncExtents;t.calculateExtents(n),t.collisionObject&&!t.kinematic?this.staticSpatialMap.update(t,n):(t.active?t.previouslyActive?this.dynamicSpatialMap.update(t,n):(this.staticSpatialMap.remove(t),this.dynamicSpatialMap.add(t,n)):t.previouslyActive?(this.dynamicSpatialMap.remove(t),this.staticSpatialMap.add(t,n)):this.staticSpatialMap.update(t,n),t.previouslyActive=t.active)},wakeConstraint:function(t){t.wakeTimeStamp=this.timeStamp+(this.midStep?0:1),t.active||(t.island?this.wakeIsland(t.island):(t.active=!0,this.activeConstraints.push(t),t.bodyA&&this.wakeBody(t.bodyA),t.bodyB&&this.wakeBody(t.bodyB)))},dynamicSweep:function(t,n,r,i){var s=t.objectA,o=t.objectB,u=t.axis,a=s.velocity,f=-a[0],l=-a[1],c=-a[2],h=o.velocity;f+=h[0],l+=h[1],c+=h[2];if(f*f+l*l+c*c<L.DONT_NORMALIZE_THRESHOLD){t.toi=undefined;return}u[0]=f,u[1]=l,u[2]=c;var p=-f,d=-l,v=-c,m=0,g,y;s.fixedRotation||(g=s.shape.radius,m+=g*Math.sqrt(a[3]*a[3]+a[4]*a[4]+a[5]*a[5])),o.fixedRotation||(y=o.shape.radius,m+=y*Math.sqrt(h[3]*h[3]+h[4]*h[4]+h[5]*h[5]));if(m<L.CONTINUOUS_ANGULAR_BULLET/n){var b=g<y?g:y;b*=L.CONTINUOUS_LINEAR_BULLET/n;if(p*p+d*d+v*v<b*b){t.toi=undefined;return}}var w=0,E=100,S=r;for(;;){s.integratePosition(S*n),o.integratePosition(S*n);var x=this.contactPairTest(t,s.transform,o.transform),T=x;x!==undefined&&(T+=i);if(T===undefined||T<L.GJK_EPA_DISTANCE_THRESHOLD){this.seperatingTOI(t)?S=undefined:t.distance=x;break}var N=u[0]*p+u[1]*d+u[2]*v,C=(m-N)*n;if(C<=0){S=undefined;break}S+=T/C;if(S>=1){S=undefined;break}w+=1;if(w>E){S=undefined;break}}t.toi=S},seperatingTOI:function(t){var n=t.objectA,r=t.objectB,i=t.closestA,s=t.closestB,o=n.velocity,u=r.velocity,a=o[0]-u[0],f=o[1]-u[1],l=o[2]-u[2];if(!n.fixedRotation){var c=i[0]-n.transform[9],h=i[1]-n.transform[10],p=i[2]-n.transform[11];a+=o[4]*p-o[5]*h,f+=o[5]*c-o[3]*p,l+=o[3]*h-o[4]*c}if(!r.fixedRotation){var d=s[0]-r.transform[9],v=s[1]-r.transform[10],m=s[2]-r.transform[11];a-=u[4]*m-u[5]*v,f-=u[5]*d-u[3]*m,l-=u[3]*v-u[4]*d}var g=t.axis,y=a*g[0]+f*g[1]+l*g[2];return y>=0},staticSweep:function(t,n,r,i){var s=t.objectA,o=t.objectB,u=t.axis,a=s.velocity,f=-a[0],l=-a[1],c=-a[2];if(f*f+l*l+c*c<L.DONT_NORMALIZE_THRESHOLD){t.toi=undefined;return}u[0]=f,u[1]=l,u[2]=c;var h=-f,p=-l,d=-c,v=0;s.fixedRotationtype||(v+=s.shape.radius*Math.sqrt(a[3]*a[3]+a[4]*a[4]+a[5]*a[5]));var m=0,g=100,y=r;for(;;){s.integratePosition(y*n);var b=this.contactPairTest(t,s.transform,o.transform),w=b;b!==undefined&&(w+=i);if(w===undefined||w<L.GJK_EPA_DISTANCE_THRESHOLD){this.seperatingTOI(t)?y=undefined:t.distance=b;break}var E=u[0]*h+u[1]*p+u[2]*d,S=(v-E)*n;if(S<=0){y=undefined;break}y+=w/S;if(y>=1){y=undefined;break}m+=1;if(m>g){y=undefined;break}}t.toi=y},performStaticTOIBase:function(n,r,i,s,o,u){var a=this.persistantTrianglesList;this.continuousFakeBody===undefined&&(this.continuousFakeBody={shape:null,transform:t.m43BuildIdentity(),startTransform:t.m43BuildIdentity()},this.continuousInvTransform=t.m43BuildIdentity(),this.continuousExtents=new Float32Array(6));var f=this.continuousFakeBody,l=this.continuousInvTransform,c=this.continuousExtents,h;if(u.shape.type==="TRIANGLE_MESH"){var p=u.shape.triangleArray,d,v;if(p.spatialMap){f.shape=o.shape,t.m43InverseOrthonormal(u.transform,l),t.m43Mul(o.startTransform,l,f.startTransform),t.m43Mul(o.endTransform,l,f.transform),W.prototype.calculateSweptExtents.call(f,c),d=p.spatialMap.getOverlappingNodes(c,a,0);for(v=0;v<d;v+=1){h=ot.allocate(),h.objectA=o,h.objectB=u,h.shapeA=o.shape,h.shapeB=st.allocate(),h.shapeB.index=a[v].index,a[v]=undefined,h.shapeB.triangleArray=u.shape.triangleArray,h.shapeB.collisionRadius=u.shape.collisionRadius,h.concave=!0,this.staticSweep(h,r,0,n);if(h.toi===undefined){ot.deallocate(h);continue}h.frozenA=!1,h.frozenB=!0,i[s]=h,s+=1}}else{d=p.numTriangles;for(v=0;v<d;v+=1){h=ot.allocate(),h.objectA=o,h.objectB=u,h.shapeA=o.shape,h.shapeB=st.allocate(),h.shapeB.index=v*I.prototype.TRIANGLE_SIZE,h.shapeB.triangleArray=u.shape.triangleArray,h.shapeB.collisionRadius=u.shape.collisionRadius,h.concave=!0,this.staticSweep(h,r,0,n);if(h.toi===undefined){ot.deallocate(h);continue}h.frozenA=!1,h.frozenB=!0,i[s]=h,s+=1}}}else{h=ot.allocate(),h.objectA=o,h.objectB=u,h.shapeA=o.shape,h.shapeB=u.shape,this.staticSweep(h,r,0,n);if(h.toi===undefined)return ot.deallocate(h),s;h.frozenA=!1,h.frozenB=!0,i[s]=h,s+=1}return s},update:function(){var n=this.dynamicSpatialMap,r=this.staticSpatialMap,i=this.activeBodies,s=this.activeKinematics,o=this.activeConstraints,u=this.activeArbiters,a=this.gravity,f=this.performanceData;f.discrete=0,f.sleepComputation=0,f.prestepContacts=0,f.prestepConstraints=0,f.integrateVelocities=0,f.warmstartContacts=0,f.warmstartConstraints=0,f.physicsIterations=0,f.integratePositions=0,f.continuous=0;var l=this.prevTimeStamp;if(l===undefined){this.prevTimeStamp=TurbulenzEngine.getTime()*.001;return}var c=TurbulenzEngine.getTime()*.001,h=c-l,p,d;if(this.variableStep){var v=this.variableMinStep,m=this.variableMaxStep;p=Math.ceil(h/m),d=h/p,d<v&&(d=v,p=Math.floor(h/d)),p>this.maxSubSteps&&this.maxGiveUpTimeStep!==0&&(p=Math.ceil(h/this.maxGiveUpTimeStep),d=h/p)}else d=this.fixedTimeStep,p=Math.floor(h/d),p>this.maxSubSteps&&this.maxGiveUpTimeStep!==0&&(p=Math.ceil(h/this.maxGiveUpTimeStep),d=h/p);if(p<=0)return;this.prevTimeStamp+=d*p,p>this.maxSubSteps&&(p=this.maxSubSteps),this.midStep=!0;var g,y,b;g=s.length;for(y=0;y<g;)b=s[y],!b.computeDeltaVelocity(d*p,b.prevTransform,b.transform)&&!b.delaySleep?(b.active=!1,g-=1,s[y]=s[g],s.pop(),this.syncBody(b)):(t.m43Copy(b.transform,b.newTransform),t.m43Copy(b.prevTransform,b.transform),y+=1),b.delaySleep=!1;var w;for(w=0;w<p;w+=1){var E,S;this.timeStamp+=1;var x;this.prevTimeStep===undefined&&(this.prevTimeStep=d);var T=d/this.prevTimeStep;this.prevTimeStep=d,g=i.length;for(y=0;y<g;y+=1)b=i[y],S=b.extents,b.calculateExtents(S),n.update(b,S),b.refreshInertiaTensor();g=s.length;for(y=0;y<g;y+=1)b=s[y],S=b.extents,b.calculateExtents(S),n.update(b,S);x=TurbulenzEngine.getTime()*.001,r.finalize(),n.finalize();var N=this.persistantObjectsList,C=n.getOverlappingPairs(N,0),k=C,A;g=i.length;for(y=0;y<g;y+=1)b=i[y],A=r.getOverlappingNodes(b.extents,N,k+1),A!==0&&(N[k]=b,k+=1+A,N[k]=b,k+=1);g=s.length;for(y=0;y<g;y+=1)b=s[y],A=r.getOverlappingNodes(b.extents,N,k+1),A!==0&&(N[k]=b,k+=1+A,N[k]=b,k+=1);var O,M;for(y=0;y<C;y+=2)O=N[y],M=N[y+1],N[y]=undefined,N[y+1]=undefined,this.filtered(O,M)||(O.id<M.id?this.narrowPhase(O.shape,M.shape,O,M):this.narrowPhase(M.shape,O.shape,M,O));for(y=C;y<k;){O=N[y],N[y]=undefined,y+=1;for(;;){M=N[y],N[y]=undefined,y+=1;if(O===M)break;this.filtered(O,M)||(O.id<M.id?this.narrowPhase(O.shape,M.shape,O,M):this.narrowPhase(M.shape,O.shape,M,O))}}f.discrete+=TurbulenzEngine.getTime()*.001-x,x=TurbulenzEngine.getTime()*.001,this.computeSleeping(d),f.sleepComputation+=TurbulenzEngine.getTime()*.001-x,x=TurbulenzEngine.getTime()*.001,y=0;var _;while(y<u.length){_=u[y];if(!_.objectA.active&&!_.objectB.active){_.active=!1,u[y]=u[u.length-1],u.pop();continue}if(_.refreshContacts()){u[y]=u[u.length-1],u.pop(),O=_.objectA,M=_.objectB;var D=O.arbiters;D[D.indexOf(_)]=D[D.length-1],D.pop(),D=M.arbiters,D[D.indexOf(_)]=D[D.length-1],D.pop(),O.contactCallbacks&&O.contactCallbacks.onRemovedContacts||M.contactCallbacks&&M.contactCallbacks.onRemovedContacts?this.contactCallbackRemovedArbiters.push(_):rt.deallocate(_);continue}_.preStep(T,d),y+=1}f.prestepContacts+=TurbulenzEngine.getTime()*.001-x,x=TurbulenzEngine.getTime()*.001,g=o.length;for(y=0;y<g;y+=1)o[y].preStep(T,d);f.prestepConstraints+=TurbulenzEngine.getTime()*.001-x,x=TurbulenzEngine.getTime()*.001,g=i.length;for(y=0;y<g;y+=1)b=i[y],b.integrateVelocity(a,d);f.integrateVelocities+=TurbulenzEngine.getTime()*.001-x,x=TurbulenzEngine.getTime()*.001,g=u.length;for(y=0;y<g;y+=1)u[y].applyCachedImpulses();f.warmstartContacts+=TurbulenzEngine.getTime()*.001-x,x=TurbulenzEngine.getTime()*.001,g=o.length;for(y=0;y<g;y+=1)o[y].applyCachedImpulses();f.warmstartConstraints+=TurbulenzEngine.getTime()*.001-x,x=TurbulenzEngine.getTime()*.001;var P=10;for(y=0;y<P;y+=1){g=u.length;for(E=0;E<g;E+=1)u[E].computeAndApplyImpulses();g=o.length;for(E=0;E<g;E+=1)o[E].computeAndApplyImpulses()}P=3,g=u.length;for(y=0;y<P;y+=1)for(E=0;E<g;E+=1)u[E].computeAndApplyBiasImpulses();f.physicsIterations+=TurbulenzEngine.getTime()*.001-x;var H=this.persistantObjectsList2,B=0;x=TurbulenzEngine.getTime()*.001,g=i.length;var j,F=d*d,I,q;for(y=0;y<g;y+=1){b=i[y],b.applyBiasVelocities(d),b.integratePosition(d);if(!b.isActiveVelocity(L.CONTINUOUS_LINEAR_SQ/d,L.CONTINUOUS_ANGULAR_SQ/d)){b.sweepFrozen=!0,b.bullet=!1;continue}I=b.transform,q=b.endTransform,q[0]=I[0],q[1]=I[1],q[2]=I[2],q[3]=I[3],q[4]=I[4],q[5]=I[5],q[6]=I[6],q[7]=I[7],q[8]=I[8],q[9]=I[9],q[10]=I[10],q[11]=I[11],j=b.shape.radius*L.CONTINUOUS_LINEAR_BULLET;var R=b.velocity,U=(R[0]*R[0]+R[1]*R[1]+R[2]*R[2])*F,z=(R[3]*R[3]+R[4]*R[4]+R[5]*R[5])*F;b.bullet=U>j*j||z>L.CONTINUOUS_ANGULAR_BULLET,S=b.extents,b.calculateSweptExtents(S),n.update(b,S),b.sweepFrozen=!1,H[B]=b,B+=1}g=s.length;for(y=0;y<g;y+=1)b=s[y],t.m43Copy(b.transform,b.startTransform),b.integratePosition(d),S=b.extents,b.calculateSweptExtents(S),n.update(b,S);f.integratePositions+=TurbulenzEngine.getTime()*.001-x,x=TurbulenzEngine.getTime()*.001,r.finalize(),n.finalize();var W=L.CONTINUOUS_SLOP+L.CONTACT_SLOP,X=this.persistantTOIEventList,V=0,$;C=n.getOverlappingPairs(N,0);for(y=0;y<C;y+=2){O=N[y],M=N[y+1],N[y]=undefined,N[y+1]=undefined;if(!(O.bullet||O.kinematic||M.bullet||M.kinematic)||O.sweepFrozen&&M.sweepFrozen||this.filtered(O,M))continue;O.kinematic||M.kinematic?O.kinematic?V=this.performStaticTOIBase(W,d,X,V,M,O):V=this.performStaticTOIBase(W,d,X,V,O,M):($=ot.allocate(),$.objectA=O,$.objectB=M,$.shapeA=O.shape,$.shapeB=M.shape,this.dynamicSweep($,d,0,W),$.frozenA=O.sweepFrozen,$.frozenB=M.sweepFrozen,X[V]=$,V+=1)}for(y=0;y<B;y+=1){O=H[y],A=r.getOverlappingNodes(O.extents,N,0);for(E=0;E<A;E+=1){M=N[E],N[E]=undefined;if(this.filtered(O,M))continue;V=this.performStaticTOIBase(W,d,X,V,O,M)}}var J=0;while(J<1&&V>0){var K=null,Q;for(y=0;y<V;){$=X[y],O=$.objectA,M=$.objectB;if(O.sweepFrozen&&M.sweepFrozen){V-=1,y!==V&&(X[y]=X[V],X[V]=undefined),ot.deallocate($);continue}if($.frozenA!==O.sweepFrozen||$.frozenB!==M.sweepFrozen){$.frozenA=O.sweepFrozen,$.frozenB=M.sweepFrozen,$.frozenA&&($.objectA=M,$.objectB=O,$.shapeA=M.shape,$.shapeB=O.shape,$.frozenA=!1,$.frozenB=!0),this.staticSweep($,d,J,W);if($.toi===undefined){V-=1,y!==V&&(X[y]=X[V],X[V]=undefined),ot.deallocate($);continue}}$.toi!==undefined&&(K===null||$.toi<K.toi)&&(K=$,Q=y),y+=1}if(K===null)break;V-=1,Q!==V&&(X[Q]=X[V],X[V]=undefined),J=K.toi,O=K.objectA,M=K.objectB,O.collisionObject||(O.sweepFrozen||(O.integratePosition(d*J),O.sweepFrozen=!0),O.permitSleep&&!O.active&&this.wakeBody(O)),M.collisionObject||(M.sweepFrozen||(M.integratePosition(d*J),M.sweepFrozen=!0),M.permitSleep&&!M.active&&this.wakeBody(M));if(O.id>M.id){var G=O;O=M,M=G;var Y=K.closestA;K.closestA=K.closestB,K.closestB=Y,Y=K.axis,Y[0]=-Y[0],Y[1]=-Y[1],Y[2]=-Y[2]}var Z=O.shape,et=M.shape;_=null;var tt=O.arbiters,nt=M.arbiters,it=tt.length<=nt.length?tt:nt,st=it.length;for(y=0;y<st;y+=1){var ut=it[y];if(ut.shapeA===Z&&ut.shapeB===et&&ut.objectA===O&&ut.objectB===M){_=ut;break}}var at=_===null;at&&(_=rt.allocate(Z,et,O,M)),_.insertContact(K.closestA,K.closestB,K.axis,K.distance,K.concave),at&&(u.push(_),_.active=!0,O.arbiters.push(_),M.arbiters.push(_)),O.kinematic&&O.active||M.kinematic&&M.active||(_.skipDiscreteCollisions=!0),ot.deallocate(K)}while(V>0)V-=1,ot.deallocate(X[V]),X[V]=undefined;while(B>0)B-=1,O=H[B],H[B]=undefined,O.sweepFrozen||O.integratePosition(d);f.continuous+=TurbulenzEngine.getTime()*.001-x}g=s.length;for(y=0;y<g;y+=1)b=s[y],t.m43Copy(b.newTransform,b.transform),t.m43Copy(b.newTransform,b.prevTransform);this.updateContactCallbacks(),this.midStep=!1},rayTest:function(n){function u(e,t,n,o,u){var a=t._public;if(a===s||(t.mask&r)===0||(t.group&i)===0)return null;n.maxFactor=u;var f=t.rayTest(n);return f!==null&&(t.collisionObject?(f.collisionObject=a,f.body=null):(f.collisionObject=null,f.body=a)),f}var r=n.group,i=n.mask;r===undefined&&(r=ft.prototype.FILTER_DYNAMIC),i===undefined&&(i=ft.prototype.FILTER_ALL);var s=n.exclude,o={origin:n.from,direction:t.v3Sub(n.to,n.from),maxFactor:1};this.staticSpatialMap.finalize(),this.dynamicSpatialMap.finalize();var a=f.rayTest([this.staticSpatialMap,this.dynamicSpatialMap],o,u);return a!==null&&delete a.factor,a},contactPairTest:function(t,n,r){var i=t.axis,s=t.shapeA,o=t.shapeB,u=t.closestA,a=t.closestB;this.contactGJK===undefined&&(this.contactGJK=Z.create(),this.contactEPA=et.create());if(s.type==="PLANE"||o.type==="PLANE"){var f,l,c,h;s.type==="PLANE"?(f=s,c=n,l=o,h=r):(f=o,c=r,l=s,h=n);var p=c[0],d=c[1],v=c[2],m=c[3],g=c[4],y=c[5],b=c[6],w=c[7],E=c[8],S=c[9],x=c[10],T=c[11],N=f.normal,C=N[0],k=N[1],L=N[2],A=f.distance,O=C*p+k*m+L*b,M=C*d+k*g+L*w,_=C*v+k*y+L*E;p=h[0],d=h[1],v=h[2],m=h[3],g=h[4],y=h[5],b=h[6],w=h[7],E=h[8];var D=h[9],P=h[10],H=h[11];C=p*O+d*M+v*_,k=m*O+g*M+y*_,L=b*O+w*M+E*_,A+=O*(S-D)+M*(x-P)+_*(T-H),i[0]=C,i[1]=k,i[2]=L,l.localSupportWithoutMargin(i,u),i[0]=-C,i[1]=-k,i[2]=-L,l.localSupportWithoutMargin(i,a);var B=u[0]*C+u[1]*k+u[2]*L-A,j=a[0]*C+a[1]*k+a[2]*L-A,F,I,q,R;B*B<j*j?(I=u[0],q=u[1],R=u[2],F=B):(I=a[0],q=a[1],R=a[2],F=j),F<0!=B*j<0&&(F=-F,O=-O,M=-M,_=-_);var U=l.collisionRadius,z=f.collisionRadius,W=p*I+m*q+b*R+D,X=d*I+g*q+w*R+P,V=v*I+y*q+E*R+H,$=z-F,J=W+O*$,K=X+M*$,Q=V+_*$;return W-=O*U,X-=M*U,V-=_*U,F-=U+z,s.type==="PLANE"?(i[0]=-O,i[1]=-M,i[2]=-_,u[0]=J,u[1]=K,u[2]=Q,a[0]=W,a[1]=X,a[2]=V):(i[0]=O,i[1]=M,i[2]=_,u[0]=W,u[1]=X,u[2]=V,a[0]=J,a[1]=K,a[2]=Q),F}var G=this.contactGJK,Y=G.evaluate(t,n,r);Y===undefined&&(Y=this.contactEPA.evaluate(G.simplex,t,n,r));if(Y!==undefined){var tt=i[0],nt=i[1],rt=i[2],it=s.collisionRadius,st=o.collisionRadius;return u[0]-=tt*it,u[1]-=nt*it,u[2]-=rt*it,a[0]+=tt*st,a[1]+=nt*st,a[2]+=rt*st,Y-it-st}return undefined},convexSweepTest:function(n,r){function d(e,n,r,s,o,u){var a=r[0],f=r[1],l=r[2],c=i.axis,h=i.closestA,d=i.closestB;c[0]=-a,c[1]=-f,c[2]=-l,i.shapeA=e,i.shapeB=s;var v=0,m=0,g=100,y,b=Number.MAX_VALUE,w=!1;for(;;){var E=p.contactPairTest(i,n,o);if(E===undefined||E<L.GJK_EPA_DISTANCE_THRESHOLD){if(y!==undefined||E!==undefined)y===undefined&&(y=E),w=!0;break}if(E-b>=1)break;b=E;var S=d[0]-h[0],x=d[1]-h[1],T=d[2]-h[2],N=a*S+f*x+l*T;if(N<=L.COPLANAR_THRESHOLD)break;var C=E*E/N;v+=C;if(v>=u){y=undefined;break}y=E,n[9]+=a*C,n[10]+=f*C,n[11]+=l*C;if(y<=L.GJK_EPA_DISTANCE_THRESHOLD){w=!0;break}m+=1;if(m>g)break}return y===undefined||!w?null:{hitPoint:t.v3Copy(d),hitNormal:t.v3Copy(c),distance:v}}this.sweepCache===undefined&&(this.sweepCache={axis:t.v3BuildZero(),shapeA:null,shapeB:null,closestA:t.v3BuildZero(),closestB:t.v3BuildZero()},this.sweepTriangle=st.allocate(),this.sweepDelta=t.v3BuildZero(),this.sweepFromExtents=new Float32Array(6),this.sweepToExtents=new Float32Array(6),this.sweepExtents=new Float32Array(6),this.sweepFakeBody={shape:null,transform:null},this.sweepTransform=t.m43BuildIdentity(),this.sweepTransform2=t.m43BuildIdentity());var i=this.sweepCache,s=this.sweepTriangle,o=this.sweepDelta,u=this.sweepFromExtents,a=this.sweepToExtents,f=this.sweepExtents,l=this.sweepFakeBody,c=this.sweepTransform,h=this.sweepTransform2,p=this,v=n.shape._private,m=n.from,g=n.to,y=g[9]-m[9],b=g[10]-m[10],w=g[11]-m[11],E=Math.sqrt(y*y+b*b+w*w),S=1/E;o[0]=y*S,o[1]=b*S,o[2]=w*S;var x=n.group===undefined?ft.prototype.FILTER_DYNAMIC:n.group,T=n.mask===undefined?ft.prototype.FILTER_ALL:n.mask,N=n.exclude;l.shape=v,l.transform=m,W.prototype.calculateExtents.call(l,u),l.transform=g,W.prototype.calculateExtents.call(l,a),f[0]=u[0]<a[0]?u[0]:a[0],f[1]=u[1]<a[1]?u[1]:a[1],f[2]=u[2]<a[2]?u[2]:a[2],f[3]=u[3]>a[3]?u[3]:a[3],f[4]=u[4]>a[4]?u[4]:a[4],f[5]=u[5]>a[5]?u[5]:a[5],this.staticSpatialMap.finalize(),this.dynamicSpatialMap.finalize();var C=this.persistantObjectsList,k=this.persistantTrianglesList,A=this.staticSpatialMap.getOverlappingNodes(f,C,0),O=A+this.dynamicSpatialMap.getOverlappingNodes(f,C,A),M=null,_,D;for(_=0;_<O;_+=1){var P=C[_];C[_]=undefined;var H=P._public;if(H===N||P.shape===v||(P.mask&x)===0||(P.group&T)===0)continue;var B,j=P.shape;if(j.type==="TRIANGLE_MESH"){var F=j.triangleArray;s.triangleArray=F,s.collisionRadius=j.collisionRadius;var q;if(F.spatialMap){t.m43InverseOrthonormal(P.transform,h),t.m43Mul(m,h,c),l.transform=c,W.prototype.calculateExtents.call(l,u),t.m43Mul(g,h,c),W.prototype.calculateExtents.call(l,a),f[0]=u[0]<a[0]?u[0]:a[0],f[1]=u[1]<a[1]?u[1]:a[1],f[2]=u[2]<a[2]?u[2]:a[2],f[3]=u[3]>a[3]?u[3]:a[3],f[4]=u[4]>a[4]?u[4]:a[4],f[5]=u[5]>a[5]?u[5]:a[5],q=F.spatialMap.getOverlappingNodes(f,k,0);for(D=0;D<q;D+=1){s.index=k[D].index,k[D]=undefined,t.m43Copy(m,h),B=d(v,h,o,s,P.transform,E);if(B){B.collisionObject=H,B.body=null;if(!r||r(B))M=B,E=B.distance}}}else{q=F.numTriangles;for(D=0;D<q;D+=1){s.index=D*I.prototype.TRIANGLE_SIZE,t.m43Copy(m,h),B=d(v,h,o,s,P.transform,E);if(B){B.collisionObject=H,B.body=null;if(!r||r(B))M=B,E=B.distance}}}}else{t.m43Copy(m,h),B=d(v,h,o,j,P.transform,E);if(B){P.collisionObject?(B.collisionObject=H,B.body=null):(B.collisionObject=null,B.body=H);if(!r||r(B))M=B,E=B.distance}}if(E<1e-4){for(D=_;D<O;D+=1)C[D]=undefined;break}}return M&&delete M.distance,M},addBody:function(t){if(t.world)return!1;t.world=this;if(t.collisionObject&&!t.kinematic)return this.collisionObjects.push(t),this.syncBody(t),!0;t.kinematic?this.kinematicBodies.push(t):this.rigidBodies.push(t);var n=!t.active;return t.previouslyActive=!0,t.active=!1,t.islandRoot=t,t.islandRank=0,n?this.syncBody(t):this.wakeBody(t),!0},removeBody:function(t){if(t.world!==this)return!1;var n,r;t.collisionObject&&!t.kinematic?n=this.collisionObjects:t.kinematic?(n=this.kinematicBodies,r=this.activeKinematics):(n=this.rigidBodies,r=this.activeBodies),t.world=null,n[n.indexOf(t)]=n[n.length-1],n.pop(),r&&t.active?(r[r.indexOf(t)]=r[r.length-1],r.pop(),this.dynamicSpatialMap.remove(t)):this.staticSpatialMap.remove(t),this.removeArbitersFromObject(t),this.removeFromContactCallbacks(t);var i=t.island;if(i){var s=i.bodies,o=s.indexOf(t);o!==-1&&(s[o]=s[s.length-1],s.pop()),t.island=null}return!0},addConstraint:function(t){if(t.world)return!1;t.world=this,this.constraints.push(t),t.bodyA&&t.bodyA.constraints.push(t),t.bodyB&&t.bodyB.constraints.push(t);var n=!t.active;return t.active=!1,t.islandRoot=t,t.islandRank=0,n||this.wakeConstraint(t),!0},removeConstraint:function(t){if(t.world!==this)return!1;t.world=null;var n=this.constraints;n[n.indexOf(t)]=n[n.length-1],n.pop(),t.bodyA&&(n=t.bodyA.constraints,n[n.indexOf(t)]=n[n.length-1],n.pop()),t.bodyB&&(n=t.bodyA.constraints,n[n.indexOf(t)]=n[n.length-1],n.pop()),t.active&&(n=this.activeConstraints,n[n.indexOf(t)]=n[n.length-1],n.pop());var r=t.island;if(r){var i=r.constraints,s=i.indexOf(t);s!==-1&&(i[s]=i[i.length-1],i.pop()),t.island=null}return!0},flush:function(){while(this.rigidBodies.length>0)this.removeBody(this.rigidBodies[0]);while(this.collisionObjects.length>0)this.removeBody(this.collisionObjects[0]);while(this.kinematicBodies.length>0)this.removeBody(this.kinematicBodies[0]);while(this.constraints.length>0)this.removeConstraint(this.constraints[0]);this.timeStamp=0},removeArbitersFromObject:function(t){var n=t.arbiters,r=this.activeArbiters;while(n.length>0){var i=n.pop(),s=i.objectA===t?i.objectB.arbiters:i.objectA.arbiters;s[s.indexOf(i)]=s[s.length-1],s.pop(),i.active&&(r[r.indexOf(i)]=r[r.length-1],r.pop());while(i.contacts.length>0){var o=i.contacts.pop();tt.deallocate(o)}rt.deallocate(i)}},removeFromContactCallbacks:function(t){var n=this.contactCallbackObjects,r=n.length,i;for(i=0;i<r;i+=1)if(n[i]===t){r-=1,i<r&&(n[i]=n[r]),n.length=r;break}t.addedToContactCallbacks=!1},updateContactCallbacks:function(){var t=this.contactCallbackObjects,n=t.length,r=tt.publicContacts,i=tt.callbackContacts,s,o,u,a,f,l=0;while(l<n){var c=t[l],h=c.arbiters,p=h.length;if(0===p)c.contactCallbacks.added=!1,n-=1,l<n&&(t[l]=t[n]),t.length=n;else{var d,v;for(d=0;d<p;d+=1){s=h[d];if(0!==s.contactFlags){var m=s.contacts,g=m.length;while(r.length<g)r[r.length]=nt.create();i.length=g;for(v=0;v<g;v+=1){var y=r[v];y._private=m[v],i[v]=y}o=s.objectA,u=s.objectB,a=o.contactCallbacks,f=u.contactCallbacks,s.contactFlags&1&&(null!==a&&a.onAddedContacts&&a.onAddedContacts(o._public,u._public,i),null!==f&&f.onAddedContacts&&f.onAddedContacts(o._public,u._public,i)),s.contactFlags&2&&(null!==a&&a.onProcessedContacts&&a.onProcessedContacts(o._public,u._public,i),null!==f&&f.onProcessedContacts&&f.onProcessedContacts(o._public,u._public,i)),s.contactFlags&4&&(null!==a&&a.onRemovedContacts&&a.onRemovedContacts(o._public,u._public,i),null!==f&&f.onRemovedContacts&&f.onRemovedContacts(o._public,u._public,i)),s.contactFlags=0;for(v=0;v<g;v+=1)m[v][51]=0}}l+=1}}var b=this.contactCallbackRemovedArbiters;n=b.length,i.length=0;for(l=0;l<n;l+=1)s=b[l],o=s.objectA,u=s.objectB,a=o.contactCallbacks,f=u.contactCallbacks,null!==a&&a.onRemovedContacts&&a.onRemovedContacts(o._public,u._public,i),null!==f&&f.onRemovedContacts&&f.onRemovedContacts(o._public,u._public,i),rt.deallocate(s);b.length=0}},ut.create=function(n){var r=new ut,i=new at;return r._private=i,i._public=r,i.gravity=n.gravity!==undefined?t.v3Copy(n.gravity):t.v3Build(0,-10,0),i.maxSubSteps=n.maxSubSteps!==undefined?n.maxSubSteps:10,i.fixedTimeStep=n.fixedTimeStep!==undefined?n.fixedTimeStep:1/60,i.variableMinStep=n.minimumTimeStep!==undefined?n.minimumTimeStep:1/70,i.variableMaxStep=n.maximumTimeStep!==undefined?n.maximumTimeStep:.02,i.variableStep=n.variableTimeSteps!==undefined?n.variableTimeSteps:!1,i.maxGiveUpTimeStep=n.maxGiveUpTimeStep!==undefined?n.maxGiveUpTimeStep:.05,Object.defineProperty(r,"maxSubSteps",{value:i.maxSubSteps,enumerable:!0}),Object.defineProperty(r,"maxGiveUpTimeStep",{value:i.maxGiveUpTimeStep,enumerable:!0}),i.variableStep?(Object.defineProperty(r,"minimumTimeStep",{value:i.variableMinStep,enumerable:!0}),Object.defineProperty(r,"maximumTimeStep",{value:i.variableMaxStep,enumerable:!0})):Object.defineProperty(r,"fixedTimeStep",{value:i.fixedTimeStep,enumerable:!0}),Object.defineProperty(r,"gravity",{get:function(){return t.v3Copy(this._private.gravity)},enumerable:!0}),i.staticSpatialMap=f.create(!0),i.dynamicSpatialMap=f.create(),i.collisionObjects=[],i.rigidBodies=[],i.constraints=[],i.kinematicBodies=[],i.activeArbiters=[],i.activeBodies=[],i.activeKinematics=[],i.activeConstraints=[],i.persistantObjectsList=[],i.persistantObjectsList2=[],i.persistantTrianglesList=[],i.persistantTOIEventList=[],i.timeStamp=0,i.performanceData={discrete:0,sleepComputation:0,prestepContacts:0,prestepConstraints:0,integrateVelocities:0,warmstartContacts:0,warmstartConstraints:0,physicsIterations:0,integratePositions:0,continuous:0},Object.defineProperty(r,"performanceData",{value:i.performanceData,enumerable:!0}),i.syncExtents=new Float32Array(6),i.contactCallbackObjects=[],i.contactCallbackRemovedArbiters=[],r};var ft=function(){function e(){this.version=1,this.vendor="Turbulenz",this.genObjectId=0}return e.create=function(){return new e},e.prototype.createDynamicsWorld=function(e){return ut.create(e)},e.prototype.createPlaneShape=function(e){return _.create(e)},e.prototype.createBoxShape=function(e){return H.create(e)},e.prototype.createSphereShape=function(e){return P.create(e)},e.prototype.createCapsuleShape=function(e){return D.create(e)},e.prototype.createCylinderShape=function(e){return B.create(e)},e.prototype.createConeShape=function(e){return j.create(e)},e.prototype.createTriangleMeshShape=function(e){return R.create(e)},e.prototype.createConvexHullShape=function(e){return U.create(e)},e.prototype.createTriangleArray=function(e){return F.create(e)},e.prototype.createCollisionObject=function(e){return z.create(e)},e.prototype.createRigidBody=function(e){return V.create(e)},e.prototype.createPoint2PointConstraint=function(e){return K.create(e)},e.prototype.createHingeConstraint=function(e){return $.create("HINGE",e)},e.prototype.createConeTwistConstraint=function(e){return $.create("CONETWIST",e)},e.prototype.create6DOFConstraint=function(e){return $.create("D6",e)},e.prototype.createSliderConstraint=function(e){return $.create("SLIDER",e)},e.prototype.createCharacter=function(e){return G.create(e)},e}();ft.prototype.FILTER_DYNAMIC=1,ft.prototype.FILTER_STATIC=2,ft.prototype.FILTER_KINEMATIC=4,ft.prototype.FILTER_DEBRIS=8,ft.prototype.FILTER_TRIGGER=16,ft.prototype.FILTER_CHARACTER=32,ft.prototype.FILTER_PROJECTILE=64,ft.prototype.FILTER_USER_MIN=128,ft.prototype.FILTER_USER_MAX=32768,ft.prototype.FILTER_ALL=65535,lt.prototype={version:1,destroy:function(){var t=this.audioContext;t?(delete this.audioContext,delete this.buffer):delete this.audio}},lt.create=function(t,n){var r=new lt,i=n.src;r.name=n.name||i,r.frequency=0,r.channels=0,r.bitrate=0,r.length=0,r.compressed=!n.uncompress;var s=n.onload,o,u,a,f,l=t.audioContext;if(l){r.audioContext=l;var c;if(i){if(!t.isResourceSupported(i))return s&&s(null),null;var h=function(t){t?(r.buffer=t,r.frequency=t.sampleRate,r.channels=t.numberOfChannels,r.bitrate=r.frequency*r.channels*2*8,r.length=t.duration,s&&s(r,200)):s&&s(null)},p=function(){s&&s(null)};o=n.data;if(o)l.decodeAudioData?l.decodeAudioData(o,h,p):(c=l.createBuffer(o,!1),h(c));else{var d;if(window.XMLHttpRequest)d=new window.XMLHttpRequest;else{if(!window.ActiveXObject)return s&&s(null),null;d=new window.ActiveXObject("Microsoft.XMLHTTP")}d.onreadystatechange=function(){if(d.readyState===4){if(!TurbulenzEngine||!TurbulenzEngine.isUnloading()){var e=d.status,t=e!==0&&d.statusText||"No connection",n=d.response;if(d.getAllResponseHeaders()===""&&!n&&e===200&&t==="OK")s&&s(null);else if(e===200||e===0)if(l.decodeAudioData)l.decodeAudioData(n,h,p);else{var r=l.createBuffer(n,!1);h(r)}else s&&s(null)}d.onreadystatechange=null,d=null}},d.open("GET",i,!0),d.responseType="arraybuffer",d.setRequestHeader("Content-Type","text/plain"),d.send(null)}return r}o=n.data;if(o){u=o.length,a=n.channels||1,f=n.frequency;var v=Math.min(l.sampleRate,96e3),m,g,y,b;if(v===f){c=l.createBuffer(a,u/a,f);for(m=0;m<a;m+=1){g=c.getChannelData(m);for(y=m,b=0;y<u;y+=a,b+=1)g[b]=o[y]}}else{var w=f/v,E=u/(w*a)|0;c=l.createBuffer(a,E,v);for(m=0;m<a;m+=1){g=c.getChannelData(m);for(b=0;b<E;b+=1)g[b]=o[m+(b*w|0)*a]}}if(c)return r.buffer=c,r.frequency=f,r.channels=a,r.bitrate=f*a*2*8,r.length=u/(f*a),s&&s(r,200),r}}else{var S;if(i){var x=i.slice(-3);o=n.data;if(o){var T;o instanceof Uint8Array?T=o:T=new Uint8Array(o),T[0]===79&&T[1]===103&&T[2]===103&&T[3]===83?(x="ogg",i="data:audio/ogg;base64,"):T[0]===82&&T[1]===73&&T[2]===70&&T[3]===70?(x="wav",i="data:audio/wav;base64,"):(x="mp3",i="data:audio/mpeg;base64,"),i+=TurbulenzEngine.base64Encode(T)}return t.supportedExtensions[x]?(S=new Audio,S.preload="auto",S.autobuffer=!0,S.src=i,S.onerror=function(){s&&(s(null),s=null)},t.addLoadingSound(function(){if(3<=S.readyState){r.frequency=S.sampleRate||S.mozSampleRate,r.channels=S.channels||S.mozChannels,r.bitrate=r.frequency*r.channels*2*8,r.length=S.duration;if(S.buffered&&S.buffered.length&&0<S.buffered.end(0)){if(isNaN(r.length)||r.length===Number.POSITIVE_INFINITY)r.length=S.buffered.end(0);s&&(s(r,200),s=null)}else{var t=function(){S.pause(),S.removeEventListener("play",t,!1),s&&(s(r,200),s=null)};S.addEventListener("play",t,!1),S.volume=0,S.play()}return!0}return!1}),r.audio=S,r):(s&&s(null),null)}o=n.data;if(o){S=new Audio;if(S.mozSetup)return u=o.length,a=n.channels||1,f=n.frequency,S.mozSetup(a,f),r.data=o,r.frequency=f,r.channels=a,r.bitrate=f*a*2*8,r.length=u/(f*a),r.audio=S,s&&s(r,200),r;S=null}}return s&&s(null),null},ct.prototype={version:1,play:function(t,n){var r=this.audioContext;if(r){var i=this.bufferNode;if(this.sound!==t)i&&i.stop(0);else if(i)return this.seek(n);i=this.createBufferNode(t),this.sound=t,this.playing||(this.playing=!0,this.paused=!1,this.sd.addPlayingSource(this)),n===undefined&&(n=0);if(0<n){var s=t.buffer;i.loop?i.start(0,n,s.duration):i.start(0,n,s.duration-n),this.playStart=r.currentTime-n}else i.start(0),this.playStart=r.currentTime}else{var o;if(this.sound!==t)this.stop(),t.data?(o=new Audio,o.mozSetup(t.channels,t.frequency)):o=t.audio.cloneNode(!0),this.sound=t,this.audio=o,o.loop=this.looping,o.addEventListener("ended",this.loopAudio,!1);else{if(this.playing&&!this.paused&&this.looping)return!0;o=this.audio}this.playing||(this.playing=!0,this.paused=!1,this.sd.addPlayingSource(this)),n===undefined&&(n=0);if(.05<Math.abs(o.currentTime-n))try{o.currentTime=n}catch(u){}t.data?o.mozWriteAudio(t.data):o.play()}return!0},stop:function(){var t=this.playing;if(t){this.playing=!1,this.paused=!1;var n=this.audioContext;if(n){this.sound=null;var r=this.bufferNode;r&&(r.stop(0),r.disconnect(),this.bufferNode=null)}else{var i=this.audio;i&&(this.sound=null,this.audio=null,i.pause(),i.removeEventListener("ended",this.loopAudio,!1),i=null)}this.sd.removePlayingSource(this)}return t},pause:function(){if(this.playing){if(!this.paused){this.paused=!0;var t=this.audioContext;t?(this.playPaused=t.currentTime,this.bufferNode.stop(0),this.bufferNode.disconnect(),this.bufferNode=null):this.audio.pause(),this.sd.removePlayingSource(this)}return!0}return!1},resume:function(t){if(this.paused){this.paused=!1;var n=this.audioContext;if(n){t===undefined&&(t=this.playPaused-this.playStart);var r=this.createBufferNode(this.sound);if(0<t){var i=this.sound.buffer;r.loop?r.start(0,t,i.duration):r.start(0,t,i.duration-t),this.playStart=n.currentTime-t}else r.start(0),this.playStart=n.currentTime}else{var s=this.audio;if(t!==undefined&&.05<Math.abs(s.currentTime-t))try{s.currentTime=t}catch(o){}s.play()}return this.sd.addPlayingSource(this),!0}return!1},rewind:function(){if(this.playing){var t=this.audioContext;if(t){var n=this.bufferNode;return n&&n.stop(0),n=this.createBufferNode(this.sound),n.start(0),this.playStart=t.currentTime,!0}var r=this.audio;if(r)return r.currentTime=0,!0}return!1},seek:function(t){if(this.playing){var n=this.audioContext;if(n){if(.05<Math.abs(n.currentTime-this.playStart-t)){var r=this.bufferNode;r&&r.stop(0),r=this.createBufferNode(this.sound);if(0<t){var i=this.sound.buffer;r.loop?r.start(0,t,i.duration):r.start(0,t,i.duration-t),this.playStart=n.currentTime-t}else r.start(0),this.playStart=n.currentTime}return!0}var s=this.audio;if(s){if(s.currentTime>t)try{s.currentTime=t}catch(o){}return!0}}return!1},clear:function(){this.stop()},setAuxiliarySendFilter:function(){},setDirectFilter:function(){},destroy:function(){this.stop();var t=this.audioContext;if(t){var n=this.pannerNode;n&&(n.disconnect(),delete this.pannerNode),delete this.audioContext}}},ct.create=function(n,r,i){var s=new ct;s.sd=n,s.id=r,s.sound=null,s.playing=!1,s.paused=!1;var o=typeof i.gain=="number"?i.gain:1,u=i.looping||!1,a=i.pitch||1,f,l,c,h=n.audioContext;if(h){s.audioContext=h,s.bufferNode=null,s.playStart=-1,s.playPaused=-1;var p=n.gainNode,d=h.createPanner();s.pannerNode=d,d.connect(p);var v=h.createGain?h.createGain():h.createGainNode();s.gainNode=v,n.linearDistance&&(typeof d.distanceModel=="string"?d.distanceModel="linear":typeof d.LINEAR_DISTANCE=="number"&&(d.distanceModel=d.LINEAR_DISTANCE)),typeof d.panningModel=="string"?d.panningModel="equalpower":d.panningModel=d.EQUALPOWER,Object.defineProperty(s,"position",{get:function(){return f.slice()},set:function(n){f=t.v3Copy(n,f),s.relative||this.pannerNode.setPosition(n[0],n[1],n[2])},enumerable:!0,configurable:!1}),Object.defineProperty(s,"direction",{get:function(){return l.slice()},set:function(n){l=t.v3Copy(n,l),this.pannerNode.setOrientation(n[0],n[1],n[2])},enumerable:!0,configurable:!1}),Object.defineProperty(s,"velocity",{get:function(){return c.slice()},set:function(n){c=t.v3Copy(n,c),this.pannerNode.setVelocity(n[0],n[1],n[2])},enumerable:!0,configurable:!1}),Object.defineProperty(s,"gain",{get:function(){return o},set:function(t){o=t,this.gainNode.gain.value=t},enumerable:!0,configurable:!1}),s.createBufferNode=function(t){var n=t.buffer,r=h.createBufferSource();return r.buffer=n,r.loop=u,r.playbackRate&&(r.playbackRate.value=a),r.connect(v),v.disconnect(),1<t.channels?v.connect(p):v.connect(d),r.start||(r.start=function(t,n,r){arguments.length<=1?this.noteOn(t):this.noteGrainOn(t,n,r)}),r.stop||(r.stop=function(t){this.noteOff(t)}),this.bufferNode=r,r},s.updateRelativePosition=function(t,n,r){1>=this.sound.channels&&d.setPosition(f[0]+t,f[1]+n,f[2]+r)},Object.defineProperty(s,"looping",{get:function(){return u},set:function(t){u=t;var n=this.bufferNode;n&&(n.loop=t)},enumerable:!0,configurable:!1}),Object.defineProperty(s,"pitch",{get:function(){return a
},set:function(t){a=t;var n=this.bufferNode;n&&n.playbackRate&&(n.playbackRate.value=t)},enumerable:!0,configurable:!1}),Object.defineProperty(s,"tell",{get:function(){return this.playing?this.paused?this.playPaused-this.playStart:h.currentTime-this.playStart:0},enumerable:!0,configurable:!1}),Object.defineProperty(s,"minDistance",{get:function(){return d.refDistance},set:function(t){this.pannerNode.maxDistance===t&&(t=this.pannerNode.maxDistance*.999),this.pannerNode.refDistance=t},enumerable:!0,configurable:!1}),Object.defineProperty(s,"maxDistance",{get:function(){return d.maxDistance},set:function(t){this.pannerNode.refDistance===t&&(t=this.pannerNode.refDistance*1.001),this.pannerNode.maxDistance=t},enumerable:!0,configurable:!1}),Object.defineProperty(s,"rollOff",{get:function(){return d.rolloffFactor},set:function(t){this.pannerNode.rolloffFactor=t},enumerable:!0,configurable:!1})}else s.audio=null,s.gainFactor=1,s.pitch=a,s.updateAudioVolume=function(){var t=this.audio;if(t){var n=Math.min(this.gainFactor*o,1);t.volume=n,0>=n?t.muted=!0:t.muted=!1}},Object.defineProperty(s,"position",{get:function(){return f.slice()},set:function(n){f=t.v3Copy(n,f)},enumerable:!0,configurable:!1}),Object.defineProperty(s,"direction",{get:function(){return l.slice()},set:function(n){l=t.v3Copy(n,l)},enumerable:!0,configurable:!1}),Object.defineProperty(s,"velocity",{get:function(){return c.slice()},set:function(n){c=t.v3Copy(n,c)},enumerable:!0,configurable:!1}),Object.defineProperty(s,"gain",{get:function(){return o},set:function(t){o=t,s.gainFactor=-1},enumerable:!0,configurable:!1}),n.loopingSupported?(Object.defineProperty(s,"looping",{get:function(){return u},set:function(t){u=t;var n=s.audio;n&&(n.loop=t)},enumerable:!0,configurable:!1}),s.loopAudio=function(){var t=s.audio;t&&(s.playing=!1,s.sd.removePlayingSource(s))}):(s.looping=u,s.loopAudio=function(){var t=s.audio;t&&(s.looping?(t.currentTime=0,t.play()):(s.playing=!1,s.sd.removePlayingSource(s)))}),Object.defineProperty(s,"tell",{get:function(){var t=s.audio;return t?t.currentTime:0},enumerable:!0,configurable:!1}),s.updateRelativePosition=function(t,n,r){var i=this.minDistance,s=this.maxDistance,o=f[0],u=f[1],a=f[2],l;if(this.relative)l=o*o+u*u+a*a;else{var c=t-o,h=n-u,p=r-a;l=c*c+h*h+p*p}var d;if(l<=i*i)d=1;else if(l>=s*s)d=0;else{var v=Math.sqrt(l);this.sd.linearDistance?d=(s-v)/(s-i):d=i/(i+this.rollOff*(v-i))}d*=this.sd.listenerGain,this.gainFactor!==d&&(this.gainFactor=d,this.updateAudioVolume())};return s.relative=i.relative,s.position=i.position||t.v3BuildZero(),s.direction=i.direction||t.v3BuildZero(),s.velocity=i.velocity||t.v3BuildZero(),s.minDistance=i.minDistance||1,s.maxDistance=i.maxDistance||3.402823466e38,s.rollOff=i.rollOff||1,s},ht.prototype={version:1,vendor:"Turbulenz",createSource:function(t){return this.lastSourceID+=1,ct.create(this,this.lastSourceID,t)},createSound:function(t){return lt.create(this,t)},loadSoundsArchive:function(t){var n=t.src;return typeof pt!="undefined"?(pt.create({sd:this,src:n,uncompress:t.uncompress,onsoundload:function(n){t.onsoundload(n)},onload:function(n){t.onload&&t.onload(n)},onerror:function(){t.onload&&t.onload(!1)}}),!0):(TurbulenzEngine.callOnError("Missing archive loader required for "+n),!1)},createEffect:function(){return null},createEffectSlot:function(){return null},createFilter:function(){return null},update:function(){var t=this.listenerTransform,n=t[9],r=t[10],i=t[11],s=this.playingSources,o;for(o in s)if(s.hasOwnProperty(o)){var u=s[o];u.updateRelativePosition(n,r,i)}},isSupported:function(t){return"FILEFORMAT_OGG"===t?this.supportedExtensions.ogg:"FILEFORMAT_MP3"===t?this.supportedExtensions.mp3:"FILEFORMAT_WAV"===t?this.supportedExtensions.wav:!1},addLoadingSound:function(t){var n=this.loadingSounds;n[n.length]=t;var r=this.loadingInterval,i=this;r===null&&(this.loadingInterval=r=window.setInterval(function(){var t=n.length,s=0;do{var o=n[s];o()?(t-=1,s<t&&(n[s]=n[t]),n.length=t):s+=1}while(s<t);t===0&&(window.clearInterval(r),i.loadingInterval=null)},100))},addPlayingSource:function(t){this.playingSources[t.id]=t},removePlayingSource:function(t){delete this.playingSources[t.id]},isResourceSupported:function(t){var n=t.slice(-3).toLowerCase();return this.supportedExtensions[n]},destroy:function(){var t=this.loadingInterval;t!==null&&(window.clearInterval(t),this.loadingInterval=null);var n=this.loadingSounds;n&&(n.length=0,this.loadingSounds=null);var r=this.playingSources,i;if(r){for(i in r)if(r.hasOwnProperty(i)){var s=r[i];s&&s.stop()}this.playingSources=null}}},ht.create=function(n){var r=new ht;r.extensions="",r.renderer="HTML5 Audio",r.alcVersion="0",r.alcExtensions="",r.alcEfxVersion="0",r.alcMaxAuxiliarySends=0,r.deviceSpecifier=n.deviceSpecifier||null,r.frequency=n.frequency||44100,r.dopplerFactor=n.dopplerFactor||1,r.dopplerVelocity=n.dopplerVelocity||1,r.speedOfSound=n.speedOfSound||343.29998779296875,r.linearDistance=n.linearDistance!==undefined?n.linearDistance:!0,r.loadingSounds=[],r.loadingInterval=null,r.playingSources={},r.lastSourceID=0;var i=window.AudioContext||window.webkitAudioContext;if(i){var s;try{s=new i}catch(o){return TurbulenzEngine.callOnError("Failed to create AudioContext:"+o),null}if(s.sampleRate===0)return null;r.renderer="WebAudio",r.audioContext=s,r.frequency=s.sampleRate,r.gainNode=s.createGain?s.createGain():s.createGainNode(),r.gainNode.connect(s.destination);var u=s.listener;u.dopplerFactor=r.dopplerFactor,u.speedOfSound=r.speedOfSound;var a,f;Object.defineProperty(r,"listenerTransform",{get:function(){return a.slice()},set:function(n){a=t.m43Copy(n,a);var r=n[9],i=n[10],s=n[11];u.setPosition(r,i,s),u.setOrientation(-n[6],-n[7],-n[8],n[3],n[4],n[5])},enumerable:!0,configurable:!1}),Object.defineProperty(r,"listenerVelocity",{get:function(){return f.slice()},set:function(n){f=t.v3Copy(n,f),u.setVelocity(n[0],n[1],n[2])},enumerable:!0,configurable:!1}),r.update=function(){this.gainNode.gain.value=this.listenerGain;var t=a[9],n=a[10],r=a[11],i=this.playingSources,o=[],u;for(u in i)if(i.hasOwnProperty(u)){var f=i[u],l=s.currentTime-f.playStart;if(f.bufferNode.buffer.duration<l){if(!f.looping){f.playing=!1,f.sound=null,f.bufferNode.disconnect(),f.bufferNode=null,o[o.length]=u;continue}f.playStart=s.currentTime-(l-f.bufferNode.buffer.duration)}f.relative&&f.updateRelativePosition(t,n,r)}var c=o.length,h;for(h=0;h<c;h+=1)delete i[o[h]]}}r.listenerTransform=n.listenerTransform||t.m43BuildIdentity(),r.listenerVelocity=n.listenerVelocity||t.v3BuildZero(),r.listenerGain=typeof n.listenerGain=="number"?n.listenerGain:1;var l=new Audio;if(r.audioContext)r.loopingSupported=!0;else{if(l.mozSetup)try{l.mozSetup(1,22050)}catch(c){return null}r.loopingSupported=typeof l.loop=="boolean"}var h={ogg:!1,mp3:!1,wav:!1};return l.canPlayType("application/ogg")&&(h.ogg=!0),l.canPlayType("audio/mp3")&&(h.mp3=!0),l.canPlayType("audio/wav")&&(h.wav=!0),r.supportedExtensions=h,l=null,r},typeof ArrayBuffer!="undefined"&&ArrayBuffer.prototype!==undefined&&ArrayBuffer.prototype.slice===undefined&&(ArrayBuffer.prototype.slice=function(t,n){var r=this.byteLength;t===undefined?t=0:t<0&&(t+=r),n===undefined?n=r:n<0&&(n+=r),r=n-t;if(0<r){var i=new Uint8Array(this,t,r),s=new Uint8Array(i);return s.buffer}return new ArrayBuffer(0)}),pt.prototype={version:1,processBytes:function(t){function i(e){n+=e}function s(e){var r=n,i=r+e,s=t[r],o;if(s&&0<e){r+=1;var u=new Array(e),a=0;do u[a]=s,a+=1,s=t[r],r+=1;while(s&&a<e);while(u[a-1]===32)a-=1;u.length=a,o=String.fromCharCode.apply(null,u)}else o="";return n=i,o}function o(e){return e=e.replace(/[^\d]/g,""),parseInt("0"+e,8)}function a(e){e.fileName=s(100),i(8),i(8),i(8),e.length=o(s(12)),i(12),i(8),e.fileType=s(1),i(100),e.ustarSignature=s(6),i(2),i(32),i(32),i(8),i(8),e.fileNamePrefix=s(155),n+=12}function d(e){p.soundsLoading-=1,e?c(e):h=!1}var n=0,r=t.length,u={fileName:null,length:0,fileType:null,ustarSignature:null,fileNamePrefix:null},f=this.sd,l=this.uncompress,c=this.onsoundload,h=!0;this.soundsLoading=0;var p=this;while(n+512<=r){a(u);if(0<u.length){var v;u.fileName==="././@LongLink"?(v=s(256),n+=256,a(u)):u.fileNamePrefix&&u.ustarSignature==="ustar"?v=u.fileNamePrefix+u.fileName:v=u.fileName;if(""===u.fileType||"0"===u.fileType)this.soundsLoading+=1,f.createSound({src:v,data:f.audioContext?t.buffer.slice(n,n+u.length):t.subarray(n,n+u.length),uncompress:l,onload:d});n+=Math.floor((u.length+511)/512)*512}}return t=null,h},isValidHeader:function(){return!0}},pt.create=function(t){var n=new pt;n.sd=t.sd,n.uncompress=t.uncompress,n.onsoundload=t.onsoundload,n.onload=t.onload,n.onerror=t.onerror,n.soundsLoading=0;var r=t.src;if(r){n.src=r;var i;if(window.XMLHttpRequest)i=new window.XMLHttpRequest;else{if(!window.ActiveXObject)return t.onerror&&t.onerror("No XMLHTTPRequest object could be created"),null;i=new window.ActiveXObject("Microsoft.XMLHTTP")}i.onreadystatechange=function(){if(i.readyState===4){if(!TurbulenzEngine||!TurbulenzEngine.isUnloading()){var e=i.status,t=i.status!==0&&i.statusText||"No connection";if(i.getAllResponseHeaders()===""&&i.responseText===""&&e===200&&t==="OK"){n.onload(!1,0);return}if(e===200||e===0){var r;if(i.responseType==="arraybuffer")r=i.response;else if(i.mozResponseArrayBuffer)r=i.mozResponseArrayBuffer;else{var s=i.responseText,o=s.length,u;r=[],r.length=o;for(u=0;u<o;u+=1)r[u]=s.charCodeAt(u)&255}e===0&&window.location.protocol==="file:"&&(e=200);var a=n.processBytes(new Uint8Array(r));if(n.onload){var f=function(){0<n.soundsLoading?(!TurbulenzEngine||!TurbulenzEngine.isUnloading())&&window.setTimeout(f,100):n.onload(a,e)};f()}}else n.onerror&&n.onerror()}i.onreadystatechange=null,i=null}},i.open("GET",t.src,!0),i.hasOwnProperty&&i.hasOwnProperty("responseType")?i.responseType="arraybuffer":i.overrideMimeType?i.overrideMimeType("text/plain; charset=x-user-defined"):i.setRequestHeader("Content-Type","text/plain; charset=x-user-defined"),i.send(null)}return n},dt.prototype={version:1,processBytes:function(t){function i(e){n+=e}function s(e){var r=n,i=r+e,s=t[r],o;if(s&&0<e){r+=1;var u=new Array(e),a=0;do u[a]=s,a+=1,s=t[r],r+=1;while(s&&a<e);while(u[a-1]===32)a-=1;u.length=a,o=String.fromCharCode.apply(null,u)}else o="";return n=i,o}function o(e){return e=e.replace(/[^\d]/g,""),parseInt("0"+e,8)}function a(e){e.fileName=s(100),i(8),i(8),i(8),e.length=o(s(12)),i(12),i(8),e.fileType=s(1),i(100),e.ustarSignature=s(6),i(2),i(32),i(32),i(8),i(8),e.fileNamePrefix=s(155),n+=12}function d(e){p.texturesLoading-=1,e?c(e):(n=r,h=!1)}var n=0,r=t.length,u={fileName:null,length:0,fileType:null,ustarSignature:null,fileNamePrefix:null},f=this.gd,l=this.mipmaps,c=this.ontextureload,h=!0;this.texturesLoading=0;var p=this;while(n+512<=r){a(u);if(0<u.length){var v;u.fileName==="././@LongLink"?(v=s(256),n+=256,a(u)):u.fileNamePrefix&&u.ustarSignature==="ustar"?v=u.fileNamePrefix+u.fileName:v=u.fileName;if(""===u.fileType||"0"===u.fileType)this.texturesLoading+=1,f.createTexture({src:v,data:t.subarray(n,n+u.length),mipmaps:l,onload:d});n+=Math.floor((u.length+511)/512)*512}}return t=null,h},isValidHeader:function(){return!0}},dt.create=function(t){var n=new dt;n.gd=t.gd,n.mipmaps=t.mipmaps,n.ontextureload=t.ontextureload,n.onload=t.onload,n.onerror=t.onerror,n.texturesLoading=0;var r=t.src;if(r){n.src=r;var i;if(window.XMLHttpRequest)i=new window.XMLHttpRequest;else{if(!window.ActiveXObject)return t.onerror&&t.onerror("No XMLHTTPRequest object could be created"),null;i=new window.ActiveXObject("Microsoft.XMLHTTP")}i.onreadystatechange=function(){if(i.readyState===4){if(!TurbulenzEngine||!TurbulenzEngine.isUnloading()){var e=i.status,t=i.status!==0&&i.statusText||"No connection";if(i.getAllResponseHeaders()===""&&i.responseText===""&&e===200&&t==="OK"){n.onload(!1,0);return}if(e===200||e===0){var r;if(i.responseType==="arraybuffer")r=i.response;else if(i.mozResponseArrayBuffer)r=i.mozResponseArrayBuffer;else{var s=i.responseText,o=s.length;r=[],r.length=o;for(var u=0;u<o;u+=1)r[u]=s.charCodeAt(u)&255}e===0&&window.location.protocol==="file:"&&(e=200);if(n.processBytes(new Uint8Array(r))){if(n.onload){var a=function(){0<n.texturesLoading?(!TurbulenzEngine||!TurbulenzEngine.isUnloading())&&window.setTimeout(a,100):n.onload(!0,e)};a()}}else n.onerror&&n.onerror()}else n.onerror&&n.onerror()}i.onreadystatechange=null,i=null}},i.open("GET",t.src,!0),i.hasOwnProperty&&i.hasOwnProperty("responseType")?i.responseType="arraybuffer":i.overrideMimeType?i.overrideMimeType("text/plain; charset=x-user-defined"):i.setRequestHeader("Content-Type","text/plain; charset=x-user-defined"),i.send(null)}return n},vt.prototype={version:1,TYPE_MAPPED:1,TYPE_COLOR:2,TYPE_GRAY:3,TYPE_MAPPED_RLE:9,TYPE_COLOR_RLE:10,TYPE_GRAY_RLE:11,DESC_ABITS:15,DESC_HORIZONTAL:16,DESC_VERTICAL:32,SIGNATURE:"TRUEVISION-XFILE",RLE_PACKETSIZE:128,processBytes:function(t){var n=this.parseHeader(t);if(!this.isValidHeader(n))return;var r=18;this.width=n.width,this.height=n.height,this.bytesPerPixel=Math.floor(n.bpp/8),this.horzRev=n.descriptor&this.DESC_HORIZONTAL,this.vertRev=!(n.descriptor&this.DESC_VERTICAL);var i=!1,s=this.gd;switch(n.imageType){case this.TYPE_MAPPED_RLE:i=!0,n.colorMapSize>24?this.format=s.PIXELFORMAT_R8G8B8A8:n.colorMapSize>16?this.format=s.PIXELFORMAT_R8G8B8:this.format=s.PIXELFORMAT_R5G5B5A1;break;case this.TYPE_MAPPED:n.colorMapSize>24?this.format=s.PIXELFORMAT_R8G8B8A8:n.colorMapSize>16?this.format=s.PIXELFORMAT_R8G8B8:this.format=s.PIXELFORMAT_R5G5B5A1;break;case this.TYPE_GRAY_RLE:i=!0,this.format=s.PIXELFORMAT_L8;break;case this.TYPE_GRAY:this.format=s.PIXELFORMAT_L8;break;case this.TYPE_COLOR_RLE:i=!0;switch(this.bytesPerPixel){case 4:this.format=s.PIXELFORMAT_R8G8B8A8;break;case 3:this.format=s.PIXELFORMAT_R8G8B8;break;case 2:this.format=s.PIXELFORMAT_R5G5B5A1;break;default:return}break;case this.TYPE_COLOR:switch(this.bytesPerPixel){case 4:this.format=s.PIXELFORMAT_R8G8B8A8;break;case 3:this.format=s.PIXELFORMAT_R8G8B8;break;case 2:this.format=s.PIXELFORMAT_R5G5B5A1;break;default:return}break;default:return}if(n.idLength){r+=n.idLength;if(r>t.length)return}if(this.TYPE_MAPPED_RLE===n.imageType||this.TYPE_MAPPED===n.imageType){if(n.colorMapType!==1)return}else if(n.colorMapType!==0)return;if(n.colorMapType===1){var o=n.colorMapIndex,u=n.colorMapLength;if(u===0)return;var a=Math.floor(n.colorMapSize/8),f=u+o,l=[];l.length=f*a,this.colorMap=l,this.colorMapBytesPerPixel=a;var c;for(c=0;c<o*a;c+=1)l[c]=0;for(c=o*a;c<o*a;c+=1,r+=1)l[c]=t[r];r+=u*a;if(r>t.length)return;if(a>=3)for(c=o*a;c<u*a;c+=a){var h=l[c];l[c]=l[c+2],l[c+2]=h}}var p=t.subarray(r);t=null,i&&(p=this.expandRLE(p));var d=this.width*this.height*this.bytesPerPixel;if(p.length<d)return;this.horzRev&&this.flipHorz(p),this.vertRev&&this.flipVert(p),this.colorMap?p=this.expandColorMap(p):2<this.bytesPerPixel?this.convertBGR2RGB(p):2===this.bytesPerPixel&&(p=this.convertARGB2RGBA(p)),this.data=p},parseHeader:function(t){var n={idLength:t[0],colorMapType:t[1],imageType:t[2],colorMapIndex:t[4]<<8|t[3],colorMapLength:t[6]<<8|t[5],colorMapSize:t[7],xOrigin:t[9]<<8|t[8],yOrigin:t[11]<<8|t[10],width:t[13]<<8|t[12],height:t[15]<<8|t[14],bpp:t[16],descriptor:t[17]};return n},isValidHeader:function(t){if(this.TYPE_MAPPED_RLE===t.imageType||this.TYPE_MAPPED===t.imageType){if(t.colorMapType!==1)return!1}else if(t.colorMapType!==0)return!1;if(t.colorMapType===1&&t.colorMapLength===0)return!1;switch(t.imageType){case this.TYPE_MAPPED_RLE:case this.TYPE_MAPPED:break;case this.TYPE_GRAY_RLE:case this.TYPE_GRAY:break;case this.TYPE_COLOR_RLE:case this.TYPE_COLOR:switch(Math.floor(t.bpp/8)){case 4:case 3:case 2:break;default:return!1}break;default:return!1}return 16384<t.width?!1:16384<t.height?!1:!0},expandRLE:function(t){var n=this.bytesPerPixel,r=this.width,i=this.height,s=n,o=r*i*n,u=this.RLE_PACKETSIZE,a=new Uint8Array(o),f=0,l=0,c,h;do{var p=t[f];f+=1;var d=((p&~u)+1)*s;if(p&u)if(s===1){var v=t[f];f+=1;for(c=0;c<d;c+=1)a[l+h]=v}else{for(c=0;c<s;c+=1)a[l+c]=t[f+c];f+=s;for(h=s;h<d;h+=s)for(c=0;c<s;c+=1)a[l+h+c]=a[l+c]}else{for(c=0;c<d;c+=1)a[l+c]=t[f+c];f+=d}l+=d}while(l<o);return a},expandColorMap:function(t){var n=this.bytesPerPixel,r=this.width,i=this.height,s=r*i*n,o=new Uint8Array(s),u=0,a=0,f=this.colorMap;delete this.colorMap;if(n===2||n===3||n===4)do{var l=t[a]*n;a+=1;for(var c=0;c<n;c+=1)o[u]=f[l+c],u+=1}while(u<s);return n===2&&(o=this.convertARGB2RGBA(o)),o},flipHorz:function(t){var n=this.bytesPerPixel,r=this.width,i=this.height,s=Math.floor(r/2),o=r*n;for(var u=0;u<i;u+=1){for(var a=0;a<s;a+=1)for(var f=0;f<n;f+=1){var l=t[a*n+f];t[a*n+f]=t[(r-a-1)*n+f],t[(r-a-1)*n+f]=l}t+=o}},flipVert:function(t){var n=this.bytesPerPixel,r=this.width,i=this.height,s=Math.floor(i/2),o=r*n;for(var u=0;u<s;u+=1){var a=u*o,f=(i-u-1)*o;for(var l=0;l<o;l+=1){var c=t[a+l];t[a+l]=t[f+l],t[f+l]=c}}},convertBGR2RGB:function(t){var n=this.bytesPerPixel,r=this.width,i=this.height,s=r*i*n,o=0;do{var u=t[o];t[o]=t[o+2],t[o+2]=u,o+=n}while(o<s)},convertARGB2RGBA:function(t){var n=this.bytesPerPixel;if(n===2){var r=this.width,i=this.height,s=r*i*n,o=new Uint16Array(r*i),u=0,a=0,f,l,c,h,p=31,d=p,v=p<<5,m=p<<10;do{var g=u[1]<<8|u[0];u+=2,c=(g&d)<<1,l=(g&v)<<1,f=(g&m)<<1,h=g>>15,o[a]=f|l|c|h,a+=1}while(u<s);return o}return t}},vt.create=function(t){var n=new vt;n.gd=t.gd,n.onload=t.onload,n.onerror=t.onerror;var r=t.src;if(r){n.src=r;var i;if(window.XMLHttpRequest)i=new window.XMLHttpRequest;else{if(!window.ActiveXObject)return t.onerror&&t.onerror("No XMLHTTPRequest object could be created"),null;i=new window.ActiveXObject("Microsoft.XMLHTTP")}i.onreadystatechange=function(){if(i.readyState===4){if(!TurbulenzEngine||!TurbulenzEngine.isUnloading()){var e=i.status,t=i.status!==0&&i.statusText||"No connection";if(i.getAllResponseHeaders()===""&&i.responseText===""&&e===200&&t==="OK"){n.onload(new Uint8Array(0),0,0,0,0);return}if(e===200||e===0){var r;if(i.responseType==="arraybuffer")r=i.response;else if(i.mozResponseArrayBuffer)r=i.mozResponseArrayBuffer;else{var s=i.responseText,o=s.length;r=[],r.length=o;for(var u=0;u<o;u+=1)r[u]=s.charCodeAt(u)&255}e===0&&window.location.protocol==="file:"&&(e=200),n.processBytes(new Uint8Array(r)),n.data?n.onload&&n.onload(n.data,n.width,n.height,n.format,e):n.onerror&&n.onerror()}else n.onerror&&n.onerror()}i.onreadystatechange=null,i=null}},i.open("GET",t.src,!0),i.hasOwnProperty&&i.hasOwnProperty("responseType")?i.responseType="arraybuffer":i.overrideMimeType?i.overrideMimeType("text/plain; charset=x-user-defined"):i.setRequestHeader("Content-Type","text/plain; charset=x-user-defined"),i.send(null)}else n.processBytes(t.data),n.data?n.onload&&n.onload(n.data,n.width,n.height,n.format,200):n.onerror&&n.onerror();return n},mt.create=function(t){var n=new mt;return n.force=t.force,n.identifier=t.identifier,n.isGameTouch=t.isGameTouch,n.positionX=t.positionX,n.positionY=t.positionY,n.radiusX=t.radiusX,n.radiusY=t.radiusY,n.rotationAngle=t.rotationAngle,n};var gt=function(){function e(){}return e.create=function(n){var r=new e;return r.changedTouches=n.changedTouches,r.gameTouches=n.gameTouches,r.touches=n.touches,r},e}(),yt=function(){function e(){this.version="0.26.1.0"}return e.prototype.setInterval=function(e,t){var n=this;return window.setInterval(function(){n.updateTime(),e()},t)},e.prototype.clearInterval=function(e){window.clearInterval(e)},e.prototype.createGraphicsDevice=function(e){if(this.graphicsDevice)return this.callOnError("GraphicsDevice already created"),null;var t=N.create(this.canvas,e);return this.graphicsDevice=t,t},e.prototype.createPhysicsDevice=function(e){if(this.physicsDevice)return this.callOnError("PhysicsDevice already created"),null;var t,n=this.getPluginObject();return n?t=n.createPhysicsDevice(e):t=ft.create(),this.physicsDevice=t,t},e.prototype.createSoundDevice=function(e){if(this.soundDevice)return this.callOnError("SoundDevice already created"),null;var t,n=this.getPluginObject();return n?t=n.createSoundDevice(e):t=ht.create(e),this.soundDevice=t,t},e.prototype.createInputDevice=function(e){if(this.inputDevice)return this.callOnError("InputDevice already created"),null;var t=C.create(this.canvas);return this.inputDevice=t,t},e.prototype.createNetworkDevice=function(e){if(this.networkDevice)throw"NetworkDevice already created";var t=k.create();return this.networkDevice=t,t},e.prototype.createMathDevice=function(e){try{var n=new Float32Array([1,2,3]);t.v3Build.apply(t,n),n[0]=t.FLOAT_MAX,t.FLOAT_MAX=n[0]}catch(r){}return t},e.prototype.createNativeMathDevice=function(e){return t},e.prototype.getGraphicsDevice=function(){var e=this.graphicsDevice;return e===null&&this.callOnError("GraphicsDevice not created yet."),e},e.prototype.getPhysicsDevice=function(){return this.physicsDevice},e.prototype.getSoundDevice=function(){return this.soundDevice},e.prototype.getInputDevice=function(){return this.inputDevice},e.prototype.getNetworkDevice=function(){return this.networkDevice},e.prototype.getMathDevice=function(){return t},e.prototype.getNativeMathDevice=function(){return t},e.prototype.getObjectStats=function(){return null},e.prototype.flush=function(){},e.prototype.run=function(){},e.prototype.encrypt=function(e){return e},e.prototype.decrypt=function(e){return e},e.prototype.generateSignature=function(e){return null},e.prototype.verifySignature=function(e,t){return!0},e.prototype.onerror=function(e){console.error(e)},e.prototype.onwarning=function(e){console.warn(e)},e.prototype.getSystemInfo=function(){return this.systemInfo},e.prototype.request=function(e,t){var n=this,r;if(window.XMLHttpRequest)r=new window.XMLHttpRequest;else{if(!window.ActiveXObject){n.callOnError("No XMLHTTPRequest object could be created");return}r=new window.ActiveXObject("Microsoft.XMLHTTP")}var i=function(){if(r.readyState===4){if(!n.isUnloading()){var i=r.responseText,s=r.status;""===i&&(i=null);if(s===0&&i&&window.location.protocol==="file:")s=200;else if(null===r.getResponseHeader("Content-Type")&&""===r.getAllResponseHeaders()){t(null,0);return}s!==0?(404===s&&(i=null),t(i,s)):t(i,0)}r.onreadystatechange=null,r=null,t=null}};r.open("GET",e,!0),t&&(r.onreadystatechange=i),r.send()},e.prototype.destroy=function(){this.networkDevice&&delete this.networkDevice,this.inputDevice&&(this.inputDevice.destroy(),delete this.inputDevice),this.physicsDevice&&delete this.physicsDevice,this.soundDevice&&(this.soundDevice.destroy&&this.soundDevice.destroy(),delete this.soundDevice),this.graphicsDevice&&(this.graphicsDevice.destroy(),delete this.graphicsDevice),this.canvas&&delete this.canvas,this.resizeCanvas&&window.removeEventListener("resize",this.resizeCanvas,!1)},e.prototype.getPluginObject=function(){return!this.plugin&&this.pluginId&&(this.plugin=document.getElementById(this.pluginId)),this.plugin},e.prototype.unload=function(){this.unloading||(this.unloading=!0,this.onunload&&this.onunload(),this.destroy&&this.destroy())},e.prototype.isUnloading=function(){return this.unloading},e.prototype.enableProfiling=function(){},e.prototype.startProfiling=function(){console&&console.profile&&console.profileEnd&&console.profile("turbulenz")},e.prototype.stopProfiling=function(){var e;return console&&console.profile&&console.profileEnd&&(console.profileEnd(),console.profiles&&(e=console.profiles[console.profiles.length-1])),e},e.prototype.callOnError=function(e){var t=this.onerror;t&&t(e)},e.create=function(n){var r=new e,i=n.canvas,s=n.fillParent;window.TurbulenzEngineCanvas=r,r.pluginId=n.pluginId,r.plugin=null;var o=Date.now,u=window.performance;u&&(u.now?o=function(){return u.now()}:u.webkitNow&&(o=function(){return u.webkitNow()})),r.getTime=o;var a=o(),f=!0,l=navigator.userAgent,c=l.indexOf("Version/6.0");-1!==c&&-1!==l.substring(c).indexOf("Safari/")&&(f=!1),f&&Object.defineProperty?(Object.defineProperty(r,"time",{get:function(){return(o()-a)*.001},set:function(e){typeof e=="number"?a=o()-e*1e3:r.callOnError("Must set 'time' attribute to a number")},enumerable:!1,configurable:!1}),r.updateTime=function(){}):r.updateTime=function(){this.time=(o()-a)*.001};if(window.postMessage){var h="0-timeout-message",p=[],d=0,v=function(t){d+=1;var n={id:d,fn:t};return p.push(n),window.postMessage(h,"*"),n},m=function(t){var n=t,r=p.length;for(var i=0;i<r;i+=1)if(p[i].id===n){p.splice(i,1);return}},g=function(t){if(t.source===window&&t.data===h){t.stopPropagation();if(p.length&&!r.isUnloading()){var n=p.shift(),i=n.fn;i()}}};window.addEventListener("message",g,!0),r.setTimeout=function(e,t){if(t<1)return v(e);var n=this;return window.setTimeout(function(){n.updateTime(),n.isUnloading()||e()},t)},r.clearTimeout=function(e){return typeof e=="object"?m(e):window.clearTimeout(e)}}else r.setTimeout=function(e,t){var n=this;return window.setTimeout(function(){n.updateTime(),n.isUnloading()||e()},t)},r.clearTimeout=function(e){return window.clearTimeout(e)};var y=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||window.mozRequestAnimationFrame;y&&(r.setInterval=function(e,t){var n=this;if(Math.abs(t-1e3/60)<=1){var r={enabled:!0},i=o()+16.6,s=function a(){if(r.enabled){var t=o(),s=t-i;0<=s&&(s>50?i=t+16.6:i+=16.6,n.updateTime(),n.isUnloading()||e()),y(a,n.canvas)}};return y(s,n.canvas),r}var u=function(){n.updateTime(),n.isUnloading()||e()};return window.setInterval(u,t)},r.clearInterval=function(e){typeof e=="object"?e.enabled=!1:window.clearInterval(e)}),r.canvas=i,r.networkDevice=null,r.inputDevice=null,r.physicsDevice=null,r.soundDevice=null,r.graphicsDevice=null,s&&(r.resizeCanvas=function(){i.width=i.parentNode.clientWidth,i.height=i.parentNode.clientHeight},r.resizeCanvas(),window.addEventListener("resize",r.resizeCanvas,!1));var b=window.onbeforeunload;window.onbeforeunload=function(){r.unload(),b&&b.call(this)},r.time=0;var w={architecture:"",cpuDescription:"",cpuVendor:"",numPhysicalCores:1,numLogicalCores:1,ramInMegabytes:0,frequencyInMegaHZ:0,osVersionMajor:0,osVersionMinor:0,osVersionBuild:0,osName:navigator.platform,platformProfile:"desktop",userLocale:(navigator.language||navigator.userLanguage).replace("-","_")},E=function(){var t=Math.min(window.screen.height,window.screen.width);return t<900},S=navigator.userAgent,x=S.indexOf("Windows");x!==-1?(w.osName="Windows",navigator.platform==="Win64"?w.architecture="x86_64":navigator.platform==="Win32"&&(w.architecture="x86"),x+=7,S.slice(x,x+4)===" NT "&&(x+=4,w.osVersionMajor=parseInt(S.slice(x,x+1),10),w.osVersionMinor=parseInt(S.slice(x+2,x+4),10)),E()&&(w.platformProfile="tablet")):(x=S.indexOf("Mac OS X"),x!==-1?(w.osName="Darwin",navigator.platform.indexOf("Intel")!==-1&&(w.architecture="x86"),x+=9,w.osVersionMajor=parseInt(S.slice(x,x+2),10),w.osVersionMinor=parseInt(S.slice(x+3,x+4),10),w.osVersionBuild=parseInt(S.slice(x+5,x+6),10)||0):(x=S.indexOf("Linux"),x!==-1?(w.osName="Linux",navigator.platform.indexOf("64")!==-1?w.architecture="x86_64":navigator.platform.indexOf("x86")!==-1&&(w.architecture="x86"),E()&&(w.platformProfile="tablet")):(x=S.indexOf("Android"),-1!==x?(w.osName="Android",navigator.platform.indexOf("arm")?w.architecture="arm":navigator.platform.indexOf("x86")&&(w.architecture="x86"),-1!==S.indexOf("Mobile")?w.platformProfile="smartphone":w.platformProfile="tablet"):-1!==S.indexOf("iPhone")||-1!==S.indexOf("iPod")?(w.osName="iOS",w.architecture="arm",w.platformProfile="smartphone"):-1!==S.indexOf("iPad")&&(w.osName="iOS",w.architecture="arm",w.platformProfile="tablet")))),r.systemInfo=w;var T="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".split("");return r.base64Encode=function(t){var n="",r=t.length,i=T,s,o,u,a,f,l,c,h;s=0;while(s<r)o=t[s],s+=1,f=o>>2,s<r?(u=t[s],s+=1,s<r?(a=t[s],s+=1,l=(o&3)<<4|u>>4,c=(u&15)<<2|a>>6,h=a&63):(l=(o&3)<<4|u>>4,c=(u&15)<<2,h=64)):(l=(o&3)<<4,c=64,h=64),n+=i[f],n+=i[l],n+=i[c],n+=i[h];return n},r},e}();window.WebGLTurbulenzEngine=yt,bt.prototype={defaultCapture:"story_shadows_rendertarget",prefixAssetURL:"",prefixTemplatesURL:"",captureLookUp:{noshadows_norendertarget:"capture/noshadows_norendertarget/",noshadows_rendertarget:"capture/noshadows_rendertarget/",shadows_norendertarget:"capture/shadows_norendertarget/",shadows_rendertarget:"capture/shadows_rendertarget/",waves3_noshadows_norendertarget:"capture/waves3_noshadows_norendertarget/",waves3_shadows_norendertarget:"capture/waves3_shadows_norendertarget/",zoom_shadows_norendertarget:"capture/zoom_shadows_norendertarget/",zoom2_shadows_tiltshift:"capture/zoom2_shadows_tiltshift/",zoom_noshadows_norendertarget:"capture/zoom_noshadows_norendertarget/",story_shadows_rendertarget:"capture/story_shadows_rendertarget/"},numTotalFrames:3600,numFramesPerGroup:60,antialias:!0,multisample:4,fixedFrameRate:!0,blockForRendering:!1,outputMetrics:!1,resultsTemplate:"results_template"},bt.create=function(){var t=new bt;return t},wt.prototype={},wt.create=function(){var t=bt.create(),n=t.captureLookUp;return n.noshadows_norendertarget="//tzawsuser-benchmark.s3.amazonaws.com/51f94db3/",n.noshadows_rendertarget="//tzawsuser-benchmark.s3.amazonaws.com/51f94bd6/",n.shadows_norendertarget="//tzawsuser-benchmark.s3.amazonaws.com/51f94867/",n.shadows_rendertarget="//tzawsuser-benchmark.s3.amazonaws.com/51f92bf7/",n.waves3_noshadows_norendertarget="//tzawsuser-benchmark.s3.amazonaws.com/520106fe/",n.waves3_shadows_norendertarget="//tzawsuser-benchmark.s3.amazonaws.com/520109eb/",n.zoom_shadows_norendertarget="//tzawsuser-benchmark.s3.amazonaws.com/5200c983/",n.zoom2_shadows_tiltshift="//tzawsuser-benchmark.s3.amazonaws.com/5214d902/",n.shadows_norendertarget2="//tzawsuser-benchmark.s3.amazonaws.com/51f94867/",n.shadows_rendertarget2="//tzawsuser-benchmark.s3.amazonaws.com/520e3eb2/",n.noshadows_rendertarget2="//tzawsuser-benchmark.s3.amazonaws.com/520e3eb2/",n.noshadows_norendertarget2="//tzawsuser-benchmark.s3.amazonaws.com/520e4fae/",n.zoom2_shadows_norendertarget="//tzawsuser-benchmark.s3.amazonaws.com/520e3905/",n.story_shadows_rendertarget="//tzawsuser-benchmark.s3.amazonaws.com/521f13a3/",t.prefixAssetURL="//tzawsuser-benchmark.s3.amazonaws.com/",t.prefixTemplatesURL="config/templates/online/",t},Et.prototype={},Et.create=function(){var t=bt.create(),n=t.captureLookUp;return n.noshadows_norendertarget="capture/noshadows_norendertarget/",n.noshadows_rendertarget="capture/noshadows_rendertarget/",n.shadows_norendertarget="capture/shadows_norendertarget/",n.shadows_rendertarget="capture/shadows_rendertarget/",n.waves3_noshadows_norendertarget="capture/waves3_noshadows_norendertarget/",n.waves3_shadows_norendertarget="capture/waves3_shadows_norendertarget/",n.zoom_shadows_norendertarget="capture/zoom_shadows_norendertarget/",n.zoom2_shadows_tiltshift="capture/zoom2_shadows_tiltshift/",n.shadows_norendertarget2="capture/shadows_norendertarget2/",n.shadows_rendertarget2="capture/shadows_rendertarget2/",n.noshadows_rendertarget2="capture/noshadows_rendertarget2/",n.noshadows_norendertarget2="capture/noshadows_norendertarget2/",n.zoom2_shadows_norendertarget="capture/zoom2_shadows_norendertarget/",n.seige_shadows_norendertarget="capture/seige_shadows_norendertarget/",n.story_shadows_rendertarget="capture/story_shadows_rendertarget/",t.prefixAssetURL="capture/",t.prefixTemplatesURL="config/templates/offline/",t},St.prototype={},St.create=function(){var t=bt.create();t.prefixAssetURL="";var n=t.captureLookUp;return n.noshadows_norendertarget="capture/noshadows_norendertarget/",n.noshadows_rendertarget="capture/noshadows_rendertarget/",n.shadows_norendertarget="capture/shadows_norendertarget/",n.shadows_rendertarget="capture/shadows_rendertarget/",n.waves3_noshadows_norendertarget="capture/waves3_noshadows_norendertarget/",n.waves3_shadows_norendertarget="capture/waves3_shadows_norendertarget/",n.zoom_shadows_norendertarget="capture/zoom_shadows_norendertarget/",n.zoom2_shadows_tiltshift="capture/zoom2_shadows_tiltshift/",t},xt.prototype={init:function(){function h(){if(!TurbulenzEngine.isUnloading()){l.playbackController.update(),s&&s.disabled&&(s.disabled=!1);if(l.playbackController.atEnd){l.displayResults(),n&&n.disabled&&(n.disabled=!1);return}c(h)}}function p(){var e=l.graphicsDevice,t=l.playbackController;if(t.addingResources||t.loadingResources||t.loadingTemplates){t.update();var n=t.getLoadingProgress();l.loadingScreen.setProgress(n)}else TurbulenzEngine.clearInterval(l.intervalID),c(h);e.beginFrame()&&(e.clear(this.loadingColor),l.loadingScreen.render(1,1))}var t=this.config;this.playbackController.init(t.prefixAssetURL,t.captureLookUp[t.defaultCapture],t.prefixTemplatesURL);var n=document.getElementById("buttonSave"),r=document.getElementById("buttonPause"),i=document.getElementById("buttonStep"),s=document.getElementById("buttonAbort"),o=document.getElementById("checkboxFixed"),u=document
.getElementById("multisampling"),a=document.getElementById("captureName");a&&(a.textContent=t.defaultCapture),u&&(u.textContent=this.playbackController.multisample);var f=this.playbackController;n&&(n.disabled=!0,n.onclick=function(){f.outputData(t.defaultCapture)}),r&&(r.onclick=function(){f.paused?(r.value="Pause",f.play()):(r.value="Play",f.pause()),i&&(i.disabled=!f.paused)}),i&&(i.disabled=!0,i.onclick=function(){f.step=!0}),s&&(s.disabled=!0,s.onclick=function(){f.abort()}),o&&(o.checked=f.fixedFrameRate,o.onclick=function(){f.fixedFrameRate=o.checked});var l=this,c=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||window.mozRequestAnimationFrame;this.intervalID=TurbulenzEngine.setInterval(p,1e3/60)},displayResults:function(){var t=document.getElementById("engine");if(!t)return;var n=TurbulenzEngine.canvas;n&&(n.style.display="none");var r=this.playbackController.processData(),i=r.userData;i||(t.innerHTML="<h1>No data to graph</h1>");var s={top:10,right:10,bottom:100,left:40},o={top:430,right:10,bottom:20,left:40},u=960-s.left-s.right,a=500-s.top-s.bottom,f=500-o.top-o.bottom,l=[0,u],c=[a,0],h=[f,0],p=i.config.hardware.name,d=i.data.sequences[0].streams[0],v=d.stats,m=d.frames,g=m.msPerFrame,y=v.frameCount,b=v.maxFrameMs,w={x:d3.scale.linear().range(l),y:d3.scale.linear().range(c),x2:d3.scale.linear().range(l),y2:d3.scale.linear().range(h)},E={x:d3.svg.axis().scale(w.x).orient("bottom"),x2:d3.svg.axis().scale(w.x2).orient("bottom"),y:d3.svg.axis().scale(w.y).orient("left")},S=function(){w.x.domain(x.empty()?w.x2.domain():x.extent()),A.select(".x.axis").call(E.x),B()},x=d3.svg.brush().x(w.x2).on("brush",S),T={},N=[],C=d3.scale.category20(),k=[],L=d3.select("#results").append("svg:svg").attr("width",u+s.left+s.right).attr("height",a+s.top+s.bottom);L.append("defs").append("clipPath").attr("id","clip").append("rect").attr("width",u).attr("height",a);var A=L.append("g").attr("transform","translate("+s.left+","+s.top+")"),O=L.append("g").attr("transform","translate("+o.left+","+o.top+")");A.append("g").attr("class","x axis").attr("transform","translate(0,"+a+")").call(E.x),A.append("g").attr("class","y axis").call(E.y),O.append("g").attr("class","x axis").attr("transform","translate(0,"+f+")").call(E.x2),O.append("g").attr("class","x brush").call(x).selectAll("rect").attr("y",-6).attr("height",f+7);var M=function(t){w.x.domain(d3.extent(t.map(function(e,t){return t}))),w.y.domain([0,d3.max(t.map(function(e){return e}))]),w.x2.domain(w.x.domain()),w.y2.domain(w.y.domain()),O.select(".x.axis").call(E.x2),A.select(".x.axis").call(E.x),O.select(".y.axis").call(E.y),A.select(".y.axis").call(E.y)},_=function(t,n){var r=d3.svg.line();r.x(function(e,t){return w.x(t)}),r.y(function(e){return w.y(e)});var i=d3.svg.line();i.x(function(e,t){return w.x2(t)}),i.y(function(e){return w.y2(e)});var s={lineName:t,line:r,line2:i,data:n,className:"line"};return N.push(s),s},D=function(t,n){var r;T[t]?(T[t].push(n),r=t+"-"+T[t].length):(T[t]=[n],r=t),k.push(r)},P=function(){var t;for(var n=0;n<N.length;n+=1)t=N[n],t.focus&&(t.focus.remove(),delete t.focus)},H=function(t,n){return A.append("svg:path").attr("d",t.line(t.data)).attr("class",t.className).style("stroke",C(n)).attr("clip-path","url(#clip)")},B=function(){var t;for(var n=0;n<N.length;n+=1)t=N[n],t.focus?(t.focus.attr("d",t.line(t.data)),t.focus.style("stroke",C(n))):t.focus=H(t,n)},j=function(t,n){return O.append("svg:path").attr("d",t.line2(t.data)).attr("class",t.className).style("stroke",C(n)).attr("clip-path","url(#clip)")},F=function(){var t;for(var n=0;n<N.length;n+=1)t=N[n],t.context&&(t.context.remove(),delete t.context)},I=function(){var t;for(var n=0;n<N.length;n+=1)t=N[n],t.context?(t.context.attr("d",t.line(t.data)),t.context.style("stroke",C(n))):t.context=j(t,n)},q=function(){L.selectAll(".legend").remove();var t=L.selectAll(".legend").data(k).enter().append("g").attr("class","legend").attr("transform",function(e,t){return"translate(0,"+t*20+")"});t.append("rect").attr("x",u-18).attr("width",18).attr("height",18).style("fill",function(e,t){return C(t)}),t.append("text").attr("x",u-24).attr("y",9).attr("dy",".35em").style("text-anchor","end").text(function(e){return e})},R=function(t){if(t.version!==0)return;var n=t.config.hardware.name,r=t.data.sequences[0].streams[0],i=r.stats,s=r.frames,o=s.msPerFrame,u=i.frameCount,a=i.maxFrameMs,f=!1;a>b&&(f=!0),u>y&&(f=!0),f&&M(o),D(n,t),_(k[k-1],o),B(),I(),q()};M(g),D(p,i),_(k[k-1],g),B(),I(),q(),this.playbackController.loadResults(R)},shutdown:function(){this.intervalID&&(TurbulenzEngine.clearInterval(this.intervalID),this.intervalID=null),this.playbackController&&(this.playbackController.destroy(),this.playbackController=null)}},xt.create=function(){var t=new xt,n=t.config=Ct.create(),r={};n.antialias&&(r.multisample=n.multisample&&n.multisample>1?n.multisample:4);var i=t.graphicsDevice=TurbulenzEngine.createGraphicsDevice(r),s=-1,o=!1,u=i.gl;u&&(o=u.getContextAttributes().antialias,!o&&n.antialias&&window.alert("Anti-aliasing was requested, but is not possible"),s=u.getParameter(u.SAMPLES));var a=t.mathDevice=TurbulenzEngine.createMathDevice({});return t.playbackController=Nt.create(n,i),t.playbackController.multisample=s,t.playbackController.antialias=o,t.loadingScreen=Tt.create(i,a,{progress:0}),t.intervalID=null,t};var Tt=function(){function e(){}return e.version=1,e.prototype.setProgress=function(e){this.progress=e},e.prototype.setTexture=function(e){this.textureMaterial.diffuse=e,this.textureWidthHalf=e.width*.5,this.textureHeightHalf=e.height*.5},e.prototype.loadAndSetTexture=function(e,t,n,r){var i=this;if(n){var s=n.urlMapping,o=n.assetPrefix;t.request({src:s&&s[r]||o+r,requestFn:function(n,r){return e.createTexture({src:n,mipmaps:!1,onload:r})},onload:function(e){e&&i.setTexture(e)}})}},e.prototype.render=function(e,t){var n=this.gd,r=n.width,i=n.height;if(r===0||i===0)return;var s,o=n.PRIMITIVE_TRIANGLE_STRIP,u;if(0<e){this.backgroundColor[3]=e;if(e>=1)n.clear(this.backgroundColor);else{n.setTechnique(this.backgroundTechnique);var a=this.backgroundColor;u=this.backgroundMaterial,u.color=a,n.setTechniqueParameters(u),s=n.beginDraw(o,4,this.posVertexFormats,this.posSemantics),s&&(s(-1,-1),s(1,-1),s(-1,1),s(1,1),n.endDraw(s),s=null)}}var f=0,l=0,c=0,h=0,p=0,d=0,v=this.assetTracker,m=v&&v.getLoadingProgress()||this.progress,g=2/r,y=-2/i;if(m!==null&&e>0){m<0?m=0:m>1&&(m=1),u=this.backgroundMaterial;var b=this.barBackgroundColor;b[3]=e;var w=this.barColor;w[3]=e,f=this.barCenter.x*r,l=this.barCenter.y*i;var E=this.barBackgroundWidth,S=.5*this.barBackgroundHeight,x=this.barBorderSize;n.setTechnique(this.backgroundTechnique),u.color=b,n.setTechniqueParameters(u),s=n.beginDraw(o,4,this.posVertexFormats,this.posSemantics),s&&(c=f-.5*E,h=c+E,p=l-S,d=l+S,s(c*g-1,p*y+1),s(h*g-1,p*y+1),s(c*g-1,d*y+1),s(h*g-1,d*y+1),n.endDraw(s),s=null),u.color=w,n.setTechniqueParameters(u),s=n.beginDraw(o,4,this.posVertexFormats,this.posSemantics),s&&(c+=x,h=c+(E-2*x)*m,p+=x,d-=x,s(c*g-1,p*y+1),s(h*g-1,p*y+1),s(c*g-1,d*y+1),s(h*g-1,d*y+1),n.endDraw(s),s=null)}var T=this.textureWidthHalf,N=this.textureHeightHalf;if(0<T&&0<t){var C=this.textureMaterial;n.setTechnique(this.textureTechnique);var k=this.clipSpace;k[0]=g,k[1]=y,C.clipSpace=k,C.alpha=t,n.setTechniqueParameters(C),s=n.beginDraw(o,4,this.textureVertexFormats,this.textureSemantics),s&&(f=r*.5,l=i*.5,c=f-T,h=f+T,p=l-N,d=l+N,s(c,p,0,0),s(h,p,1,0),s(c,d,0,1),s(h,d,1,1),n.endDraw(s),s=null)}},e.create=function(n,r,i){var s=new e;s.gd=n,s.backgroundColor=r.v4Build(.231,.231,.231,1),s.backgroundTechnique=null,s.backgroundMaterial=n.createTechniqueParameters(),s.posVertexFormats=[n.VERTEXFORMAT_FLOAT2],s.posSemantics=n.createSemantics(["POSITION"]),s.clipSpace=r.v4Build(1,1,-1,1),s.textureWidthHalf=0,s.textureHeightHalf=0,s.textureTechnique=null,s.textureMaterial=n.createTechniqueParameters(),s.textureVertexFormats=[n.VERTEXFORMAT_FLOAT2,n.VERTEXFORMAT_FLOAT2],s.textureSemantics=n.createSemantics(["POSITION","TEXCOORD0"]);if(i){s.barBackgroundColor=r.v4BuildZero(),s.barColor=r.v4BuildOne(),s.barCenter={x:.5,y:.75},s.barBorderSize=4,s.barBackgroundWidth=544,s.barBackgroundHeight=32,s.assetTracker=null,s.progress=null,i.backgroundColor&&(s.backgroundColor=i.backgroundColor),i.barBackgroundColor&&(s.barBackgroundColor=i.barBackgroundColor),i.barColor&&(s.barColor=i.barColor);if(i.barCenter){var o;o=i.barCenter.x,s.barCenter.x=o>1?1:o<0?0:o,o=i.barCenter.y,s.barCenter.y=o>1?1:o<0?0:o}i.barBorderSize&&(s.barBorderSize=i.barBorderSize),i.barBackgroundWidth&&(s.barBackgroundWidth=i.barBackgroundWidth),i.barBackgroundHeight&&(s.barBackgroundHeight=i.barBackgroundHeight),i.assetTracker&&(s.assetTracker=i.assetTracker),i.progress&&(s.progress=i.progress)}var u={version:1,name:"loadingscreen.cgfx",samplers:{diffuse:{MinFilter:9729,MagFilter:9729,WrapS:33071,WrapT:33071}},parameters:{color:{type:"float",columns:4},clipSpace:{type:"float",columns:4},alpha:{type:"float"},diffuse:{type:"sampler2D"}},techniques:{background:[{parameters:["color"],semantics:["POSITION"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[770,771]},programs:["vp_background","fp_background"]}],texture:[{parameters:["clipSpace","alpha","diffuse"],semantics:["POSITION","TEXCOORD0"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[770,771]},programs:["vp_texture","fp_texture"]}]},programs:{fp_texture:{type:"fragment",code:"#ifdef GL_ES\n#define TZ_LOWP lowp\nprecision mediump float;\nprecision mediump int;\n#else\n#define TZ_LOWP\n#endif\nvarying vec4 tz_TexCoord[1];\nfloat _TMP0;float _TMP1;float _TMP12;uniform float alpha;uniform sampler2D diffuse;void main()\n{vec4 _textureColor;_textureColor=texture2D(diffuse,tz_TexCoord[0].xy);_TMP1=min(1.0,alpha);_TMP12=max(0.0,_TMP1);_TMP0=_TMP12*_TMP12*(3.0-2.0*_TMP12);_textureColor.w=_textureColor.w*_TMP0;gl_FragColor=_textureColor;}"},vp_texture:{type:"vertex",code:"#ifdef GL_ES\n#define TZ_LOWP lowp\nprecision mediump float;\nprecision mediump int;\n#else\n#define TZ_LOWP\n#endif\nvarying vec4 tz_TexCoord[1];attribute vec4 ATTR0;attribute vec4 ATTR8;\nvec4 _OutPosition1;vec2 _OutUV1;uniform vec4 clipSpace;void main()\n{_OutPosition1.xy=ATTR0.xy*clipSpace.xy+clipSpace.zw;_OutPosition1.zw=ATTR0.zw;_OutUV1=ATTR8.xy;tz_TexCoord[0].xy=ATTR8.xy;gl_Position=_OutPosition1;}"},fp_background:{type:"fragment",code:"#ifdef GL_ES\n#define TZ_LOWP lowp\nprecision mediump float;\nprecision mediump int;\n#else\n#define TZ_LOWP\n#endif\nvec4 _ret_0;float _TMP0;float _TMP1;float _TMP11;uniform vec4 color;void main()\n{_TMP1=min(1.0,color.w);_TMP11=max(0.0,_TMP1);_TMP0=_TMP11*_TMP11*(3.0-2.0*_TMP11);_ret_0=vec4(color.x,color.y,color.z,_TMP0);gl_FragColor=_ret_0;}"},vp_background:{type:"vertex",code:"#ifdef GL_ES\n#define TZ_LOWP lowp\nprecision mediump float;\nprecision mediump int;\n#else\n#define TZ_LOWP\n#endif\nattribute vec4 ATTR0;\nvoid main()\n{gl_Position=ATTR0;}"}}},a=n.createShader(u);return a?(s.backgroundTechnique=a.getTechnique("background"),s.textureTechnique=a.getTechnique("texture"),s):null},e}();Nt.prototype={init:function(t,n,r){this.prefixAssetURL=t,this.prefixCaptureURL=n,this.prefixTemplatesURL=r,this.loadAssets()},_requestData:function(t){var n=this,r=this.playbackGraphicsDevice,i={resources:null,data:null,frames:null,ready:!1};this.groups[t]=i;var s=window.XMLHttpRequest?new window.XMLHttpRequest:new window.ActiveXObject("Microsoft.XMLHTTP"),o=window.XMLHttpRequest?new window.XMLHttpRequest:new window.ActiveXObject("Microsoft.XMLHTTP"),u=window.XMLHttpRequest?new window.XMLHttpRequest:new window.ActiveXObject("Microsoft.XMLHTTP"),a=function(){s.readyState===4&&(i.resources=JSON.parse(s.responseText),n.numCaptureDataLoaded+=1,i.resources&&i.data&&i.frames&&(i.ready=!0),t===this.currentGroupIndex&&this.addingResources&&(r.addResources(i.resources,n.prefixAssetURL),n.addingResources=!1,n.loadingResources=!0),s.onreadystatechange=null,s.responseText=null,s=null)},f=function(){o.readyState===4&&(i.data=o.response,n.numCaptureDataLoaded+=1,i.resources&&i.data&&i.frames&&(i.ready=!0,t===n.currentGroupIndex&&n.loadingResources&&r.numPendingResources===0&&(r.addData(i.data),r.addFrames(i.frames,!0),n.loadingResources=!1)),o.onreadystatechange=null,o.responseText=null,o=null)},l=function(){u.readyState===4&&(i.frames=JSON.parse(u.responseText),n.numCaptureDataLoaded+=1,i.resources&&i.data&&i.frames&&(i.ready=!0,t===n.currentGroupIndex&&n.loadingResources&&r.numPendingResources===0&&(r.addData(i.data),r.addFrames(i.frames,!0),n.loadingResources=!1)),u.onreadystatechange=null,u.responseText=null,u=null)},c="-"+t*this.numFramesPerGroup+"-"+((t+1)*this.numFramesPerGroup-1);s.open("GET",this.prefixCaptureURL+"resources"+c+".json",!0),s.onreadystatechange=a,s.send(),o.open("GET",this.prefixCaptureURL+"data"+c+".bin",!0),o.responseType="arraybuffer",o.onreadystatechange=f,o.send(),u.open("GET",this.prefixCaptureURL+"frames"+c+".json",!0),u.onreadystatechange=l,u.send(),this.numCaptureData+=3},_isSupportedTemplate:function(t){return t.version===0},loadAssets:function(){var t;for(t=0;t<this.numGroups;t+=1)this._requestData(t)},getLoadingProgress:function(){return this.numCaptureDataLoaded/this.numCaptureData},pause:function(){this.pauseStart=TurbulenzEngine.getTime(),this.paused=!0},play:function(){this.pauseStart&&(this.playbackStart+=TurbulenzEngine.getTime()-this.pauseStart),this.paused=!1},abort:function(){this.aborted=!0},update:function(){var t=!1,n=this.graphicsDevice,r=this.playbackGraphicsDevice,i=this.groups[this.currentGroupIndex];i.ready&&(this.addingResources&&(r.addResources(i.resources,this.prefixAssetURL),this.addingResources=!1,this.loadingResources=!0),this.loadingResources&&r.numPendingResources===0&&(r.addData(i.data),r.addFrames(i.frames,!0),this.loadingResources=!1),!this.addingResources&&!this.loadingResources&&!this.loadingTemplates&&(t=!0));if(n.beginFrame()){if(t){if(!this.playbackStart){r.play(0),this.framesRendered=1,this.relativeFrameIndex=1,this.previousFrameTime=TurbulenzEngine.getTime(),this.playbackStart=TurbulenzEngine.getTime(),this.streamStats={},this.resultsData={},this.playbackConfig={},this.streamStats.startTime=(new Date).getTime();return}var s=TurbulenzEngine.getTime();r.play(this.relativeFrameIndex);var o=TurbulenzEngine.getTime()-s,u;if(this.config.blockForRendering)this.graphicsDevice.getScreenshot(!1,0,0,1,1),u=TurbulenzEngine.getTime()-s;else{var a=TurbulenzEngine.getTime();u=a-this.previousFrameTime,this.previousFrameTime=a}this.frameTimeElement&&(this.frameTimeElement.textContent=u.toFixed(1)+" ms");if((!this.paused||this.step)&&!this.atEnd){this.step=!1,this.framesRendered+=1,this.framesRendered%60===0&&(this.averageFrameTime=this.newAverageFrameTime,this.newAverageFrameTime=0),this.newAverageFrameTime+=u/60;var f=(TurbulenzEngine.getTime()-this.playbackStart)/1e3;this.averageFrameTimeElement&&(this.averageFrameTimeElement.textContent=this.averageFrameTime.toFixed(1)+" ms"),this.timeElement&&(this.timeElement.textContent=f.toFixed(2)+" s"),this.framesRenderedElement&&(this.framesRenderedElement.textContent=this.framesRendered.toString()),this.averageFpsElement&&(this.averageFpsElement.textContent=(this.framesRendered/f).toFixed(2)),this.frameNumberElement&&(this.frameNumberElement.textContent=(this.currentGroupIndex*this.numFramesPerGroup+this.relativeFrameIndex).toString()),this.resolutionElement&&(this.resolutionElement.textContent=this.playbackGraphicsDevice.playWidth.toString()+" x "+this.playbackGraphicsDevice.playHeight.toString());var l;if(this.fixedFrameRate||n.fps<=0){l=1,this.msPerFrame[this.msPerFrame.length]=u,this.msDispatchPerFrame[this.msDispatchPerFrame.length]=o;if(this.metricsPerFrame){var c=n.metrics;if(c){var h=this.metricsPerFrame[this.metricsPerFrame.length]={},p;for(p in this.metricsFields)this.metricsFields.hasOwnProperty(p)&&(h[p]=c[p])}}}else{var d=(TurbulenzEngine.getTime()-this.playbackStart)*.06,v=this.currentGroupIndex*this.numFramesPerGroup+this.relativeFrameIndex;l=Math.floor(d-v)}this.relativeFrameIndex+=l;if(this.relativeFrameIndex>=this.numFramesPerGroup){l>0&&r.skip(this.numFramesPerGroup);if(this.currentGroupIndex+1<this.numGroups&&!this.aborted)i.data=this.emptyData,this.currentGroupIndex+=1,this.relativeFrameIndex-=this.numFramesPerGroup,this.addingResources=!0;else{this.relativeFrameIndex-=l;var m=this.streamStats;m.playDuration=f,m.frameCount=this.framesRendered,m.averageFps=this.framesRendered/f,m.endTime=(new Date).getTime();var g=this.playbackConfig;g.canvasWidth=n.width,g.canvasHeight=n.height,g.playWidth=this.playbackGraphicsDevice.playWidth,g.playHeight=this.playbackGraphicsDevice.playHeight,g.multisample=this.multisample,g.antialias=this.antialias,g.fixedFrameRate=this.fixedFrameRate,this.atEnd=!0}}}}else n.clear(this.loadingColor);n.endFrame()}},generateUserData:function(t){var n=this.resultsTemplateData;if(!n)return null;if(!n.config.hardware.name){var r="";while(!r)r=window.prompt("Please specify a name for this hardware (e.g. Frank's Laptop, Quad-core Desktop)");n.config.hardware.name=r}n.config.playback=this.playbackConfig,this.playbackConfig={};var i={},s=t.timing.obj,o=null;t.metrics&&t.metrics.obj&&(o=t.metrics.obj);for(var u in s)s.hasOwnProperty(u)&&(i[u]=s[u]);if(o)for(var a in o)s.hasOwnProperty(a)&&(i[u]=s[a]);i.indices=t.frameIndices;var f=[],l=t.testStats,c=l.length;for(var h=0;h<c;h+=1)f.push({stats:l[h]});return n.data.sequences=[{streams:[{frames:i,stats:t.streamStats,tests:f}]}],n},processData:function(){if(this.dataProcessed)return this.resultsData;var t=this.resultsData,n=0,r=[],i={msPerFrame:[],msDispatchPerFrame:[],averageMsPerFrame:[],averageMsPerDispatch:[]},s="msPerFrame,msDispatchPerFrame,averageMsPerFrame,averageMsPerDispatch\n",o=this.msPerFrame;if(o.length>0){var u=this.msDispatchPerFrame,a=o.length,f=0,l=0,c=0,h=0,p=-1,d=-1,v=-1,m=-1,g;for(g=0;g<a;g+=1)g%60===0&&(f=l,c=h,l=0,h=0),l+=o[g]/60,h+=u[g]/60,p===-1?p=o[g]:o[g]>p&&(p=o[g]),d===-1?d=o[g]:o[g]<d&&(d=o[g]),v===-1?v=u[g]:u[g]>v&&(v=u[g]),m===-1?m=u[g]:u[g]<m&&(m=u[g]),s+=o[g]+","+u[g]+","+f+","+c+"\n",i.averageMsPerFrame.push(f),i.averageMsPerDispatch.push(c),r.push(n),n+=1;var y=this.streamStats;y.maxFrameMs=p,y.minFrameMs=d,y.maxDispatchMs=v,y.minDispatchMs=m,i.msPerFrame=this.msPerFrame,i.msDispatchPerFrame=this.msDispatchPerFrame,t.timing={csv:s,obj:i},this.msPerFrame=[],this.msDispatchPerFrame=[];var b={},w=this.metricsPerFrame;if(w){var E="",S=this.metricsFields,x;for(x in S)S.hasOwnProperty(x)&&(E+=x+",",b[x]=[]);E+="\n";var T=w.length;for(g=0;g<T;g+=1){var N=w[g];for(x in S)S.hasOwnProperty(x)&&(E+=N[x]+",",b[x].push(N[x]));E+="\n"}t.metrics={csv:E,obj:b},this.metricsPerFrame=[]}}return t.frameIndices=r,t.streamStats=this.streamStats,this.streamStats={},t.testStats=[t.streamStats],this.resultsData=t,this.resultsData.userData=this.generateUserData(t),this.dataProcessed=!0,this.resultsData},loadResults:function(t){function i(){window.alert("Could not read existing data"),n.loadingResults=!1}function s(e){var t=e;return function(){delete n.resultsToLoad[t],n.loadingResults&&window.alert("Could not read data for: "+t)}}function o(e,t){var i=n.resultsToLoad;delete i[e];if(!n.loadingResults)return;var s;try{s=JSON.parse(t)}catch(o){window.alert("Could not parse data for: "+e);return}n.savedResults.push(s);var u=0;for(var a in i)i.hasOwnProperty(a)&&(u+=1);n.loadingResults=u>0,r(s)}function u(e){if(!n.loadingResults)return;var t=e.length;for(var r=0;r<t;r+=1){var i=e[r];n.userDataManager.get(i,o,s(i)),n.resultsToLoad[i]=!0}}var n=this,r=t;n.savedResults=[],n.resultsToLoad={};var a=this.userDataManager;return a&&(a.getKeys(u,i),this.loadingResults=!0),this.loadingResults},cancelLoadResults:function(){this.loadingResults=!1},outputData:function(t){function a(){window.alert("Could not read existing data")}function f(){window.alert("Could not save data")}function l(){window.alert("Saved results")}function c(e,t){var n=t;return function(r){var i=!1,s=!1,o=e+"-results",a=r.length;for(var c=0;c<a;c+=1){var h=r[c];if(h===o){s=!0;var p=window.confirm("Data already exists with this name. Would you like to overwrite?");p&&(i=!0)}}(!s||s&&i)&&u.userDataManager.set(o,JSON.stringify(n.userData),l,f)}}var n=this.processData();if(!n.userData){window.alert("No results to save");return}var r=n.userData.config.hardware.name,i=r.replace(/[^a-z0-9]/gi,"_").toLowerCase(),s=(new Date).getTime(),o=i+"/"+s;n.timing&&n.timing.csv&&this.postData("/local/v1/save/webgl-benchmark/data/"+o+"-timing.csv",n.timing.csv),n.metrics&&n.metrics.csv&&this.postData("/local/v1/save/webgl-benchmark/data/"+t+"-metrics.csv",n.metrics.csv),n.userData&&this.postData("/local/v1/save/webgl-benchmark/data/"+o+"-results.json",JSON.stringify(n.userData));var u=this,h=this.userDataManager;h&&n.userData&&h.getKeys(c(s,n),a)},postData:function(t,n){var r=this,i;this.xhrPool.length===0?i=window.XMLHttpRequest?new window.XMLHttpRequest:new window.ActiveXObject("Microsoft.XMLHTTP"):i=this.xhrPool.pop(),i.open("POST",t,!0),i.onreadystatechange=function(){i.readyState===4&&(i.onreadystatechange=null,r.xhrPool.push(i))},i.send(n)},destroy:function(){this.playbackGraphicsDevice.destroy();var t=this.gameSession;t&&(t.destroy(),this.gameSession=null)}},Nt.create=function(t,n){var r=new Nt;r.graphicsDevice=n,r.config=t,r.playbackGraphicsDevice=qt.create(n),r.playbackGraphicsDevice.onerror=function(e){window.alert(e)},r.prefixAssetURL=null,r.prefixCaptureURL=null,r.prefixTemplatesURL=null;var i=r.numTotalFrames=t.numTotalFrames,s=r.numFramesPerGroup=t.numFramesPerGroup;r.numGroups=Math.floor(i/s),r.groups=[],r.currentGroupIndex=0,r.relativeFrameIndex=0,r.framesRendered=0,r.averageFrameTime=0,r.newAverageFrameTime=0,r.addingResources=!0,r.loadingResources=!1,r.loadingTemplates=!0,r.loadingResults=!1,r.emptyData=[-1,-1,-1,-1],r.step=!1,r.numCaptureData=0,r.numCaptureDataLoaded=0,r.previousFrameTime=0,r.atEnd=!1,r.framesRenderedElement=document.getElementById("framesRendered"),r.timeElement=document.getElementById("time"),r.frameTimeElement=document.getElementById("frameTime"),r.averageFrameTimeElement=document.getElementById("averageFrameTime"),r.frameNumberElement=document.getElementById("frameNumber"),r.resolutionElement=document.getElementById("resolution"),r.averageFpsElement=document.getElementById("averageFps"),r.paused=!1,r.pauseStart=null,r.fixedFrameRate=t.fixedFrameRate,r.xhrPool=[],r.msPerFrame=[],r.msDispatchPerFrame=[],t.outputMetrics?r.metricsPerFrame=[]:r.metricsPerFrame=null,r.sentData=!1,r.metricsFields={renderTargetChanges:1,textureChanges:1,renderStateChanges:1,vertexBufferChanges:1,indexBufferChanges:1,techniqueChanges:1,drawCalls:1,primitives:1},r.playbackConfig={},r.resultsData=null,r.dataProcessed=!1,r.resultsTemplateData=null,r.aborted=!1,r.multisample=-1,r.antialias=!1;var o={},u=jt.create(o);r.gameSession=null,r.userDataManager=null,r.mappingTable=null;var a=function(){window.alert("Mapping table is missing. Cannot save data."),r.resultsTemplateData=null,r.loadingTemplates=!1},f=function(t){function n(e,t){if(!e||t!==200){window.alert("Results template is missing: "+i+". Cannot save data."),r.resultsTemplateData=null,r.loadingTemplates=!1;return}try{r.resultsTemplateData=JSON.parse(e),r.resultsTemplateData?r._isSupportedTemplate(r.resultsTemplateData)||(window.alert("Results template is incompatible. Cannot save data."),r.resultsTemplateData=null):(window.alert("Results template is empty. Cannot save data."),r.resultsTemplateData=null),r.loadingTemplates=!1}catch(n){window.alert("Failed to parse results template: "+i+" with message: "+n)}}var i=r.prefixTemplatesURL+r.config.resultsTemplate+".json";TurbulenzEngine.request(t.getURL(i),n)},l=function(t){r.mappingTable=_t.createMappingTable(u,t,f,null,a),r.userDataManager=Ht.create(u,t)},c=function(){var t=r.gameSession;t&&(t.destroy(),r.gameSession=null),r.userDataManager=null};return r.gameSession=_t.createGameSession(u,l,c),r},Ct.prototype={},Ct.create=function(){var t=wt.create();return t.defaultCapture="zoom2_shadows_tiltshift",Lt(t),t};var At=function(){function e(){}return e.create=function(){return new e},e}(),Ot=function(){function e(){}return e.prototype.push=function(e,t){var n=At.create();n.key=e,n.value=t,n.timeOffset=TurbulenzEngine.time,this.events.push(n)},e.prototype.length=function(){return this.events.length},e.prototype.clear=function(){this.events.length=0},e.create=function(){var n=new e;return n.events=[],n},e}(),Mt=function(){function e(){}return e.prototype.request=function(e){var t=function(){e.callback&&e.callback({ok:!1,msg:"Service Unavailable. Discarding request"},503)},n=this,i=this.serviceStatusObserver,s;s=function(o,u){u?e.neverDiscard||(i.unsubscribe(s),t()):o&&(i.unsubscribe(s),n.request(e))};if(!this.running)return this.discardRequests&&!e.neverDiscard?(TurbulenzEngine.setTimeout(t,0),!1):(e.waiting||(e.waiting=!0,i.subscribe(s)),!0);var o=e.responseFilter;return e.responseFilter=function(u,a,f,l){if(l===503){var c=JSON.parse(f),h=c.data,p=h?h.discardRequests:!0;return n.discardRequests=p,p&&!e.neverDiscard?t():i.subscribe(s),_t.serviceUnavailable(n,u),!1}return o?o.call(e.requestHandler,u,a,f,l):!0},r.ajax(e),!0},e.create=function(n,r){var i=new e;return r||(r={}),i.running=!0,i.discardRequests=!1,i.serviceStatusObserver=l.create(),i.serviceName=n,i.onServiceUnavailable=r.onServiceUnavailable,i.onServiceAvailable=r.onServiceAvailable,i},e}(),_t=function(){function e(){}return e.multiplayerJoinRequestQueue={argsQueue:[],handler:function(){},context:undefined,paused:!0,onEvent:function(t,n){this.handler=t,this.context=n},push:function(t){var n=[t];this.paused?this.argsQueue.push(n):this.handler.apply(this.context,n)},shift:function(){var t=this.argsQueue.shift();return t?t[0]:undefined},clear:function(){this.argsQueue=[]},pause:function(){this.paused=!0},resume:function(){this.paused=!1;while(this.argsQueue.length){this.handler.apply(this.context,this.argsQueue.shift());if(this.paused)break}}},e.available=function(){return window.gameSlug!==undefined},e.addBridgeEvents=function(){var t=window.top.Turbulenz,n=t&&t.Data||{},r=n.joinMultiplayerSessionId,i=this,s=function(t){i.multiplayerJoinRequestQueue.push(t)},o=function(t){var n=JSON.parse(t);n.mode&&(i.mode=n.mode),n.joinMultiplayerSessionId&&i.multiplayerJoinRequestQueue.push(n.joinMultiplayerSessionId),i.bridgeServices=!!n.bridgeServices};r&&this.multiplayerJoinRequestQueue.push(r),Pt.setOnMultiplayerSessionToJoin(s),Pt.setOnReceiveConfig(o),Pt.triggerRequestConfig(),this.responseHandlers=[null],this.responseIndex=0,Pt.on("bridgeservices.response",function(e){i.routeResponse(e)})},e.callOnBridge=function(t,n,r){var i={data:n,key:undefined};r&&(this.responseIndex+=1,this.responseHandlers[this.responseIndex]=r,i.key=this.responseIndex),Pt.emit("bridgeservices."+t,JSON.stringify(i))},e.addSignature=function(t,n){var r;return t.requestUrl=n,r=TurbulenzEngine.encrypt(JSON.stringify(t)),t.str=r,t.signature=TurbulenzEngine.generateSignature(r),t},e.routeResponse=function(t){var n=JSON.parse(t),r=n.key||0,i=this.responseHandlers[r];i&&(this.responseHandlers[r]=null,i(n.data))},e.defaultErrorCallback=function(e,t){},e.onServiceUnavailable=function(t,n){},e.onServiceAvailable=function(t,n){},e.createGameSession=function(t,n,r){return Bt.create(t,n,r)},e.createMappingTable=function(n,r,i,s,o){var u,a=r&&r.mappingTable,f,l,c;a?(f=a.mappingTableURL,l=a.mappingTablePrefix,c=a.assetPrefix):s?(f=s.mappingTableURL||(s.mappingTableURL===""?"":"mapping_table.json"),l=s.mappingTablePrefix||(s.mappingTablePrefix===""?"":"staticmax/"),c=s.assetPrefix||(s.assetPrefix===""?"":"missing/")):(f="mapping_table.json",l="staticmax/",c="missing/");var h=function(n){var r=s&&(s.urnMapping||{}),i=o||e.defaultErrorCallback;u.setMapping(r),i(n)},p={mappingTableURL:f,mappingTablePrefix:l,assetPrefix:c,requestHandler:n,onload:i,errorCallback:h};return u=Dt.create(p),u},e.createLeaderboardManager=function(t,n,r,i){return LeaderboardManager.create(t,n,r,i)},e.createBadgeManager=function(t,n){return BadgeManager.create(t,n)},e.createStoreManager=function(t,n,r,i){return StoreManager.create(t,n,r,i)},e.createNotificationsManager=function(t,n,r,i){return NotificationsManager.create(t,n,r,i)},e.createMultiplayerSessionManager=function(t,n){return MultiPlayerSessionManager.create(t,n)},e.createUserProfile=function(n,r,i){var s={};i||(i=e.defaultErrorCallback);var o=function(t){if(t&&t.ok){t=t.data;var n;for(n in t)t.hasOwnProperty(n)&&(s[n]=t[n])}},u="/api/v1/profiles/user";return e.available()&&this.getService("profiles").request({url:u,method:"GET",callback:function(t,n){n===200?o(t):i&&i("TurbulenzServices.createUserProfile error with HTTP status "+n+": "+t.msg,n),r&&r(s)},requestHandler:n}),s},e.upgradeAnonymousUser=function(t){if(t){var n=function(n){t()};Pt.on("user.upgrade.occurred",n)}Pt.emit("user.upgrade.show")},e.sendCustomMetricEvent=function(n,r,i,s,o){o||(o=e.defaultErrorCallback);if(!e.available()){o("TurbulenzServices.sendCustomMetricEvent failed: Service not available",0);return}if("string"!=typeof n||0===n.length){o("TurbulenzServices.sendCustomMetricEvent failed: Event key must be a non-empty string",0);return}if("number"!=typeof r||isNaN(r)||!isFinite(r)){if("[object Array]"!==Object.prototype.toString.call(r)){o("TurbulenzServices.sendCustomMetricEvent failed: Event value must be a number or an array of numbers",0);return}var u,a=r.length;for(u=0;u<a;u+=1)if("number"!=typeof r[u]||isNaN(r[u])||!isFinite(r[u])){o("TurbulenzServices.sendCustomMetricEvent failed: Event value array elements must be numbers",0);return}}this.getService("customMetrics").request({url:"/api/v1/custommetrics/add-event/"+s.gameSlug,method:"POST",data:{key:n,value:r,gameSessionId:s.gameSessionId},callback:function(t,n){n!==200&&o("TurbulenzServices.sendCustomMetricEvent error with HTTP status "+n+": "+t.msg,n)},requestHandler:i,encrypt:!0})},e.sendCustomMetricEventBatch=function(n,r,i,s){s||(s=e.defaultErrorCallback);if(!e.available()){s&&s("TurbulenzServices.sendCustomMetricEventBatch failed: Service not available",0);return}var o=TurbulenzEngine.time,u=n.events,a,f=u.length;for(a=0;a<f;a+=1){var l=u[a].key,c=u[a].value,h=u[a].timeOffset;if("string"!=typeof l||0===l.length){s&&s("TurbulenzServices.sendCustomMetricEventBatch failed: Event key must be a non-empty string",0);return}if("number"!=typeof c||isNaN(c)||!isFinite(c)){if("[object Array]"!==Object.prototype.toString.call(c)){s&&s("TurbulenzServices.sendCustomMetricEventBatch failed: Event value must be a number or an array of numbers",0);return}var p,d=c.length;for(p=0;p<d;p+=1)if("number"!=typeof c[p]||isNaN(c[p])||!isFinite(c[p])){s&&s("TurbulenzServices.sendCustomMetricEventBatch failed: Event value array elements must be numbers",0);return}}if("number"!=typeof h||isNaN(h)||!isFinite(h)){s&&s("TurbulenzServices.sendCustomMetricEventBatch failed: Event time offset is corrupted",0);return}u[a].timeOffset=h-o}this.getService("customMetrics").request({url:"/api/v1/custommetrics/add-event-batch/"+i.gameSlug,method:"POST",data:{batch:u,gameSessionId:i.gameSessionId},callback:function(t,n){n!==200&&s&&s("TurbulenzServices.sendCustomMetricEventBatch error with HTTP status "+n+": "+t.msg,n)},requestHandler:r,encrypt:!0})},e.services={},e.waitingServices={},e.pollingServiceStatus=!1,e.defaultPollInterval=4e3,e.getService=function(t){var n=this.services;if(n.hasOwnProperty(t))return n[t];var r=Mt.create(t);return n[t]=r,r},e.serviceUnavailable=function(n,i){var s=this.waitingServices,o=n.serviceName;if(s.hasOwnProperty(o))return;s[o]=n,n.running=!1;var u=function(n){var r=i.onServiceUnavailable;r&&r.call(n,i),n.onServiceUnavailable&&n.onServiceUnavailable(),e.onServiceUnavailable&&e.onServiceUnavailable(n)};n.discardRequests&&u(n);if(this.pollingServiceStatus)return;var a=this,f,l="/api/v1/service-status/game/read/"+window.gameSlug,c=function(n,r){if(r===200){var o=n.data,l=o.services,c=!1,h;for(h in s)if(s.hasOwnProperty(h)){var p=s[h],d=l[h],v=d.running;p.running=v,p.description=d.description;if(v){if(p.discardRequests){var m=i.onServiceAvailable;m&&m.call(p,i),p.onServiceAvailable&&p.onServiceAvailable(),e.onServiceAvailable&&e.onServiceAvailable(p)}delete s[h],p.discardRequests=!1,p.serviceStatusObserver.notify(v,p.discardRequests)}else d.discardRequests&&!p.discardRequests&&(p.discardRequests=!0,u(p),p.serviceStatusObserver.notify(v,p.discardRequests)),c=!0}if(!c){this.pollingServiceStatus=!1;return}TurbulenzEngine.setTimeout(f,o.pollInterval*1e3)}else TurbulenzEngine.setTimeout(f,a.defaultPollInterval)};f=function(){r.ajax({url:l,method:"GET",callback:c})},f()},e}();typeof Pt!="undefined"&&_t
.addBridgeEvents();var Dt=function(){function e(){}return e.version=1,e.prototype.getURL=function(e,t){var n=this.overrides,r=this.currentProfile,i=n[r],s;while(i){s=i.urnmapping[e];if(s)return s;i=n[i.parent]}return s=this.urlMapping[e],s?s:(t&&t(e),this.assetPrefix+e)},e.prototype.setMapping=function(e){this.urlMapping=e},e.prototype.map=function(e,t){this.urlMapping[e]=t},e.prototype.alias=function(e,t){var n=this.urlMapping;n[e]=n[t]},e.prototype.getCurrentProfile=function(){return this.currentProfile},e.prototype.setProfile=function(e){this.overrides.hasOwnProperty(e)?this.currentProfile=e:this.currentProfile=undefined},e.create=function(n){var r=new e;r.mappingTableURL=n.mappingTableURL,r.tablePrefix=n.mappingTablePrefix,r.assetPrefix=n.assetPrefix,r.overrides={},r.errorCallbackFn=n.errorCallback||_t.defaultErrorCallback,r.currentProfile=TurbulenzEngine.getSystemInfo().platformProfile;var i=function(t){var i=t.urnmapping||t.urnremapping||{},s=t.overrides||{};r.urlMapping=i,r.overrides=s;var o=r.tablePrefix;if(o){var u=function(t){var n;for(n in t)t.hasOwnProperty(n)&&(t[n]=o+t[n])};u(i);var a;for(a in s)s.hasOwnProperty(a)&&u(s[a].urnmapping)}n.onload(r)};return r.mappingTableURL?n.requestHandler.request({src:r.mappingTableURL,onload:function(t,n){if(n===200){var s=JSON.parse(t);i(s)}else r.urlMapping={},t=t||{msg:"(no response)"},r.errorCallbackFn("MappingTable.create: HTTP status "+n+": "+t.msg,n)}}):n.mappingTableData?TurbulenzEngine.setTimeout(function(){i(JSON.parse(n.mappingTableData))},0):TurbulenzEngine.setTimeout(function(){r.errorCallbackFn("!! mappingtable params contain no url or data")},0),r},e}(),Pt=function(){function e(){}return e._bridge=undefined,e._initInstance=function(){var t=window.top.Turbulenz;if(t&&t.Services){var n=t.Services.bridge;if(!n)return;this._bridge=n,this.emit=n.emit,this.on=n.gameListenerOn||n.addListener||n.setListener,this.addListener=n.gameListenerOn||n.addListener||n.setListener,this.setListener=n.gameListenerOn||n.setListener}typeof _t!="undefined"&&_t.addBridgeEvents()},e.isInitialised=function(){return this._bridge!==undefined},e.emit=function(t,n){},e.on=function(t,n){},e.addListener=function(){},e.setListener=function(t,n){},e.setOnReceiveConfig=function(t){this.on("config.set",t)},e.triggerRequestConfig=function(){this.emit("config.request")},e.startLoading=function(){this.emit("status.loading.start")},e.startSaving=function(){this.emit("status.saving.start")},e.stopLoading=function(){this.emit("status.loading.stop")},e.stopSaving=function(){this.emit("status.saving.stop")},e.createdGameSession=function(t){this.emit("game.session.created",t)},e.destroyedGameSession=function(t){this.emit("game.session.destroyed",t)},e.setGameSessionStatus=function(t,n){this.emit("game.session.status",t,n)},e.setGameSessionInfo=function(t){this.emit("game.session.info",t)},e.updateUserBadge=function(t){this.emit("userbadge.update",t)},e.updateLeaderBoard=function(t){this.emit("leaderboards.update",t)},e.setOnMultiplayerSessionToJoin=function(t){this.on("multiplayer.session.join",t)},e.triggerJoinedMultiplayerSession=function(t){this.emit("multiplayer.session.joined",t)},e.triggerLeaveMultiplayerSession=function(t){this.emit("multiplayer.session.leave",t)},e.triggerMultiplayerSessionMakePublic=function(t){this.emit("multiplayer.session.makepublic",t)},e.setOnBasketUpdate=function(t){this.on("basket.site.update",t)},e.triggerBasketUpdate=function(t){this.emit("basket.game.update.v2",t)},e.triggerUserStoreUpdate=function(t){this.emit("store.user.update",t)},e.setOnPurchaseConfirmed=function(t){this.on("purchase.confirmed",t)},e.setOnPurchaseRejected=function(t){this.on("purchase.rejected",t)},e.triggerShowConfirmPurchase=function(){this.emit("purchase.show.confirm")},e.triggerFetchStoreMeta=function(){this.emit("fetch.store.meta")},e.setOnStoreMeta=function(t){this.on("store.meta.v2",t)},e.triggerSendInstantNotification=function(t){this.emit("notifications.ingame.sendInstant",t)},e.triggerSendDelayedNotification=function(t){this.emit("notifications.ingame.sendDelayed",t)},e.setOnNotificationSent=function(t){this.on("notifications.ingame.sent",t)},e.triggerCancelNotificationByID=function(t){this.emit("notifications.ingame.cancelByID",t)},e.triggerCancelNotificationsByKey=function(t){this.emit("notifications.ingame.cancelByKey",t)},e.triggerCancelAllNotifications=function(t){this.emit("notifications.ingame.cancelAll",t)},e.triggerInitNotificationManager=function(t){this.emit("notifications.ingame.initNotificationManager",t)},e.setOnReceiveNotification=function(t){this.on("notifications.ingame.receive",t)},e.changeAspectRatio=function(t){this.emit("change.viewport.ratio",t)},e.setOnViewportHide=function(t){this.on("change.viewport.hide",t)},e.setOnViewportShow=function(t){this.on("change.viewport.show",t)},e.setOnFullscreenOn=function(t){this.on("change.viewport.fullscreen.on",t)},e.setOnFullscreenOff=function(t){this.on("change.viewport.fullscreen.off",t)},e.setOnMenuStateChange=function(t){this.on("change.menu.state",t)},e.setOnUserStateChange=function(t){this.on("change.user.state",t)},e.triggerOnFullscreen=function(){this.emit("trigger.viewport.fullscreen")},e.triggerOnViewportVisibility=function(){this.emit("trigger.viewport.visibility")},e.triggerOnMenuStateChange=function(){this.emit("trigger.menu.state")},e.triggerOnUserStateChange=function(){this.emit("trigger.user.state")},e.queryFullscreen=function(t){this.emit("query.viewport.fullscreen",t)},e.queryViewportVisibility=function(t){this.emit("query.viewport.visibility",t)},e.queryMenuState=function(t){this.emit("query.menu.state",t)},e.queryUserState=function(t){this.emit("query.user.state",t)},e}();Pt.isInitialised()||Pt._initInstance();var Ht=function(){function e(){this.keyValidate=new RegExp("^[A-Za-z0-9]+([\\-\\.][A-Za-z0-9]+)*$")}return e.version=1,e.prototype.validateKey=function(e){return!e||typeof e!="string"?(this.errorCallbackFn("Invalid key string (Key string is empty or not a string)"),!1):this.keyValidate.test(e)?e:(this.errorCallbackFn("Invalid key string (Only alphanumeric characters and .- are permitted)"),!1)},e.prototype.getKeys=function(e,t){var n=this,r=function(i,s){if(s===200)e(i.keys||i.array);else{var o=t||n.errorCallbackFn;o("UserDataManager.getKeys failed with status "+s+": "+i.msg,s,n.getKeys,[e])}},i={gameSessionId:n.gameSessionId};_t.bridgeServices?_t.callOnBridge("userdata.getkeys",null,e):this.service.request({url:"/api/v1/user-data/get-keys",method:"GET",data:i,callback:r,requestHandler:this.requestHandler,encrypt:!0})},e.prototype.exists=function(e,t,n){if(!this.validateKey(e))return;var r=this,i=function(s,o){if(o===200)t(e,s.exists);else{var u=n||r.errorCallbackFn;u("UserDataManager.exists failed with status "+o+": "+s.msg,o,r.exists,[e,t])}},s={gameSessionId:r.gameSessionId};_t.bridgeServices?_t.callOnBridge("userdata.exists",e,function(r){t(e,r)}):this.service.request({url:"/api/v1/user-data/exists/"+e,method:"GET",data:s,callback:i,requestHandler:this.requestHandler,encrypt:!0})},e.prototype.get=function(e,t,n){if(!this.validateKey(e))return;var r=this,i=function(s,o){if(o===200)t(e,s.value);else if(o===404)t(e,null);else{var u=n||r.errorCallbackFn;u("UserDataManager.get failed with status "+o+": "+s.msg,o,r.get,[e,t])}},s={gameSessionId:r.gameSessionId};_t.bridgeServices?_t.callOnBridge("userdata.get",e,function(r){t(e,r)}):this.service.request({url:"/api/v1/user-data/get/"+e,method:"GET",data:s,callback:i,requestHandler:this.requestHandler,encrypt:!0})},e.prototype.set=function(e,t,n,r){if(!this.validateKey(e))return;if(!t){this.remove(e,n);return}var i=this,s=function(o,u){if(u===200)n(e);else{var a=r||i.errorCallbackFn;a("UserDataManager.set failed with status "+u+": "+o.msg,u,i.set,[e,t,n])}},o={gameSessionId:i.gameSessionId,value:t},u="/api/v1/user-data/set/"+e;_t.bridgeServices?(_t.addSignature(o,u),o.key=e,_t.callOnBridge("userdata.set",o,function(){n(e)})):this.service.request({url:u,method:"POST",data:o,callback:s,requestHandler:this.requestHandler,encrypt:!0})},e.prototype.remove=function(e,t,n){if(!this.validateKey(e))return;var r=this,i=function(s,o){if(o===200)t(e);else if(o===404)t(e);else{var u=n||r.errorCallbackFn;u("UserDataManager.remove failed with status "+o+": "+s.msg,o,r.remove,[e,t])}},s={gameSessionId:r.gameSessionId};_t.bridgeServices?_t.callOnBridge("userdata.remove",e,function(){t(e)}):this.service.request({url:"/api/v1/user-data/remove/"+e,method:"POST",data:s,callback:i,requestHandler:this.requestHandler,encrypt:!0})},e.prototype.removeAll=function(e,t){var n=this,r=function(i,s){if(s===200)e();else{var o=t||n.errorCallbackFn;o("UserDataManager.removeAll failed with status "+s+": "+i.msg,s,n.removeAll,[e])}},i={gameSessionId:n.gameSessionId};_t.bridgeServices?_t.callOnBridge("userdata.removeall",null,e):this.service.request({url:"/api/v1/user-data/remove-all",method:"POST",data:i,callback:r,requestHandler:this.requestHandler,encrypt:!0})},e.create=function(n,r,i){var s;return _t.available()?(s=new e,s.requestHandler=n,s.errorCallbackFn=i||_t.defaultErrorCallback,s.gameSessionId=r.gameSessionId,s.service=_t.getService("userdata"),s):null},e}(),Bt=function(){function e(){this.post_delay=1e3}return e.version=1,e.prototype.setStatus=function(e){if(this.destroyed||this.status===e)return;this.status=e,Pt.setGameSessionStatus(this.gameSessionId,e)},e.prototype.destroy=function(e){var t;this.pendingUpdate&&(TurbulenzEngine.clearTimeout(this.pendingUpdate),this.pendingUpdate=null),!this.destroyed&&this.gameSessionId?(Pt.destroyedGameSession(this.gameSessionId),this.destroyed=!0,t={gameSessionId:this.gameSessionId},_t.bridgeServices?_t.callOnBridge("gamesession.destroy",t,e):r.ajax({url:"/api/v1/games/destroy-session",method:"POST",data:t,callback:e,requestHandler:this.requestHandler})):e&&TurbulenzEngine.setTimeout(e,0)},e.prototype.setTeamInfo=function(e){var t=this.info.sessionData,n=t.teamList||[];e.join("#")!==n.join("#")&&(t.teamList=e,this.update())},e.prototype.setPlayerInfo=function(e,t){var n=this.info.playerSessionData[e],r,i=!1;n||(n={},this.info.playerSessionData[e]=n,i=!0);for(r in t)if(t.hasOwnProperty(r)){if(!this.templatePlayerData.hasOwnProperty(r))throw"unknown session data property "+r;n[r]!==t[r]&&(n[r]=t[r],i=!0)}i&&this.update()},e.prototype.removePlayerInfo=function(e){delete this.info.playerSessionData[e],this.update()},e.prototype.clearAllPlayerInfo=function(){this.info.playerSessionData={},this.update()},e.prototype.update=function(){this.pendingUpdate||(this.pendingUpdate=TurbulenzEngine.setTimeout(this.postData,this.post_delay))},e.create=function(n,r,i){var s=new e,o=window.gameSlug,u=window.top.Turbulenz,a=u&&u.Data||{},f=a.mode||_t.mode,l="/api/v1/games/create-session/"+o,c=function(t,n){n===200?(s.mappingTable=t.mappingTable,s.gameSessionId=t.gameSessionId,r&&r(s),Pt.createdGameSession(s.gameSessionId)):s.errorCallbackFn("TurbulenzServices.createGameSession error with HTTP status "+n+": "+t.msg,n)};return s.info={sessionData:{},playerSessionData:{}},s.templatePlayerData={team:null,color:null,status:null,rank:null,score:null,sortkey:null},s.postData=function(){Pt.setGameSessionInfo(JSON.stringify(s.info)),s.pendingUpdate=null},s.pendingUpdate=null,s.gameSlug=o,s.requestHandler=n,s.errorCallbackFn=i||_t.defaultErrorCallback,s.gameSessionId=null,s.service=_t.getService("gameSessions"),s.status=null,_t.available()?(f&&(l+="/"+f),s.service.request({url:l,method:"POST",callback:c,requestHandler:n,neverDiscard:!0}),s):(r&&TurbulenzEngine.setTimeout(function(){r(s)},0),s)},e}(),jt=function(){function e(){this.reasonConnectionLost=0,this.reasonServiceBusy=1}return e.prototype.retryExponential=function(e,t,n){if(!this.notifiedConnectionLost&&TurbulenzEngine.time-this.connectionLostTime>this.notifyTime*.001){this.notifiedConnectionLost=!0;var r;n===0?r=this.reasonConnectionLost:r=this.reasonServiceBusy,e.reason=r,this.onRequestTimeout(r,e)}if(this.connected)this.connectionLostTime=TurbulenzEngine.time,this.notifiedConnectionLost=!1,this.connected=!1,this.reconnectTest=e,e.status=n;else if(this.reconnectTest!==e){var i=this.reconnectedObserver,s=function(){i.unsubscribe(s),t()};i.subscribe(s);return}e.expTime?(e.expTime=2*e.expTime,e.expTime>this.maxRetryTime&&(e.expTime=this.maxRetryTime)):e.expTime=this.initialRetryTime,e.retries?e.retries+=1:e.retries=1,TurbulenzEngine.setTimeout(t,e.expTime)},e.prototype.retryAfter=function(e,t,n,r){e.retries?e.retries+=1:(e.firstRetry=TurbulenzEngine.time,e.retries=1);if(!e.notifiedMaxRetries&&TurbulenzEngine.time-e.firstRetry+t>this.notifyTime){e.notifiedMaxRetries=!0;var i=this.reasonServiceBusy;e.reason=i,this.onRequestTimeout(i,e)}TurbulenzEngine.setTimeout(n,t*1e3)},e.prototype.request=function(e){var t,n=this,r=function(i,s){if(n.destroyed)return;var o=n.sendEventToHandlers,u=n.handlers;if(s===0||s===408||s===429||s===480){n.retryExponential(e,t,s);return}n.connected||(n.connected=!0,n.reconnectTest===e&&n.notifiedConnectionLost&&n.onReconnected(n.reconnectTest.reason,n.reconnectTest),n.reconnectTest=null,n.reconnectedObserver.notify());if(e.responseFilter&&!e.responseFilter.call(this,e,t,i,s))return;if(n.responseFilter&&!n.responseFilter(e,t,i,s))return;if(e.onload){var a;i&&i.name?a=i.name:a=e.src,o(u.eventOnload,{eventType:"eventOnload",name:a}),e.onload(i,s,e),e.onload=null}e=null};t=function(){if(n.destroyed)return;e.requestFn?e.requestOwner?e.requestFn.call(e.requestOwner,e.src,r,e):e.requestFn(e.src,r,e):e.requestOwner?e.requestOwner.request(e.src,r,e):TurbulenzEngine.request(e.src,r)},t()},e.prototype.addEventListener=function(e,t){var n,r,i;if(this.handlers.hasOwnProperty(e)){i=this.handlers[e];if(t){r=i.length;for(n=0;n<r;n+=1)if(i[n]===t)return;i.push(t)}}},e.prototype.removeEventListener=function(e,t){var n,r,i;if(this.handlers.hasOwnProperty(e)){i=this.handlers[e];if(t){r=i.length;for(n=0;n<r;n+=1)if(i[n]===t){i.splice(n,1);break}}}},e.prototype.sendEventToHandlers=function(e,t){var n,r=e.length;if(r)for(n=0;n<r;n+=1)e[n](t)},e.prototype.destroy=function(){this.destroyed=!0,this.handlers=null,this.onReconnected=null,this.onRequestTimeout=null},e.create=function(n){var r=new e;r.initialRetryTime=n.initialRetryTime||500,r.notifyTime=n.notifyTime||4e3,r.maxRetryTime=n.maxRetryTime||8e3,r.notifiedConnectionLost=!1,r.connected=!0,r.reconnectedObserver=l.create(),r.reconnectTest=null,r.onReconnected=n.onReconnected||function(){},r.onRequestTimeout=n.onRequestTimeout||function(){};var i={eventOnload:[]};return r.handlers=i,r},e}(),Ft={setTechniqueParameters:0,drawIndexed:1,draw:2,setIndexBuffer:3,setStream:4,setTechnique:5,setData:6,setAllData:7,beginRenderTarget:8,clear:9,endRenderTarget:10,beginEndDraw:11,setScissor:12,setViewport:13,beginOcclusionQuery:14,endOcclusionQuery:15,updateTextureData:16},It=function(){function e(e){this.precision=1e-6;var t=[],n;for(n in e){var r=e[n];if(typeof r=="number"||typeof r=="string"||0===n.indexOf("VERTEXFORMAT"))this[n]=r,0===n.indexOf("SEMANTIC_")&&t.length<=r&&(t[r]=n.slice(9))}return this.gd=e,this.current=[],this.frames=[],this.commands=[],this.numCommands=0,this.lastId=-1,this.recycledIds=[],this.destroyedIds=[],this.integerData={},this.floatData={},this.mixedData={},this.objects={},this.objectArray=[],this.names={},this.numNames=0,this.vertexBuffers={},this.indexBuffers={},this.techniqueParameterBuffers={},this.semantics={},this.semanticsMap={},this.formats={},this.formatsMap={},this.textures={},this.shaders={},this.techniques={},this.videos={},this.renderBuffers={},this.renderTargets={},this.occlusionQueries={},this.reverseSemantic=t,this}return e.prototype._getCommandId=function(){var e=this.numCommands;return this.numCommands=e+1,e},e.prototype._getIntegerId=function(){if(this.recycledIds.length)return this.recycledIds.pop();var e=this.lastId+1;return this.lastId=e,e},e.prototype._getStringId=function(){return this._getIntegerId().toString()},e.prototype._addData=function(e,t,n){var r,i;e instanceof ArrayBuffer?i=this.mixedData:n?i=this.integerData:i=this.floatData;var s=i[t];if(s===undefined)i[t]=s=[],r=0;else{e instanceof ArrayBuffer?r=this._lowerBoundGeneric(s,new Uint8Array(e,0,t),t,0):n?r=this._lowerBoundGeneric(s,e,t,0):r=this._lowerBoundFloat(s,e,t);if(r<0)return r=-r-1,s[r].toString()}var o;if(e instanceof ArrayBuffer)o=new Uint8Array(e.slice(0,t));else if(n)if(e.BYTES_PER_ELEMENT)t<e.length?o=new e.constructor(e.subarray(0,t)):o=new e.constructor(e);else{var u=e[0],a=e[0],f;for(f=1;f<t;f+=1){var l=e[f];u>l?u=l:a<l&&(a=l)}var c;0<=u&&a<=255?c=Uint8Array:-128<=u&&a<=127?c=Int8Array:0<=u&&a<=65535?c=Uint16Array:-32768<=u&&a<=32767?c=Int16Array:0<=u?c=Uint32Array:c=Int32Array,t<e.length?o=new c(e.slice(0,t)):o=new c(e)}else t<e.length?e.subarray?o=new Float32Array(e.subarray(0,t)):o=new Float32Array(e.slice(0,t)):o=new Float32Array(e);var h=this._getIntegerId();return r<s.length?s.splice(r,0,h,o):s.push(h,o),h.toString()},e.prototype._addCommand=function(e,t,n,r,i,s,o,u,a){var f=arguments.length,l,c=this.commands[e];if(c===undefined)this.commands[e]=c=[],l=0;else if(0<c.length){if(f===1){this.current.push(c[0]);return}f===2?l=this._lowerBoundSimpleCommand(c,arguments):l=this._lowerBoundGeneric(c,arguments,f,1);if(l<0){l=-l-1,this.current.push(c[l]);return}}else l=0;var h=new Array(f),p;h[0]=e;for(p=1;p<f;p+=1)h[p]=arguments[p];var d=this._getCommandId();l<c.length?c.splice(l,0,d,h):c.push(d,h),this.current.push(d)},e.prototype._objectToArray=function(e){var t=this.objectArray;t.length=0;var n,r;for(n in e)e.hasOwnProperty(n)&&(r=e[n],r!==undefined&&r!==null&&t.push(this._addName(n),this._clone(r)));return t},e.prototype._patchObjectArray=function(e){var t=e.length,n,r;for(n=0;n<t;n+=2)e[n]=this._addName(e[n]),r=e[n+1],r!==undefined&&r!==null&&(e[n+1]=this._clone(r));return e},e.prototype._sortObjectArray=function(e,t){var n,r,i,s;for(i=2;i<t;i+=2){n=e[i],r=e[i+1];for(s=i-2;s>-2&&e[s]>n;s-=2)e[s+2]=e[s],e[s+3]=e[s+1];e[s+2]=n,e[s+3]=r}},e.prototype._addName=function(e){var t=this.names[e];return t===undefined&&(t=this.numNames,this.numNames+=1,this.names[e]=t),t},e.prototype._addObject=function(e){var t;e instanceof Array?t=this._patchObjectArray(e):t=this._objectToArray(e);var n=t.length;if(n===0)return null;2<n&&this._sortObjectArray(t,n);var r,i=this.objects[n];if(i===undefined)this.objects[n]=i=[],r=0;else{r=this._lowerBoundGeneric(i,t,n,0);if(r<0)return r=-r-1,i[r].toString()}var s=this._getIntegerId();return r<i.length?i.splice(r,0,s,t.slice()):i.push(s,t.slice()),s.toString()},e.prototype._cloneObject=function(e,t){var n,r,i,s,o;if(typeof e._id=="string")return e._id;if(e.BYTES_PER_ELEMENT){n=e.length;if(t||n===0){i=new Array(n);for(r=0;r<n;r+=1)i[r]=e[r];return i}var u=!(e instanceof Float32Array||e instanceof Float64Array);return this._addData(e,n,u)}if(e instanceof Array){n=e.length;if(!t&&n!==0){for(r=0;r<n;r+=1)if(typeof e[r]!="number")break;if(r===n)return this._addData(e,n,!1)}i=new Array(n);for(r=0;r<n;r+=1)s=e[r],s!==undefined&&typeof s!="function"&&(!s||typeof s!="object"?i[r]=s:i[r]=this._cloneObject(s,t));return i}if(e instanceof ArrayBuffer)return undefined;if(e instanceof Date)return i=new Date(e.getTime()),i;i={};var a;for(a in e)e.hasOwnProperty(a)&&(s=e[a],s!==undefined&&typeof s!="function"&&(!s||typeof s!="object"?i[a]=s:i[a]=this._cloneObject(s,t)));return i},e.prototype._clone=function(e){return!e||typeof e!="object"?e:this._cloneObject(e,!1)},e.prototype._cloneVertexFormats=function(e){var t=this.gd,n=e.length,r=new Array(n),i;for(i=0;i<n;i+=1){var s=e[i];typeof s=="string"?r[i]=s:s===t.VERTEXFORMAT_BYTE4?r[i]="BYTE4":s===t.VERTEXFORMAT_BYTE4N?r[i]="BYTE4N":s===t.VERTEXFORMAT_UBYTE4?r[i]="UBYTE4":s===t.VERTEXFORMAT_UBYTE4N?r[i]="UBYTE4N":s===t.VERTEXFORMAT_SHORT2?r[i]="SHORT2":s===t.VERTEXFORMAT_SHORT2N?r[i]="SHORT2N":s===t.VERTEXFORMAT_SHORT4?r[i]="SHORT4":s===t.VERTEXFORMAT_SHORT4N?r[i]="SHORT4N":s===t.VERTEXFORMAT_USHORT2?r[i]="USHORT2":s===t.VERTEXFORMAT_USHORT2N?r[i]="USHORT2N":s===t.VERTEXFORMAT_USHORT4?r[i]="USHORT4":s===t.VERTEXFORMAT_USHORT4N?r[i]="USHORT4N":s===t.VERTEXFORMAT_FLOAT1?r[i]="FLOAT1":s===t.VERTEXFORMAT_FLOAT2?r[i]="FLOAT2":s===t.VERTEXFORMAT_FLOAT3?r[i]="FLOAT3":s===t.VERTEXFORMAT_FLOAT4&&(r[i]="FLOAT4")}var o=r.join(","),u=this.formatsMap[o];return u===undefined&&(u=this._getStringId(),this.formats[u]=r,this.formatsMap[o]=u),u},e.prototype._cloneSemantics=function(e){var t=this.gd,n=e.length,r=new Array(n),i,s;for(i=0;i<n;i+=1){var o=e[i];typeof o=="string"?s=o:s=this.reverseSemantic[o],s==="TEXCOORD0"&&(s="TEXCOORD"),r[i]=s}return r},e.prototype._checkProperties=function(e){var t={},n=this.objectArray;n.length=0,e.dirty=!1;var r=e.parameters;for(var i in r)if(r.hasOwnProperty(i)){var s=r[i];if(s.dirty){s.dirty=0;var o=s.info;if(o&&null!==location){var u=o.values,a;o.sampler!==undefined?a=u:1===o.numValues?a=u[0]:a=u,t[i]=a,n.push(i,a)}}}var f=this._addObject(n);f!==null&&this._addCommand(Ft.setTechniqueParameters,f),this.gd.setTechniqueParameters(t)},e.prototype._lowerBoundGeneric=function(e,t,n,r){var i=0,s=e.length>>>1,o,u,a,f,l,c,h;while(0<s){o=s>>>1,u=i+o,a=(u<<1)+1,l=e[a],f=r;for(;;){c=l[f],h=t[f];if(c!==h){if(c<h){i=u+1,s-=o+1;break}s=o;break}f+=1;if(f>=n)return-a}}return i<<1},e.prototype._lowerBoundSimpleCommand=function(e,t){var n=0,r=e.length>>>1,i,s,o,u,a;while(0<r){i=r>>>1,s=n+i,o=(s<<1)+1,u=e[o][1],a=t[1];if(u===a)return-o;u<a?(n=s+1,r-=i+1):r=i}return n<<1},e.prototype._lowerBoundFloat=function(e,t,n){var r=0,i=e.length>>>1,s,o,u,a,f=this.precision,l=-f,a,c,h;while(0<i){s=i>>>1,o=r+s,u=(o<<1)+1,c=0,h=e[u];for(;;){a=h[c]-t[c];if(a<l){r=o+1,i-=s+1;break}if(a>f){i=s;break}c+=1;if(c>=n)return-u}}return r<<1},e.prototype._equalFloatArrays=function(e,t,n){var r=0,i=this.precision;do{if(Math.abs(e[r]-t[r])>=i)return!1;r+=1}while(r<n);return!0},e.prototype._equalIntegerArrays=function(e,t,n){var r=0;do{if(e[r]!==t[r])return!1;r+=1}while(r<n);return!0},e.prototype._setFilteredTechniqueParameters=function(e,t,n){var r=this.objectArray;r.length=0;var i,s,o;for(i in e)if(t[i]!==undefined){s=e[i],o=n[i];if(o!==s)if(s!==undefined){if(o!==undefined&&(s instanceof Float32Array||s instanceof Array)&&s._id===undefined&&s.length<=o.length&&this._equalFloatArrays(s,o,s.length))continue;n[i]=s,r.push(i,s)}else delete e[i]}if(0<r.length){var u=this._addObject(r);u!==null&&this._addCommand(Ft.setTechniqueParameters,u),this.gd.setTechniqueParameters(e)}},e.prototype.drawIndexed=function(e,t,n){this.gd.drawIndexed(e,t,n),this._addCommand(Ft.drawIndexed,e,t,n||0)},e.prototype.draw=function(e,t,n){this.gd.draw(e,t,n),this._addCommand(Ft.draw,e,t,n||0)},e.prototype.setTechniqueParameters=function(e){var t=arguments.length;for(var n=0;n<t;n+=1){var r=arguments[n];if(r){var i=this._addObject(r);i!==null&&this._addCommand(Ft.setTechniqueParameters,i)}}this.gd.setTechniqueParameters.apply(this.gd,arguments)},e.prototype.setTechnique=function(e){if(e.passes.length===1){var t=e.passes[0];t.dirty&&this._checkProperties(t)}this.gd.setTechnique(e),e.device=null;var n=e._id;if(n===undefined){n=this._getStringId(),e._id=n,this.techniques[n]={shader:e.shader._id,name:e.name};if(e.passes.length===1){var r=this;e.checkProperties=function(){var t=this.passes[0];t.dirty&&r._checkProperties(t)}}}this._addCommand(Ft.setTechnique,n)},e.prototype.setStream=function(e,t,n){n===undefined&&(n=0),this._addCommand(Ft.setStream,e._id,t._id,n),this.gd.setStream(e,t,n)},e.prototype.setIndexBuffer=function(e){this._addCommand(Ft.setIndexBuffer,e._id),this.gd.setIndexBuffer(e)},e.prototype.drawArray=function(e,t,n){var r=e.length;if(r<=0)return;r>1&&n&&(n>0?e.sort(function(t,n){return n.sortKey-t.sortKey}):e.sort(function(t,n){return t.sortKey-n.sortKey}));var i=t.length,s=null,o=null,u=null,a=null,f=-1,l=null,c=0,h=!1,p=null,d=0,v=0,m=-1,g=this.current,y=this.gd;for(var b=0;b<r;b+=1){var w=e[b],E=w.technique,S=w.endTechniqueParameters,x=w.endStreams,T=w.endInstances,N=w.indexBuffer,C=w.primitive,k=w.count,L=w.firstIndex;if(a!==E){a=E,this.setTechnique(E),E.passes.length===1?o=E.passes[0].parameters:o=E.shader.parameters,s={};for(v=0;v<i;v+=1)this._setFilteredTechniqueParameters(t[v],o,s)}for(v=48;v<S;v+=1)this._setFilteredTechniqueParameters(w[v],o,s);h=f===x;for(c=0;h&&c<x;c+=3)h=l[c]===w[c]&&l[c+1]===w[c+1]&&l[c+2]===w[c+2];if(!h){f=x,l=w;for(c=0;c<x;c+=3)p=w[c],p&&this.setStream(p,w[c+1],w[c+2])}if(N){u!==N&&(u=N,this.setIndexBuffer(N)),v=56;if(v<T){m=-1;do this._setFilteredTechniqueParameters(w[v],o,s),m===-1?(this.drawIndexed(C,k,L),m=g[g.length-1]):(y.drawIndexed(C,k,L),g.push(m)),v+=1;while(v<T)}else this.drawIndexed(C,k,L)}else{v=56;if(v<T){m=-1;do this._setFilteredTechniqueParameters(w[v],o,s),m===-1?(this.draw(C,k,L),m=g[g.length-1]):(y.draw(C,k,L),g.push(m)),v+=1;while(v<T)}else this.draw(C,k,L)}}},e.prototype.beginDraw=function(e,t,n,r){var i=this.gd.beginDraw(e,t,n,r);if(i){var s=this,o=[];t=0;var u=function(){var n=arguments.length;for(var r=0;r<n;r+=1){var s=arguments[r];typeof s=="number"?o.push(s):o.push.apply(o,s)}t+=1,i.apply(this,arguments)};return u.end=function(){0<t&&s._addCommand(Ft.beginEndDraw,e,t,s._cloneVertexFormats(n),r._id,s._addData(o,o.length,!1))},u.proxy=i,u}return i},e.prototype.endDraw=function(e){e.end(),this.gd.endDraw(e.proxy)},e.prototype.setViewport=function(e,t,n,r){var i=this.gd;i.setViewport(e,t,n,r),n===i.width&&r===i.height&&(n=-1,r=-1),this._addCommand(Ft.setViewport,e,t,n,r)},e.prototype.setScissor=function(e,t,n,r){var i=this.gd;i.setScissor(e,t,n,r),n===i.width&&r===i.height&&(n=-1,r=-1),this._addCommand(Ft.setScissor,e,t,n,r)},e.prototype.clear=function(e,t,n){this._addCommand(Ft.clear,this._clone(e),t,n),this.gd.clear(e,t,n)},e.prototype.beginFrame=function(){return this.width=this.gd.width,this.height=this.gd.height,this.gd.beginFrame()},e.prototype.beginRenderTarget=function(e){return this._addCommand(Ft.beginRenderTarget,e._id),this.gd.beginRenderTarget(e)},e.prototype.endRenderTarget=function(){this._addCommand(Ft.endRenderTarget),this.gd.endRenderTarget()},e.prototype.beginOcclusionQuery=function(e){return this._addCommand(Ft.beginOcclusionQuery,e._id),this.gd.beginOcclusionQuery(e)},e.prototype.endOcclusionQuery=function(e){this._addCommand(Ft.endOcclusionQuery,e._id),this.gd.endOcclusionQuery(e)},e.prototype.endFrame=function(){this.frames.push(this.current),this.current=[],this.gd.endFrame(),this.fps=this.gd.fps},e.prototype.createTechniqueParameters=function(e){return this.gd.createTechniqueParameters(e)},e.prototype.createSemantics=function(e){var t=this.gd.createSemantics(e);if(t){var n=this._cloneSemantics(e),r=n.join(","),i=this.semanticsMap[r];i===undefined&&(i=this._getStringId(),this.semanticsMap[r]=i,this.semantics[i]=n),t._id=i}return t},e.prototype.createVertexBuffer=function(e){var t=this.gd.createVertexBuffer(e);if(t){var n=this._getStringId();t._id=n;var r=this,i=t.setData;t.setData=function(t,s,o){s===undefined&&(s=0),o===undefined&&(o=this.numVertices);var u;t instanceof ArrayBuffer?u=o*this.strideInBytes:u=o*this.stride,s===0&&o===this.numVertices?r._addCommand(Ft.setAllData,n,r._addData(t,u,!1)):0<o&&r._addCommand(Ft.setData,n,s,o,r._addData(t,u,!1)),i.call(this,t,s,o)};var s=t.map;t.map=function(i,o){i===undefined&&(i=0),o===undefined&&(o=this.numVertices);var u=s.call(this,i,o);if(u){var a=[];o=0;var f=function(){var t=arguments.length;for(var n=0;n<t;n+=1){var r=arguments[n];typeof r=="number"?a.push(r):a.push.apply(a,r)}o+=1,u.apply(this,arguments)};return f.end=function(){i===0&&o===t.numVertices?r._addCommand(Ft.setAllData,n,r._addData(a,a.length,!1)):0<o&&r._addCommand(Ft.setData,n,i,o,r._addData(a,a.length,!1))},f.proxy=u,f}return u};var o=t.unmap;t.unmap=function(t){t.end(),o.call(this,t.proxy)};var u=t.destroy;t.destroy=function(){r.destroyedIds.push(parseInt(this._id,10)),u.call(this)};var a=e.attributes;e.attributes=this._cloneVertexFormats(a),(e.dynamic===!1||e["transient"])&&delete e.dynamic;if(e.data){var f=e.data;this._addCommand(Ft.setAllData,n,this._addData(f,f.length,!1)),delete e.data}this.vertexBuffers[n]=this._cloneObject(e,!0),e.attributes=a}return t},e.prototype.createIndexBuffer=function(e){var t=this.gd.createIndexBuffer(e);if(t){var n=this._getStringId();t._id=n;var r=this,i=t.setData;t.setData=function(t,s,o){s===undefined&&(s=0),o===undefined&&(o=this.numIndices),s===0&&o===this.numIndices?r._addCommand(Ft.setAllData,n,r._addData(t,o,!0)):0<o&&r._addCommand(Ft.setData,n,s,o,r._addData(t,o,!0)),i.call(this,t,s,o)};var s=t.map;t.map=function(i,o){i===undefined&&(i=0),o===undefined&&(o=this.numIndices);var u=s.call(this,i,o);return u&&(u.end=function(){var s=u.data,o=u.getNumWrittenIndices();i===0&&o===t.numIndices?r._addCommand(Ft.setAllData,n,r._addData(s,o,!0)):0<o&&r._addCommand(Ft.setData,n,i,o,r._addData(s,o,!0))}),u};var o=t.unmap;t.unmap=function(t){t.end(),o.call(this,t)};var u=t.destroy;t.destroy=function(){r.destroyedIds.push(parseInt(this._id,10)),u.call(this)},(e.dynamic===!1||e["transient"])&&delete e.dynamic;if(e.data){var a=e.data;this._addCommand(Ft.setAllData,n,this._addData(a,a.length,!0)),delete e.data}var f=this._cloneObject(e,!0);f.format===this.gd.INDEXFORMAT_USHORT?f.format="USHORT":f.format===this.gd.INDEXFORMAT_UINT?f.format="UINT":f.format===this.gd.INDEXFORMAT_UBYTE&&(f.format="UBYTE"),this.indexBuffers[n]=f}return t},e.prototype.createTexture=function(e){var t=this.gd.createTexture(e);if(t){var n=this._getStringId();t._id=n;var r=this,i=t.setData;t.setData=function(t){var s=!(t instanceof Float32Array||t instanceof Float64Array),o=r._addData(t,t.length,s);arguments.length===1?(r._addCommand(Ft.setAllData,n,o),i.call(this,t)):(r._addCommand(Ft.updateTextureData,n,o,arguments[1],arguments[2],arguments[3],arguments[4],arguments[5],arguments[6]),i.apply(this,arguments))};if(e.data){var s=e.data,o=!(s instanceof Float32Array||s instanceof Float64Array);this._addCommand(Ft.setAllData,n,this._addData(s,s.length,o)),delete e.data}e.cubemap===!1&&delete e.cubemap,e.dynamic===!1&&delete e.dynamic,e.mipmaps===!1&&delete e.mipmaps;var u=this._cloneObject(e,!0);u.renderable&&u.width===this.gd.width&&u.height===this.gd.height&&(u.width=-1,u.height=-1),this.textures[n]=u}return t},e.prototype.createVideo=function(e){var t=this.gd.createVideo(e);if(t){var n=this._getStringId();t._id=n,this.videos[n]=this._cloneObject(e,!0)}return t},e.prototype.createShader=function(e){var t=this._cloneObject(e,!0),n=this.gd.createShader(e);if(n){var r=this._getStringId();n._id=r,this.shaders[r]=t}return n},e.prototype.createTechniqueParameterBuffer=function(e){var t=new Float32Array(e.numFloats),n=this._getStringId();t._id=n;if(t._id!==n)return this.gd.createTechniqueParameterBuffer(e);var r=this;t.setData=function(t,i,s){i===undefined&&(i=0),s===undefined&&(s=this.length);var o=0;while(o<s&&this[i]===t[o])i+=1,o+=1;var u=i+s;while(o<s&&this[u-1]===t[s-1])u-=1,s-=1;if(o>=s)return;0<o&&(s-=o,t.subarray?t=t.subarray(o,o+s):t=t.slice(o,s)),i===0&&s===this.length?r._addCommand(Ft.setAllData,n,r._addData(t,s,!1)):r._addCommand(Ft.setData,n,i,s,r._addData(t,s,!1)),o=0;do this[i]=t[o],i+=1,o+=1;while(o<s)},t.map=function(n,r){n===undefined&&(n=0),r===undefined&&(r=this.length);var i=new Float32Array(r),s=0,o=function(){var t=arguments.length;for(var n=0;n<t;n+=1){var r=arguments[n];if(typeof r=="number")i[s]=r,s+=1;else{var o=r.length,u;for(u=0;u<o;u+=1)i[s]=r[u],s+=1}}};return o.end=function(){t.setData(i,n,s)},o},t.unmap=function(t){t.end()},t.destroy=function(){r.destroyedIds.push(parseInt(this._id,10)),this.length=0},e.dynamic===!1&&delete e.dynamic;if(e.data){var i=e.data;this._addCommand(Ft.setAllData,n,this._addData(i,i.length,!1)),delete e.data}return this.techniqueParameterBuffers[n]=this._cloneObject(e,!0),t},e.prototype.createRenderBuffer=function(e){var t=this.gd.createRenderBuffer(e);if(t){var n=this._getStringId();t._id=n;var r=this._cloneObject(e,!0);r.width===this.gd.width&&r.height===this.gd.height&&(r.width=-1,r.height=-1),this.renderBuffers[n]=r}return t},e.prototype.createRenderTarget=function(e){var t=this.gd.createRenderTarget(e);if(t){var n=this._getStringId();t._id=n,this.renderTargets[n]=this._cloneObject(e,!0)}return t},e.prototype.createOcclusionQuery=function(e){var t=this.gd.createOcclusionQuery(e);if(t){var n=this._getStringId();t._id=n,this.occlusionQueries[n]=this._cloneObject(e,!0)}return t},e.prototype.createDrawParameters=function(e){return this.gd.createDrawParameters(e)},e.prototype.isSupported=function(e){return this.gd.isSupported(e)},e.prototype.maxSupported=function(e){return this.gd.maxSupported(e)},e.prototype.loadTexturesArchive=function(e){var t=this._cloneObject(e,!0);t.archive={},this.textures[this._getStringId()]=t;var n=this,r=e.ontextureload,i=e.onload;return e.ontextureload=function(i){if(i){var s=n._getStringId
();t.archive[i.name]=s,i._id=s,r(i)}},e.onload=function(n,s){e.ontextureload=r,e.onload=i,i&&e.onload(n,s)},this.gd.loadTexturesArchive(e)},e.prototype.getScreenshot=function(e,t,n,r,i){return this.gd.getScreenshot(e,t,n,r,i)},e.prototype.flush=function(){this.gd.flush()},e.prototype.finish=function(){this.gd.finish()},e.prototype.getFramesString=function(){var e='{"version":1,';e+='"width":'+this.gd.width+",",e+='"height":'+this.gd.height+",",e+='"names":[';var t=this.names,n=this.numNames,r=new Array(n),i;for(i in t)t.hasOwnProperty(i)&&(r[t[i]]=i);var s;for(s=0;s<n;s+=1)s&&(e+=","),e+='"'+r[s]+'"';e+='],"objects":[';var o=this.objects,u=!1,a,f,l,c,h,p;for(i in o)if(o.hasOwnProperty(i)){a=o[i],l=a.length;for(s=0;s<l;s+=2){c=a[s],f=a[s+1],w=f.length,u?e+=",":u=!0,e+=c+",[";for(h=0;h<w;h+=1){h&&(e+=",");var d=f[h];typeof d=="string"?e+='"'+d+'"':typeof d=="number"?(p=d|0,p===d?e+=p:e+=d.toFixed(4).replace(/\.?0+$/,"")):e+=d}e+="]"}}var v=this.commands,m=v.length,g=this.numCommands,y=new Array(g),b,w;for(i=0;i<m;i+=1){b=v[i];if(b!==undefined){w=b.length;for(s=0;s<w;s+=2)y[b[s]]=b[s+1]}}e+='],"commands":[';for(s=0;s<g;s+=1){s&&(e+=","),e+="[";var E=y[s],S=E.length,x,d;for(x=0;x<S;x+=1)d=E[x],x&&(e+=","),typeof d=="string"?e+=d:typeof d=="number"?(p=d|0,p===d?e+=p:e+=d.toFixed(4).replace(/\.?0+$/,"")):d===undefined||d===null?e+="null":e+=d;e+="]"}e+='],"frames":[';var T=this.frames,N=T.length;for(s=0;s<N;s+=1)s&&(e+=","),e+="["+T[s].join(",")+"]";return e+="]}",e},e.prototype._getDataBinSize=function(e,t){var n=0,r,i,s,o,u;for(r in e)if(e.hasOwnProperty(r)){i=e[r],s=i.length;if(s===0)continue;n+=4,n+=4;for(o=0;o<s;o+=2)u=i[o+1],n+=4,t&&(n+=4),n+=u.byteLength+3&2147483644}return n+=4,n},e.prototype._getDataBinBuffer=function(e,t,n,r){var i,s,o,u,a;for(i in n)if(n.hasOwnProperty(i)){s=n[i],o=s.length;if(o===0)continue;e[t]=o>>>1,t+=1,e[t]=parseInt(i,10),t+=1;var f,l,c,h,p,d;for(u=0;u<o;u+=2){e[t]=s[u],t+=1,l=s[u+1],c=l.length,r&&(l instanceof Uint8Array?h=8:l instanceof Int8Array?h=-8:l instanceof Uint16Array?h=16:l instanceof Int16Array?h=-16:l instanceof Uint32Array?h=32:h=-32,e[t]=h,t+=1);if(r){var v=new l.constructor(e.buffer,t*4,c);for(a=0;a<c;a+=1)v[a]=l[a];t+=l.byteLength+3>>>2}else{l=new Int32Array(l.buffer,0,l.length);for(a=0;a<c;a+=1)e[t]=l[a],t+=1}}}return e[t]=-1,t+=1,t},e.prototype.getDataBuffer=function(){var e=8;e+=this._getDataBinSize(this.integerData,!0),e+=this._getDataBinSize(this.floatData,!1),e+=this._getDataBinSize(this.mixedData,!0);var t=new ArrayBuffer(e),n=new Uint8Array(t),r="TZBD";n[0]=r.charCodeAt(0),n[1]=r.charCodeAt(1),n[2]=r.charCodeAt(2),n[3]=r.charCodeAt(3);var i=new Int32Array(t);i[1]=1;var s=2;return s=this._getDataBinBuffer(i,s,this.integerData,!0),s=this._getDataBinBuffer(i,s,this.floatData,!1),s=this._getDataBinBuffer(i,s,this.mixedData,!0),n},e.prototype.getResourcesString=function(){return JSON.stringify({version:1,resources:{vertexBuffers:this.vertexBuffers,indexBuffers:this.indexBuffers,techniqueParameterBuffers:this.techniqueParameterBuffers,semantics:this.semantics,formats:this.formats,textures:this.textures,shaders:this.shaders,techniques:this.techniques,videos:this.videos,renderBuffers:this.renderBuffers,renderTargets:this.renderTargets}})},e.prototype._recycleDataBinIds=function(e){var t=this.recycledIds,n,r,i,s;for(i in e)if(e.hasOwnProperty(i)){n=e[i],r=n.length;for(s=0;s<r;s+=2)t.push(n[s]);n.length=0}},e.prototype.reset=function(){var e=this.frames,t=e.length,n;for(n=0;n<t;n+=1)e[n].length=0,e[n]=null;e.length=0;var r=this.commands,i=r.length;for(n=0;n<i;n+=1)r[n]!==undefined&&(r[n].length=0);this.numCommands=0,this._recycleDataBinIds(this.integerData),this._recycleDataBinIds(this.floatData),this._recycleDataBinIds(this.mixedData),this._recycleDataBinIds(this.objects);var s=this.recycledIds;this.destroyedIds.length&&(s.push.apply(s,this.destroyedIds),this.destroyedIds.length=0),s.sort(function(e,t){return t-e});var o=this.lastId;n=0;while(o===s[n])n+=1,o-=1;n&&(this.lastId=o,n<s.length?s.splice(0,n):s.length=0),this.names={},this.numNames=0,this.vertexBuffers={},this.indexBuffers={},this.techniqueParameterBuffers={},this.semantics={},this.formats={},this.textures={},this.shaders={},this.techniques={},this.videos={},this.renderBuffers={},this.renderTargets={},this.occlusionQueries={}},e.prototype.destroy=function(){this.gd.destroy(),this.gd=null,this.current=null,this.frames=null,this.commands=null,this.numCommands=0,this.lastId=-1,this.recycledIds=null,this.destroyedIds=null,this.integerData=null,this.floatData=null,this.mixedData=null,this.objects=null,this.objectArray=null,this.names=null,this.numNames=0,this.vertexBuffers=null,this.indexBuffers=null,this.techniqueParameterBuffers=null,this.semantics=null,this.semanticsMap=null,this.textures=null,this.shaders=null,this.techniques=null,this.videos=null,this.renderBuffers=null,this.renderTargets=null,this.occlusionQueries=null,this.reverseSemantic=null},e.create=function(t){return new e(t)},e.version=1,e}(),qt=function(){function e(e){this.black=[0,0,0,1],this.gd=e,this.nextFrameIndex=0,this.srcWidth=0,this.srcHeight=0,this.playWidth=0,this.playHeight=0,this.frames=[],this.entities=[],this.writerData=[],this.numPendingResources=0,this.numResourcesAdded=0,this.onerror=null}return e.prototype._storeEntity=function(e,t){(t===null||t===undefined)&&this.onerror&&this.onerror("Failed to create entity: "+e),typeof e=="string"&&(e=parseInt(e,10));var n=this.entities[e];n&&n.destroy&&n.destroy(),this.entities[e]=t},e.prototype._resolveEntity=function(e){typeof e=="string"&&(e=parseInt(e,10));if(typeof e!="number")return e;var t=this.entities[e];return t||this.onerror&&this.onerror("Unknown entity: "+e),t},e.prototype.addResources=function(e,t){function a(e){return i.numPendingResources+=1,i.numResourcesAdded+=1,function(n,r){n?i.numPendingResources-=1:i.onerror&&i.onerror("Failed to load resource: "+e)}}function f(e){return function(n){i.numPendingResources-=1,i._storeEntity(e[n.name],n)}}var n=e.resources,r=this.gd,i=this,s,o,u,l=n.shaders;for(s in l)l.hasOwnProperty(s)&&(o=l[s],this._storeEntity(s,r.createShader(o)));var c=n.videos;for(s in c)c.hasOwnProperty(s)&&(o=c[s],u=o.src,u&&(o.src=t+u,o.onload=a(o.src)),this._storeEntity(s,r.createVideo(o)));var h=n.renderBuffers;for(s in h)h.hasOwnProperty(s)&&(o=h[s],o.width===-1&&(o.width=r.width),o.height===-1&&(o.height=r.height),this._storeEntity(s,r.createRenderBuffer(o)));var p=n.textures;for(s in p)if(p.hasOwnProperty(s)){o=p[s],u=o.src,u&&(o.src=t+u,o.onload=a(o.src));if(o.archive){var d=o.archive,v;for(v in d)d.hasOwnProperty(v)&&(this.numPendingResources+=1,this.numResourcesAdded+=1);o.ontextureload=f(d),r.loadTexturesArchive(o)}else o.width===-1&&(o.width=r.width),o.height===-1&&(o.height=r.height),this._storeEntity(s,r.createTexture(o))}var m=n.renderTargets;for(s in m)m.hasOwnProperty(s)&&(o=m[s],typeof o.colorTexture0=="string"&&(o.colorTexture0=this._resolveEntity(o.colorTexture0)),typeof o.colorTexture1=="string"&&(o.colorTexture1=this._resolveEntity(o.colorTexture1)),typeof o.colorTexture2=="string"&&(o.colorTexture2=this._resolveEntity(o.colorTexture2)),typeof o.colorTexture3=="string"&&(o.colorTexture3=this._resolveEntity(o.colorTexture3)),typeof o.depthBuffer=="string"&&(o.depthBuffer=this._resolveEntity(o.depthBuffer)),typeof o.depthTexture=="string"&&(o.depthTexture=this._resolveEntity(o.depthTexture)),this._storeEntity(s,r.createRenderTarget(o)));var g=n.formats;for(s in g)if(g.hasOwnProperty(s)){var y=g[s],b=y.length,w;for(w=0;w<b;w+=1){var E=y[w];y[w]=r["VERTEXFORMAT_"+E];if(y[w]===undefined){this.onerror&&this.onerror("Unknown vertex format: "+E);return}}this._storeEntity(s,y)}var S=n.vertexBuffers;for(s in S)S.hasOwnProperty(s)&&(o=S[s],o.attributes=this._resolveEntity(o.attributes),this._storeEntity(s,r.createVertexBuffer(o)));var x=n.indexBuffers;for(s in x)x.hasOwnProperty(s)&&(o=x[s],this._storeEntity(s,r.createIndexBuffer(o)));var T=n.techniqueParameterBuffers;for(s in T)T.hasOwnProperty(s)&&(o=T[s],this._storeEntity(s,r.createTechniqueParameterBuffer(o)));var N=n.semantics;for(s in N)N.hasOwnProperty(s)&&(o=N[s],this._storeEntity(s,r.createSemantics(o)));var C=n.techniques;for(s in C)C.hasOwnProperty(s)&&(o=C[s],this._storeEntity(s,this._resolveEntity(o.shader).getTechnique(o.name)));e.resources={}},e.prototype.addData=function(e){var t=new Int32Array(e),n=2,r,i,s,o,u,a,f;for(;;){r=t[n],n+=1;if(r<0)break;i=t[n],n+=1;for(s=0;s<r;s+=1)o=t[n],n+=1,u=t[n],n+=1,a=n<<2,u===8?f=new Uint8Array(e,a,i):u===-8?f=new Int8Array(e,a,i):u===16?f=new Uint16Array(e,a,i):u===-16?f=new Int16Array(e,a,i):u===32?f=new Uint32Array(e,a,i):f=new Int32Array(e,a,i),this._storeEntity(o,f),n+=f.byteLength+3>>>2}for(;;){r=t[n],n+=1;if(r<0)break;i=t[n],n+=1;for(s=0;s<r;s+=1)o=t[n],n+=1,a=n<<2,f=new Float32Array(e,a,i),this._storeEntity(o,f),n+=i}if(n<t.length)for(;;){r=t[n],n+=1;if(r<0)break;i=t[n],n+=1;for(s=0;s<r;s+=1)o=t[n],n+=2,a=n<<2,f=e.slice(a,a+i),this._storeEntity(o,f),n+=f.byteLength+3>>>2}},e.prototype.addFrames=function(e,t){var n=this.gd,r=e.names,i=e.objects,s=i.length,o,u,a,f,l,c,h,p,d;for(l=0;l<s;l+=2){o=i[l],u=i[l+1],f=u.length,a=n.createTechniqueParameters();for(c=0;c<f;c+=2)h=r[u[c]],p=u[c+1],typeof p=="string"?a[h]=this._resolveEntity(p):a[h]=p;this._storeEntity(o,a)}i.length=0,r.length=0;var v=e.commands,m=v.length,g=e.frames,y=g.length,b=this.frames,w,E,S;if(t){var x=b.length;for(l=0;l<x;l+=1)b[l].length=0,b[l]=null;b.length=0,this.nextFrameIndex=0}for(l=0;l<m;l+=1){var E=v[l],T=E.length,N=E[0];if(N===Ft.setTechniqueParameters)E[1]=this._resolveEntity(E[1]);else if(N!==Ft.drawIndexed&&N!==Ft.draw)if(N===Ft.setIndexBuffer)E[1]=this._resolveEntity(E[1]);else if(N===Ft.setStream)E[1]=this._resolveEntity(E[1]),E[2]=this._resolveEntity(E[2]);else if(N===Ft.setTechnique)E[1]=this._resolveEntity(E[1]);else if(N===Ft.setData)E[1]=this._resolveEntity(E[1]),E[4]=this._resolveEntity(E[4]);else if(N===Ft.setAllData)E[1]=this._resolveEntity(E[1]),E[2]=this._resolveEntity(E[2]);else if(N===Ft.beginRenderTarget)E[1]=this._resolveEntity(E[1]);else if(N===Ft.clear)E[1]=this._resolveEntity(E[1]);else if(N!==Ft.endRenderTarget)if(N===Ft.beginEndDraw)E[3]=this._resolveEntity(E[3]),E[4]=this._resolveEntity(E[4]),E[5]=this._resolveEntity(E[5]);else if(N!==Ft.setViewport&&N!==Ft.setScissor)if(N===Ft.beginOcclusionQuery)E[1]=this._resolveEntity(E[1]);else if(N===Ft.endOcclusionQuery)E[1]=this._resolveEntity(E[1]);else{if(N!==Ft.updateTextureData){this.onerror&&this.onerror("Unknown command: "+N);break}E[1]=this._resolveEntity(E[1]),E[2]=this._resolveEntity(E[2])}}for(l=0;l<y;l+=1){var C=g[l],m=C.length;for(w=0;w<m;w+=1)S=C[w],E=v[S],C[w]=E;b.push(C)}v.length=0,g.length=0,this.srcWidth=e.width,this.srcHeight=e.height},e.prototype._beginEndDraw=function(e,t,n,r,i){var s=this.gd.beginDraw(e,t,n,r);if(s){var o=s.write,u=i.length,a=Math.floor(u/t),f=this.writerData;f.length=a;var l=0;while(l<u){var c;for(c=0;c<a;c+=1)f[c]=i[l],l+=1;o.apply(s,f)}this.gd.endDraw(s)}},e.prototype.skip=function(e){var t=this.nextFrameIndex;while(t<e){var n=this.frames[t];if(!n)return!1;var r=n.length,i,s;for(i=0;i<r;i+=1){var o=n[i],u=o[0];u===Ft.setData?(s=o[1],s["transient"]||s.setData(o[4],o[2],o[3])):u===Ft.setAllData?(s=o[1],s["transient"]||s.setData(o[2])):u===Ft.updateTextureData&&o[1].setData(o[2],o[3],o[4],o[5],o[6],o[7],o[8])}t+=1,this.nextFrameIndex=t}return!0},e.prototype.play=function(e){this.nextFrameIndex<e&&this.skip(e);var t=this.frames[e];if(!t)return!1;var n=this.gd,r=n.width,i=n.height,s=r/i/(this.srcWidth/this.srcHeight),o,u,a,f;s<1-1/i?(o=0,a=r,f=i*s|0,u=i-f>>1,n.setScissor(0,0,a,u),n.clear(this.black),n.setScissor(0,f-u,a,u),n.clear(this.black)):s>1+1/r?(u=0,f=i,a=r/s|0,o=r-a>>1,n.setScissor(0,0,o,f),n.clear(this.black),n.setScissor(a-o,0,o,f),n.clear(this.black)):(u=0,f=i,a=r,o=0);if(o||u)n.setScissor(o,u,a,f),n.setViewport(o,u,a,f);this.playWidth=a,this.playHeight=f;var l=t.length,c;for(c=0;c<l;c+=1){var h=t[c],p=h[0];if(p===Ft.setTechniqueParameters)n.setTechniqueParameters(h[1]);else if(p===Ft.drawIndexed)n.drawIndexed(h[1],h[2],h[3]);else if(p===Ft.draw)n.draw(h[1],h[2],h[3]);else if(p===Ft.setIndexBuffer)n.setIndexBuffer(h[1]);else if(p===Ft.setStream)n.setStream(h[1],h[2],h[3]);else if(p===Ft.setTechnique)n.setTechnique(h[1]);else if(p===Ft.setData)h[1].setData(h[4],h[2],h[3]);else if(p===Ft.setAllData)h[1].setData(h[2]);else if(p===Ft.beginRenderTarget)n.beginRenderTarget(h[1]);else if(p===Ft.clear)n.clear(h[1],h[2],h[3]);else if(p===Ft.endRenderTarget)n.endRenderTarget();else if(p===Ft.beginEndDraw)this._beginEndDraw(h[1],h[2],h[3],h[4],h[5]);else if(p===Ft.setViewport){var d=h[1],v=h[2],m=h[3],g=h[4];m===-1&&(d=o,m=a),g===-1&&(v=u,g=f),n.setViewport(d,v,m,g)}else if(p===Ft.setScissor){var d=h[1],v=h[2],m=h[3],g=h[4];m===-1&&(d=o,m=a),g===-1&&(v=u,g=f),n.setScissor(d,v,m,g)}else if(p===Ft.beginOcclusionQuery)n.beginOcclusionQuery(h[1]);else if(p===Ft.endOcclusionQuery)n.endOcclusionQuery(h[1]);else{if(p!==Ft.updateTextureData){this.onerror&&this.onerror("Unknown command: "+p);break}h[1].setData(h[2],h[3],h[4],h[5],h[6],h[7],h[8])}}return this.nextFrameIndex=e+1,!0},e.prototype.destroy=function(){this.gd=null,this.frames=null,this.entities=null},e.create=function(t){return new e(t)},e.version=1,e}();TurbulenzEngine.onload=function(){var t=xt.create(null);TurbulenzEngine.onunload=function(){t.shutdown()},t.init()},window.TurbulenzEngine=TurbulenzEngine})();